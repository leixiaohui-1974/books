<!-- 变更日志
v2 2026-02-16: 根据四角色评审修订——补充基础题答案要点与术语一致性声明
v1 2026-02-16: 初稿
-->

# 第十章 在环测试与验证

---

## 学习目标

完成本章后，你应能够：

1. 区分 MIL/SIL/HIL 的测试目标、边界与实施成本；
2. 设计面向水系统控制策略的测试用例体系与覆盖度指标；
3. 构建从离线仿真到在线回归的在环测试流水线；
4. 将 ODD、Safety Envelope 与最小风险状态纳入验证闭环；
5. 制定版本发布门禁、缺陷分级与回归策略。

> **章首衔接（承接ch09）**  
> 上一章给出 HydroOS 的系统化落地框架。本章进一步解决“如何证明它可安全上线”：通过在环测试建立可复现、可量化、可审计的验证体系。

## 10.1 为什么在环测试是上线前提

[物理直觉] 水系统控制策略常在多扰动条件下运行，单次离线算例不能代表真实风险边界。

[工程解释] 在环测试（In-the-Loop Testing）通过分层验证（MIL/SIL/HIL）逐步缩小“仿真与现场”的差距，使策略在上线前暴露问题、收敛风险。

## 10.2 MIL/SIL/HIL 分层框架

### 10.2.1 MIL（Model-in-the-Loop）

- 对象：控制算法与系统模型；
- 目标：快速筛查策略有效性与参数敏感性；
- 优势：成本低、迭代快；
- 局限：与真实设备交互差异较大。

### 10.2.2 SIL（Software-in-the-Loop）

- 对象：软件栈、接口协议与调度逻辑；
- 目标：验证软件行为、时序一致性与异常处理；
- 关键：接口契约、线程与消息队列稳定性。

### 10.2.3 HIL（Hardware-in-the-Loop）

- 对象：控制器、通信链路与关键执行设备；
- 目标：验证真实硬件约束下的控制可行性；
- 关键：时延抖动、传感器噪声、联锁动作可靠性。

[图10-1: MIL-SIL-HIL在环测试管线]
{描述: 从模型验证到软件集成再到硬件闭环逐级放大真实度，设置统一门禁与缺陷回流机制。}
{尺寸: 全页}
{颜色方案: 蓝色系}
{对应ARCH编号: ARCH-06}

## 10.3 测试用例设计方法

### 10.3.1 场景维度拆解

建议按四维构建用例矩阵：
1. 水文扰动（常态、突涨、枯水、极端事件）；
2. 设备状态（正常、降级、检修、失效）；
3. 通信条件（正常、延迟、丢包、断链）；
4. 组织条件（自动运行、人工接管、应急演练）。

### 10.3.2 用例分级

- **P0关键用例**：涉及 Safety Envelope 与联锁安全；
- **P1重要用例**：影响供水稳定与调度收益；
- **P2常规用例**：功能完整性与报表一致性。

[工程解释] 用例分级用于资源聚焦：P0 必须全量通过，P1 需达到门限，P2 支持持续改进。

## 10.4 覆盖度指标与门禁

覆盖度不只看“跑了多少用例”，还应关注“风险是否被覆盖”。

建议指标：
- 场景覆盖率（按ODD子域统计）；
- 风险覆盖率（高风险触发条件覆盖）；
- 回退覆盖率（最小风险状态触发链路覆盖）；
- 回归通过率（版本升级后关键用例稳定通过率）。

[表10-1: 在环测试发布门禁]
| 门禁项 | 判据示例 | 处置策略 |
|---|---|---|
| 安全门禁 | P0用例100%通过 | 不通过禁止发布 |
| 覆盖门禁 | ODD关键子域覆盖达标 | 补充用例后重测 |
| 稳定门禁 | 回归波动在阈值内 | 冻结版本排查 |
| 回退门禁 | 最小风险状态触发成功 | 强制整改 |

## 10.5 缺陷分级与回归机制

### 10.5.1 缺陷分级

- **S0 致命**：可能触发安全事故或联锁失效；
- **S1 严重**：导致关键功能不可用或结果失真；
- **S2 一般**：不影响核心安全，但影响效率或可用性；
- **S3 轻微**：界面、日志或非关键体验问题。

### 10.5.2 回归策略

每次策略或软件变更后，至少执行：
1. P0 全量回归；
2. 涉及模块的 P1 定向回归；
3. 随机抽样 P2 回归；
4. 关键指标漂移对比分析。

[图10-2: 缺陷闭环与回归流程]
{描述: 缺陷发现-定位-修复-复测-回归-发布闭环，包含S0/S1快速通道与版本冻结分支。}
{尺寸: 全页}
{颜色方案: 蓝色系}
{对应ARCH编号: ARCH-06}

## 10.6 例题：某策略版本发布前的在环验证计划

【例10-1】某调水系统计划发布新版本协同调度策略，需在两周内完成上线前验证。

**已知**：
- 新版本涉及 MAS 协同逻辑与回退策略优化；
- 现有测试平台支持 MIL/SIL/HIL 全流程；
- 运维要求“安全零妥协、收益可解释”。

**求解**：制定测试计划与发布门禁。

**解题过程**：

步骤1：识别变更点并映射风险清单。  
步骤2：构建P0/P1/P2用例矩阵，优先覆盖高风险ODD子域。  
步骤3：先执行 MIL 参数筛查，再执行 SIL 接口一致性验证。  
步骤4：在 HIL 中验证时延抖动、链路故障与联锁动作。  
步骤5：统计覆盖率、通过率、回退成功率并生成审计报告。  
步骤6：仅当门禁全部通过后才批准分级发布。

**结果讨论**：

发布决策应基于证据而非经验。若收益提升明显但安全门禁未达标，仍应阻断发布并回退至稳定版本。

### 在环测试章节上线检查清单

- [ ] 是否建立 MIL/SIL/HIL 一体化流程；
- [ ] 是否定义 P0/P1/P2 用例与缺陷分级；
- [ ] 是否完成 ODD 与高风险场景覆盖评估；
- [ ] 是否验证最小风险状态触发与回退链路；
- [ ] 是否形成可审计发布报告与回归基线。

## 10.7 本章小结

本章构建了在环测试与验证的系统方法：以 MIL/SIL/HIL 分层逼近真实运行，以覆盖度与门禁保障发布质量，以缺陷闭环与回归机制维持版本稳定。关键结论是：在环测试不是上线前的“附加项”，而是自主水网工程化的核心保障。下一章将进入水网信息安全，讨论控制系统在网络攻击与数据威胁下的韧性设计。

## 习题

### 基础题

1. MIL、SIL、HIL 三者的核心差异是什么？  
2. 为什么在环测试必须关注“风险覆盖率”而不只是“用例数量”？  
3. P0 用例与 S0 缺陷分别代表什么管理含义？

### 基础题参考答案要点

1. MIL验证模型与算法逻辑，SIL验证软件集成与接口时序，HIL验证真实硬件约束下的闭环行为。  
2. 因为同样数量的用例可能遗漏高风险场景；风险覆盖率用于衡量关键失效模式是否被验证。  
3. P0是必须全通过的关键安全用例等级；S0是必须立即阻断发布的致命缺陷等级。

> **术语一致性声明**：本章统一采用“在环测试（In-the-Loop Testing）”“运行设计域（Operational Design Domain, ODD）”“安全包络（Safety Envelope）”“最小风险状态（Minimum Risk State）”“多智能体系统（Multi-Agent System, MAS）”“水网操作系统（Water Network Operating System, HydroOS）”“SCADA+MAS Fusion Architecture”等规范术语，并与前序章节保持一致。

### 应用题

4. 为“泵站群协同控制升级”设计一套两周在环测试计划。  
5. 设计一个版本发布门禁看板（至少包含5项核心指标）。

### 思考题

6. 当测试周期受限时，如何平衡“覆盖深度”与“发布时效”？

## 拓展阅读

1. ISO/IEC/IEEE 29119 Software Testing Standards.  
2. Leveson, N. (2011). *Engineering a Safer World*.  
3. Myers, G. J. et al. (2011). *The Art of Software Testing*.  
4. Lei et al. (2025c). 在环测试系统。  
5. Van Overloop, P. J. (2006). *Model Predictive Control on Open Water Systems*.
