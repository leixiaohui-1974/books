<!-- 变更日志
v2 2026-02-16: 根据四角色评审修订——补充术语一致性声明与基础题答案要点，强化教学闭环
v1 2026-02-16: 初稿
-->

# 第十三章 数字孪生与仿真平台

---

## 学习目标

完成本章后，你应能够：

1. 理解数字孪生在水系统控制中的定位与边界；
2. 区分离线仿真、准实时仿真与在线孪生三类应用；
3. 说明 FMI/FMU 在模型封装与复用中的作用；
4. 设计“模型—数据—控制”闭环在线校正流程；
5. 建立孪生平台在验证、发布与运维中的工程规范。

> **章首衔接（承接ch12）**  
> 上一章给出了 HDC 的控制组织结构。本章进一步回答“如何验证并持续改进控制策略”：通过数字孪生与仿真平台，把设计、测试、运行和复盘连接成闭环。

> **前章回顾**：上一章介绍了本领域的核心概念与方法。本章在此基础上进一步展开。


## 数字孪生的定义与价值

[物理直觉] 水系统在真实世界运行成本高、风险高，不可能把所有策略直接在现场试错。数字孪生提供了“可重复、可回放、可注入故障”的实验场。

[工程解释] 数字孪生不是单一模型，而是“机理模型 + 数据驱动模型 + 运行数据 + 业务规则”的组合体，服务于预测、控制、诊断和培训。

## 三类仿真形态

[表13-1: 仿真形态对比]
| 形态 | 时间特性 | 主要用途 | 典型输出 |
|---|---|---|---|
| 离线仿真 | 非实时 | 方案设计、参数整定 | 可行性结论 |
| 准实时仿真 | 加速/近实时 | 回归测试、策略对比 | 性能评估报告 |
| 在线孪生 | 实时同步 | 运行监测、预测预警 | 风险告警与校正建议 |

[工程要点] 不同形态应共享同一术语体系与接口规范，避免“设计环境有效、生产环境失效”的割裂。

## FMI/FMU封装与模型互操作

FMI（Functional Mock-up Interface）用于跨工具模型交换，FMU（Functional Mock-up Unit）是可执行模型单元。

推荐封装流程：

1. 明确输入输出变量、采样时间、单位与坐标系；
2. 导出 FMU 并进行单元级一致性测试；
3. 在平台中进行多FMU耦合仿真；
4. 记录版本号、依赖库与校验哈希，保证可追溯。

[图13-1: 水系统数字孪生平台架构]
{描述: 左侧为数据接入层（SCADA、气象、设备日志），中间为模型层（机理模型、FMU、数据模型），右侧为应用层（MPC、FDI、运维可视化、在环测试）。}
{尺寸: 全页}
{颜色方案: 蓝色系}
{对应ARCH编号: ARCH-06（在环管线思想借鉴）}

## 在线校正与参数同化

设参数向量为 \(\boldsymbol{\theta}\)，在线校正可表示为：
\[
\boldsymbol{\theta}_{k+1}=\boldsymbol{\theta}_{k}+\eta\,\nabla_{\boldsymbol{\theta}}\mathcal{L}(\hat{\mathbf{y}}_k,\mathbf{y}_k)
\]

其中 \(\mathcal{L}\) 为预测误差损失函数，\(\eta\) 为学习率或更新步长。

[工程解释] 参数更新必须受安全约束与版本审计约束，不允许“边运行边无界改参”。建议采用“影子更新→并行评估→受控发布”三段式。

## 孪生平台与在环验证协同

数字孪生应接入 MIL/SIL/HIL 在环链路，形成统一验证闭环：

1. 需求变更后自动生成回归测试集；
2. 对控制器版本进行覆盖度评估；
3. 对关键故障场景进行注入与复现；
4. 生成发布门禁报告并归档。

[图13-2: 数字孪生驱动的发布门禁流程]
{描述: 展示“模型更新→回归仿真→在环验证→风险审查→灰度发布→运行监测”的闭环流程。}
{尺寸: 半页}
{颜色方案: 蓝色系}
{对应ARCH编号: ARCH-06}

## 例题：泵站效率曲线漂移下的在线校正

【例13-1】某泵站季节性运行后，实测能耗高于孪生预测 8%，需在不中断运行条件下完成模型校正。

**解题过程**：

步骤1：冻结控制策略主版本，启动影子孪生实例。  
步骤2：引入近期运行数据，对泵效率参数进行受约束更新。  
步骤3：在准实时回放场景比较“旧参数/新参数”预测误差。  
步骤4：通过门禁阈值后灰度发布新参数至在线孪生。  
步骤5：持续监测24小时，若异常则一键回滚旧版本。

**结果讨论**：

在线校正目标不是“误差最小化到极致”，而是“在安全与可追溯前提下稳定提升预测一致性”。

### 数字孪生上线检查清单

- [ ] 是否完成模型输入输出与单位字典统一；
- [ ] 是否建立FMU版本、依赖与哈希追踪机制；
- [ ] 是否具备影子运行、灰度发布与回滚能力；
- [ ] 是否覆盖关键故障注入与回归测试场景；
- [ ] 是否打通控制日志、仿真日志与审计日志。

## 本章小结

本章建立了数字孪生平台的工程主线：以 FMI/FMU 互操作为基础，以在线校正为核心，以在环验证和发布门禁保障可信上线。下一章将进入胶东调水工程案例，把前述建模、控制、估计与孪生框架落到大型明渠调水系统实践中。

## 习题

### 基础题

**13-1.** 数字孪生与普通离线仿真的核心差异是什么？  
**13-2.** FMI 与 FMU 分别解决什么问题？  
**13-3.** 为什么在线参数更新必须配套灰度发布与回滚机制？

### 基础题参考答案要点

**13-4.** 数字孪生强调与现场实时数据同步和在线闭环更新，离线仿真主要用于静态方案验证。  
**13-5.** FMI定义跨工具互操作接口标准，FMU是按该标准封装的可执行模型单元。  
**13-6.** 防止在线改参引发运行风险，确保参数变更可验证、可回滚、可审计。

### 应用题

**13-7.** 为某明渠调水系统设计一套“影子孪生+灰度发布”流程。  
**13-8.** 设计一个包含传感器缺测与通信延迟的孪生回归测试集。

### 思考题

**13-9.** 当“模型精度”与“平台实时性”冲突时，如何给出工程可接受折中？

## 拓展阅读

1. FMI Standard documentation (Modelica Association).
2. ASME V&V 40: Verification and Validation in Computational Modeling.
3. Litrico, X. & Fromion, V. *Modeling and Control of Hydrosystems*.
4. Rawlings, J.B. et al. *Model Predictive Control*.
5. Lei et al. (2025c). 水网在环测试系统。
