# 第2章 水网多智能体系统的形式化建模

## 学习目标

- 回顾第1章提出的MAS工程定义，并将其转化为可计算的数学模型。
- 掌握水网MAS的五元组描述：状态、动作、观测、通信拓扑、约束集。
- 理解“局部可观测—全局可协同”条件下的信息组织方法。
- 能够用统一符号写出智能体状态更新、协同优化目标与安全约束。
- 为第3章的共识机制与协商协议建立统一建模接口。

---

## 2.1 章节衔接：从“概念定义”走向“可计算表达”

第1章给出的核心结论是：水网多智能体系统（Multi-Agent System, MAS）不是把若干算法简单拼接，而是在运行设计域（Operational Design Domain, ODD）与安全包络（Safety Envelope）内，通过协议化协同实现全局目标一致性。这个结论在工程层面成立，但要进入可验证、可部署、可复现实验的阶段，必须回答三个问题：

1. “系统状态”到底由哪些变量构成？
2. “协同动作”如何在时空耦合的水力网络中传递？
3. “安全约束”如何从管理条款转化为机器可执行规则？

本章的任务，就是把上述问题统一到一个形式化框架中。读者可以将本章理解为：给后续算法章节搭建“坐标系”。没有坐标系，讨论性能改进会失去可比性；没有统一符号，跨团队协作会陷入语义歧义。

---

## 2.2 水网MAS的系统五元组

### 2.2.1 物理直觉

水网运行并不是静态图，而是“流量 $Q$ 与水位 $h$ 在网络中传播、延迟、耦合、反馈”的连续过程。任何智能体决策都不是在真空中发生：它改变局部执行量，再经过水力传输与通信延迟，最终影响其他节点观测。因此，建模必须同时包含“水力状态”和“协同状态”。

### 2.2.2 数学定义

定义水网MAS为五元组：

$$
\mathcal{M}=\langle \mathcal{X},\mathcal{U},\mathcal{Y},\mathcal{G},\mathcal{C} \rangle
$$

其中：

- $\mathcal{X}$：系统状态空间，含水力状态与运行逻辑状态；
- $\mathcal{U}$：控制输入空间，含闸门开度、泵站频率、机组出力指令等；
- $\mathcal{Y}$：观测空间，含监测量、估计量与告警量；
- $\mathcal{G}$：通信拓扑图，描述智能体间消息可达关系；
- $\mathcal{C}$：约束集合，含ODD、Safety Envelope及设备工艺约束。

### 2.2.3 工程解释

该五元组的价值在于把“业务语言”映射成“计算对象”：例如“闸门不可超速开闭”在模型中对应输入变化率约束；“下游生态流量不能低于下限”对应状态-输入联合不等式；“某站离线检修”对应拓扑图临时删边与可用动作子集收缩。

---

## 2.3 状态建模：从水力状态到协同状态

### 2.3.1 局部状态向量

对第 $i$ 个智能体，定义局部状态向量：

$$
\mathbf{x}_i(k)=\begin{bmatrix}
Q_i(k) & h_i(k) & \hat{d}_i(k) & m_i(k)
\end{bmatrix}^\top
$$

其中 $Q_i$ 为关键断面流量，$h_i$ 为关键控制水位，$\hat{d}_i$ 为扰动估计（如来水预测偏差），$m_i$ 为模式变量（如常态、汛限、应急）。

**物理直觉**：同一水位在不同模式下意义不同。比如 $h=32.1\,\mathrm{m}$ 在常态可接受，在汛限模式可能接近黄色预警边界。因此必须把“模式”并入状态，而不是作为注释。

### 2.3.2 全局状态拼接

将 $N$ 个智能体局部状态拼接为：

$$
\mathbf{x}(k)=\begin{bmatrix}
\mathbf{x}_1(k)^\top & \mathbf{x}_2(k)^\top & \cdots & \mathbf{x}_N(k)^\top
\end{bmatrix}^\top
$$

在离散时域下，系统可近似写为：

$$
\mathbf{x}(k+1)=\mathbf{A}\mathbf{x}(k)+\mathbf{B}\mathbf{u}(k)+\mathbf{E}\mathbf{w}(k)
$$

其中 $\mathbf{w}(k)$ 表示外部扰动（降雨、来水误差、负荷波动）。

**工程意义**：当 $\mathbf{A},\mathbf{B}$ 可在线更新时，可形成“模型—数据融合”的自适应协同基础；当仅有区间信息时，可在第6章引入鲁棒边界传播。

---

## 2.4 观测建模与部分可观测性

### 2.4.1 为什么“全观测”通常不现实

真实工程中，传感器故障、通信中断、采样异步非常常见。若算法隐含“所有状态都可实时准确获取”的假设，部署后往往退化。因此，本书采用“部分可观测”建模：智能体仅基于本地观测与邻域消息决策。

定义第 $i$ 个智能体观测：

$$
\mathbf{y}_i(k)=\mathbf{C}_i\mathbf{x}(k)+\mathbf{v}_i(k)
$$

其中 $\mathbf{v}_i(k)$ 为观测噪声与缺测误差。

### 2.4.2 状态估计接口

为后续章节统一接口，本章规定每个智能体包含状态估计器：

$$
\hat{\mathbf{x}}_i(k|k)=\mathcal{E}_i\big(\mathbf{y}_i(0\!:\!k),\ \mathcal{N}_i(0\!:\!k)\big)
$$

其中 $\mathcal{N}_i$ 表示来自邻居智能体的消息序列。

**工程解释**：这里不限定估计器必须是Kalman滤波，也可为粒子滤波或学习型估计器；关键是统一输入输出接口，保证不同技术栈可插拔。

---

## 2.5 通信拓扑与协同时序

### 2.5.1 拓扑图定义

定义通信拓扑 $\mathcal{G}=(\mathcal{V},\mathcal{E})$，其中：

- 节点集 $\mathcal{V}$ 对应智能体；
- 边集 $\mathcal{E}$ 对应可通信链路；
- 权重 $a_{ij}$ 表示链路可信度或协同权重。

邻接矩阵记为 $\mathbf{W}=[w_{ij}]$，满足 $w_{ij}\ge0$ 且 $\sum_j w_{ij}=1$。

### 2.5.2 延时与异步

水网协同中，延时不是异常而是常态。记消息延时为 $\tau_{ij}(k)$，则第 $i$ 个智能体在时刻 $k$ 接收到的邻居状态可写为：

$$
\tilde{\mathbf{x}}_j(k)=\hat{\mathbf{x}}_j\big(k-\tau_{ij}(k)\big)
$$

**工程意义**：这一定义使“延时鲁棒性”可量化。后续章节可通过设定 $\tau_{ij}(k)$ 的上界与分布，进行协议稳定性与性能退化测试。

[图2-1: 水网MAS通信-控制耦合拓扑]
{描述: 上层为智能体通信图（含主备链路与延时标注），下层为水力连接图（渠道/泵站/闸门）；中间用映射箭头连接，展示“物理邻近”与“通信邻近”不完全一致。}
{尺寸: 全页}
{颜色方案: 蓝色系}
{对应ARCH编号: ARCH-04}

---

## 2.6 约束建模：ODD与Safety Envelope的机器表达

### 2.6.1 ODD约束

ODD本质是运行有效域。可形式化为：

$$
\mathbf{z}(k)\in\Omega_{\text{ODD}}
$$

其中 $\mathbf{z}$ 由气象、水文、设备可用性、通信健康度等外生变量构成。若 $\mathbf{z}(k)\notin\Omega_{\text{ODD}}$，系统应触发降级或人工接管。

### 2.6.2 安全包络约束

对关键控制量设上下界：

$$
Q_{\min}\le Q(k)\le Q_{\max},\qquad h_{\min}\le h(k)\le h_{\max}
$$

进一步考虑执行器变化率：

$$
\Delta u_{\min}\le u(k)-u(k-1)\le\Delta u_{\max}
$$

**工程解释**：第一组不等式控制“状态是否越界”，第二组不等式控制“动作是否过激”。在闸门与机组控制中，忽略变化率限制会导致机械冲击与振荡。

### 2.6.3 最小风险状态触发规则

设触发函数：

$$
\phi(k)=\mathbb{I}\Big(\mathbf{z}(k)\notin\Omega_{\text{ODD}}\ \lor\ s(k)>s_{\text{th}}\Big)
$$

其中 $s(k)$ 为综合风险指数。若 $\phi(k)=1$，系统进入最小风险状态（Minimal Risk State），执行预定义安全策略集 $\Pi_{safe}$。

[表2-1: 典型约束到工程条款映射]

| 模型约束 | 工程语义 | 典型来源 |
|---|---|---|
| $Q\in[Q_{\min},Q_{\max}]$ | 下泄流量红线控制 | 防洪调度规程 |
| $h\in[h_{\min},h_{\max}]$ | 水位安全运行区间 | 水库运行细则 |
| $\Delta u$ 受限 | 闸门/机组动作速率限制 | 设备保护逻辑 |
| $\mathbf{z}\in\Omega_{\text{ODD}}$ | 场景有效域判定 | 运行设计文件 |
| $\phi=1\Rightarrow\Pi_{safe}$ | 最小风险状态切换 | 应急预案 |

---

## 2.7 协同目标函数与分解策略

### 2.7.1 全局目标

定义滚动时域 $T_p$ 上的全局代价：

$$
J=\sum_{k=0}^{T_p-1}\Big(\|\mathbf{x}(k)-\mathbf{x}_{ref}(k)\|_{\mathbf{Q}}^2+\|\mathbf{u}(k)\|_{\mathbf{R}}^2\Big)+\lambda\,\Psi(\mathcal{G},k)
$$

其中 $\Psi(\mathcal{G},k)$ 表示协同通信代价或一致性偏差惩罚。

### 2.7.2 分布式分解

工程上常把全局目标分解为局部子目标：

$$
J\approx\sum_{i=1}^{N} J_i + \sum_{(i,j)\in\mathcal{E}} J_{ij}^{\text{coord}}
$$

**物理直觉**：每个智能体只求“本地可控子问题”，再通过协调项补偿跨节点耦合影响。这样可显著降低在线计算压力，并提升系统扩展性。

---

## 2.8 例题：三节点协同建模与约束校核

【例2-1】考虑“上游库A—中间闸B—下游库C”三节点系统，采样周期为5分钟。设 $A$、$C$ 各配置1个优化智能体，$B$ 配置执行+监督复合智能体。需建立最小可运行模型并检验是否满足安全约束。

**已知**：
- 库A安全水位区间：$[30.0,31.5]$ m；当前 $h_A=31.3$ m；
- 库C安全水位区间：$[27.5,29.0]$ m；当前 $h_C=27.7$ m；
- 闸B下泄流量范围：$Q_B\in[80,360]$ m³/s；
- 闸B动作变化率限制：$|\Delta u_B|\le 6\%$/周期；
- 通信延时上界：$\tau_{AB},\tau_{BC}\le2$ 个采样周期。

**求解**：
1. 写出该系统的状态、输入、观测与约束集合；
2. 给出一次协同决策迭代中各智能体消息交换顺序；
3. 判断若建议指令使 $Q_B=390$ m³/s，系统应如何处理。

**解题过程**：

步骤1（状态与输入定义）
- 取状态 $\mathbf{x}=[h_A,h_C,Q_B]^\top$，输入 $u_B$ 为闸门开度指令。
- 观测向量 $\mathbf{y}=[h_A^{obs},h_C^{obs},Q_B^{obs}]^\top$。

步骤2（约束集合构建）
- 水位约束：$30.0\le h_A\le31.5$，$27.5\le h_C\le29.0$。
- 流量约束：$80\le Q_B\le360$。
- 动作约束：$|u_B(k)-u_B(k-1)|\le6\%$。

步骤3（协同时序）
- $t_k$：A/C优化智能体基于本地估计提交候选策略；
- $t_k+\delta$：B监督智能体做硬约束校核；
- $t_k+2\delta$：若冲突，返回可行域边界并触发二次协商；
- $t_k+3\delta$：执行智能体下发最终指令并记录审计日志。

步骤4（越界处理）
- 候选 $Q_B=390$ 超过上限360，属于硬约束违规；
- 监督智能体应拒绝下发并进行边界投影：$Q_B\leftarrow360$；
- 同时标记本轮“可行域触边事件”，供后续调参或告警。

**结果讨论**：
该例表明，形式化建模的核心收益不是“公式更漂亮”，而是让越限处理、协商回路与审计闭环具备统一执行逻辑。对于实际值守而言，这意味着在高压工况下依然可以保持决策纪律。

---

## 2.9 本章小结

本章完成了水网多智能体系统从概念到模型的关键跨越。首先，构建了 $\langle \mathcal{X},\mathcal{U},\mathcal{Y},\mathcal{G},\mathcal{C} \rangle$ 五元组，将状态、动作、观测、拓扑与约束纳入统一框架；其次，给出了局部状态、全局拼接、部分可观测与延时通信的标准表达，明确了“局部估计+邻域消息”的决策基础；再次，形式化描述了ODD与Safety Envelope约束，并引入最小风险状态触发规则，使工程规程可以直接映射到机器可执行逻辑；最后，通过三节点例题展示了“建模—协商—校核—执行”的闭环流程。下一章将在此基础上讨论一致性协议与协商机制，回答“如何在延时与异步条件下实现稳定协同”这一核心问题。

---

## 习题

### 一、基础题

1. 解释为何水网MAS至少需要“状态空间+通信拓扑+约束集合”三类对象，缺一会导致什么后果？
2. 写出你所在工程场景中一个“ODD变量”与一个“Safety Envelope变量”，并说明二者差异。
3. 说明“部分可观测”假设为何更符合实际部署条件。

### 二、应用题

4. 对某“四站两库”系统，尝试定义最小五元组 $\mathcal{M}$，并给出每个集合的工程含义。
5. 给定某闸门流量约束 $Q\in[100,420]$ m³/s、动作变化率 $|\Delta u|\le5\%$/周期，设计一个“监督智能体校核函数”的伪代码框架。

### 三、思考题

6. 在通信质量较差但水力耦合较强的系统中，应该优先投资通信基础设施，还是优先改进局部控制器鲁棒性？请给出你的权衡逻辑。

---

## 拓展阅读

1. Wooldridge, M. (2009). *An Introduction to MultiAgent Systems* (2nd ed.). Wiley.
2. Olfati-Saber, R., Fax, J. A., & Murray, R. M. (2007). Consensus and cooperation in networked multi-agent systems. *Proceedings of the IEEE*, 95(1), 215–233.
3. Camponogara, E., Jia, D., Krogh, B. H., & Talukdar, S. (2002). Distributed model predictive control. *IEEE Control Systems Magazine*, 22(1), 44–52.
4. Lei, X. (2025b). 自主智能水网架构. DOI: 10.13476/j.cnki.nsbdqk.2025.0079.
5. Lei, X. (2025c). 在环测试系统. DOI: 10.13476/j.cnki.nsbdqk.2025.0080.

---

**下一章预告**：第3章将重点讨论一致性协议、协商机制与收敛性条件，给出可直接用于SCADA+MAS Fusion Architecture的消息协议模板与冲突消解流程。
