# 第5章 复杂约束与冲突消解

## 学习目标

- 回顾第4章接口治理与异常分支，理解复杂约束为何成为协同控制的瓶颈。
- 掌握非凸可行域、优先级冲突与多目标权重漂移的工程表现形式。
- 能够构建“约束分层+冲突仲裁+在线重权重”三段式消解框架。
- 理解签名服务故障、通信抖动等复合异常下的应急旁路策略。
- 为第6章在环验证（In-the-Loop Testing）准备可测试的冲突场景模板。

---

## 5.1 章节衔接：从架构可用到策略可用

第4章解决了“系统能跑起来”的问题，本章解决“系统在矛盾目标下还能跑得稳”的问题。真实水网的协同失败通常不来自单一算法错误，而来自多约束叠加：防洪要快泄、供水要稳位、发电要高效、生态要保底，且各目标在时间上并不同步。因此，冲突消解不是附加模块，而是SCADA+MAS Fusion Architecture的核心能力。

---

## 5.2 复杂约束的三类来源

### 5.2.1 几何层：非凸可行域

当闸门组合动作、泵组启停逻辑、梯级联动边界共同作用时，可行域常呈非凸形态。此时“简单平均+线性投影”可能投影到伪可行区。

### 5.2.2 业务层：优先级冲突

防洪优先级在汛期可高于发电，但在枯水期可能反转；同一约束在不同运行设计域（ODD）下权重不同。

### 5.2.3 运行层：约束时变

通信质量、设备健康度、人工接管意愿会改变实时可行域边界，导致“上一周期可行、下一周期失效”。

[图5-1: 复杂约束叠加示意]
{描述: 以二维示意展示物理约束、业务约束、运行约束的交叠区，突出非凸可行域与动态边界漂移。}
{尺寸: 半页}
{颜色方案: 蓝色系}

---

## 5.3 冲突消解框架：分层、仲裁、重权重

### 5.3.1 约束分层

- **硬约束层**：Safety Envelope红线、设备保护、法定调度边界；
- **软约束层**：经济性、能耗、波动平滑、操作偏好；
- **偏好约束层**：班组经验规则、区域协同偏好。

处理原则：硬约束不可违反，软约束可惩罚，偏好约束可协商。

### 5.3.2 冲突仲裁

定义候选策略集 $\mathcal{U}_c$，先做硬约束过滤：

$$
\mathcal{U}_f=\{\mathbf{u}\in\mathcal{U}_c\mid g_h(\mathbf{u})\le0\}
$$

再在 $\mathcal{U}_f$ 内进行加权排序：

$$
J(\mathbf{u})=\sum_{m=1}^{M}\alpha_m(k)J_m(\mathbf{u}),\qquad \sum_m\alpha_m(k)=1
$$

其中 $\alpha_m(k)$ 为在线权重。

### 5.3.3 在线重权重

引入风险驱动权重更新：

$$
\alpha_m(k+1)=\frac{\alpha_m(k)\exp\{-\eta\,r_m(k)\}}{\sum_{l}\alpha_l(k)\exp\{-\eta\,r_l(k)\}}
$$

其中 $r_m(k)$ 为目标 $m$ 的风险贡献，$\eta$ 为学习率。

**工程解释**：该机制让系统在高风险场景自动提高安全相关目标权重，在平稳场景回归经济目标。

[表5-1: 约束冲突仲裁规则]

| 冲突类型 | 检测信号 | 仲裁规则 | 输出动作 |
|---|---|---|---|
| 防洪 vs 供水 | 水位逼近红线且供水缺额扩大 | 安全优先，供水次优补偿 | 限幅泄放+后续补偿计划 |
| 发电 vs 生态 | 出力需求升高且生态下限受压 | 生态硬约束保底 | 出力重调度 |
| 通信异常 vs 自动执行 | 丢包率超阈值 | 启用降级策略 | 保守动作或人工接管 |
| 签名服务故障 vs 指令下发 | `signature_invalid`持续 | 启用旁路白名单+双人复核 | 受限执行 |

---

## 5.4 签名服务故障的应急旁路策略

针对第4章评审提出的关键问题，本章补充“签名服务故障”旁路策略：

1. 触发条件：连续 $n_{sig}$ 次签名验证失败且诊断为签名服务故障（非攻击）；
2. 旁路机制：仅允许白名单动作集 $\Pi_{wl}$ 下发，并要求双人复核；
3. 时效限制：旁路窗口不超过 $T_{wl}$；
4. 退出条件：签名服务恢复且连续 $m$ 次校验通过。

该策略确保“安全可降级”，避免因单点安全组件故障导致全网失控或全网停控。

---

## 5.5 例题：非凸可行域下的三目标冲突消解

【例5-1】某梯级系统当前面临三目标冲突：
- 防洪目标：上游水位需在2小时内下降0.4 m；
- 供水目标：下游供水不得低于日计划的95%；
- 发电目标：机组总出力不低于基线的90%。

**已知**：
- 候选动作集经设备逻辑约束后形成非凸可行域；
- 当前风险评估显示防洪风险最高；
- 通信质量正常，但签名服务间歇抖动。

**求解**：给出一次分层仲裁与在线重权重后的可执行策略选择流程。

**解题过程**：
1. 先用硬约束过滤候选动作，剔除越过Safety Envelope方案；
2. 对剩余候选计算三目标代价 $J_{flood},J_{supply},J_{power}$；
3. 根据风险更新权重，提升防洪项 $\alpha_{flood}$；
4. 若签名服务抖动触发阈值，进入白名单旁路并启用双人复核；
5. 在可执行集合中选取综合代价最小方案并下发。

**结果讨论**：
该流程体现了“先可行、再最优”的工程逻辑。对于非凸可行域问题，硬约束过滤和旁路治理比追求全局最优更重要，因为它们直接决定系统是否安全连续运行。

---

## 5.6 本章小结

本章面向复杂约束场景，构建了“约束分层—冲突仲裁—在线重权重”的冲突消解框架。核心要点包括：第一，非凸可行域使得常规线性投影失效，必须先做硬约束过滤；第二，目标冲突应通过风险驱动权重动态调整，而非固定权重静态优化；第三，针对签名服务故障等复合异常，需要设置白名单旁路与双人复核机制，保证降级可控。通过例5-1，本章展示了在三目标冲突下的可执行策略生成流程。下一章将把这些策略放入SIM-SIL-HIL链路中，评估其鲁棒性、覆盖度与回归稳定性。

---

## 习题

### 一、基础题

1. 为什么非凸可行域会导致“平均一致+投影”方法失效？
2. 解释硬约束、软约束、偏好约束三者的处理优先级。
3. 说明在线重权重机制在高风险工况下的作用。

### 二、应用题

4. 给定三目标权重初值 $(0.4,0.35,0.25)$ 与风险向量 $(0.8,0.3,0.2)$，设 $\eta=0.5$，计算一次权重更新结果并解释含义。
5. 设计“签名服务故障旁路”流程图，至少包含触发、白名单执行、双人复核、退出四个环节。

### 三、思考题

6. 在跨流域联合调度中，若不同管理主体对“风险优先级”认知不一致，技术仲裁机制应如何与治理协商机制配合？

---

## 拓展阅读

1. Nedić, A., & Ozdaglar, A. (2009). Distributed subgradient methods for multi-agent optimization. *IEEE TAC*, 54(1), 48–61.
2. Boyd, S., Parikh, N., Chu, E., et al. (2011). Distributed optimization and statistical learning via ADMM. *Foundations and Trends in ML*.
3. Lei, X. (2025b). 自主智能水网架构. DOI: 10.13476/j.cnki.nsbdqk.2025.0079.
4. Lei, X. (2025c). 在环测试系统. DOI: 10.13476/j.cnki.nsbdqk.2025.0080.
5. Lei, X. (2025d). 水资源系统分析学科展望. DOI: 10.13476/j.cnki.nsbdqk.2025.0078.

---

**下一章预告**：第6章将进入SIM-SIL-HIL在环验证体系，重点讨论测试用例设计、覆盖度指标与回归测试流程。
