<!-- 变更日志
v1 2026-02-16: 初稿
-->

# ch02 HydroOS总体架构与组件划分

## 学习目标

完成本章后，读者应能够：

1. 描述 HydroOS 三层总体架构及其与 SCADA+MAS Fusion Architecture 的关系；
2. 识别核心组件（设备抽象、数据总线、调度引擎、门禁中心、审计中心）的职责边界；
3. 给出组件依赖矩阵与接口契约最小字段集合；
4. 理解运行设计域（Operational Design Domain, ODD）与安全包络（Safety Envelope）在架构层的落位方式；
5. 设计可扩展、可观测、可回退的组件化部署策略。

> 本章承接 ch01：在“为什么需要 HydroOS”之后，回答“HydroOS 到底由哪些组件组成、如何协同运行”。

> **前章回顾**：上一章介绍了本领域的核心概念与方法。本章在此基础上进一步展开。


## 架构设计原则

HydroOS 架构遵循四项原则：

1. **控制优先时序**：所有组件协同必须满足控制周期约束；
2. **安全先于最优**：门禁链路优先于优化链路；
3. **接口稳定演进**：先稳定契约，再演进实现；
4. **故障可降级可回放**：任何关键动作都可追溯。

[物理直觉] 水力系统中“先保堤再调度”，软件系统中对应“先保门禁再优化”。

[工程解释] 这四项原则决定了组件优先级：门禁与执行路径属于一级关键组件，不可与报表类组件同等对待。

## 三层总体架构

HydroOS 可划分为三层：

- **L0 设备抽象层（Device Abstraction Layer）**：统一设备模型与驱动适配；
- **L1 运行时服务层（Runtime Services Layer）**：提供数据总线、调度引擎、策略托管、门禁与审计；
- **L2 应用智能层（Application Intelligence Layer）**：承载 MPC、MAS、认知决策等业务应用。

[图2-1: HydroOS三层架构与关键组件]
{描述: 展示L0/L1/L2三层及组件之间调用链路，强调门禁中心位于执行路径关键节点。}
{尺寸: 全页}
{颜色方案: 蓝色系}
{对应ARCH编号: ARCH-03}

## 核心组件职责划分

### 2.4.1 设备抽象服务（DAS）

- 将 PLC/RTU/传感器/执行器映射为统一资源对象；
- 提供标准读写、状态订阅、健康诊断接口；
- 屏蔽厂商协议差异。

### 2.4.2 实时数据总线（RDB）

- 提供时序数据、事件流与状态快照；
- 支持多优先级通道：控制通道 > 告警通道 > 分析通道；
- 保证关键数据路径低时延与可追踪。

### 2.4.3 调度与策略引擎（SSE）

- 托管 MPC/MAS/规则策略服务；
- 执行策略编排、版本切换与灰度发布；
- 输出可执行控制意图并提交门禁中心。

### 2.4.4 门禁与联锁中心（GIC）

- 执行 ODD 匹配、包络校验、超时门禁、联锁触发；
- 拒绝不满足约束的策略动作；
- 触发降级、回滚与人工接管。

### 2.4.5 审计与回放中心（ARC）

- 记录“数据—决策—执行—反馈”全链路事件；
- 提供事件回放与责任追溯；
- 支撑复盘与合规检查。

[表2-1: HydroOS组件职责与SLA模板]
{描述: 列包括组件名称、关键职责、输入输出、SLA指标、故障降级动作、责任角色。}
{尺寸: 半页}
{颜色方案: 灰度}

## 组件依赖矩阵与接口契约

为了避免“隐式耦合”，建议显式维护组件依赖矩阵。示例如下：

- SSE 依赖 RDB（订阅状态）与 GIC（动作校验）；
- GIC 依赖 RDB（实时状态）与 DAS（执行可达性）；
- ARC 依赖全组件事件流进行审计归档。

接口契约应至少包含字段：

- `trace_id`：全链路追踪编号；
- `oddscope`：ODD 子域标识；
- `safety_level`：安全等级；
- `deadline_ms`：动作最晚生效时间；
- `fallback_policy`：失败回退策略编号。

[工程解释] 没有统一 `trace_id` 的系统，几乎无法完成有效复盘与责任定位。

## 架构级时序门禁

在组件化架构下，时序门禁可写为：

$$
\tau_{ingest}+\tau_{plan}+\tau_{gate}+\tau_{exec}\le T_c
$$

其中：

- $\tau_{ingest}$：数据接入与标准化时延；
- $\tau_{plan}$：策略规划时延；
- $\tau_{gate}$：门禁校验时延；
- $\tau_{exec}$：执行确认时延。

[物理直觉] 调度链路像接力，任何一棒超时都会让整条控制链失效。

[工程解释] 门禁校验不是“额外负担”，而是必须计入控制预算的核心环节。

## 可复现实例：组件故障下的降级路径

【例2-1】某次运行中，实时数据总线（RDB）出现抖动，导致策略引擎获取状态延迟增大，预测可能超出控制周期 $T_c$。

**已知**：

- 正常时：$\tau_{ingest}=120$ ms，$\tau_{plan}=280$ ms，$\tau_{gate}=90$ ms，$\tau_{exec}=160$ ms；
- 控制周期：$T_c=800$ ms；
- 异常时 $\tau_{ingest}$ 上升至 260 ms。

**求解**：判断是否超时，并设计降级动作。

**解题过程**：

1. 正常总时延：$120+280+90+160=650$ ms，满足门禁；
2. 异常总时延：$260+280+90+160=790$ ms，仍满足但裕量仅 10 ms；
3. 启动黄色告警：切换轻量策略、降低非关键通道采样频率；
4. 若连续3周期超过 800 ms，触发橙色告警并切换保底规则。

**结果讨论**：
通过组件级预算与分级降级机制，可将“局部故障”约束为“可控性能退化”，避免演化为系统性失控。

## 本章小结

本章给出了 HydroOS 的总体架构与组件边界：通过三层分工承载从设备接入到智能应用的全链路能力，通过依赖矩阵与接口契约控制系统复杂性，通过时序门禁将“可运行”转化为“可验证运行”。下一章将进入设备抽象层，详细讨论设备模型、驱动适配与协议统一。

## 习题

### 基础题

**2-1.** 为什么组件职责边界不清会放大运行风险？
**2-2.** GIC 与 SSE 在控制链路中分别承担什么角色？
**2-3.** 解释架构级时序门禁公式中四个时延项的工程含义。

### 应用题

**2-4.** 为某泵站群设计一份组件依赖矩阵，标注强依赖与可降级依赖。  
**2-5.** 设计一份接口契约最小字段模板，并说明每个字段用于哪个门禁环节。

### 思考题

**2-6.** 如果新增一个认知AI组件，如何在不破坏既有实时性门禁的前提下接入 HydroOS？

### 基础题参考答案要点

**2-7.** 会导致故障定位困难、责任不清和连锁失效。  
**2-8.** SSE负责策略生成与编排，GIC负责安全校验与放行/拒绝。  
**2-9.** 分别对应接入、规划、门禁、执行时延，总和不得超过控制周期。

## 拓展阅读

1. **Bass, L., Clements, P. & Kazman, R. (2021). *Software Architecture in Practice*.**
2. **Tanenbaum, A.S. & Bos, H. (2014). *Modern Operating Systems*.**
3. **Rawlings, J.B., Mayne, D.Q. & Diehl, M. (2017). *Model Predictive Control: Theory, Computation, and Design*.**
4. **Lei et al. (2025b). 自主智能水网架构。**
5. **Lei et al. (2025c). 在环测试系统。**
