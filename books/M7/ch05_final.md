<!-- 变更日志
v1 2026-02-16: 初稿
-->

# ch05 任务编排与调度引擎

## 5.1 学习目标

完成本章后，读者应能够：

1. 理解 HydroOS 任务编排与调度引擎（Scheduler & Orchestration Engine, SOE）的职责；
2. 设计面向控制任务、优化任务、审计任务的分级编排策略；
3. 建立任务 SLA（Service Level Agreement）与超时降级机制；
4. 给出多任务冲突仲裁规则与优先级治理流程；
5. 构建可追溯的任务生命周期管理与复盘闭环。

> 本章承接 ch04：在实时数据总线稳定运行后，需要把“数据可达”进一步转化为“任务可执行、可协调、可回退”。

## 5.2 为什么需要统一任务编排

在水网运行中，控制优化、告警处理、审计归档、模型更新会并发发生。若各任务独立调度，常见问题包括：

- 高优任务被低优批处理挤占资源；
- 冲突任务同时下发相反控制意图；
- 失败重试无统一策略导致雪崩。

[物理直觉] 一条河道的行洪、供水、生态下泄必须统一调度，软件任务也必须统一调度。

[工程解释] SOE 的目标不是“把任务排满”，而是保证关键任务准时、冲突可解、失败可控。

## 5.3 任务模型与生命周期

建议统一任务模型字段：

- `task_id`、`trace_id`、`task_type`；
- `priority`、`deadline_ms`、`oddscope`；
- `resource_quota`（CPU/内存/带宽）；
- `retry_policy`、`fallback_policy`；
- `state`（Created/Queued/Running/Succeeded/Failed/RolledBack）。

任务生命周期建议：

1. 创建（Create）；
2. 准入校验（Admit）；
3. 调度执行（Dispatch & Run）；
4. 结果确认（Commit）；
5. 失败回退（Rollback）；
6. 审计归档（Archive）。

[表5-1: SOE任务模型与生命周期门禁]
{描述: 列包括阶段、输入条件、门禁规则、失败动作、审计字段。}
{尺寸: 半页}
{颜色方案: 灰度}

## 5.4 任务SLA分级（补齐ch04遗留项）

为补齐 ch04 跟踪项，本章给出任务 SLA 分级模板：

- **SLA-A（关键控制）**：P95 完成时延 ≤ 500 ms，失败自动降级并告警；
- **SLA-B（运行优化）**：P95 完成时延 ≤ 2 s，允许有限重试；
- **SLA-C（分析与报表）**：分钟级完成，允许排队延后。

建议默认映射：

- 控制命令任务 → SLA-A；
- MPC 求解任务 → SLA-B；
- 报表/训练任务 → SLA-C。

[工程解释] SLA 应与 ODD 场景联动：汛期可临时收紧 SLA-A 阈值，压缩非关键任务配额。

## 5.5 调度冲突仲裁策略（补齐ch04遗留项）

常见冲突类型：

1. **资源冲突**：多任务争用同一执行资源；
2. **目标冲突**：两个任务输出相反控制意图；
3. **时序冲突**：高优任务被低优任务阻塞。

推荐仲裁顺序：

1. 安全优先（Safety First）；
2. ODD 适配优先；
3. SLA 等级优先；
4. 新鲜度优先（最新状态任务优先）。

仲裁决策可表示为：

$$
Score = w_s S_{safety}+w_o S_{odd}+w_l S_{sla}+w_f S_{fresh}
$$

取分值最高任务先执行，冲突任务进入等待或降级队列。

[工程解释] 分值模型需可解释，禁止“黑箱抢占”导致审计不可追踪。


[图5-1: 任务编排与冲突仲裁流程图]
{描述: 展示任务创建、准入、仲裁、执行、回退、审计归档的完整流程及关键门禁节点。}
{尺寸: 全页}
{颜色方案: 蓝色系}

## 5.6 调度时序预算

SOE 运行时预算建议：

$$
\tau_{admit}+\tau_{schedule}+\tau_{run}+\tau_{commit}\le T_c
$$

其中：

- $\tau_{admit}$：准入校验；
- $\tau_{schedule}$：排队与仲裁；
- $\tau_{run}$：任务执行；
- $\tau_{commit}$：结果确认与发布。

[物理直觉] 就算任务本身执行很快，若准入和仲裁过慢，整体依然超时。

## 5.7 可复现实例：多任务并发冲突处置

【例5-1】某站点在洪峰期间并发出现三类任务：

- T1：联锁安全任务（SLA-A）；
- T2：经济型 MPC 优化任务（SLA-B）；
- T3：日报生成任务（SLA-C）。

**已知**：

- 当前 CPU 资源仅支持两任务并行；
- T1 与 T2 对同一闸门目标有冲突；
- 控制周期 $T_c=1$ s。

**求解**：给出调度与仲裁策略。

**解题过程**：

1. 先执行 T1（安全优先 + SLA-A）；
2. T2 进入仲裁，若与 T1 冲突则降级为保守参数组；
3. T3 延迟执行并转入低优先队列；
4. 记录仲裁分值与最终决策，写入审计中心。

**结果讨论**：
该策略保证关键安全动作准时执行，同时维持优化任务最小可行运行。

## 5.8 本章小结

本章建立了 HydroOS 任务编排中枢：通过统一任务模型、SLA 分级、冲突仲裁与时序预算，把“并发任务”转化为“可治理任务流”。SOE 使系统在复杂工况下仍保持可解释、可追溯与可降级执行。下一章将进入控制与优化服务托管，讨论算法服务如何在 SOE 上稳定运行。

## 习题

### 基础题

1. 为什么任务编排必须与 ODD 和安全门禁联动？
2. SLA-A 与 SLA-C 的本质差异是什么？
3. 解释调度时序预算公式中四项时延含义。

### 应用题

4. 为某泵站群设计一份任务分级清单，包含任务类型、SLA等级、失败回退策略。  
5. 设计一个冲突仲裁评分表，给出权重设置依据与审批流程。

### 思考题

6. 当经济优化任务长期被安全任务压制时，你如何在不破坏安全底线前提下改进调度策略？

### 基础题参考答案要点

1. 因任务是否可执行取决于运行场景与安全约束，必须联动校验。  
2. SLA-A面向关键控制低时延高可靠，SLA-C面向非关键任务可延后。  
3. 分别是准入、仲裁、执行、提交时延，总和受控制周期约束。

## 拓展阅读

1. Burns, B. et al. (2022). *Kubernetes: Up and Running*.  
2. Kleppmann, M. (2017). *Designing Data-Intensive Applications*.  
3. Hohpe, G. & Woolf, B. (2003). *Enterprise Integration Patterns*.  
4. Lei et al. (2025b). 自主智能水网架构。  
5. Lei et al. (2025c). 在环测试系统。

> **术语一致性声明**：本章统一采用“水网操作系统（Water Network Operating System, HydroOS）”“运行设计域（Operational Design Domain, ODD）”“安全包络（Safety Envelope）”“模型预测控制（Model Predictive Control, MPC）”“在环测试（In-the-Loop Testing）”等规范术语；数学符号采用 $Q,h,\tau,T_p,T_c,\mathbf{x},\mathbf{u},\mathbf{y},J$。

### 质量检查清单（执行结果）

- [x] 章首学习目标、章末小结/习题/拓展阅读完整；
- [x] 基础题3 + 应用题2 + 思考题1，含基础题答案要点；
- [x] 公式前有物理直觉，公式后有工程解释；
- [x] 含可复现实例（例5-1）；
- [x] 图表不少于2项（图5-1、表5-1）；
- [x] 章首回顾ch04，章末预告ch06。
