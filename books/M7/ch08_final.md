<!-- 变更日志
v1 2026-02-16: 初稿（基于“继续”命令自动续写）
-->

# ch08 在环测试与发布流水线

## 8.1 学习目标

完成本章后，读者应能够：

1. 说明 HydroOS 在环测试（In-the-Loop Testing）与持续交付（CI/CD）的一体化关系；
2. 设计覆盖 SIM-SIL-HIL 的分层测试关卡，并定义放行门槛；
3. 构建“门禁结果—发布流水线—工单系统”字段映射，形成可审计交付链；
4. 制定灰度发布、回滚与紧急越权放行的补偿性审计模板；
5. 通过量化指标评估发布稳定性与工程风险。

> 承接 ch07：上一章回答“谁能执行、如何问责”；本章进一步回答“如何在上线前验证、上线中控险、上线后可追溯”。

## 8.2 从门禁到交付：为什么必须一体化

在水网操作系统中，控制算法上线不是“代码发布”问题，而是“运行安全”问题。若门禁与发布流水线解耦，常见后果包括：

- 审批通过的规则版本未真正部署；
- 已部署算法绕过 ODD 与 Safety Envelope 校验；
- 现场异常后无法快速定位“谁在何时上线了什么”。

因此建议采用统一链路：**变更申请 → 在环测试 → 门禁校验 → 灰度发布 → 运行观测 → 闭环归档**。

[图8-1: HydroOS在环测试与发布流水线总览]
{描述: 展示从需求工单、模型构建、SIM/SIL/HIL测试、门禁审批、灰度发布、运行监控到复盘归档的端到端流程，标注每个阶段输入输出与责任角色。}
{尺寸: 全页}
{颜色方案: 蓝色系}
{对应ARCH编号: ARCH-06}

## 8.3 分层在环测试关卡设计

HydroOS 推荐三层测试关卡：

1. **SIM（Model-in-the-Loop）**：在数字孪生中验证控制逻辑正确性；
2. **SIL（Software-in-the-Loop）**：在近真实软件栈验证时序、接口与容错；
3. **HIL（Hardware-in-the-Loop）**：在真实控制器与仿真对象耦合下验证联锁与执行稳定性。

[物理直觉] 水工控制就像“先纸面推演、再台架联调、最后实装带载”。测试层级越靠后，发现问题成本越高，因此必须把问题前移。

建议每层至少定义“通过/阻断”两类标准：

- SIM：目标函数 $J$ 相对基线改善、约束违例次数、极端工况稳定性；
- SIL：接口超时率、消息重放正确率、容器重启后恢复时间；
- HIL：闭环振荡幅值、联锁触发准确率、设备保护动作一致性。

[表8-1: SIM-SIL-HIL测试关卡与放行门槛]
{描述: 列包括测试层、关键指标、阈值、触发阻断条件、责任人、可豁免条件。}
{尺寸: 半页}
{颜色方案: 灰度}

## 8.4 流水线门禁公式与时序预算

为避免“测试通过但上线超时”或“上线成功但风险未控”，可定义发布门禁预算：

$$
\tau_{sim}+\tau_{sil}+\tau_{hil}+\tau_{approve}+\tau_{deploy} \le \tau_{release}^{budget}
$$

其中：

- $\tau_{sim},\tau_{sil},\tau_{hil}$ 分别为三层测试耗时；
- $\tau_{approve}$ 为门禁审批与签核耗时；
- $\tau_{deploy}$ 为发布执行耗时。

[工程解释] 当总时长超过预算时，应优先优化测试自动化与审批串并行结构，而不是压缩 HIL 关键测试项。

对关键站点建议：常规发布 $\tau_{release}^{budget}\le 4$ h，紧急补丁发布 $\le 1$ h（需触发补偿性审计）。

## 8.5 工单字段映射与审计闭环（补齐ch07遗留项）

为补齐 ch07/ch06 遗留项，本节给出标准字段映射模板。核心思想是：**每一次发布都可追溯到门禁决策与测试证据**。

### 8.5.1 门禁结果与流水线字段映射

最小字段集建议如下：

- 门禁侧：`gate_version`、`gate_result`、`risk_level`、`approver_chain`；
- 流水线侧：`pipeline_id`、`build_sha`、`artifact_digest`、`deploy_env`；
- 工单侧：`ticket_id`、`change_type`、`rollback_plan_id`、`post_review_id`。

映射规则示例：

- `gate_version` ↔ `ticket.change_policy_version`；
- `pipeline_id` ↔ `ticket.execution_ref`；
- `risk_level=red` 时强制 `deploy_env=staging`，禁止直达生产。

### 8.5.2 审计报表模板编号

建议统一模板编号（补齐 ch05/ch06 跟踪项）：

- `AUD-RPT-08-01`：发布门禁放行报告；
- `AUD-RPT-08-02`：灰度观察期稳定性报告；
- `AUD-RPT-08-03`：回滚与根因复盘报告；
- `AUD-RPT-08-04`：紧急越权放行补偿性审计报告。

## 8.6 灰度发布与回滚策略

灰度发布推荐三阶段：

1. **影子运行（Shadow）**：新策略只计算不执行，比较建议动作差异；
2. **小流量执行（Canary）**：选取低风险渠段/机组执行，设置严格门槛；
3. **全量放开（Full）**：观测窗口稳定后逐步扩大范围。

关键回滚触发条件示例：

- 连续两个观测窗口内，约束违例次数高于基线 1.5 倍；
- 联锁触发频率异常升高且无法用外部工况解释；
- 关键指标（如流量偏差、调度延迟）越过红线阈值。

[图8-2: 灰度发布-回滚状态机]
{描述: 状态包含Shadow、Canary、Full、Rollback；标注进入条件、退出条件与强制回退触发器。}
{尺寸: 半页}
{颜色方案: 蓝色系}

## 8.7 紧急越权放行与补偿性审计（补齐ch07遗留项）

在洪峰突发、通信受损等极端工况下，可允许“紧急越权放行”，但必须满足：

- 仅限预定义角色触发；
- 有效期短（如 30 min）；
- 自动生成 `AUD-RPT-08-04`；
- 24 h 内完成补偿性复盘会签。

补偿性审计模板最小字段：

- 越权原因与环境证据（雨情、水情、设备状态）；
- 被绕过规则列表与风险评估；
- 临时控制动作、持续时间、影响范围；
- 恢复常态门禁的时间戳与确认人。

[工程解释] 越权不是“免责通道”，而是“先稳态、后问责”的受控机制。

## 8.8 可复现实例：一次灰度发布的阻断与回滚

【例8-1】某调水片区上线新的模型预测控制（MPC）参数组，在 SIL 与 HIL 通过后进入 Canary 阶段。上线 20 min 后，观测到告警量升高。

**已知**：

- 基线黄色告警：10 次/h；
- Canary 实测黄色告警：19 次/h；
- 约束违例次数：基线 2 次/h，当前 5 次/h；
- 门禁规则：告警倍率 > 1.8 或违例倍率 > 2.0 触发回滚。

**求解**：判断是否回滚，并生成最小审计动作序列。

**解题过程**：

1. 告警倍率 $=19/10=1.9>1.8$，满足回滚触发条件；
2. 违例倍率 $=5/2=2.5>2.0$，再次满足触发条件；
3. 执行自动回滚到上一稳定版本，并冻结全量发布；
4. 生成 `AUD-RPT-08-03` 与 `AUD-RPT-08-04`（若存在越权动作）并提交复盘。

**结果讨论**：
双阈值触发避免了“指标轻微波动”与“真正失稳”混淆，回滚决策可解释、可复核。

## 8.9 本章小结

本章围绕 HydroOS 交付链路，建立了从 SIM-SIL-HIL 在环验证到灰度发布、回滚处置、补偿性审计的完整工程流程。核心不在“发布速度”，而在“验证充分、放行可控、异常可追溯”。下一章将进入 HydroOS API 与应用生态，讨论如何对外提供稳定、可扩展的能力接口。

## 习题

### 基础题

1. 说明 SIM、SIL、HIL 三层测试在目标与风险控制上的差异。  
2. 解释发布预算公式中 $\tau_{approve}$ 与 $\tau_{deploy}$ 的工程含义。  
3. 为什么 `risk_level=red` 不应直接进入生产环境？

### 应用题

4. 设计一套水电站机组控制策略发布的 Canary 门槛，至少包含 3 个量化指标与回滚条件。  
5. 给出“门禁—流水线—工单”字段映射表，满足审计追溯最小要求。

### 思考题

6. 当极端洪水来临且通信链路不稳定时，你会如何平衡“紧急越权放行”的必要性与“事后问责”的完整性？

### 基础题参考答案要点

1. SIM重模型逻辑，SIL重软件时序与接口，HIL重真实执行与联锁稳定性。  
2. 前者是治理流程耗时，后者是技术执行耗时，二者共同决定发布周期。  
3. 因 red 表示高风险状态，需先在隔离环境验证并追加审批。

## 拓展阅读

1. Lei et al. (2025c). 在环测试系统。  
2. ISO 23247 (Digital Twin Framework for Manufacturing，方法可借鉴于工业系统测试分层)。  
3. Google SRE Workbook (Chapter on Canarying and Rollbacks).  
4. Litrico, X. & Fromion, V. (2009). *Modeling and Control of Hydrosystems*.  
5. NIST SP 800-53 Rev.5 (Change Management & Audit Controls).

> **术语一致性声明**：本章统一采用“在环测试（In-the-Loop Testing）”“运行设计域（Operational Design Domain, ODD）”“安全包络（Safety Envelope）”“分层分布式控制（Hierarchical Distributed Control, HDC）”“水网操作系统（Water Network Operating System, HydroOS）”“模型预测控制（Model Predictive Control, MPC）”等规范术语；数学符号采用 $Q,h,\tau,T_p,T_c,\mathbf{x},\mathbf{u},\mathbf{y},J$。

### 质量检查清单（执行结果）

- [x] 章首学习目标、章末小结/习题/拓展阅读完整；
- [x] 基础题3 + 应用题2 + 思考题1，含基础题答案要点；
- [x] 公式前有物理直觉，公式后有工程解释；
- [x] 含可复现实例（例8-1）；
- [x] 图表不少于2项（图8-1、图8-2、表8-1）；
- [x] 章首回顾ch07，章末预告ch09；
- [x] 已补齐ch05/ch06/ch07对ch08的跟踪项（报表模板、字段映射、越权审计模板）。
