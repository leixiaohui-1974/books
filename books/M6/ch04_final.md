<!-- 变更日志
v1 2026-02-19: 初稿
-->

# 第四章 MIL：模型在环测试

## 学习目标

1. 掌握MIL测试的标准架构与工作流程，理解MIL在三级在环验证体系中的"首道关卡"角色；
2. 理解控制算法MIL验证的核心方法——阶跃响应测试、设定点跟踪、扰动抑制和多变量耦合测试——并能为具体工程设计MIL测试方案；
3. 掌握参数敏感性分析的OAT与全局方法（Sobol/Morris），能够识别控制系统的关键参数及其影响路径；
4. 掌握蒙特卡洛场景扫描的设计方法，能够构建覆盖ODD边界的场景矩阵并进行批量MIL测试；
5. 理解加速仿真与批量测试的工程实现方法，掌握MIL测试报告的规范化编写要求。

> **前章回顾**：第三章解决了仿真环境中最核心的技术问题——水力学模型的封装与接口标准化。从Saint-Venant全模型到IDZ/Muskingum降阶模型，从FMU封装到SCADA数据接口，从多模型耦合编排到参数在线同化，我们已经建立了一套完整的模型组件工具箱。本章将以这些模型组件为基础，系统阐述MIL（Model-in-the-Loop）测试的方法论和工程实践——如何用纯软件环境中的模型闭环测试，在控制算法真正接入硬件之前，尽可能早地发现和修正设计缺陷。

---

## MIL测试的定位与价值

### 4.1.1 三级验证中的"第一道关卡"

在CHS在环验证体系中，MIL是成本最低、速度最快、修改最容易的验证阶段。一个直观的类比：如果HIL测试是建筑竣工后的消防验收，SIL测试是施工过程中的隐蔽工程检查，那么MIL测试就是图纸阶段的结构计算复核——发现问题的成本随阶段指数增长，而MIL恰恰是成本最低的纠错窗口。

**表4-1 三级在环测试的成本-效益对比**

| 维度 | MIL | SIL | HIL |
|------|-----|-----|-----|
| 测试对象 | 控制算法模型 | 嵌入式软件 | 实际硬件+软件 |
| 仿真环境 | 纯数学模型 | 软件仿真+协议仿真 | 实时仿真器+物理接口 |
| 单次测试成本 | ￥0.01-0.1（计算资源） | ￥1-10（服务器+许可证） | ￥100-1000（设备+人员） |
| 单次测试时间 | 秒-分钟（可超实时） | 分钟-小时（近实时） | 小时-天（严格实时） |
| 场景覆盖能力 | 极高（可扫描万级场景） | 中等（百级场景） | 有限（十-百级场景） |
| 可发现的缺陷类型 | 算法逻辑、参数设置、稳定性 | 软件集成、接口协议、时序 | 硬件兼容性、信号质量、时延 |
| 修改周期 | 分钟-小时 | 小时-天 | 天-周 |

工程实践中的统计数据支持这一分级。在胶东调水MIL/SIL/HIL全流程验证中，MIL阶段发现的缺陷占全部缺陷的约58%，SIL阶段发现约28%，HIL阶段发现约14%（Lei, 2025c）。换言之，超过一半的问题在最廉价的阶段就被捕获和修复。

### 4.1.2 MIL能发现什么，不能发现什么

明确MIL的能力边界是正确使用它的前提。

**MIL能够发现的典型缺陷**包括：控制算法本身的逻辑错误（如PI参数整定不当导致振荡）、多变量耦合导致的意外交互（如上游闸门调整引发下游水位超限）、极端工况下的算法失效（如冰期低流速时控制器饱和）、参数敏感性问题（如Manning糙率变化导致控制性能显著恶化）、优化目标冲突（如节能与水位稳定的权衡失调）。

**MIL无法发现的缺陷**包括：软件实现中的编码错误（MIL直接使用算法模型，不涉及具体软件编码）、通信延迟与丢包效应（MIL假设理想通信）、硬件响应特性（如闸门执行器的死区、滞后和非线性）、采样与量化效应（MIL使用连续或高精度离散信号）、实际传感器的噪声和故障模式。

这些边界决定了MIL不能替代SIL和HIL，但也说明了MIL作为"首道过滤器"的不可替代性——在将控制算法推入更昂贵的测试阶段之前，确保其在"理想条件下"的正确性和鲁棒性。

### 4.1.3 MIL与传统"离线仿真"的区别

水利行业长期使用离线仿真来评估控制方案，MIL与之有本质区别。传统离线仿真通常是"开环"的——给定一组输入序列，运行水力学模型，观察输出。MIL则强调"闭环"——控制算法根据被控对象模型的输出实时调整控制输入，形成反馈环路。

闭环测试能够暴露开环测试隐藏的问题。一个典型的例子：某PI控制器在开环阶跃响应分析中表现为稳定，但当闭环连接实际水力学模型时，由于模型中包含的延时和非线性特性，系统出现了持续振荡。这种振荡只有在控制器与被控对象形成反馈回路时才会出现。

---

## MIL测试架构

### 4.2.1 标准MIL架构

MIL测试的标准架构由四个核心组件构成：被控对象模型（Plant Model）、控制算法模型（Controller Model）、测试引擎（Test Engine）和评估模块（Assessment Module）。

**被控对象模型**即第三章封装的水力学模型组件。在MIL测试中，它充当"虚拟水网"的角色——接收控制指令（闸门开度、泵站功率等），计算水力学响应（水位、流量等），向控制算法提供"虚拟传感器"读数。被控对象模型的可信度直接决定MIL测试结论的可靠性，这也是为什么第三章强调模型校验的ABC等级分类。

**控制算法模型**是被测试的对象。在MIL阶段，控制算法通常以数学模型或高级语言脚本的形式存在——例如MATLAB/Simulink模型、Python实现或伪代码级的逻辑描述。与SIL阶段的嵌入式代码不同，MIL中的控制算法不需要考虑实时性、内存限制和硬件接口等工程约束。

**测试引擎**负责整个MIL测试的编排和执行。它的核心功能包括：场景加载（从场景库中读取测试场景定义）、仿真控制（启动/暂停/停止仿真，设置仿真参数）、数据采集（以指定频率采集所有信号）、时钟管理（在加速仿真中维护虚拟时钟）。

**评估模块**对测试结果进行自动化评判。它根据预定义的通过/失败准则（Pass/Fail Criteria）对每个测试用例的结果做出裁决。典型的评估指标包括：稳态误差是否在允许范围内、超调量是否超过限值、调节时间是否满足要求、安全约束是否被违反。

【例4-1】某调水渠道系统采用PI控制器维持下游水位稳定。设计MIL测试来验证该控制器在流量阶跃扰动下的性能。

[已知] 渠段长度L=15km，设计流量Q₀=30 m³/s，PI控制器参数K_p=0.5, T_i=600s，控制目标：下游水位h_ref=3.2m。MIL通过准则：超调量≤0.15m，调节时间≤1800s，稳态误差≤0.02m。

[MIL架构配置]
- 被控对象模型：该渠段的IDZ降阶模型（A_d=12.5 m², τ_d=450s，已通过B级校验）
- 控制算法模型：离散PI控制器，采样周期T_s=60s
- 测试引擎：加速仿真（100×实时），场景定义：上游流量在t=0时从30 m³/s阶跃至35 m³/s
- 评估模块：自动计算超调量、调节时间、稳态误差，与通过准则对比

[测试执行] 仿真总时长7200s（虚拟时间2小时），加速比100×，实际计算时间约72秒。PI控制器根据水位偏差e(k)=h_ref-h(k)计算闸门开度调整量：

$$\Delta u(k) = K_p \left[ e(k) - e(k-1) + \frac{T_s}{T_i} e(k) \right]$$

[测试结果] 下游水位从3.20m最高升至3.32m（超调量0.12m＜0.15m ✓），经过约1500s恢复至3.21m（调节时间1500s＜1800s ✓），稳态误差0.01m＜0.02m ✓。MIL判定：**PASS**。

[结果讨论] 该测试用例的结论是控制器在标称条件下的阶跃响应满足设计要求。但MIL通过并不意味着工作结束——还需要测试更多场景（不同幅度的扰动、冰期工况、传感器延迟等），这正是后续各节讨论的内容。

### 4.2.2 MIL测试工作流程

一个完整的MIL测试项目遵循以下标准化流程：

**阶段一：准备**。确认被控对象模型已通过校验（至少B级可信度）；确认控制算法模型与设计文档一致；定义测试范围（本轮MIL覆盖的功能列表）；编制测试计划（场景、准则、排期）。

**阶段二：基准测试**。执行标称工况下的基础功能测试——阶跃响应、设定点跟踪、扰动抑制等。目的是在"最友好"的条件下确认控制算法的基本正确性。如果基准测试不通过，后续的鲁棒性测试和场景扫描没有意义。

**阶段三：参数敏感性分析**。系统性地扰动模型参数和控制器参数，评估控制性能对参数变化的敏感程度。识别出"关键参数"——性能对其微小变化特别敏感的参数——为参数标定和鲁棒性设计提供依据。

**阶段四：场景扫描**。利用加速仿真能力，批量执行大量测试场景。场景涵盖ODD定义的各种工况组合——不同来水量、不同季节、不同设备状态、不同故障模式。目的是在参数空间和工况空间中系统性地搜索控制算法的"薄弱区域"。

**阶段五：评估与报告**。汇总所有测试结果，生成标准化的MIL测试报告。对失败用例进行根因分析，提出修改建议。决策：控制算法是否可以进入SIL阶段。

---

## 控制算法MIL验证

### 4.3.1 阶跃响应测试

阶跃响应测试是最基础的MIL测试类型，通过向系统施加阶跃扰动并观察响应，评估控制系统的基本动态特性。

水利控制系统中的阶跃扰动有两类：**设定点阶跃**（控制目标突然变化，如下游水位目标从3.2m调整至3.5m）和**负载阶跃**（外部扰动突然变化，如上游来水量突增或下游取水量突变）。两类阶跃测试评估的控制特性不同。

阶跃响应测试的标准评估指标包括：

- **超调量**（Overshoot）：$M_p = (y_{max} - y_{ss})/y_{ss} \times 100\%$。对于水利系统，超调量直接关系到安全——水位超调可能导致漫溢或结构损坏。
- **调节时间**（Settling Time）：输出进入并保持在稳态值±δ范围内的时间。水利系统的调节时间通常在分钟至小时量级，远长于电力和机械系统。
- **稳态误差**（Steady-State Error）：$e_{ss} = |y_{ss} - y_{ref}|$。PI控制器理论上可消除阶跃扰动的稳态误差，但实际中由于约束饱和等因素可能存在残余偏差。
- **上升时间**（Rise Time）：输出从稳态值10%上升到90%所需的时间。反映控制系统的响应速度。

对于多渠段串联系统，阶跃响应测试还需关注**扰动传播特性**——上游的阶跃扰动如何沿渠道向下游传播，各节制闸的控制器是否能协同抑制扰动。

### 4.3.2 设定点跟踪测试

设定点跟踪测试评估控制系统跟踪时变目标的能力。与阶跃响应测试的恒定目标不同，设定点跟踪测试使用随时间变化的参考轨迹。

水利系统中典型的设定点跟踪场景包括：调水计划变更（24小时内分时段调整输水流量）、潮汐河口水位调节（跟踪预测潮位曲线）、梯级水库协调调度（跟踪优化器给出的时变放水曲线）。

设定点跟踪的MIL评估指标增加了：

- **跟踪误差积分**（IAE/ISE/ITAE）：衡量整个跟踪过程的累积误差。IAE = $\int_0^T |e(t)| dt$ 对持续偏差敏感，ISE = $\int_0^T e^2(t) dt$ 对大偏差敏感，ITAE = $\int_0^T t|e(t)| dt$ 对后期偏差更敏感。
- **最大瞬时偏差**：跟踪过程中出现的最大绝对误差，关系到安全约束是否被触犯。

**表4-2 水利控制系统MIL阶跃响应典型指标范围**

| 系统类型 | 超调量上限 | 调节时间上限 | 稳态误差上限 | 说明 |
|---------|----------|------------|------------|------|
| 长距离输水明渠 | 0.10-0.20 m | 1800-3600 s | 0.02-0.05 m | 延时大，响应慢 |
| 短渠段（＜5km） | 0.05-0.10 m | 300-900 s | 0.01-0.03 m | 延时小，可快速调节 |
| 泵站流量控制 | 3-5% | 60-300 s | 1-2% | 执行器响应快 |
| 水库水位控制 | 0.05-0.10 m | 小时-天级 | 0.02 m | 库容调节缓慢 |
| 管道压力控制 | 0.5-2.0 m | 10-60 s | 0.1-0.5 m | 水锤效应敏感 |

### 4.3.3 扰动抑制测试

扰动抑制测试评估控制系统拒绝外部扰动的能力。水利系统面对的典型扰动包括：上游来水量波动（自然来水或上游工程调度引起）、下游取水量变化（用水单位的计划内和计划外取水）、旁侧入流（降雨径流、支渠汇入）、设备突发故障（闸门卡滞、泵站跳闸）。

扰动抑制测试的设计要点在于扰动信号的选择。常用的扰动信号类型包括：

**阶跃扰动**：最基础的扰动类型，评估系统对突变的抑制能力。应测试正向和负向阶跃，以及不同幅度的阶跃。

**斜坡扰动**：模拟缓慢渐变的工况变化，如季节性来水量变化、用水需求渐增。评估系统能否在变化过程中维持控制精度。

**随机扰动**：使用带限白噪声或实测数据中提取的随机过程，模拟真实工况中的不确定性。

**复合扰动**：将多种扰动叠加，模拟复杂的实际工况——例如，上游来水阶跃的同时下游取水量也在波动。

【例4-2】某多渠段调水系统包含3个串联渠段和4座节制闸，采用分布式PI控制。设计MIL测试方案验证该系统对旁侧入流扰动的抑制能力。

[系统描述] 渠段1（10km）—闸1—渠段2（8km）—闸2—渠段3（12km）—闸3—渠段4（6km）—闸4（末端）。设计流量25 m³/s。控制策略：每座闸以其下游水位为控制目标，各闸PI参数独立整定。

[扰动设计] 在渠段2入口处（K18处），模拟一条支渠的突发来水。扰动信号：先在t=600s时注入2 m³/s的阶跃旁侧入流（模拟暴雨后支渠来水），持续1800s后消退。

[通过准则] (a) 所有渠段水位不超过安全上限（距渠顶0.3m以上安全裕度）；(b) 扰动消退后3600s内各闸下游水位恢复至设定值±0.03m；(c) 闸门动作速率不超过机械限制（0.005 m/s）。

[MIL执行] 使用3段IDZ模型级联组成被控对象模型，4个离散PI控制器，测试引擎以50×加速比运行。虚拟仿真时长14400s（4小时），实际计算时间约5分钟。

[测试结果] 旁侧入流注入后，渠段2下游水位从2.85m升至3.02m（距安全上限3.50m尚有0.48m裕度 ✓）。闸2和闸3依次调大开度以消化多余流量。扰动消退后，闸2下游水位在2200s内恢复（＜3600s ✓），但闸3下游水位恢复耗时3400s，接近限值。闸门最大动作速率0.003 m/s（＜0.005 m/s ✓）。

[结果讨论] 系统通过了该扰动抑制测试，但闸3的恢复时间接近上限，提示其PI参数可能需要重新整定——积分时间常数可能过大，导致消除偏差速度偏慢。这一发现将指导后续的参数敏感性分析，重点关注闸3的T_i参数。

### 4.3.4 多变量耦合测试

水利系统天然是多变量耦合系统——上游闸门的操作会影响下游水位，多个闸门之间通过水力学过程产生交互。多变量耦合测试专门评估多控制回路之间的交互是否导致系统性能恶化。

耦合测试的设计关键是**同时激励多个回路**。典型方法包括：对多个回路同时施加阶跃扰动（测试同步响应）、对相邻回路依次施加扰动（测试扰动传播与回路间干扰）、对全系统施加全局工况变化（如全线减水或增水，测试协调控制能力）。

耦合测试的评估需增加**交互性指标**——衡量一个回路的操作对其他回路造成的影响。常用的交互性度量包括相对增益阵列（RGA）分析和Niederlinski指数，前者可在MIL前通过模型分析计算，后者用于判断分散控制的稳定性。MIL测试则提供这些理论指标的动态验证。

---

## 参数敏感性分析

### 4.4.1 为什么需要敏感性分析

MIL基准测试使用的是"标称参数"——设计手册中的糙率值、校验后的模型参数、整定好的控制器参数。但在实际工程中，几乎所有参数都存在不确定性：Manning糙率随淤积和植被生长变化、渠道断面因沉降或维修而改变、传感器存在系统偏差。

参数敏感性分析的目的是回答两个核心问题：（1）**哪些参数是关键的**——系统性能对哪些参数的变化最敏感？（2）**允许多大的偏差**——关键参数偏离标称值多少时，系统仍能满足性能要求？

### 4.4.2 局部敏感性分析（OAT方法）

局部敏感性分析采用"一次一变量"（One-At-a-Time, OAT）方法：固定其他参数在标称值，仅改变一个参数，观察输出的变化。

设控制系统的性能指标为$J$（如调节时间），参数向量为$\boldsymbol{\theta} = [\theta_1, \theta_2, \ldots, \theta_p]^T$。参数$\theta_i$的局部敏感性系数定义为：

$$S_i = \frac{\partial J}{\partial \theta_i} \bigg|_{\boldsymbol{\theta}=\boldsymbol{\theta}_0}$$

在实际MIL测试中，由于$J$通常不是$\theta_i$的解析函数，采用有限差分近似：

$$S_i \approx \frac{J(\theta_{i,0} + \Delta\theta_i) - J(\theta_{i,0} - \Delta\theta_i)}{2\Delta\theta_i}$$

为了比较不同量纲参数的敏感性，通常使用归一化敏感性系数：

$$S_i^* = \frac{\theta_{i,0}}{J_0} \cdot S_i = \frac{\theta_{i,0}}{J_0} \cdot \frac{\Delta J}{\Delta\theta_i}$$

$S_i^*$的物理含义是：参数$\theta_i$相对变化1%时，性能指标$J$的相对变化百分比。

OAT方法的优势是简单直观、计算量可控（$p$个参数仅需$2p+1$次仿真）。其局限在于忽略了参数之间的交互效应——在水利系统中，糙率变化与闸门特性变化的耦合效应可能显著，OAT无法捕捉。

### 4.4.3 全局敏感性分析

全局敏感性分析在参数的整个不确定性范围内同时采样，能够捕捉参数交互效应。两种最常用的方法是Sobol方法和Morris方法。

**Sobol方法**基于方差分解。设性能指标$J$的总方差为$V(J)$，则$J$可分解为各参数的单独贡献和交互贡献：

$$V(J) = \sum_i V_i + \sum_{i<j} V_{ij} + \cdots + V_{12\ldots p}$$

其中$V_i$是仅由$\theta_i$引起的方差，$V_{ij}$是由$\theta_i$和$\theta_j$交互引起的方差。一阶Sobol指数$S_i = V_i/V(J)$衡量参数$\theta_i$对总方差的单独贡献，总效应指数$S_{T_i} = 1 - V_{\sim i}/V(J)$衡量参数$\theta_i$的全部贡献（包括与其他参数的交互）。若$S_{T_i} - S_i$较大，说明$\theta_i$与其他参数有显著交互。

Sobol方法的计算量较大——对于$p$个参数，需要$N(p+2)$次模型评估（$N$为基准样本量，通常取1000-10000），因此在MIL中通常使用降阶模型进行Sobol分析。

**Morris方法**（Elementary Effects方法）是一种计算量适中的筛选方法，适用于参数较多时快速识别"重要参数"和"不重要参数"。每次在参数空间中沿一个维度跳跃一步，计算对应的输出变化（Elementary Effect）。重复$r$次（通常$r=10-20$），统计每个参数的Elementary Effect的均值$\mu^*$（衡量影响大小）和标准差$\sigma$（衡量非线性和交互效应强度）。

**表4-3 水利控制系统MIL典型敏感参数及其不确定性范围**

| 参数类别 | 典型参数 | 标称值范围 | 不确定性（%） | 典型敏感性 |
|---------|---------|----------|-------------|----------|
| 渠道水力学 | Manning糙率 $n$ | 0.013-0.020 | ±20-30% | 高 |
| | 渠道底宽 $B$ | 按设计 | ±2-5% | 中 |
| | 渠道底坡 $S_0$ | 按设计 | ±5-10% | 中-高 |
| 控制器 | 比例增益 $K_p$ | 整定值 | ±10-20% | 高 |
| | 积分时间 $T_i$ | 整定值 | ±10-20% | 中-高 |
| | 采样周期 $T_s$ | 30-120s | 固定 | 低-中 |
| 执行器 | 闸门延时 | 5-30s | ±30-50% | 中 |
| | 闸门死区 | 0.01-0.05m | ±50% | 低-中 |
| 边界条件 | 上游来水量 | 按预报 | ±10-30% | 高 |
| | 下游取水量 | 按计划 | ±20-50% | 中-高 |

### 4.4.4 从敏感性到鲁棒性需求

参数敏感性分析的最终产出是一份**关键参数清单**和对应的**容许偏差范围**。

【例4-3】对例4-1中的PI控制系统进行OAT敏感性分析。

[参数选择] 分析5个参数的敏感性：Manning糙率$n$（标称0.015）、渠道底宽$B$（标称10m）、PI增益$K_p$（标称0.5）、PI积分时间$T_i$（标称600s）、上游来水扰动幅度$\Delta Q$（标称5 m³/s）。

[MIL执行] 每个参数在标称值的±20%范围内取5个水平（-20%, -10%, 0%, +10%, +20%），共25次MIL仿真。性能指标$J$取调节时间$t_s$。加速比100×，总计算时间约30分钟。

[分析结果] 归一化敏感性系数$S^*$（调节时间对参数的敏感性）：

| 参数 | $S^*$ | 敏感性等级 |
|------|-------|----------|
| $K_p$ | -1.42 | 高（$K_p$增大→$t_s$显著减小） |
| $n$ | +0.89 | 高（糙率增大→延时增加→$t_s$增大） |
| $T_i$ | +0.65 | 中-高 |
| $\Delta Q$ | +0.51 | 中 |
| $B$ | -0.23 | 低 |

[结果讨论] $K_p$和$n$是两个最敏感的参数。$K_p$的高敏感性说明控制器参数整定对性能至关重要——$K_p$偏低20%时调节时间增加28%，提示需要在SIL/HIL阶段保证参数整定的精度。$n$的高敏感性意味着渠道糙率变化（如淤积后糙率增大）会显著影响控制性能，建议在运行中持续监测糙率变化并调整控制参数。$B$的低敏感性说明渠道宽度的微小变化对控制性能影响不大，可以放松其测量精度要求。

---

## 蒙特卡洛场景扫描

### 4.5.1 为什么需要大规模场景扫描

参数敏感性分析告诉我们"哪些参数重要"，但没有回答"在参数不确定性的联合作用下，系统在多大比例的可能工况中满足性能要求"。蒙特卡洛场景扫描通过随机采样大量参数组合，构建性能指标的统计分布，从而回答这个问题。

### 4.5.2 场景矩阵设计

场景矩阵定义了MIL场景扫描中需要覆盖的维度。对于水利控制系统，场景矩阵通常包含四个维度（与第七章将详细讨论的ODD四维矩阵一致）：

**水文维度**：来水量级（枯水/平水/丰水/洪水）、来水变化速率（缓变/快变/突变）、旁侧入流模式（无/小/中/大）。

**设备维度**：闸门状态（正常/卡滞/延迟增大）、泵站状态（全部可用/部分检修）、传感器状态（正常/偏差/失效）。

**环境维度**：季节（非冰期/过渡期/冰期）、水质（正常/高浊度/冰絮）、渠道状态（新建/正常运行/淤积严重）。

**控制维度**：控制模式（本地自动/集中调度/应急手动）、通信状态（正常/延迟/中断）、协调策略（独立控制/协调控制/MPC在线优化）。

四维矩阵的组合数量可能极大。例如，若每个维度有5个离散水平，四维矩阵的全组合为5⁴=625种场景——每种场景如果做10次蒙特卡洛采样（考虑参数不确定性），总共需要6250次MIL仿真。利用加速仿真，这个规模在MIL中完全可行。

### 4.5.3 采样策略

蒙特卡洛采样的效率取决于采样策略的选择。

**纯随机采样**（Simple Random Sampling）是最基本的方法：对每个参数从其概率分布中独立随机抽样。优势是实现简单、理论保证无偏；劣势是样本利用效率低，需要较多样本才能充分覆盖参数空间的各个区域。

**拉丁超立方采样**（Latin Hypercube Sampling, LHS）将每个参数的分布区间等分为$N$个层次，确保每个层次恰好被采样一次。LHS比纯随机采样能以更少的样本量实现更均匀的空间覆盖。对于$p$个参数的$N$次LHS采样，其空间覆盖效率约等于纯随机采样的$N \cdot \sqrt{p}$次。在MIL场景扫描中，LHS是推荐的默认采样策略。

**重要性采样**（Importance Sampling）将更多的样本集中在"高风险"区域——例如极端来水、设备故障等低概率高影响事件。重要性采样特别适用于估计"失败概率"这一低概率事件。

### 4.5.4 结果分析与统计

蒙特卡洛场景扫描的结果是一组性能指标的样本，需要进行统计分析。

**性能指标的概率分布**：绘制调节时间、超调量等指标的直方图和经验累积分布函数（ECDF），直观展示控制系统在不同工况下的性能分布。

**可靠度估计**：计算性能指标满足要求的比例（蒙特卡洛可靠度）。例如，1000次仿真中有962次超调量在限值以内，则可靠度估计为96.2%，95%置信区间为[94.8%, 97.3%]（基于Wilson区间估计）。

**失败模式分析**：对未通过的场景进行聚类分析，识别导致失败的主要工况组合。常见的分析方法包括分类树（以"通过/失败"为标签，以场景参数为特征，训练分类树识别关键因素）和条件概率分析（计算特定工况下的失败概率，如"冰期且来水突增"条件下的失败概率）。

【例4-4】对例4-2中的多渠段系统进行蒙特卡洛场景扫描。

[场景设计] 3个场景维度：来水量级（正态分布，均值25 m³/s，标准差5 m³/s）、Manning糙率（对数正态分布，均值0.015，变异系数0.15）、旁侧入流幅度（均匀分布，0-4 m³/s）。采用LHS生成1000组参数样本。

[通过准则] 同例4-2：所有水位不超限、扰动恢复＜3600s、闸门速率不超限。

[MIL执行] 1000个场景，每个场景仿真虚拟时间14400s，加速比50×。单次仿真约5分钟，8线程并行，总计算时间约10小时（夜间批量执行）。

[统计结果] 1000次仿真中，943次通过全部准则（可靠度94.3%）。57次失败分析如下：

- 47次因闸3恢复时间超限（占失败的82%），与例4-2的发现一致
- 7次因渠段2水位超限（来水量＞35 m³/s且旁侧入流＞3 m³/s时发生）
- 3次因闸门动作速率超限（来水突变幅度＞10 m³/s时发生）

分类树分析显示：闸3恢复超限的最强预测因素是Manning糙率（$n > 0.017$时失败率跃升至18%），其次是来水量级（$Q > 30$ m³/s时失败率增加）。

[结果讨论] 94.3%的可靠度是否可接受？这取决于工程的安全等级要求。对于一般调水工程，95%的可靠度通常被视为MIL阶段的最低要求。当前结果略低于95%，主要薄弱点在闸3控制器——建议重新整定闸3的PI参数（减小$T_i$以加快恢复），整定后重新扫描。此外，7次水位超限事件对应的是极端来水+大旁侧入流的叠加工况，可能需要增加协调控制策略或安全联锁。

---

## 加速仿真与批量测试

### 4.6.1 加速仿真的实现

MIL测试的核心优势之一是能够以超实时速度运行。加速仿真的实现方式取决于被控对象模型的计算复杂度。

**降阶模型（ROM）加速**：IDZ、Muskingum等降阶模型的单步计算量极小（微秒级），加速比可达1000×-10000×。一个24小时虚拟时间的场景仅需数秒实际时间。ROM加速是MIL场景扫描的首选方案。

**全模型加速**：Saint-Venant全模型的单步计算量较大（毫秒级），加速比通常在10×-100×范围。对于需要高保真度的关键场景验证，使用全模型加速是必要的。

**混合加速策略**：结合ROM和全模型的优势——先用ROM进行快速大规模扫描（万级场景），筛选出高风险场景（通常占总场景的5%-15%），再对这些高风险场景使用全模型进行精确验证。这种两阶段策略可以在保证验证质量的同时大幅降低总计算量。

### 4.6.2 批量测试框架

大规模MIL测试需要自动化的批量测试框架来管理测试执行。一个工程级的批量MIL测试框架包含以下组件：

**场景管理器**：从场景库中读取场景定义，管理场景的优先级排序和执行队列。场景定义包括：初始条件、边界条件时间序列、参数设置、扰动注入计划和通过准则。

**并行执行引擎**：将多个MIL仿真分配到多核/多机计算资源上并行执行。由于MIL中各场景之间通常互相独立，并行化的效率接近线性（受限于内存和I/O带宽）。

**结果收集器**：自动收集每次仿真的时间序列数据和评估结果，存入结构化数据库。

**监控面板**：实时显示批量测试的进度（已完成/总数）、通过率趋势、失败场景的快速预览。

### 4.6.3 测试数据管理

大规模MIL测试产生的数据量不容忽视。以1000个场景为例，每个场景记录10个通道、采样周期60s、仿真时长24小时——每个场景约14,400个时间步×10通道=144,000个数据点。1000个场景总计约1.44亿数据点。

测试数据管理的关键原则：**原始数据完整保存**（用于事后分析和审计追溯）、**评估结果结构化存储**（每个场景的通过/失败判定和指标值存入关系数据库）、**版本关联**（每次测试明确记录使用的模型版本、控制算法版本和场景库版本）。

---

## MIL报告规范

### 4.7.1 报告结构

MIL测试报告是控制算法从MIL阶段进入SIL阶段的"通行证"。标准化的报告结构确保信息完整、可审查。

**表4-4 MIL测试报告标准结构**

| 章节 | 内容要求 | 备注 |
|------|---------|------|
| 1. 概述 | 测试对象、测试范围、测试目的 | 明确本次MIL覆盖的功能范围 |
| 2. 测试环境 | 被控对象模型（型号/版本/校验等级）、控制算法模型（版本/配置）、测试引擎（版本/配置） | 确保可复现 |
| 3. 测试方案 | 测试用例列表、场景矩阵、通过准则 | 需经评审批准 |
| 4. 测试执行 | 执行日期、执行人、偏差记录 | 记录任何偏离计划的情况 |
| 5. 基准测试结果 | 阶跃响应、设定点跟踪、扰动抑制的详细结果 | 含时间序列图和指标汇总 |
| 6. 敏感性分析结果 | 关键参数清单、容许偏差范围 | 含敏感性排序图 |
| 7. 场景扫描结果 | 可靠度估计、失败模式分析 | 含概率分布图和失败场景聚类 |
| 8. 缺陷与建议 | 发现的缺陷、根因分析、修改建议 | 按严重性分级 |
| 9. 结论与决策 | MIL是否通过、是否可进入SIL | 需签字确认 |
| 附录A | 全部测试用例的通过/失败汇总表 | — |
| 附录B | 典型场景的详细时间序列 | 至少包含最优、最差和临界场景 |

### 4.7.2 缺陷分级与追踪

MIL测试中发现的缺陷按照严重性分为四级：

**S1-致命**：控制算法在标称条件下即失效（如系统发散、安全约束严重违反）。必须在进入SIL前完全修复。

**S2-严重**：控制算法在部分常见工况下性能不达标（如某类扰动的恢复时间超限）。必须修复或提供规避方案后方可进入SIL。

**S3-一般**：控制算法在少数极端工况下性能退化（如极端来水量下超调量略超限值）。应在SIL阶段前或SIL阶段中修复。

**S4-建议**：性能可接受但有优化空间（如调节时间虽在限值内但偏长）。可在后续版本中优化。

**表4-5 MIL缺陷分级与处理要求**

| 等级 | 描述 | 进入SIL条件 | 修复时限 |
|------|------|-----------|---------|
| S1-致命 | 标称条件失效 | 必须修复 | MIL阶段内 |
| S2-严重 | 常见工况不达标 | 必须修复或规避 | MIL阶段内 |
| S3-一般 | 极端工况退化 | 可带入SIL | SIL阶段结束前 |
| S4-建议 | 有优化空间 | 可带入SIL | 无硬性要求 |

每个缺陷需要记录：唯一编号、发现日期、严重性等级、所属功能模块、重现场景、根因分析、修改方案、验证状态。缺陷修复后必须进行回归测试——不仅验证缺陷已修复，还要确认修复未引入新的问题。

---

## 本章小结

本章系统阐述了MIL（模型在环）测试的方法论和工程实践。

首先，明确了MIL在三级在环验证体系中的定位。MIL是成本最低、速度最快的验证阶段，能够发现约58%的控制系统缺陷（表4-1）。其核心价值在于"闭环"——通过控制算法与被控对象模型的闭环连接，暴露开环分析无法发现的动态问题。MIL能够发现算法逻辑、参数整定和多变量耦合方面的缺陷，但无法发现软件编码、通信延迟和硬件兼容性方面的问题。

其次，建立了MIL测试的标准架构和工作流程。四组件架构（被控对象模型、控制算法模型、测试引擎、评估模块）提供了清晰的职责划分。五阶段工作流程（准备→基准测试→敏感性分析→场景扫描→评估报告）确保测试过程的系统性。

第三，阐述了控制算法MIL验证的四类测试——阶跃响应、设定点跟踪、扰动抑制和多变量耦合——及其评估指标体系（表4-2）。通过例4-1和例4-2展示了单渠段和多渠段系统的MIL测试设计方法。

第四，介绍了参数敏感性分析方法。OAT方法简单高效但忽略参数交互，Sobol和Morris方法能够捕捉全局敏感性和参数交互（表4-3）。通过例4-3展示了从敏感性分析到鲁棒性需求的转化过程。

第五，论述了蒙特卡洛场景扫描的设计与分析方法。四维场景矩阵、LHS采样策略和失败模式聚类分析构成了场景扫描的完整方法链。通过例4-4展示了1000场景扫描的实践流程和结果分析方法。

第六，讨论了加速仿真、批量测试和测试数据管理的工程实现，以及MIL报告的标准化结构（表4-4）和缺陷分级体系（表4-5）。

> 下一章将从MIL进入SIL——当控制算法从数学模型转化为嵌入式软件代码后，需要面对一系列新的验证挑战：接口协议是否正确？时序是否满足实时性要求？异常输入是否被妥善处理？SIL测试将在软件层面回答这些MIL无法触及的问题。

---

## 习题

### 基础题

**4-1.** 请解释MIL测试中"闭环"与"开环"的区别。为什么一个在开环阶跃响应分析中表现稳定的控制器，在闭环MIL测试中可能出现振荡？请用反馈系统的框图说明可能的原因。

**4-2.** 列出MIL测试能够发现和不能发现的缺陷类型（各至少3种）。如果一个控制算法通过了所有MIL测试，是否可以直接跳过SIL进入HIL？为什么？

**4-3.** 解释归一化敏感性系数$S_i^*$的物理含义。如果$S_{K_p}^* = -1.5$，$S_n^* = +0.8$，请分别解释这两个数值的工程含义，并说明哪个参数更值得在工程运行中重点监测。

**4-4.** 比较OAT、Morris和Sobol三种敏感性分析方法的优缺点和适用场景。对于一个包含15个不确定参数的水利控制系统，如果MIL计算预算为2000次仿真，你推荐使用哪种方法或组合？

### 应用题

**4-5.** 某水库泄洪控制系统包含3扇弧形闸门，采用PID控制维持下游河道水位在安全范围内。请设计完整的MIL测试方案，包括：（a）基准测试的场景列表（至少包含5个测试场景）；（b）每个场景的通过准则；（c）参数敏感性分析的参数列表（至少8个参数）和扰动范围；（d）蒙特卡洛场景扫描的场景矩阵设计（四维矩阵，每维至少3个水平）。

**4-6.** 对例4-4的场景扫描结果进行进一步分析。已知闸3控制器的积分时间$T_i$=800s，分析显示$n > 0.017$时闸3恢复超限。请：（a）估算将$T_i$从800s减小到500s后的改善效果（利用敏感性系数近似估算）；（b）设计一组回归测试场景（至少5个），验证参数调整后系统性能的改善且未引入新问题；（c）讨论减小$T_i$可能带来的负面效应。

### 思考题

**4-7.** MIL测试的可信度取决于被控对象模型的可信度。如果被控对象模型本身存在系统性偏差（例如糙率标定偏低导致模型中的延时比实际短），MIL测试可能给出过于乐观的结论。讨论：（a）这种"模型乐观偏差"在实际工程中有多常见？（b）有哪些方法可以检测和缓解模型偏差对MIL结论的影响？（c）MIL报告中应如何描述模型不确定性对测试结论的影响？

**4-8.** 本章的蒙特卡洛场景扫描假设场景参数是随机独立或弱相关的。但在实际水利系统中，参数之间可能存在强相关性——例如暴雨工况下来水量大且水质差，低温工况下冰期且设备故障率升高。讨论：（a）忽略参数相关性可能导致场景扫描遗漏哪些重要的工况组合？（b）如何在采样策略中引入参数相关性（提示：考虑Copula方法或条件采样）？（c）历史运行数据在构建参数相关结构中可以发挥什么作用？

---

## 拓展阅读

1. **Saltelli, A., Ratto, M., Andres, T., et al. (2008).** *Global Sensitivity Analysis: The Primer.* John Wiley & Sons. — 全局敏感性分析的权威教材，系统阐述了Sobol、Morris和基于方差的敏感性分析方法。第4-6章对理解本章4.4节的方法论有直接参考价值。

2. **Savić, D.A., Banyard, J.K., & Walters, G.A. (2006).** "Monte Carlo simulation for uncertainty analysis of water distribution systems." *Journal of Hydroinformatics*, 8(2), 113-127. — 蒙特卡洛方法在水网系统分析中的应用，展示了采样策略选择和不确定性量化方法，与本章4.5节的场景扫描方法论有直接关联。

3. **Clemmens, A.J., Kacerek, T.F., Grawitz, B., & Schuurmans, W. (1998).** "Test cases for canal control algorithms." *Journal of Irrigation and Drainage Engineering*, 124(1), 23-30. — 明渠控制算法的标准化测试用例设计，提出了经典的阶跃响应和设定点跟踪测试方法。虽发表年代较早，但其测试方法论至今仍是在环验证的重要参考。

4. **Lei, X. et al. (2025c).** "In-the-Loop Testing System for Water Network Control." *南水北调与水利科技（中英文）*, DOI: 10.13476/j.cnki.nsbdqk.2025.0080. — 提出了HydroOS框架下的水网在环测试系统架构，其中MIL测试流程和缺陷分级体系是本章工程实践的直接基础。

5. **Van Overloop, P.J., Schuurmans, J., Brouwer, R., & Burt, C.M. (2005).** "Multiple-model optimization of proportional integral controllers on canals." *Journal of Irrigation and Drainage Engineering*, 131(2), 190-196. — 多模型环境下的明渠PI控制器优化，展示了参数敏感性分析与控制器整定的结合方法，对本章4.4节的"从敏感性到鲁棒性"转化有重要参考价值。
