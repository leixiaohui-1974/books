<!-- 变更日志
v1 2026-02-19: 初稿
-->

# 第七章 测试用例设计与场景矩阵

## 学习目标

1. 掌握基于运行设计域（ODD）的测试场景系统化设计方法，理解从ODD定义到测试用例的推导过程；
2. 理解四维场景矩阵（水文/设备/通信/组织）的构建方法，能够为具体水利控制工程设计完整的场景矩阵；
3. 掌握测试用例分级（P0/P1/P2）的原则与实践，能够在有限测试资源下合理分配优先级；
4. 掌握边界值分析和极端工况测试的设计方法，理解"角落场景"对控制系统可靠性的挑战；
5. 理解自动化测试框架的架构设计和测试数据管理的工程方法。

> **前章回顾**：第四至六章分别阐述了MIL、SIL和HIL三级在环测试的方法论与实践。每一级测试都涉及"测试什么"的问题——阶跃响应、参数敏感性、接口契约、安全联锁等。然而，这些测试类型如何组织为系统性的测试方案？如何确保测试的覆盖面足够全面而不遗漏关键场景？如何在有限的测试预算内优先验证最重要的功能？本章将回答这些"测试设计"层面的问题，建立从运行设计域到测试用例的完整方法链。

---

## ODD驱动的测试设计

### 7.1.1 运行设计域（ODD）的概念

运行设计域（Operational Design Domain, ODD）源于自动驾驶领域，定义了自动化系统"设计为在其中工作"的全部条件集合。CHS将这一概念引入水利控制系统——水网控制系统的ODD定义了控制系统能够安全、有效运行的全部工况条件的边界。

水利控制系统的ODD包括但不限于：水文条件范围（来水量、水位、流速的上下界）、设备工作条件（可用设备组合、设备维护状态）、环境条件（温度、冰期、水质）、通信条件（可用链路、延迟上界）、操作条件（控制模式、操作人员配置）。

ODD的核心价值在于为测试设计提供了系统化的"需求源"——**测试的目标是验证控制系统在ODD边界内的全部工况下满足性能要求，并在超出ODD边界时安全降级**。

### 7.1.2 从ODD到测试场景的推导

ODD到测试场景的推导遵循三步法：

**第一步：ODD分解**。将ODD分解为若干独立或弱相关的维度，每个维度定义其取值范围和代表性水平。

**第二步：场景组合**。将各维度的代表性水平进行组合，生成场景空间。全组合数量可能极大（如4维×5水平=625种），需要采用智能组合策略（如正交设计、Pairwise测试）减少组合数量。

**第三步：场景到用例**。为每个场景定义具体的测试用例——初始条件、输入序列、通过准则、执行阶段（MIL/SIL/HIL）。

---

## 四维场景矩阵

### 7.2.1 矩阵结构

水利控制系统的场景空间可以用四维矩阵系统化描述：

**表7-1 水利控制系统四维场景矩阵**

| 维度 | 子维度 | 典型水平 | 水平数 |
|------|-------|---------|-------|
| 水文 | 来水量级 | 枯水/平水/丰水/洪水/超标准洪水 | 5 |
| | 来水变化 | 缓变/快变/突变/周期性 | 4 |
| | 旁侧入流 | 无/小/中/大 | 4 |
| | 水质/冰情 | 正常/高浊度/初冰/稳定冰期/融冰 | 5 |
| 设备 | 闸门状态 | 全部正常/单闸故障/多闸故障 | 3 |
| | 泵站状态 | 全部可用/单泵检修/多泵检修 | 3 |
| | 传感器状态 | 全部正常/单点故障/多点故障/全失 | 4 |
| | 执行器精度 | 标准/退化/严重退化 | 3 |
| 通信 | 链路状态 | 全通/单链路断/多链路断/全断 | 4 |
| | 延迟水平 | 正常/增大2倍/增大5倍/增大10倍 | 4 |
| | 丢包率 | ＜0.1%/0.1-1%/1-5%/＞5% | 4 |
| 组织 | 控制模式 | 全自动/半自动/手动 | 3 |
| | 操作人员 | 满编/值班/最少人员 | 3 |
| | 协调策略 | 集中优化/分布式协调/本地自治 | 3 |

四维矩阵的全组合数为：水文(5×4×4×5)×设备(3×3×4×3)×通信(4×4×4)×组织(3×3×3) = 400×108×64×27 ≈ 7.5×10⁷种。显然，全组合测试是不可行的，需要采用系统化的组合缩减策略。

### 7.2.2 组合缩减策略

**基于风险的缩减**：并非所有维度组合都有意义或有风险。例如"超标准洪水+冰期"在大多数地区不会同时出现。基于工程知识和历史数据，排除不合理或极低概率的组合，可将场景数缩减约50-70%。

**Pairwise测试**：Pairwise（两两组合）覆盖要求任意两个维度的任意两个水平组合至少出现一次。对于上述场景矩阵，Pairwise覆盖通常只需要数百个场景（而非数千万），同时已被证明能够覆盖大多数实际缺陷（经验表明，约70%的缺陷由单因素或两因素交互触发）。

**正交阵列**：使用正交实验设计方法选择场景组合，保证因素效应的均衡估计。适用于需要进行敏感性分析的场景设计。

【例7-1】某调水工程的ODD包含4个主维度、各3-4个子维度。使用Pairwise方法生成测试场景矩阵。

[输入] 取水文维度的4个子维度（各取3个代表性水平）、设备维度的3个子维度（各取3个水平）、通信维度的2个子维度（各取3个水平）、组织维度的2个子维度（各取3个水平），共11个因素各3水平。

[Pairwise生成] 全组合数为3¹¹ ≈ 177,147种。使用Pairwise生成工具（如PICT或ACTS），在保证任意两因素的任意两水平组合至少出现一次的约束下，生成最小场景集。

[结果] Pairwise生成了27个基本场景。加上专家补充的13个"高风险角落场景"（如冰期+多闸故障+通信延迟），总计40个场景。每个场景在MIL/SIL/HIL三级各需执行一次，总计120次测试。与全组合相比，场景数缩减了4400倍以上。

[结果讨论] 40个场景是否"足够"？Pairwise保证了两两交互的覆盖，但不能保证三因素及更高阶交互的覆盖。对于安全关键系统，建议在Pairwise基础上补充"最高风险三因素组合"的专项测试。

---

## 测试用例分级

### 7.3.1 P0/P1/P2分级体系

测试用例按照重要性和执行频率分为三级：

**P0-冒烟测试**（Smoke Test）：覆盖系统最核心的功能——如果P0不通过，系统存在根本性问题。P0测试数量少（通常20-50个用例）、执行快（15分钟内）、每次构建必须通过。

P0用例的选择标准：安全联锁功能、基本控制功能（标称工况下的阶跃响应）、关键接口通信（传感器数据采集、控制指令下达）、降级机制的基本触发。

**P1-核心测试**（Core Test）：覆盖系统的全部功能和常见工况。P1测试数量中等（100-300个用例）、执行时间数小时、每日或每版本执行。

P1用例覆盖：全部控制模式（自动/半自动/手动）、常见工况的场景矩阵、接口契约测试全集、时序一致性验证、基本异常处理。

**P2-扩展测试**（Extended Test）：覆盖极端工况、边界条件和稀有故障组合。P2测试数量大（500-2000个用例）、执行时间可达数天、版本发布前或专项验证时执行。

P2用例覆盖：蒙特卡洛场景扫描、边界值测试全集、多故障叠加场景、长时间运行稳定性测试、压力测试。

**表7-2 P0/P1/P2分级的执行策略**

| 等级 | 用例数 | 执行时间 | 执行频率 | 必须通过条件 |
|------|-------|---------|---------|------------|
| P0 | 20-50 | ＜15min | 每次代码提交 | 全部通过才可合入 |
| P1 | 100-300 | 1-4h | 每日/每版本 | 通过率≥98% |
| P2 | 500-2000 | 1-7天 | 版本发布前 | 通过率≥95%，S1/S2缺陷为零 |

### 7.3.2 用例编写规范

每个测试用例应包含以下要素：

- **用例编号**：按"阶段-类别-序号"编码，如MIL-STEP-001表示"MIL阶段、阶跃响应类、第1号用例"
- **标题**：简明描述测试目的
- **优先级**：P0/P1/P2
- **适用阶段**：MIL/SIL/HIL（有些用例在多个阶段重复执行）
- **前置条件**：系统应处于的初始状态
- **测试步骤**：明确的操作序列
- **预期结果**：定量的通过准则
- **实际结果**：测试执行后填写
- **判定**：PASS/FAIL/BLOCKED

---

## 边界值与极端工况测试

### 7.4.1 边界值分析

边界值分析（Boundary Value Analysis, BVA）是基于"缺陷往往出现在边界"这一经验观察的测试方法。对于水利控制系统，边界值存在于：

**物理边界**：水位的安全上下限、流量的最大最小值、闸门的全开全关位置、泵站的额定流量和最小流量。

**控制边界**：PI控制器的饱和限制（积分饱和和控制输出饱和）、MPC的约束边界（当约束激活时控制器行为变化）、模式切换阈值（如从自动切换到手动的触发条件）。

**通信边界**：超时阈值（判定通信中断的临界时间）、缓冲区大小限制、同时连接数限制。

BVA的标准做法是：对每个边界，至少测试三个点——边界值本身、紧邻边界的内侧值、紧邻边界的外侧值。

### 7.4.2 角落场景（Corner Cases）

角落场景是多个维度同时处于边界或极端值的组合，是控制系统最容易失效的区域。

【例7-2】某调水渠道控制系统的角落场景识别。

[系统ODD] 来水量Q∈[5, 50] m³/s，下游水位h∈[1.0, 4.5]m，Manning糙率n∈[0.012, 0.022]，闸门可用数∈{1,2,3}。

[角落场景列表]
- CS-01：最大来水(50)+最高水位(4.5)+最大糙率(0.022)+仅1闸可用——最极端的泄洪能力不足场景
- CS-02：最小来水(5)+最低水位(1.0)+最小糙率(0.012)+3闸全部可用——低流量下闸门精细调节的极限
- CS-03：来水突变(5→50，1小时内)+冰期糙率(0.020)+2闸可用——冰期突发大流量
- CS-04：来水为0+水位在安全下限附近+全部传感器数据延迟——断流场景下的最低水位保护

[测试设计] 每个角落场景在MIL阶段先行验证（快速且成本低）。MIL不通过的场景需要修改控制策略后再测试。MIL通过的场景在SIL和HIL阶段重复验证。

[结果讨论] 角落场景测试的价值不在于这些极端组合的发生概率——它们可能极低——而在于暴露控制系统在设计边界附近的行为。如果控制系统在角落场景中表现出不可接受的行为（如失控或崩溃），即使该场景概率极低，也需要修正设计或添加保护机制。

---

## 自动化测试框架

### 7.5.1 框架架构

大规模在环测试需要自动化框架来保证效率和可重复性。水利控制系统的自动化测试框架包含五个层次：

**场景层**：场景库管理、场景参数化定义、场景组合生成（Pairwise/正交设计）。

**编排层**：测试执行计划管理——按照P0→P1→P2的优先级排列执行队列，分配MIL/SIL/HIL测试资源，处理测试依赖关系。

**执行层**：对接MIL仿真引擎、SIL软件环境和HIL实时仿真器。执行层负责场景加载、仿真启动、数据采集和异常注入。

**评估层**：自动化的通过/失败判定——从时间序列数据中提取性能指标，与通过准则对比，生成用例级和场景级的评估报告。

**报告层**：生成结构化的测试报告——覆盖度统计、缺陷汇总、趋势分析。

**表7-3 自动化测试框架的技术选型参考**

| 层次 | 功能 | 典型技术/工具 |
|------|------|-------------|
| 场景层 | 场景管理与组合 | PICT/ACTS(Pairwise)、YAML/JSON场景定义 |
| 编排层 | 执行计划与调度 | Jenkins/GitLab CI、自定义调度器 |
| 执行层 | 仿真对接 | FMI Co-Simulation API、OPC-UA客户端 |
| 评估层 | 自动化判定 | Python脚本+NumPy/Pandas |
| 报告层 | 报告生成 | Allure/自定义HTML报告 |

### 7.5.2 测试可重复性保证

自动化测试的核心价值之一是可重复性——任何人在任何时间执行同一测试用例，应得到相同的结果（在允许的数值精度范围内）。保证可重复性的关键措施包括：

**版本锁定**：每次测试运行明确记录被测软件版本、被控对象模型版本、测试框架版本和场景库版本。

**随机种子固定**：蒙特卡洛采样、随机扰动注入等涉及随机性的测试必须使用固定种子，确保测试的确定性。

**环境快照**：SIL和HIL测试前保存系统配置快照（PLC配置、网络配置、仿真器参数），测试环境变更时需要记录和审核。

---

## 测试数据管理

### 7.6.1 数据分层存储

大规模在环测试产生的数据分为三层：

**原始数据层**：仿真过程中的全部时间序列数据（水位、流量、闸门开度等），以二进制格式存储，支持高速写入。典型数据量：每场景数十MB，千场景数十GB。

**评估数据层**：从原始数据提取的性能指标（超调量、调节时间等）和通过/失败判定，以结构化格式（关系数据库或JSON）存储。典型数据量：每场景数KB。

**报告数据层**：汇总的测试报告、趋势图表和缺陷追踪记录。供项目管理和质量审计使用。

### 7.6.2 数据追溯与审计

工程验收要求测试数据具有完整的追溯链——从最终的"MIL/SIL/HIL测试通过"结论，能够逆向追溯到：具体的测试用例编号、测试执行日期和执行人、使用的软件和模型版本、原始时间序列数据、评估计算过程。

【例7-3】某工程的在环验证审计中，审计员质疑HIL测试报告中"安全联锁响应时间2.8s"的结论。数据追溯过程如下：

[追溯链] 报告第6.4节 → 测试用例HIL-SI-001 → 执行记录#2025-0715-003 → 原始数据文件hil_si001_20250715.bin → 时间戳T1=602.000s（水位达标）、T6=604.800s（联锁触发）→ Δt = 2.8s ✓

[审计结论] 数据链完整，结论可追溯。审计员进一步要求查看时间戳的校准记录——确认实时仿真器和PLC的时钟同步精度为±10ms，不影响2.8s结论的可靠性。

---

## 本章小结

本章建立了从运行设计域（ODD）到测试用例的系统化设计方法。

首先，引入了ODD驱动的测试设计理念。ODD定义了控制系统安全运行的全部工况边界，为测试设计提供了系统化的"需求源"。ODD到测试场景的三步推导法（分解→组合→用例化）确保测试方案的完备性。

其次，构建了四维场景矩阵框架——水文/设备/通信/组织四个维度系统化描述水利控制系统的场景空间（表7-1）。针对全组合场景数过大的问题，介绍了基于风险的缩减、Pairwise测试和正交阵列三种组合缩减策略。通过例7-1展示了Pairwise方法将场景数从17万缩减至40个的实践。

第三，建立了P0/P1/P2三级测试用例分级体系（表7-2），以及测试用例的标准编写规范，确保在有限测试资源下优先验证最关键的功能。

第四，阐述了边界值分析和角落场景测试方法。例7-2展示了如何系统性地识别多维度同时处于极端值的角落场景，揭示控制系统在设计边界附近的潜在风险。

第五，介绍了自动化测试框架的五层架构（表7-3）和测试可重复性保证措施。

第六，讨论了测试数据的分层存储和追溯审计方法。例7-3展示了完整数据追溯链在工程审计中的应用。

> 下一章将从"如何设计测试"上升到"如何评价测试"——覆盖度度量回答"测试是否够全面？"，质量门禁回答"系统是否可以发布？"。这些定量化的评价方法将为在环验证的工程决策提供科学依据。

---

## 习题

### 基础题

**7-1.** 解释运行设计域（ODD）的概念。为什么ODD对于测试设计如此重要？如果一个控制系统没有明确定义ODD，测试设计会面临什么困难？

**7-2.** 解释Pairwise测试的基本原理。为什么Pairwise测试能以远少于全组合的场景数覆盖大多数缺陷？它的局限性是什么？

**7-3.** 区分P0、P1和P2三级测试用例的适用场景和执行频率。如果在一次P0测试中有1个用例失败，应该如何处理？如果在P2测试中有5%的用例失败呢？

**7-4.** 什么是"角落场景"（Corner Case）？为什么角落场景对控制系统测试特别重要？请为一个简单的单闸水位控制系统列出至少3个角落场景。

### 应用题

**7-5.** 某调水工程包含4座闸站和1座泵站，输水距离50km。请为该工程设计四维场景矩阵：（a）列出每个维度的子维度和代表性水平；（b）计算全组合场景数；（c）使用Pairwise方法估算最小场景数（可使用经验公式$N_{pw} \approx k \cdot v^2$，其中$v$为最大水平数，$k$为因素数的对数）；（d）补充至少5个专家推荐的角落场景。

**7-6.** 为上述工程设计自动化MIL测试框架。要求：（a）定义场景描述格式（YAML或JSON模板，至少包含5个必填字段）；（b）设计评估模块的通过准则定义语法（支持超调量、调节时间、稳态误差三种指标的上下界检查）；（c）设计测试报告的结构（至少包含覆盖度统计和缺陷汇总两部分）。

### 思考题

**7-7.** Pairwise测试假设大多数缺陷由两因素交互触发。但在水利控制系统中，某些缺陷可能需要三个或更多因素同时处于特定水平才会出现（例如"冰期+大流量+通信延迟"三因素组合）。讨论：（a）如何识别需要三因素覆盖的关键组合？（b）将覆盖要求从两两提高到三因素（t-wise覆盖）会使场景数增加多少？（c）在工程实践中，如何平衡覆盖充分性与测试成本？

**7-8.** 自动化测试框架的一个潜在风险是"测试惰性"——团队过度依赖自动化测试，忽略了探索性测试和基于经验的人工测试。讨论：（a）自动化测试和人工测试各有什么优势？（b）在水利控制系统的在环验证中，哪些类型的测试更适合自动化，哪些更适合人工？（c）如何在测试团队中建立自动化与人工测试的平衡文化？

---

## 拓展阅读

1. **Kuhn, D.R., Wallace, D.R., & Gallo, A.M. (2004).** "Software fault interactions and implications for software testing." *IEEE Transactions on Software Engineering*, 30(6), 418-421. — 实证研究表明大多数软件缺陷由单因素或两因素交互触发，为Pairwise测试的有效性提供了统计证据。

2. **SAE International (2021).** *SAE J3016: Taxonomy and Definitions for Terms Related to Driving Automation Systems.* — 自动驾驶ODD定义的行业标准。虽面向汽车领域，但其ODD分类框架和层次结构对水利控制系统ODD定义有重要参考价值。

3. **Myers, G.J., Sandler, C., & Badgett, T. (2011).** *The Art of Software Testing.* 3rd ed., John Wiley & Sons. — 软件测试经典教材。第4-5章关于边界值分析、等价类划分和因果图的方法论，是本章测试用例设计方法的理论基础。

4. **Lei, X. et al. (2025c).** "In-the-Loop Testing System for Water Network Control." *南水北调与水利科技（中英文）*, DOI: 10.13476/j.cnki.nsbdqk.2025.0080. — HydroOS框架下的在环测试系统，其中的场景矩阵设计方法和测试用例分级体系是本章工程实践的直接基础。

5. **Grindal, M., Offutt, J., & Andler, S.F. (2005).** "Combination testing strategies: a survey." *Software Testing, Verification and Reliability*, 15(3), 167-199. — 组合测试策略的综合综述，系统比较了全组合、Pairwise、正交阵列等方法的覆盖能力和效率。
