<!-- 变更日志
v1 2026-02-16: 初稿（基于“继续”命令自动续写）
-->

# ch06 在环测试与验证

## 学习目标

完成本章后，读者应能够：

1. 说明胶东调水场景下在环测试（In-the-Loop Testing）的分层目标；
2. 构建 MIL/SIL/HIL 测试链路与覆盖度指标体系；
3. 建立在环测试结果与发布门禁的映射规则（补齐 ch05 跟踪项）；
4. 设计回归测试、异常注入与发布准入策略；
5. 为 ch07 运行效果评估提供可追溯验证证据。

> 承接 ch05：在线优化策略已定义，本章回答“策略能否安全上线并稳定运行”。

> **前章回顾**：上一章介绍了本领域的核心概念与方法。本章在此基础上进一步展开。


## 为什么在环测试是上线前硬门槛

胶东调水控制策略涉及模型误差、通信时延、执行器约束与突发扰动。仅依靠离线仿真无法覆盖真实链路中的时序与异常。

[工程解释] 在环测试的核心价值是把“实验室可行”转化为“工程可上线”。

推荐原则：

- 不通过在环测试，不进入发布门禁；
- 不通过关键回归，不允许全量放开；
- 不可解释的异常，不允许跳过审计。

## MIL/SIL/HIL 分层测试设计

### 6.3.1 MIL（Model-in-the-Loop）

目标：验证控制逻辑与目标函数是否正确。

重点检查：
- 约束可行率；
- 目标函数收敛性；
- 扰动工况下稳定性。

### 6.3.2 SIL（Software-in-the-Loop）

目标：验证软件实现、接口协议与时序正确性。

重点检查：
- 接口字段一致性；
- 调度周期内求解完成率；
- 异常处理与回退逻辑。

### 6.3.3 HIL（Hardware-in-the-Loop）

目标：验证真实控制器与仿真对象耦合下的可执行性。

重点检查：
- 指令闭环时延；
- 联锁触发正确率；
- 模式切换稳定性。

[图6-1: MIL-SIL-HIL在环测试管线]
{描述: 展示策略版本从MIL到SIL再到HIL的测试门禁、数据输入输出、失败回退路径与审计归档。}
{尺寸: 全页}
{颜色方案: 蓝色系}
{对应ARCH编号: ARCH-06}

## 覆盖度度量与判据

建议覆盖度分三类：

1. **场景覆盖度**：常态、波动、应急工况覆盖比例；
2. **约束覆盖度**：ODD 与安全包络边界触达比例；
3. **故障覆盖度**：通信中断、测点异常、执行器受限等注入比例。

可定义综合覆盖指标：

$$
C_{itl}=\eta_1 C_{scene}+\eta_2 C_{constraint}+\eta_3 C_{fault}
$$

其中 $\eta_1+\eta_2+\eta_3=1$。

[物理直觉] 只覆盖“正常工况”就像只在晴天试航，不足以证明系统具备工程韧性。

[表6-1: 在环测试覆盖度指标与阈值]
{描述: 列包括覆盖维度、计算方法、最小阈值、数据来源、失败处置。}
{尺寸: 半页}
{颜色方案: 灰度}

## 在环结果到发布门禁映射（补齐ch05/ch04跟踪项）

为补齐 ch05/ch04 跟踪项，本节定义“测试结果—门禁动作”映射：

- `MIL_pass && SIL_pass && HIL_pass` 且 `C_{itl}` 达标 → 允许进入灰度发布；
- 仅 `MIL_pass`、`SIL/HIL` 未通过 → 阻断发布，回到联调；
- HIL 关键联锁失败 → 强制阻断并触发整改工单。

门禁字段建议：

- `test_bundle_id`、`coverage_score`、`critical_fail_count`、`release_gate_result`、`rollback_plan_id`。

[TODO: 需补充胶东现场门禁系统字段枚举与工单ID映射规则]

## 异常注入与回归测试策略

建议按“周回归 + 版本回归 + 重大变更专项回归”执行：

- 周回归：核心场景与关键约束快速回放；
- 版本回归：每次策略变更执行完整在环链路；
- 专项回归：针对事故复盘问题追加定向用例。

异常注入示例：

- 传感器冻结与跳变；
- 通信延迟抖动与短时中断；
- 执行器响应迟滞与限幅。

## 可复现实例：发布前门禁判定

【例6-1】某策略版本在测试中得到如下结果：

- MIL 通过；
- SIL 通过；
- HIL 中联锁误触发率超阈值（关键失败 1 项）；
- 综合覆盖度 $C_{itl}$ 达标。

**求解**：判断是否允许灰度发布。

**解题过程**：
1. 检查关键失败项：存在 HIL 关键失败；
2. 根据门禁规则，关键联锁失败属于强制阻断条件；
3. 输出 `release_gate_result = blocked`；
4. 生成整改工单并要求回归通过后重提放行。

**结果讨论**：
即使覆盖度达标，只要关键联锁失败，仍应阻断发布，这体现“安全优先”原则。

## 本章小结

本章建立了胶东调水在环测试与发布门禁的一体化机制：通过 MIL/SIL/HIL 分层验证、覆盖度量化、门禁映射与回归策略，将策略上线风险前移管理。下一章将基于上线后数据开展运行效果评估。

## 习题

### 基础题

**6-1.** 为什么在环测试不能被离线仿真完全替代？
**6-2.** 解释 $C_{itl}$ 三个组成部分的工程意义。
**6-3.** HIL 关键失败为何应触发强制阻断？

### 应用题

**6-4.** 设计一套发布门禁映射表，包含至少 5 条“测试结果→门禁动作”规则。  
**6-5.** 给出一个异常注入回归计划，覆盖传感器、通信、执行器三类故障。

### 思考题

**6-6.** 如果覆盖度达标但线上仍出现异常，问题更可能出在测试设计还是运行环境，如何判定？

### 基础题参考答案要点

**6-7.** 在环能验证真实时序与软硬件耦合行为。  
**6-8.** 分别对应场景完整性、约束边界覆盖与故障韧性。  
**6-9.** 因联锁直接关系运行安全，容错空间极小。

## 拓展阅读

1. **Lei et al. (2025c). 在环测试系统。**
2. **ASCE (2014). *MOP 131: Canal Automation for Irrigation Systems*.**
3. **NIST SP 800-53 Rev.5 (System and Communications Protection).**
4. **Litrico, X. & Fromion, V. (2009). *Modeling and Control of Hydrosystems*.**
5. **Van Overloop, P.J. (2006). *Model Predictive Control on Open Water Systems*.**
