<!-- 变更日志
v1 2026-02-16: 初稿
-->

# ch04 实时数据总线与事件系统

## 学习目标

完成本章后，读者应能够：

1. 理解 HydroOS 实时数据总线（Real-time Data Bus, RDB）在控制闭环中的作用；
2. 设计面向控制、告警、分析三类业务的消息通道与 QoS（Quality of Service）等级；
3. 构建事件模型、消息重放策略与幂等处理机制；
4. 建立数据一致性、时序完整性与审计追踪的联动门禁；
5. 给出总线故障场景下的降级与恢复流程。

> 本章承接 ch03：设备数据已能标准化接入，下一步是确保这些数据在 HydroOS 内“准时、可靠、可追溯”地流动。

> **前章回顾**：上一章介绍了本领域的核心概念与方法。本章在此基础上进一步展开。


## 为什么实时数据总线是中枢神经

若没有统一总线，策略引擎、门禁中心、审计中心将各自拉取数据，导致重复采集、状态不一致与时序漂移。

[物理直觉] 同一条河道不能允许多个“互不对时”的水位基准，否则调度结论必然冲突。

RDB 的目标是提供单一事实来源（Single Source of Truth）：

- 同步时钟下的统一状态流；
- 面向不同时效需求的分级通道；
- 全链路 trace_id 可追踪。

[工程解释] RDB 不是“消息中间件替代品”，而是带运行门禁语义的工业实时总线。

## 消息模型与主题划分

建议消息统一结构包含：

- `trace_id`、`topic`、`asset_id`、`point_id`；
- `event_time`、`ingest_time`、`quality_code`；
- `value`、`unit`、`oddscope`；
- `seq_no`、`replay_flag`、`signature`。

主题建议按功能划分：

1. `ctrl.state.*`：控制状态流；
2. `ctrl.command.*`：控制指令流；
3. `alarm.event.*`：告警事件流；
4. `audit.event.*`：审计归档流。

[表4-1: RDB消息模型与主题规范]
{描述: 列包括字段/主题、含义、生产者、消费者、时效要求、门禁校验规则。}
{尺寸: 半页}
{颜色方案: 灰度}

## QoS等级设计（补齐ch03遗留项）

为满足 ch03 的跟踪项，本章给出 QoS 建议分级：

- **QoS-0（Best Effort）**：分析类数据，可丢失，不重传；
- **QoS-1（At Least Once）**：告警与非关键控制反馈，允许重复，需幂等；
- **QoS-2（Exactly Once）**：关键控制命令与联锁事件，不允许重复或丢失。

推荐门禁策略：

- `ctrl.command.*` 默认 QoS-2；
- `alarm.event.*` 默认 QoS-1；
- `audit.event.*` 至少 QoS-1 且必须落盘成功回执。

[工程解释] QoS 不是“越高越好”，过高 QoS 会增加时延；应按风险等级匹配。

## 事件系统与幂等处理

事件系统应支持三类事件：

1. **状态事件**：设备状态、运行状态变化；
2. **控制事件**：策略下发、门禁放行/拒绝、联锁触发；
3. **运维事件**：发布、回滚、人工接管、权限变更。

幂等键建议：

$$
idempotency\_key=hash(trace\_id,topic,seq\_no,event\_time)
$$

[工程解释] 任何 QoS-1 通道都可能出现重复消息，没有幂等机制将导致重复执行风险。

## 消息重放策略（补齐ch04目标项）

重放用于故障恢复、仿真回放与审计复盘，建议分三级：

- **R1 快速重放**：仅重放最近窗口（如 10 min）关键主题；
- **R2 场景重放**：按 trace_id 重放完整事件链；
- **R3 全量重放**：用于离线复盘与模型再训练。

重放门禁要求：

- 重放消息必须带 `replay_flag=true`；
- 生产环境默认禁止将重放消息写入控制命令主题；
- 仅在沙箱或在环测试（In-the-Loop Testing）环境允许闭环重放。

[图4-1: RDB事件流与重放控制路径]
{描述: 展示实时流、归档流、重放流三条路径及重放门禁检查点。}
{尺寸: 全页}
{颜色方案: 蓝色系}

## 时序一致性门禁

RDB 侧可定义一致性门禁：

$$
\Delta t_{clock}+\Delta t_{queue}+\Delta t_{process}\le \Delta t_{max}
$$

其中：

- $\Delta t_{clock}$：时钟偏差；
- $\Delta t_{queue}$：排队延迟；
- $\Delta t_{process}$：消费者处理延迟。

建议关键控制通道设置 $\Delta t_{max}\le 150$ ms，并将越限事件写入 `alarm.event.latency` 主题。

## 可复现实例：总线拥塞下的分级降级

【例4-1】某次雨洪联调期间，告警事件激增导致 `alarm.event.*` 主题积压，影响 `ctrl.state.*` 消费延迟。

**已知**：

- 控制周期 $T_c=1$ s；
- `ctrl.state.*` 目标端到端时延 ≤ 300 ms；
- 当前观测：`ctrl.state.*` P95 = 340 ms，`alarm.event.*` 队列长度持续增长。

**求解**：设计拥塞处置流程。

**解题过程**：

1. 触发黄色告警：提升 `ctrl.state.*` 通道优先级，限制低优先级分析流；
2. 对 `alarm.event.*` 启用批处理与限速，保证关键告警不丢失；
3. 若 P95 仍 > 300 ms 持续 3 周期，触发橙色告警并启动 R1 快速重放策略；
4. 恢复后执行 trace_id 级别回放核对，确认无关键事件丢失。

**结果讨论**：
通过“优先级重排+分级限流+受控重放”，可在拥塞场景下保持控制链路稳定。

## 本章小结

本章构建了 HydroOS 的实时数据中枢：通过统一消息模型、QoS 分级、幂等键与重放策略，实现数据流的时效性、可靠性和可追溯性平衡。RDB 既支撑实时控制，也支撑审计复盘。下一章将进入任务编排与调度引擎，讨论策略服务如何在总线上实现可控协同。

## 习题

### 基础题

**4-1.** 为什么 `ctrl.command.*` 建议采用 QoS-2？
**4-2.** `idempotency_key` 在事件系统中解决了什么问题？
**4-3.** 解释一致性门禁公式中三个时延项。

### 应用题

**4-4.** 为一个“暴雨+多站联调”场景设计主题优先级与限流策略。  
**4-5.** 设计一份“事件重放审批单”，包含触发条件、环境限制、回放范围和审计字段。

### 思考题

**4-6.** 当“实时控制低时延”与“全量审计高可靠”冲突时，你会如何在架构上做取舍？

### 基础题参考答案要点

**4-7.** 因关键控制命令不能重复也不能丢失，需要最严格传输保证。  
**4-8.** 防止重复消息导致重复执行，保障事件处理幂等性。  
**4-9.** 分别对应时钟偏差、队列延迟、处理延迟，总和应小于门限。

## 拓展阅读

1. **Kleppmann, M. (2017). *Designing Data-Intensive Applications*.**
2. **Hohpe, G. & Woolf, B. (2003). *Enterprise Integration Patterns*.**
3. **Bass, L., Clements, P. & Kazman, R. (2021). *Software Architecture in Practice*.**
4. **Lei et al. (2025b). 自主智能水网架构。**
5. **Lei et al. (2025c). 在环测试系统。**
