<!-- 变更日志
v1 2026-02-16: 初稿（基于“继续”命令自动续写）
-->

# ch09 发电-泄洪一体化建模

## 9.1 学习目标

完成本章后，读者应能够：

1. 建立沙坪水电站发电-泄洪一体化的状态空间建模框架；
2. 将 ch08 的硬约束/软约束/治理约束映射到可计算模型；
3. 构建兼顾发电收益、防洪安全与调节平滑性的目标函数；
4. 给出“硬约束不可行时最小风险状态（MRS）”的形式化表达；
5. 产出可直接用于 ch10 控制设计与 ch11 梯级协同的一致接口。

> 承接 ch08：上一章已定义参数口径与约束分层，本章把这些工程语义转化为可求解模型。

## 9.2 问题定义与建模边界

沙坪场景下，一体化建模不是“单一优化器最大化发电功率”，而是多目标、分时标、受安全硬约束支配的动态决策问题。

建议以滚动窗口 $k=0,1,\dots,N-1$ 表示调度时域，主要变量为：

- 状态向量 $\mathbf{x}_k=[h_k,\,s_k,\,\mathbf{x}_{unit,k}]^\top$；
- 控制向量 $\mathbf{u}_k=[P_{set,k},\,g_k]^\top$；
- 扰动向量 $\mathbf{d}_k=[Q_{in,k},\,P_{grid,k}]^\top$；
- 输出向量 $\mathbf{y}_k=[Q_{out,k},\,h_k,\,P_k]^\top$。

其中 $h$ 为库水位，$s$ 为等效库容状态，$P_{set}$ 为机组功率设定，$g$ 为闸门开度。 

[工程解释] 该定义保证“水力过程（$h,s,Q$）”与“电力过程（$P$）”在同一模型内耦合，避免后续控制器只优化发电、忽略泄洪安全。

## 9.3 动态模型：水位-流量-功率耦合

### 9.3.1 库容连续方程离散化

[物理直觉] 水库水位变化的本质由“入流减出流”决定，这是质量守恒。

$$
s_{k+1}=s_k+\Delta t\,(Q_{in,k}-Q_{out,k})
$$

其中 $\Delta t$ 为离散步长。由库容-水位曲线近似可得：

$$
h_{k+1}=f_h(s_{k+1})
$$

若在工作点线性化，可写成：

$$
h_{k+1}\approx a_h h_k+b_h(Q_{in,k}-Q_{out,k})
$$

### 9.3.2 出流分解：机组流量与泄洪流量

$$
Q_{out,k}=Q_{tur,k}+Q_{spill,k}
$$

其中：

- $Q_{tur,k}=f_t(P_{set,k},h_k,\mathbf{x}_{unit,k})$；
- $Q_{spill,k}=f_g(g_k,h_k,h_{d,k})$。

[工程解释] 机组出力与耗水量并非固定比例，受有效水头和机组效率区间影响；闸门泄量同时受上/下游水位差影响，不能仅由开度线性外推。

### 9.3.3 机组状态转移

$$
\mathbf{x}_{unit,k+1}=\mathbf{A}_u\mathbf{x}_{unit,k}+\mathbf{B}_u\mathbf{u}_k+\mathbf{E}_u\mathbf{d}_k
$$

状态可包含开停机标志、最小开机时长计数、检修可用性标志等。

## 9.4 约束分层映射（补齐 ch08/ch07 跟踪项）

### 9.4.1 硬约束（必须满足）

$$
h_{min}\le h_k\le h_{max}
$$

$$
0\le g_k\le g_{max},\quad 0\le P_{set,k}\le P_{max}^{avail}
$$

$$
Q_{out,k}\le Q_{safe}(h_k,\text{downstream state})
$$

以及联锁/保护逻辑约束（以逻辑变量或混合整数形式表达）：

$$
\phi_{interlock}(\mathbf{x}_k,\mathbf{u}_k)=1
$$

### 9.4.2 软约束（代价惩罚）

$$
|P_k-P_{grid,k}|\rightarrow \min, \quad |h_k-h_k^{ref}|\rightarrow \min
$$

$$
\|\Delta \mathbf{u}_k\|_2^2\rightarrow \min
$$

可通过权重项并入目标函数。

### 9.4.3 治理约束（可追溯）

治理约束不直接改变物理可行域，但改变“可发布策略集合”：

- 策略版本必须绑定 `constraint_profile_version`；
- 人机切换必须存在 `operator_action_log`；
- 关键回退必须有 `fallback_reason_code`。

[工程解释] 物理可行不等于可上线；缺审计链条的策略在工程上应视为不可发布。

[图9-1: 三层约束到优化问题的映射关系]
{描述: 展示硬约束进入可行域、软约束进入目标函数、治理约束进入发布门禁与审计链条。}
{尺寸: 全页}
{颜色方案: 蓝色系}

## 9.5 目标函数设计：收益-安全-平滑三目标

可定义阶段代价并进行加权求和：

$$
J=\sum_{k=0}^{N-1}\left(\lambda_p J_{power,k}+\lambda_h J_{level,k}+\lambda_u J_{smooth,k}+\lambda_r J_{risk,k}\right)
$$

其中：

$$
J_{power,k}=\|P_k-P_{grid,k}\|_2^2
$$

$$
J_{level,k}=\|h_k-h_k^{ref}\|_2^2
$$

$$
J_{smooth,k}=\|\Delta P_{set,k}\|_2^2+\|\Delta g_k\|_2^2
$$

$$
J_{risk,k}=\rho(h_k,Q_{out,k})
$$

$\rho(\cdot)$ 可为接近安全边界时快速增大的屏障函数。

[物理直觉] 防洪安全不是“超限后再处罚”，而应在靠近边界时就显著抬高代价，主动远离风险区域。

## 9.6 最小风险状态（MRS）建模表达（补齐评审建议）

当预测窗口内硬约束集合不可行（如极端来水+机组受限）时，模型应切换到 MRS（Minimal Risk State）而非继续追求经济目标。

### 9.6.1 不可行判据

若优化问题无可行解，记为：

$$
\mathcal{F}(\mathbf{x}_k,\mathbf{d}_{k:k+N})=\varnothing
$$

触发 MRS 模式。

### 9.6.2 MRS 目标

$$
\min \sum_{k=0}^{N-1}\left(\omega_h\,\xi_{h,k}+\omega_q\,\xi_{q,k}+\omega_u\|\Delta \mathbf{u}_k\|_1\right)
$$

其中 $\xi_{h,k},\xi_{q,k}$ 为对硬约束的最小松弛变量（仅在绝对必要时启用），并满足：

$$
\xi_{h,k}\ge 0,\;\xi_{q,k}\ge 0,\;\omega_h,\omega_q \gg \omega_u
$$

[工程解释] 该表达体现“先保结构安全和人身安全，再考虑动作平滑与设备损耗”。

### 9.6.3 MRS 输出动作

- 强制降载或限发；
- 预泄与闸门受控开度序列；
- 触发上级调度与人工确认；
- 自动生成事件包进入审计流程。

[表9-1: MRS触发条件—控制动作—治理动作对照表]
{描述: 列包括触发源、不可行类型、自动控制动作、人工确认要求、审计字段、退出条件。}
{尺寸: 半页}
{颜色方案: 灰度}

## 9.7 分层求解框架

为兼顾实时性与可解释性，建议采用两层求解：

1. **层L2（分钟至小时）**：滚动优化 $P_{set}$ 与目标库水位轨迹；
2. **层L1（秒至分钟）**：在L2目标下执行机组/闸门跟踪与联锁保护。

层间接口建议：

- `l2_dispatch_plan_id`；
- `l1_tracking_profile`；
- `mrs_flag`；
- `release_gate`（发布门禁状态）。

[图9-2: 发电-泄洪一体化分层求解流程]
{描述: 从来水与电网预测输入开始，经L2优化、L1跟踪、联锁保护与治理审计，形成闭环。}
{尺寸: 全页}
{颜色方案: 蓝色系}

## 9.8 可复现实例：晚高峰叠加来水突增

【例9-1】某日18:00-22:00窗口，电网要求提高出力，且上游来水突增。给定教学化参数：

- $P_{grid}$ 阶跃上调；
- $Q_{in}$ 预测上偏；
- 初始水位接近上限；
- 一台机组可用容量受检修后限制。

**任务**：比较常规模式与 MRS 模式下的决策差异。

**解题过程**：
1. 先在常规目标函数下求解，检查可行域是否为空；
2. 若不可行，切入 MRS：放弃部分功率跟踪，优先控制水位与下泄风险；
3. 输出控制序列与审计字段，记录 `mrs_flag=true`；
4. 评估退出条件：来水回落且硬约束恢复可行后，逐步退出 MRS。

**结果讨论**：
在极端工况下，MRS 使系统从“优化失败”转为“风险最小化可执行”，这是工程可用性的关键。

## 9.9 本章小结

本章完成了沙坪发电-泄洪一体化模型构建，给出了状态方程、三层约束映射、三目标代价函数与最小风险状态（MRS）表达。至此，Part II 已具备可计算建模基础。下一章将在此基础上设计“认知智能+ODD+HDC”控制架构与发布门禁。

## 习题

### 基础题

1. 为什么硬约束应作为可行域约束而不是软惩罚项？
2. 写出库容连续方程的离散形式，并解释各项物理意义。
3. 说明 MRS 中松弛变量与常规软约束惩罚的区别。

### 应用题

4. 依据本章框架，构建一个 6 步滚动优化的变量与约束清单。  
5. 设计一条“不可行检测→MRS触发→治理留痕→退出MRS”的状态机。

### 思考题

6. 若长期频繁触发 MRS，应优先调整模型、设备、还是调度规则？请给出分层治理建议。

### 基础题参考答案要点

1. 因硬约束对应安全与结构边界，违反代价不可被经济收益抵消。  
2. $s_{k+1}=s_k+\Delta t(Q_{in,k}-Q_{out,k})$，表示库容由净入流累积变化。  
3. MRS 松弛变量用于“不可行时最小违约”，常规软约束用于“可行域内优化偏好”。

## 拓展阅读

1. Van Overloop, P.J. (2006). *Model Predictive Control on Open Water Systems*.  
2. Kundur, P. (1994). *Power System Stability and Control*.  
3. Lei et al. (2025c). 在环测试系统与发布门禁。  
4. ASCE (2014). *MOP 131: Canal Automation for Irrigation Systems*.  
5. ISO 31000 (Risk Management Guidelines).

> **术语一致性声明**：本章统一采用“模型预测控制（Model Predictive Control, MPC）”“分层分布式控制（Hierarchical Distributed Control, HDC）”“运行设计域（Operational Design Domain, ODD）”“安全包络（Safety Envelope）”“在环测试（In-the-Loop Testing）”等规范术语；数学符号采用 $Q,h,\tau,T_p,T_c,\mathbf{x},\mathbf{u},\mathbf{y},J$。

### 质量检查清单（执行结果）

- [x] 章首学习目标、章末小结/习题/拓展阅读完整；
- [x] 基础题3 + 应用题2 + 思考题1，含基础题答案要点；
- [x] 公式前有物理直觉，公式后有工程解释；
- [x] 含可复现实例（例9-1）；
- [x] 图表不少于2项（图9-1、图9-2、表9-1）；
- [x] 章首回顾ch08，章末预告ch10；
- [x] 已补齐ch07/ch08对ch09提出的约束分层示例与MRS建模表达跟踪项。
