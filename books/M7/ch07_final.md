<!-- 变更日志
v1 2026-02-16: 初稿
-->

# ch07 安全门禁与审计系统

## 7.1 学习目标

完成本章后，读者应能够：

1. 理解 HydroOS 安全门禁（Gatekeeping）在运行链路中的角色与优先级；
2. 设计面向策略发布、控制执行、权限操作的分层门禁规则；
3. 构建门禁规则版本化管理与变更审批矩阵；
4. 建立审计事件模型与可追溯复盘流程；
5. 给出异常触发下的联锁、降级与问责闭环。

> 本章承接 ch06：算法服务已可托管，本章进一步回答“哪些动作可以执行、谁有权执行、执行后如何问责”。

## 7.2 安全门禁的系统定位

HydroOS 中安全门禁不是外围插件，而是控制链路中的强制检查点。任何控制意图必须经过门禁放行后才能进入执行层。

[物理直觉] 在水工系统里，闸门动作前必须确认上下游安全边界；软件系统里同样需要动作前的硬门禁。

门禁覆盖三类对象：

- **策略对象**：模型版本、参数组、约束集；
- **动作对象**：控制命令、联锁触发、回滚指令；
- **操作对象**：人工接管、权限变更、紧急放行。

[工程解释] 门禁目标是“阻断高风险动作”，而非“增加审批流程负担”。

## 7.3 分层门禁规则体系

建议规则分为三层：

1. **L1 合规门禁**：权限、签名、版本合法性；
2. **L2 运行门禁**：ODD 匹配、安全包络、时序预算；
3. **L3 联锁门禁**：红区触发、设备异常、通信失效。

推荐执行顺序：L1 → L2 → L3，任一层失败即拒绝动作并触发回退策略。

[表7-1: 分层门禁规则模板]
{描述: 列包括规则层级、校验项、输入字段、失败动作、人工确认要求、审计字段。}
{尺寸: 半页}
{颜色方案: 灰度}

## 7.4 门禁规则版本化与审批矩阵（补齐ch06遗留项）

为补齐 ch06 跟踪项，本章给出版本化管理规范：

- 规则版本号：`GK-major.minor.patch`；
- 规则变更类型：
  - major：影响安全边界或联锁逻辑；
  - minor：新增校验项或阈值微调；
  - patch：文案/非功能修订。

审批矩阵建议：

- major：技术负责人 + 安全负责人 + 值守主管三签；
- minor：技术负责人 + 值守主管双签；
- patch：模块负责人单签并备案。

[工程解释] 版本化不是形式化文档，而是事故后责任溯源的关键依据。

## 7.5 审计事件模型

审计系统建议记录“人—策略—动作—结果”四元组：

- `actor_id`、`role`、`approval_chain`；
- `policy_version`、`model_version`；
- `action_type`、`target_asset`、`trace_id`；
- `result`、`latency_ms`、`rollback_flag`、`reason_code`。

审计事件最小落盘要求：

- 关键动作落盘成功率 = 100%；
- 审计延迟 P95 ≤ 2 s；
- 审计记录不可篡改（签名或哈希链）。

[图7-1: 门禁决策与审计链路]
{描述: 展示规则校验、决策结果、执行反馈、审计归档与复盘查询全链路。}
{尺寸: 全页}
{颜色方案: 蓝色系}

## 7.6 门禁时序预算

门禁处理应满足：

$$
\tau_{auth}+\tau_{rule}+\tau_{risk}+\tau_{audit}\le \tau_{gate}^{budget}
$$

其中：

- $\tau_{auth}$：权限与身份校验；
- $\tau_{rule}$：规则计算；
- $\tau_{risk}$：风险评估；
- $\tau_{audit}$：审计落盘确认。

建议关键控制路径 $\tau_{gate}^{budget}\le 200$ ms。

[物理直觉] 门禁太慢会拖垮实时控制，门禁太弱会放大安全风险，二者必须平衡。

## 7.7 可复现实例：规则变更引发的回滚处置

【例7-1】某站点将黄色告警阈值从 0.85 收紧至 0.75（minor 版本变更），上线后 30 min 内告警量显著上升，触发多次非必要降级。

**已知**：

- 变更版本：`GK-2.3.0`；
- 历史基线：每小时黄色告警 12 次；
- 当前观测：每小时黄色告警 41 次。

**求解**：设计审计驱动的回滚流程。

**解题过程**：

1. 触发异常门禁：告警倍率超过 2 倍阈值；
2. 审计系统检索变更链路，确认唯一主要变更为 `GK-2.3.0`；
3. 回滚至 `GK-2.2.4`，并保持联锁规则不变；
4. 生成复盘报告：记录审批链、影响范围、改进建议。

**结果讨论**：
版本化门禁 + 审计链路使“问题定位—回滚—问责”可在短时间内闭环完成。

## 7.8 本章小结

本章构建了 HydroOS 的治理底座：通过分层门禁规则、版本化审批矩阵和审计事件模型，将控制系统从“能运行”提升到“可治理、可问责、可复盘”。下一章将进入在环测试与发布流水线，讨论如何把门禁规则嵌入工程交付流程。

## 习题

### 基础题

1. 为什么门禁规则必须分层而不是单一阈值判断？
2. major/minor/patch 三类门禁规则变更在审批上有何差异？
3. 解释门禁时序预算公式中四项时延含义。

### 应用题

4. 设计一份门禁规则变更审批矩阵，给出不同变更级别的签批角色与时限。  
5. 设计审计事件最小字段清单，并说明哪些字段用于责任追溯。

### 思考题

6. 在极端应急场景下，是否允许“临时越权放行”？若允许，应设置哪些补偿性审计机制？

### 基础题参考答案要点

1. 因权限、运行约束和联锁风险属于不同风险层次，需分层校验。  
2. major需最高级多方审批，minor中等级双签，patch可简化备案。  
3. 分别对应认证、规则计算、风险评估、审计确认，总和受门禁预算约束。

## 拓展阅读

1. NIST SP 800-53 Rev.5 (Security and Privacy Controls).  
2. ISO/IEC 27001 (latest).  
3. Kleppmann, M. (2017). *Designing Data-Intensive Applications*.  
4. Lei et al. (2025b). 自主智能水网架构。  
5. Lei et al. (2025c). 在环测试系统。

> **术语一致性声明**：本章统一采用“水网操作系统（Water Network Operating System, HydroOS）”“运行设计域（Operational Design Domain, ODD）”“安全包络（Safety Envelope）”“在环测试（In-the-Loop Testing）”“模型预测控制（Model Predictive Control, MPC）”等规范术语；数学符号采用 $Q,h,\tau,T_p,T_c,\mathbf{x},\mathbf{u},\mathbf{y},J$。

### 质量检查清单（执行结果）

- [x] 章首学习目标、章末小结/习题/拓展阅读完整；
- [x] 基础题3 + 应用题2 + 思考题1，含基础题答案要点；
- [x] 公式前有物理直觉，公式后有工程解释；
- [x] 含可复现实例（例7-1）；
- [x] 图表不少于2项（图7-1、表7-1）；
- [x] 章首回顾ch06，章末预告ch08。
