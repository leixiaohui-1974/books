<!-- 变更日志
v1 2026-02-16: 初稿
-->

# ch03 设备抽象层与驱动适配

## 3.1 学习目标

完成本章后，读者应能够：

1. 理解设备抽象层（Device Abstraction Layer, DAL）在 HydroOS 中的角色与边界；
2. 设计面向多厂商 PLC/RTU/传感器/执行器的统一资源模型；
3. 构建驱动适配器的生命周期管理（注册、健康检查、降级、下线）；
4. 给出协议适配测试基线与验收门禁；
5. 建立设备故障场景下的保底控制与审计闭环。

> 本章承接 ch02：在总体架构明确后，首先下钻到 L0 设备抽象层，解决“异构设备如何变成可统一调度对象”的核心问题。

## 3.2 为什么必须做设备抽象

在工程现场，设备协议多样（Modbus、IEC 104、OPC UA、私有串口协议），点位命名与质量标记也常不一致。若上层应用直接耦合设备协议，将导致：

- 策略无法跨站复制；
- 升级改造牵一发动全身；
- 故障定位依赖个别工程师经验。

[物理直觉] 不同口径的管道不能直接拼接，必须先做标准化接头；设备抽象层就是软件系统里的“标准接头”。

[工程解释] DAL 的价值不在“多写一层代码”，而在于隔离变化：设备侧可替换、应用侧可复用。

## 3.3 统一资源模型

建议将设备抽象为三类资源对象：

1. **Telemetry Point**（测点）：只读，带质量位与时间戳；
2. **Control Point**（控点）：可写，带约束与回执；
3. **Asset Node**（资产节点）：聚合测点/控点与设备元数据。

最小字段建议：

- `asset_id`、`point_id`；
- `signal_type`（analog/digital/counter）；
- `unit`、`range_min`、`range_max`；
- `quality_code`、`timestamp`；
- `command_ack`、`fallback_mode`。

[表3-1: 统一设备资源模型字段模板]
{描述: 列包括字段名、含义、类型、是否必填、门禁校验规则、异常处理动作。}
{尺寸: 半页}
{颜色方案: 灰度}

## 3.4 驱动适配器架构

每类协议建议实现独立 Adapter，并统一暴露以下接口：

- `connect()`：建立会话与认证；
- `read_points()`：批量读取测点；
- `write_points()`：写入控点并等待回执；
- `health_check()`：输出连接质量与错误计数；
- `disconnect()`：优雅下线。

Adapter 管理器负责：

- 驱动注册与版本管理；
- 周期健康检查；
- 失败重试与熔断；
- 与门禁中心联动触发降级。

[图3-1: 驱动适配器与DAL调用链]
{描述: 展示HydroOS运行时通过Adapter访问多协议设备的调用路径与错误回退路径。}
{尺寸: 全页}
{颜色方案: 蓝色系}

## 3.5 协议适配测试基线

为满足 ch02 遗留项，本章给出多厂商协议适配测试基线。建议按四类用例执行：

1. **功能正确性**：读写值、单位、量纲、方向一致；
2. **时序性能**：P95 读取时延、写入回执时延；
3. **异常韧性**：断链、错码、抖动、重复报文处理；
4. **安全门禁**：越权写入拒绝、非法点位拒绝、审计落盘完整。

测试基线判定建议：

- 关键控点写入成功率 ≥ 99.9%；
- 写入回执 P95 ≤ 200 ms；
- 异常恢复时间 ≤ 2 个控制周期；
- 审计事件缺失率 = 0。

[工程解释] 这些阈值可按站点调整，但必须作为上线前强制门禁，而非建议项。

## 3.6 设备抽象层时序预算

对 DAL 可定义时序预算：

$$
\tau_{collect}+\tau_{normalize}+\tau_{dispatch}\le \tau_{ingest}^{budget}
$$

其中：

- $\tau_{collect}$：协议采集时延；
- $\tau_{normalize}$：字段标准化与质量位映射时延；
- $\tau_{dispatch}$：分发到数据总线时延。

[物理直觉] 如果“量测进站”已经超时，上层再聪明也无法做出实时决策。

[工程解释] 设备层预算应与 ch02 架构级预算联动，超预算时优先降采样非关键测点。

## 3.7 可复现实例：多协议站点接入验收

【例3-1】某泵站群包含三类设备：PLC-A（OPC UA）、RTU-B（IEC 104）、老旧闸控器-C（Modbus RTU）。要求在 1 周内完成 HydroOS 接入并通过门禁验收。

**已知**：

- 控制周期 $T_c=1$ s；
- DAL 接入预算 $\tau_{ingest}^{budget}=300$ ms；
- 关键控点写入回执门限 P95 ≤ 200 ms。

**求解**：设计接入步骤与验收判定。

**解题过程**：

1. 建立统一点位字典与单位映射，完成 `asset_id/point_id` 标准化；
2. 分别开发三类 Adapter，并统一健康检查输出字段；
3. 执行四类测试基线，记录每类协议的 P95 时延与失败率；
4. 若 Modbus 设备回执超阈值，先限制其高频控制权限并设置保底规则；
5. 全部门禁通过后再开放全量调度权限。

**结果讨论**：
通过“统一模型+分协议适配+统一门禁”流程，可在不改造全部存量设备前提下实现可控接入。

## 3.8 本章小结

本章完成了 HydroOS L0 层的关键设计：统一资源模型、驱动适配器体系、协议测试基线与时序预算联动机制。设备抽象层把“异构现场设备”转化为“可治理的软件对象”，为后续实时数据总线与策略编排提供了稳定输入。下一章将进入实时数据总线与事件系统，讨论数据一致性与事件驱动协同。

## 习题

### 基础题

1. 为什么 DAL 是 HydroOS 的“变化隔离层”？
2. 统一资源模型中为什么必须包含 `quality_code` 与 `timestamp`？
3. 解释 DAL 时序预算公式各项含义。

### 应用题

4. 针对一个含 OPC UA 与 Modbus 混合站点，设计适配器健康检查指标与告警阈值。  
5. 设计一份“协议适配上线验收单”，至少包含功能、性能、异常、安全四类判定项。

### 思考题

6. 若现场存在无法升级的老旧设备，你如何在保证安全前提下纳入 HydroOS 统一调度？

### 基础题参考答案要点

1. 它隔离设备协议差异，避免上层应用直接耦合现场异构细节。  
2. 质量位与时间戳决定数据是否可信、是否可用于实时控制。  
3. 分别对应采集、标准化、分发时延，总和应受接入预算约束。

## 拓展阅读

1. OPC Foundation (2022). *OPC UA Specification Overview*.  
2. IEC 60870-5-104 Companion Standard (latest).  
3. Modbus Organization (2012). *Modbus Application Protocol Specification*.  
4. Bass, L., Clements, P. & Kazman, R. (2021). *Software Architecture in Practice*.  
5. Lei et al. (2025c). 在环测试系统。

> **术语一致性声明**：本章统一采用“水网操作系统（Water Network Operating System, HydroOS）”“运行设计域（Operational Design Domain, ODD）”“安全包络（Safety Envelope）”“模型预测控制（Model Predictive Control, MPC）”“在环测试（In-the-Loop Testing）”等规范术语；数学符号采用 $Q,h,\tau,T_p,T_c,\mathbf{x},\mathbf{u},\mathbf{y},J$。

### 质量检查清单（执行结果）

- [x] 章首学习目标、章末小结/习题/拓展阅读完整；
- [x] 基础题3 + 应用题2 + 思考题1，含基础题答案要点；
- [x] 公式前有物理直觉，公式后有工程解释；
- [x] 含可复现实例（例3-1）；
- [x] 图表不少于2项（图3-1、表3-1）；
- [x] 章首回顾ch02，章末预告ch04。
