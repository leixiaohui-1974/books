<!-- 变更日志
v1 2026-02-19: 初稿
-->

# 第二章 数字孪生与仿真环境构建

---

> 第一章阐明了在环验证的必要性和总体框架。本章转向在环验证的基础设施建设——仿真环境。正如赛车手在上赛道前需要一个逼真的模拟器，水利控制系统在上线前需要一个忠实模拟水网行为的数字孪生体。仿真环境的质量直接决定了在环验证的有效性。

---

## 学习目标

完成本章后，读者应能够：

1. 定义水利数字孪生的概念内涵，区分静态数字模型（Digital Model）、动态数字影子（Digital Shadow）和闭环数字孪生（Digital Twin）三个层次；
2. 区分离线仿真、实时仿真和超实时仿真三类仿真形态的适用场景，并能够根据在环测试需求选择合适的仿真形态；
3. 阐述FMI/FMU封装标准的基本原理和工程应用，能够将水力学模型封装为FMU组件并参与联合仿真；
4. 设计水利系统联合仿真框架，协调水力学模型、设备模型、通信模型和环境模型之间的时间步进和数据交换；
5. 应用仿真环境校验方法（包括模型验证、代码验证和不确定性量化），评估仿真结果的可信度。

---

## 2.1 数字孪生的概念与层次

### 2.1.1 从CAD图纸到数字孪生

水利工程的信息化表达经历了三个阶段的演进。

第一阶段是**电子化**——将传统的纸质图纸、设计计算书和运行规程转化为电子文件。这个阶段产生的是"数字文档"，它们是物理世界的静态记录，不具备仿真或交互能力。

第二阶段是**模型化**——建立水利系统的数学模型和计算模型。水力学仿真模型（如基于Saint-Venant方程的一维模型）、结构分析模型、水资源调配模型等，能够在给定输入条件下预测系统行为。这个阶段产生的是"数字模型"（Digital Model），它们可以进行"what-if"分析，但与物理系统之间没有实时的数据连接。

第三阶段是**孪生化**——建立与物理系统实时连接、持续同步的数字副本。数字孪生（Digital Twin）不仅包含系统的数学模型，还通过传感器数据实现与物理系统的双向数据流：物理系统的实时状态持续更新数字孪生的参数和边界条件，数字孪生的分析结果反馈指导物理系统的运行决策。

Michael Grieves在2003年首次提出数字孪生概念时，定义了三个核心要素：物理实体（Physical Entity）、虚拟实体（Virtual Entity）和连接（Connection）。在水利系统中：

物理实体是实际的水利工程——渠道、闸门、水泵、管道、水库以及它们构成的水网。虚拟实体是对应的数字模型——水力学仿真模型、设备动力学模型、控制系统模型和通信网络模型。连接是SCADA系统提供的双向数据通道——传感器数据从物理侧流向虚拟侧，控制指令和分析结果从虚拟侧流向物理侧。

### 2.1.2 水利数字孪生的三个层次

根据虚实之间的数据流方向和交互深度，水利数字孪生可以分为三个层次。

**数字模型（Digital Model）**是最基础的层次。数字模型是物理系统的数学表达，可以接受人工输入的边界条件进行仿真计算，但与物理系统之间不存在自动化的数据交换。典型应用包括：工程设计阶段的水力学计算、调度方案的离线优化、以及本书重点讨论的MIL测试。在MIL测试中，控制算法与数字模型闭环运行，验证算法在理想化条件下的行为。

**数字影子（Digital Shadow）**增加了从物理系统到虚拟系统的单向数据流。SCADA系统采集的实时运行数据（水位、流量、闸门开度、水泵状态等）自动传输到数字影子中，驱动数字模型的边界条件更新和参数校正。数字影子可以实现：实时状态监测、异常检测（将实测值与模型预测值对比）、短期预测（基于当前状态推演未来趋势）。但数字影子的分析结果不自动反馈到物理系统——是否采纳取决于人类调度员的判断。

**数字孪生（Digital Twin）**实现了物理系统与虚拟系统之间的双向数据流。在数字影子的基础上，数字孪生的分析结果可以直接或间接地影响物理系统的控制行为——例如，数字孪生检测到模型参数偏移后自动更新控制器参数，或者数字孪生的预测结果触发安全联锁动作。完整的数字孪生是水网自主运行的基础设施——它使得控制系统能够基于对水网状态的持续、准确、全面的"感知"做出决策。

**表2-1 水利数字孪生三层次对比**

| 维度 | 数字模型 | 数字影子 | 数字孪生 |
|------|---------|---------|---------|
| 数据流方向 | 手动输入→模型 | 物理→虚拟（自动） | 物理⇄虚拟（双向） |
| 实时性 | 非实时 | 准实时 | 实时 |
| 模型更新 | 手动 | 自动（单向） | 自动（双向） |
| 在环测试角色 | MIL环境 | SIL辅助 | HIL/运行时监控 |
| 技术成熟度 | 高 | 中-高 | 中 |

### 2.1.3 水利数字孪生的特殊性

与制造业、航空等领域的数字孪生相比，水利数字孪生具有若干特殊性。

**空间尺度跨度大**。水利系统的空间尺度从厘米级（闸门密封间隙）到千公里级（调水工程全线），跨越了6-7个数量级。数字孪生需要在不同空间尺度上采用不同分辨率的模型，并处理模型之间的尺度耦合问题。

**时间尺度跨度大**。水利过程的时间尺度从秒级（水锤波传播）到年级（水库调蓄周期），跨越了7-8个数量级。不同时间尺度的过程需要不同的仿真步长和更新频率，这对联合仿真框架的时间同步机制提出了挑战。

**物理过程高度非线性**。明渠水流的圣维南方程是双曲型偏微分方程，在断面突变、闸门调节和水跃等场景下表现出强非线性。这种非线性意味着线性化分析和小扰动假设可能不适用，仿真模型需要保留完整的非线性特性。

**环境边界条件不确定**。水利系统的输入（来水量、降雨、蒸发）受气象因素影响，具有显著的随机性和不确定性。数字孪生需要处理这种输入不确定性，并将其传播到输出的不确定性估计中。

---

## 2.2 三类仿真形态

### 2.2.1 离线仿真

离线仿真（Offline Simulation）不受实时时钟约束，仿真时间可以快于或慢于物理时间。在水利在环验证中，离线仿真主要用于MIL测试和大规模场景扫描。

离线仿真的核心优势是**加速比**。在MIL测试中，仿真模型可以以物理时间的100-1000倍速度运行（取决于模型复杂度和计算资源），使得在几分钟到几小时内完成数百个场景的仿真测试成为可能。这种加速能力对于蒙特卡洛分析（遍历参数空间）和敏感性分析（扫描参数变化范围）尤为重要。

离线仿真的典型工具链包括：MATLAB/Simulink（控制算法建模和仿真）、Python/SciPy（自定义仿真脚本）、SIC（法国INRAE的灌溉渠道仿真软件）、MIKE 11/MIKE+（丹麦DHI的水力学仿真软件）。在CHS体系中，HydroOS集成了基于Python的离线仿真框架，支持控制策略与水力学模型的批量化MIL测试。

离线仿真的局限在于：它无法验证与实时性相关的问题（如通信延迟、任务调度抖动）；它使用的是控制算法的原始形式（如Python脚本或Simulink模型），而非目标平台的执行代码；它与真实硬件没有交互，无法发现硬件兼容性问题。

### 2.2.2 实时仿真

实时仿真（Real-Time Simulation）要求仿真时间严格等于物理时间——仿真中的1秒对应物理世界的1秒。实时仿真是SIL测试（软实时）和HIL测试（硬实时）的基础。

**软实时仿真**用于SIL测试。软件栈运行在PC或工业计算机上，仿真模型以实时速率提供输入信号。软实时允许偶尔的时间步超限（jitter），只要平均执行速率满足实时要求。软实时仿真适用于验证软件逻辑的正确性和通信协议的时序行为，但不用于验证严格的硬实时约束。

**硬实时仿真**用于HIL测试。仿真模型运行在专用的实时仿真器（如dSPACE SCALEXIO、NI PXI、OPAL-RT等）上，每个仿真步长必须在规定时间内完成。硬实时的要求来自于物理接口的时序约束——如果仿真器不能在规定时间内更新模拟信号输出，控制器接收到的信号将出现不连续或失真，导致测试结果失去意义。

水力学模型的实时仿真面临一个特殊挑战：圣维南方程的数值求解通常需要较细的空间离散和较短的时间步长以保证数值稳定性（CFL条件），但实时仿真要求每个时间步长的计算在固定时间（如1ms或10ms）内完成。当水力系统规模较大时（如百公里级调水渠道），全维模型可能无法满足实时约束。

解决这一矛盾的技术路线有三种：（1）使用降阶模型（ROM）替代全维模型，牺牲一定精度换取计算速度——M1《明渠水动力降阶建模》详细讨论了各种降阶方法；（2）使用并行计算在多核处理器或FPGA上加速仿真计算；（3）采用异步多速率仿真（multi-rate simulation），对快变量（如水锤波）使用细步长、对慢变量（如渠道水位）使用粗步长。

### 2.2.3 超实时仿真

超实时仿真（Faster-than-Real-Time Simulation）是近年来兴起的仿真模式，仿真速度快于物理时间但通常不超过10-50倍。超实时仿真的典型应用是"前瞻预测"——在当前时刻启动一次超实时仿真，在物理过程发生之前"预见"未来几小时或几天的系统状态。

在在环验证的语境下，超实时仿真有两个重要应用。

第一，**验证前瞻控制策略**。模型预测控制（MPC）等前瞻性控制算法需要在每个控制步内求解一个包含未来N步的优化问题。如果控制步为5分钟、预测时域为2小时，则MPC求解器需要在5分钟内完成24步的仿真和优化。超实时仿真能力确保MPC的计算可以在规定时间内完成。

第二，**加速HIL测试**。传统HIL测试严格实时运行，测试一个24小时的调度场景需要24小时的实际时间。在某些不涉及硬件时序约束的测试环节（如策略逻辑验证的回放测试），使用超实时仿真可以将测试时间压缩到数小时甚至数十分钟。但需要注意，涉及硬件响应时间和通信时延验证的测试不能使用超实时模式。

**表2-2 三类仿真形态对比**

| 维度 | 离线仿真 | 实时仿真 | 超实时仿真 |
|------|---------|---------|----------|
| 时间比例 | 100x-1000x | 1x（严格） | 2x-50x |
| 实时约束 | 无 | 软实时/硬实时 | 软实时 |
| 主要用途 | MIL、场景扫描 | SIL、HIL | MPC验证、加速测试 |
| 模型精度 | 可用全维模型 | 可能需要降阶 | 需要降阶或并行化 |
| 硬件交互 | 无 | 软件接口/物理接口 | 软件接口 |
| 适用阶段 | 算法开发 | 系统集成 | 策略验证、回归测试 |

---

## 2.3 FMI/FMU封装标准

### 2.3.1 为什么需要模型封装标准

在环验证体系中，仿真环境通常需要集成来自不同来源的多个模型：水力学模型可能使用Fortran编写、闸门模型可能使用MATLAB/Simulink建模、通信网络模型可能使用NS-3仿真、控制算法可能使用C语言实现。这些模型使用不同的编程语言、数值求解方法和时间步进策略，如果没有统一的接口标准，将它们集成到一个联合仿真环境中将是一项艰巨的系统集成工作。

功能模拟接口（Functional Mock-up Interface, FMI）标准正是为解决这一问题而诞生的。FMI由Modelica协会发布，目前最新版本为FMI 3.0（2022年发布）。FMI定义了一套语言无关、平台无关的标准接口，使得任何仿真工具生成的模型都可以被打包为一个标准化的"黑盒"组件——功能模拟单元（Functional Mock-up Unit, FMU），并在任何支持FMI标准的仿真环境中运行。

### 2.3.2 FMU的结构与类型

一个FMU本质上是一个ZIP压缩包（扩展名为.fmu），包含以下内容：

**模型描述文件**（modelDescription.xml）：定义了FMU的输入变量、输出变量、参数、初始条件和能力标志（如是否支持变步长、是否提供导数信息等）。这是FMU的"说明书"，宿主仿真环境通过解析此文件了解FMU的接口和特性。

**二进制库**（binaries/目录下）：包含FMU的编译后代码，通常为动态链接库（.dll或.so文件）。二进制库实现了FMI标准定义的C函数接口——初始化（fmi3InstantiateXxx）、设置输入（fmi3SetXxx）、执行步进（fmi3DoStep）和获取输出（fmi3GetXxx）等。

**源代码**（sources/目录下，可选）：如果FMU的发布者选择提供源代码，宿主环境可以针对目标平台重新编译，以优化性能或适配特定的实时操作系统。

**资源文件**（resources/目录下，可选）：包含模型需要的额外数据文件，如参数表、特性曲线、查找表等。

FMI 3.0定义了两种FMU类型：

**协同仿真FMU（Co-Simulation FMU, CS-FMU）**：FMU内部集成了数值求解器，宿主环境只需要在每个通信步（communication step）通知FMU推进到下一时刻，FMU自行管理内部的积分步长和求解过程。CS-FMU适用于"黑盒"集成场景——宿主环境不需要了解FMU内部的数值方法。

**模型交换FMU（Model Exchange FMU, ME-FMU）**：FMU只提供模型方程（微分方程的右端函数），数值积分由宿主环境的求解器统一执行。ME-FMU适用于需要精确控制求解过程的场景——例如，当多个子系统之间存在强耦合时，统一的求解器可以更好地处理数值稳定性问题。

在水利在环验证中，CS-FMU更为常用，因为水力学模型通常有自己成熟的求解器（如Preissmann格式、显式Runge-Kutta方法），将其封装为CS-FMU可以保持求解器的优化特性。但在涉及水-闸-泵强耦合的场景中，ME-FMU配合统一求解器可能获得更好的数值稳定性。

### 2.3.3 水力学模型的FMU封装实践

将水力学模型封装为FMU涉及以下关键步骤。

**步骤一：接口定义**。确定FMU的输入变量和输出变量。对于一个渠段水力学模型，典型的输入包括：上游来水流量（或水位）、下游出水流量（或水位）、旁侧入流（或出流）、以及闸门/水泵的操作指令。典型的输出包括：渠段内各计算节点的水位和流量、闸门处的实际过流量、以及水力参数（如弗劳德数、雷诺数）。

**步骤二：时间步进接口实现**。实现fmi3DoStep函数，在每个通信步中：（1）从宿主环境获取输入变量的当前值；（2）将输入变量作为边界条件驱动水力学模型前进到下一时刻；（3）将模型输出通过FMI接口返回给宿主环境。需要注意的是，水力学模型的内部积分步长（由CFL条件决定）通常远小于通信步长，因此在一个通信步内可能需要执行多个内部积分步。

**步骤三：初始化与参数化**。实现初始化接口，允许宿主环境在仿真开始前设置模型参数（如渠道几何参数、糙率系数、初始水位等）。参数可以通过FMI的参数设置接口或通过资源文件传入。

**步骤四：状态保存与恢复**（可选但推荐）。实现状态快照（fmi3GetFMUState）和恢复（fmi3SetFMUState）接口，使得仿真可以保存当前状态并在需要时回滚。这一功能在在环验证中非常有用——例如，可以保存系统在某个特定时刻的状态，然后从同一状态出发测试多个不同的控制策略。

【例2-1】某明渠渠段长L=20km，矩形断面宽B=10m，底坡S₀=0.0002，曼宁糙率n=0.015。要求将其一维圣维南方程模型封装为CS-FMU，通信步长为60秒。

[已知]
- 渠段几何和水力参数如上所述
- 设计流量Q₀=30 m³/s，正常水深y₀≈2.1m
- 使用Preissmann隐格式求解，空间步长Δx=500m，内部时间步长Δt_int=10s

[求解] FMU接口设计

输入变量：
- Q_upstream (m³/s)：上游来水流量
- Q_downstream (m³/s)：下游出水流量
- Q_lateral[1..40] (m³/s)：40个计算节点处的旁侧入流

输出变量：
- y[1..41] (m)：41个断面的水位
- Q[1..41] (m³/s)：41个断面的流量
- Fr[1..41] (-)：各断面弗劳德数

通信步执行逻辑：
每次fmi3DoStep被调用时，FMU内部执行6个积分步（60s / 10s = 6步），在每个内部步中使用Preissmann格式求解圣维南方程。边界条件在通信步内保持不变（零阶保持）或线性插值（一阶保持）。

[结果讨论] 该封装方案的关键设计决策是通信步长（60s）与内部步长（10s）的比例。60秒的通信步长意味着控制系统每60秒更新一次闸门指令，这与实际SCADA系统的采样周期一致。内部步长10秒保证了CFL条件的满足（水面波速约3m/s，Δx=500m，Courant数≈0.06<1）。如果通信步长进一步缩短到10秒，每个通信步只包含1个内部步，虽然减小了控制延迟但增加了通信开销。这是在环测试中需要权衡的典型设计问题。

---

## 2.4 联合仿真框架

### 2.4.1 水利在环验证的联合仿真架构

在环验证的仿真环境通常不是单一模型，而是多个子模型的联合仿真。一个典型的水利在环验证仿真环境包括以下子系统模型：

**水力学子系统**：模拟渠道、管道、水库等水力基础设施中的水流行为。核心方程为圣维南方程（明渠）或水锤方程（管道）。空间尺度为米到公里级，时间尺度为秒到小时级。

**水工建筑物子系统**：模拟闸门、水泵、溢流堰等水工设施的动力学行为。包括闸门的机械运动方程（开度-时间曲线、速率限制、死区）、水泵的特性曲线（H-Q曲线、效率曲线、启停逻辑）。时间尺度为毫秒到秒级。

**传感器与通信子系统**：模拟传感器的测量特性（量程、精度、噪声、采样率、故障模式）和通信网络的传输特性（延迟、丢包率、带宽限制）。这一子系统对于SIL和HIL测试尤为重要——它决定了控制器接收到的信息质量。

**环境子系统**：模拟外部环境条件，包括气象条件（降雨、温度、风速）、上游来水（水文过程）和用水需求（灌溉、供水、生态）。环境子系统通常基于历史数据回放或随机过程生成。

**控制子系统**：被测试的控制策略。在MIL中以算法模型形式存在，在SIL中以目标代码形式存在，在HIL中运行在真实控制器硬件上。

### 2.4.2 时间同步策略

联合仿真的核心技术挑战是时间同步——如何协调不同子系统之间的时间步进和数据交换。

**固定步长同步**是最简单的策略。所有子系统使用相同的通信步长H，在每个通信步开始时交换数据，然后各自推进H时间。这种策略实现简单、行为确定，但通信步长H必须足够小以捕捉最快的子系统动态。如果不同子系统的特征时间尺度差异很大（如水锤波的毫秒级vs渠道水位的分钟级），固定步长策略要么浪费计算资源（步长取最小值）、要么丢失快变过程（步长取较大值）。

**变步长同步**允许不同子系统使用不同的通信步长，根据各自的动态特性自适应调整。快变子系统（如水锤）使用小步长，慢变子系统（如渠道水位）使用大步长。变步长策略的挑战是保持数据一致性——当快变子系统在两个慢变步之间执行多步时，慢变子系统提供的输入需要通过插值获得。

**事件驱动同步**适用于包含离散事件的仿真场景（如闸门开启/关闭、水泵启停、安全联锁触发）。当某个子系统产生离散事件时，通知联合仿真主控器暂停所有子系统，处理事件的影响，然后重新同步推进。这种策略保证了离散事件不被遗漏，但实现复杂度较高。

在水利在环验证中，推荐的策略是**分层多速率同步**：将子系统按特征时间尺度分组，组内使用固定步长同步，组间使用变步长或事件驱动同步。例如：水力学组（步长1-10s）、设备组（步长0.01-0.1s）、通信组（步长0.1-1s）。HydroOS的联合仿真引擎实现了这种分层多速率策略。

### 2.4.3 数据交换与外推

子系统之间的数据交换不仅涉及"交换什么"，还涉及"如何处理交换间隙"——在两个通信步之间，子系统需要估算对方输出的中间值。

**零阶保持（Zero-Order Hold, ZOH）**：在通信步之间，假设对方输出保持不变。这是最简单也最保守的方法，适用于变化缓慢的变量。

**一阶外推（First-Order Extrapolation）**：基于最近两个通信步的输出值，线性外推中间值。这种方法对线性变化的变量有更好的精度，但对突变（如闸门快速调节导致的流量突变）可能产生外推误差。

**高阶外推**：基于更多历史值进行多项式外推。理论精度更高，但在非光滑变量上可能产生振荡。

一般建议是：对水位、流量等连续变量使用一阶外推；对闸门开度、水泵状态等可能突变的变量使用零阶保持；对传感器输出使用零阶保持加采样延迟模拟。

---

## 2.5 仿真环境的校验

### 2.5.1 仿真可信度的概念

仿真环境是在环验证的"仲裁者"——控制策略在仿真环境中的表现决定了它是否被允许上线。因此，仿真环境本身的可信度（credibility）直接影响在环验证结论的有效性。一个不可信的仿真环境可能导致两种错误：将有缺陷的策略误判为合格（假阴性）、或将正确的策略误判为不合格（假阳性）。前者危害更大，因为它可能导致安全事故。

仿真可信度的评估包括三个层面：

**代码验证（Code Verification）**：验证仿真代码是否正确实现了数学模型。即使数学模型准确描述了物理现象，代码实现中的错误（如差分格式编程错误、边界条件处理不当、数值精度不足）也会导致仿真结果偏离数学模型的精确解。代码验证的典型方法包括：与解析解对比（如均匀流的曼宁公式解、简单水锤的Joukowski公式解）、收敛性分析（随网格加密或步长减小，数值解趋向精确解的阶数是否与理论一致）、以及制造解方法（Method of Manufactured Solutions, MMS）。

**模型验证（Model Validation）**：验证数学模型是否准确描述了物理现象。即使代码正确，模型的简化假设（如忽略侧向动量交换、忽略风应力、采用恒定糙率等）也可能导致模型预测与实际观测的偏差。模型验证的核心方法是将模型输出与实测数据（现场监测数据或实验室实验数据）对比，评估偏差的大小和分布特征。

**不确定性量化（Uncertainty Quantification, UQ）**：量化仿真结果中由模型参数不确定性、输入数据不确定性和数值方法误差引起的不确定性。在在环验证中，不确定性量化帮助回答"仿真结果可以被信任到什么程度"——如果仿真结果的不确定性范围覆盖了通过/不通过的判定边界，那么测试结论的可靠性就需要打折扣。

### 2.5.2 水利仿真模型的校验方法

**方法一：稳态校验**。在稳态条件下（所有变量不随时间变化），圣维南方程退化为曼宁公式或均匀流公式，存在解析解。将仿真模型在稳态条件下的输出与解析解对比，可以校验模型的基本正确性。稳态校验简单快速，但只能验证模型在一个工作点附近的行为。

**方法二：动态校验**。选取有实测数据的历史工况（如某次闸门调节过程的实测水位/流量过程线），将同样的边界条件输入仿真模型，对比仿真输出与实测值的时间序列。动态校验评估模型在瞬态过程中的精度，通常使用纳什-萨特克利夫效率系数（NSE）、均方根误差（RMSE）和峰值误差等指标。对于在环验证，推荐的最低校验标准是：NSE > 0.85、RMSE < 允许偏差的50%、峰值误差 < 允许偏差的30%。

**方法三：极端工况校验**。选取历史上发生过的极端工况（如最大洪水、最低流量、设备故障等），验证仿真模型在极端条件下的表现。极端工况校验的难点是实测数据的稀缺性——极端工况本身就是罕见事件，可能没有充分的实测数据用于对比。在这种情况下，可以使用跨模型验证（将待验证模型的结果与更精细或更成熟的参考模型对比）或物理一致性检验（验证结果是否满足质量守恒、能量守恒等基本物理定律）。

### 2.5.3 仿真环境的等级评定

参照美国航空航天学会（AIAA）和美国机械工程师学会（ASME）发布的仿真验证与确认指南，可以建立水利仿真环境的等级评定体系。

**表2-3 水利仿真环境校验等级**

| 等级 | 代码验证 | 模型验证 | 不确定性量化 | 适用测试阶段 |
|------|---------|---------|------------|-----------|
| A级（高可信） | 完整MMS验证+收敛性分析 | 多工况实测数据对比 | 完整的参数/输入UQ | HIL测试 |
| B级（中可信） | 解析解对比+基本收敛性 | 典型工况实测数据对比 | 关键参数UQ | SIL测试 |
| C级（基本可信） | 解析解对比 | 稳态校验 | 无或简化 | MIL测试 |

这一等级体系的含义是：MIL测试可以使用C级仿真环境（因为MIL的主要目的是验证算法逻辑而非精确的系统响应）；SIL测试应使用B级以上的仿真环境；HIL测试——作为上线前的最后验证——应使用A级仿真环境，以确保验证结论的可靠性。

---

## 2.6 HydroOS仿真服务架构

### 2.6.1 仿真即服务（Simulation-as-a-Service）

HydroOS水网操作系统提供了一种"仿真即服务"（Simulation-as-a-Service, SaaS）的架构，将仿真能力封装为可调用的微服务。

在这一架构下，仿真环境不是一个独立运行的桌面应用程序，而是HydroOS平台中的一个服务层。控制策略开发者通过标准API提交仿真任务（指定模型、场景、参数和输出要求），仿真服务自动分配计算资源、执行仿真、收集结果并返回。这种架构有几个优势：

**资源弹性**。仿真任务的计算需求可能差异很大——一个简单的MIL测试可能只需要一个CPU核运行几分钟，而一个大规模蒙特卡洛扫描可能需要数十个核并行运行数小时。SaaS架构可以根据任务需求动态分配计算资源。

**版本一致性**。仿真模型和仿真引擎作为平台服务进行统一的版本管理，确保所有测试使用相同版本的仿真环境。这对测试结果的可复现性至关重要。

**审计追溯**。所有仿真任务的配置、执行过程和结果都被平台自动记录，形成完整的审计追溯链。这满足了在环验证原理中"可审计"的要求。

### 2.6.2 模型库管理

HydroOS的仿真服务维护一个分层的模型库（Model Repository）：

**基础模型层**：包含经过校验的通用物理模型——圣维南方程求解器、管道水锤模型、闸门水力学模型、水泵特性曲线模型等。这些模型由CHS研发团队维护，经过严格的代码验证和模型验证。

**工程模型层**：包含针对特定工程的参数化实例——如胶东调水总干渠模型（已标定的渠道几何、糙率和边界条件）、某闸站的设备模型（实测的闸门特性参数和水泵曲线）等。工程模型层的模型在基础模型层的基础上，通过工程实测数据进行参数标定。

**测试场景层**：包含预定义的测试场景集合——边界条件时间序列（来水过程线、取水计划）、环境条件序列（气温曲线、降雨序列）、设备故障序列（闸门卡滞、传感器失灵）等。测试场景层为在环测试提供标准化的输入，确保不同版本控制策略的测试条件一致。

---

## 本章小结

本章建立了水利在环验证仿真环境的理论基础和技术框架。

首先，定义了水利数字孪生的概念体系。从电子化→模型化→孪生化的演进脉络出发，区分了数字模型、数字影子和数字孪生三个层次（表2-1），并分析了水利数字孪生在空间尺度、时间尺度、非线性和环境不确定性方面的特殊性。

其次，阐述了三类仿真形态。离线仿真以加速比为核心优势，适用于MIL测试和场景扫描；实时仿真以时间严格同步为核心要求，适用于SIL和HIL测试；超实时仿真在实时与加速之间取得平衡，适用于MPC验证和回归测试加速（表2-2）。

第三，详细介绍了FMI/FMU封装标准。FMI标准解决了异构模型集成的接口问题，FMU作为标准化的模型封装单元支持即插即用的联合仿真。通过例题2-1展示了水力学模型FMU封装的实践方法。

第四，讨论了联合仿真框架的设计，重点是多子系统之间的时间同步策略（固定步长、变步长、事件驱动、分层多速率）和数据交换方法（零阶保持、一阶外推）。

第五，建立了仿真环境校验方法体系，包括代码验证、模型验证和不确定性量化三个层面，以及A/B/C三级可信度评定体系（表2-3）。

> 下一章将聚焦仿真环境中最核心的组件——水力学模型的封装与接口标准。如何将复杂的水力学模型高效、准确地封装为在环测试可用的组件，是构建高质量仿真环境的技术关键。

---

## 习题

### 基础题

1. 请用自己的话解释数字模型、数字影子和数字孪生的区别。对于一个新建的调水工程，在工程建设阶段、试运行阶段和正式运行阶段，分别适合建设哪个层次的数字化系统？请说明理由。

2. 解释FMI标准中CS-FMU和ME-FMU的区别。对于一个包含水力学模型和闸门模型的联合仿真，如果水力学模型使用Preissmann格式、闸门模型使用四阶Runge-Kutta方法，应该分别封装为CS-FMU还是ME-FMU？为什么？

3. 某在环测试仿真环境在NSE检验中得分0.78、RMSE为允许偏差的65%。按照本章提出的校验标准（表2-3），该仿真环境属于哪个等级？它适用于哪些测试阶段？如果要将其提升到更高等级，应该重点改进哪些方面？

### 应用题

4. 某调水工程包含100km明渠、5座闸站、3座泵站和12个监测断面。请设计该工程在环验证仿真环境的联合仿真架构：需要哪些子系统模型？各子系统之间的接口如何定义？推荐的时间同步策略是什么？请画出架构示意图。

5. 对于例2-1中的渠段FMU，如果需要在HIL测试中使用（实时约束：仿真步长不超过10ms），而当前Preissmann格式的单步计算时间约为5ms，请分析该FMU是否满足实时约束。如果不满足，提出至少两种优化方案。

### 思考题

6. 本章指出水利数字孪生的挑战之一是"环境边界条件不确定"。讨论：如果仿真环境中的边界条件（如来水量）与实际值偏差较大，在环验证的结论是否仍然有效？如何通过仿真实验设计（如扰动注入、鲁棒性测试）来缓解这一问题？

---

## 拓展阅读

1. **Grieves, M. (2014).** "Digital Twin: Manufacturing Excellence through Virtual Factory Replication." *White Paper, Florida Institute of Technology*. — 数字孪生概念的创始文献之一，定义了物理实体-虚拟实体-连接的三要素框架，为理解水利数字孪生的概念基础提供参考。

2. **Blochwitz, T., Otter, M., Åkesson, J., et al. (2012).** "Functional Mockup Interface 2.0: The Standard for Tool Independent Exchange of Simulation Models." *Proceedings of the 9th International Modelica Conference*. — FMI 2.0标准的官方技术论文，详细阐述了FMI的设计理念、接口规范和工具支持生态。

3. **AIAA (1998).** *Guide for the Verification and Validation of Computational Fluid Dynamics Simulations.* AIAA-G-077-1998. — 美国航空航天学会的CFD仿真V&V指南，建立了代码验证→模型验证→不确定性量化的三层校验框架，其方法论可直接应用于水力学仿真模型的校验。

4. **Rasheed, A., San, O., & Kvamsdal, T. (2020).** "Digital Twin: Values, Challenges and Enablers from a Modeling Perspective." *IEEE Access*, 8, 21980-22012. — 数字孪生技术的综合综述，覆盖了建模方法、数据驱动方法和混合方法，对理解水利数字孪生的技术路线有参考价值。

5. **Lei, X. et al. (2025c).** "In-the-Loop Testing System for Water Network Control." *南水北调与水利科技（中英文）*, DOI: 10.13476/j.cnki.nsbdqk.2025.0080. — 提出了基于HydroOS的水网在环测试系统框架，其中的仿真服务架构设计是本章第六节的工程基础。
