# 第6章 在环验证体系：SIM-SIL-HIL与回归测试

## 学习目标

- 回顾第5章冲突消解策略，理解为何必须通过在环验证再上线。
- 掌握SIM、SIL、HIL三层验证对象、输入、输出与通过准则。
- 能够设计覆盖度指标体系，并建立用例分层与回归机制。
- 理解“签名故障+通信抖动”等复合异常的联合回归测试方法。
- 为第7章认知增强与在线学习策略验证打好实验基座。

---

## 6.1 章节衔接：从“策略可执行”到“策略可证明”

第5章给出了复杂约束下的冲突消解机制，但工程上线不仅要求“能执行”，还要求“可证明安全”。在环验证（In-the-Loop Testing）的价值在于：把算法、软件、硬件和运行环境逐层闭环，确认策略在边界工况下仍满足安全包络（Safety Envelope）和运行设计域（ODD）约束。

---

## 6.2 三层验证链路与职责

### 6.2.1 SIM（Model-in-the-Loop）

- **验证对象**：控制策略与系统模型耦合逻辑；
- **典型输入**：标准工况、极端来水、参数扰动；
- **输出**：状态轨迹、约束违背率、代价函数收敛性；
- **通过准则**：无硬约束违规，关键指标达标。

### 6.2.2 SIL（Software-in-the-Loop）

- **验证对象**：真实软件栈（优化、监督、消息总线）在仿真环境中的行为；
- **典型输入**：真实消息格式、异常注入（丢包、延时、签名失败）；
- **输出**：端到端时延、协议一致性、异常恢复时间；
- **通过准则**：协议无死锁，异常可恢复，时延不超阈值。

### 6.2.3 HIL（Hardware-in-the-Loop）

- **验证对象**：控制器、网关、PLC/RTU等硬件闭环；
- **典型输入**：近实时工况流、硬件故障注入；
- **输出**：执行稳定性、硬件负载、链路可靠性；
- **通过准则**：执行链路连续可用，故障场景可安全降级。

[图6-1: SIM-SIL-HIL在环验证管线]
{描述: 从SIM到SIL到HIL的阶段门流程图，每阶段包含输入、输出、准入门槛与回退条件；标注“未通过则回退前阶段”。}
{尺寸: 全页}
{颜色方案: 蓝色系}
{对应ARCH编号: ARCH-06}

---

## 6.3 覆盖度指标体系

为避免“只测常态不测边界”，本章采用三维覆盖度：

1. **场景覆盖度 $C_s$**：工况组合覆盖比例（枯水/平水/洪水、检修、突发）；
2. **约束覆盖度 $C_c$**：硬约束、软约束、旁路机制触发覆盖比例；
3. **路径覆盖度 $C_p$**：协议状态机路径被触达比例。

综合覆盖度可定义为：

$$
C_{all}=\omega_s C_s+\omega_c C_c+\omega_p C_p,
\qquad \omega_s+\omega_c+\omega_p=1
$$

[表6-1: 覆盖度指标对照表]

| 指标 | 定义 | 目标值（建议） | 说明 |
|---|---|---|---|
| $C_s$ | 已执行场景/目标场景 | ≥ 0.85 | 覆盖典型+边界工况 |
| $C_c$ | 已触发约束/总约束条目 | ≥ 0.90 | 必须覆盖硬约束触发 |
| $C_p$ | 已走通状态路径/总路径 | ≥ 0.80 | 含异常分支路径 |
| MTTR | 异常恢复平均时间 | ≤ 60 s | 含自动恢复与回退 |
| NVR | 硬约束违规率 | = 0 | 生产准入红线 |

---

## 6.4 回归测试策略

### 6.4.1 用例分层

- **L1 基线用例**：常态工况与主流程；
- **L2 扰动用例**：参数漂移、预测偏差、轻度通信抖动；
- **L3 异常用例**：签名失败、TTL耗尽、ODD越界、设备离线；
- **L4 复合用例**：多异常并发（如签名故障+通信抖动+高来水）。

### 6.4.2 触发机制

任一策略版本、模型版本、接口版本变化，都应触发L1-L3全量回归；涉及安全逻辑变化，必须追加L4复合回归。

---

## 6.5 联合异常回归：签名故障+通信抖动

针对前章评审建议，本章定义联合回归模板：

- 条件A：签名服务间歇失败（每10条消息失败2条）；
- 条件B：链路抖动导致随机延时 $\tau\in[0,3]$ 个周期；
- 条件C：上游来水突增触发高风险调度。

验证目标：
1. 系统是否进入白名单旁路并保持硬约束不违规；
2. 协议是否无死锁并可在阈值内恢复；
3. 回退逻辑是否可被审计追踪。

[图6-2: 联合异常回归时序]
{描述: 按时间展示签名失败事件、延时波动、策略重算、旁路执行、恢复退出全过程。}
{尺寸: 半页}
{颜色方案: 灰度}

---

## 6.6 例题：构建一个最小可用回归集

【例6-1】某区域水网准备从S2（建议模式）升级到S3（半自动）。请构建最小可用回归测试集，并判断是否具备升级条件。

**已知**：
- 当前基线用例通过率 100%；
- 扰动用例通过率 95%；
- 异常用例中“签名故障+抖动”恢复时间 52 s；
- 覆盖度统计：$C_s=0.88,\ C_c=0.91,\ C_p=0.82$；
- 建议权重：$\omega_s=0.3,\ \omega_c=0.4,\ \omega_p=0.3$。

**求解**：
1. 计算综合覆盖度 $C_{all}$；
2. 判断是否满足升级门槛（设门槛为0.85且NVR=0）。

**解题过程**：
1. 代入可得：
   $$
   C_{all}=0.3\times0.88+0.4\times0.91+0.3\times0.82=0.874
   $$
2. 已知NVR=0，且MTTR=52 s小于60 s阈值；
3. 因 $C_{all}=0.874>0.85$，满足升级条件。

**结果讨论**：
该例说明升级决策不应依赖单一通过率，而应同时考虑覆盖度、恢复能力与硬约束违规率。覆盖度达标且零违规，是从建议模式走向半自动的关键门槛。

---

## 6.7 本章小结

本章建立了M4的在环验证主线：SIM用于策略与模型耦合验证，SIL用于软件协议与异常恢复验证，HIL用于硬件闭环与执行链路验证。基于场景、约束、路径三维覆盖度，构建了可量化的准入指标，并给出回归测试分层策略。针对“签名故障+通信抖动”复合异常，本章提供了联合回归模板，确保系统在高压场景下仍可安全降级与可审计恢复。下一章将进一步讨论认知增强模块与在线学习策略如何接入这一验证体系并保持可控演进。

---

## 习题

### 一、基础题

1. 比较SIM、SIL、HIL三层在验证目标上的差异。
2. 为什么路径覆盖度 $C_p$ 对异常治理尤其重要？
3. 解释NVR=0为何被定义为生产准入红线。

### 二、应用题

4. 某版本测试得到 $C_s=0.80, C_c=0.92, C_p=0.76$，权重同例6-1。请计算 $C_{all}$ 并判断若门槛为0.85是否可升级。
5. 设计一个L4复合回归用例，至少包含两个通信异常与一个安全约束触发事件。

### 三、思考题

6. 若项目进度压力较大，是否可以降低覆盖度门槛以加快上线？请从短期收益与长期风险角度论证。

---

## 拓展阅读

1. Lei, X. (2025c). 在环测试系统. DOI: 10.13476/j.cnki.nsbdqk.2025.0080.
2. Seshia, S. A., Sadigh, D., & Sastry, S. S. (2016). Formal methods for CPS. *Annual Review of Control, Robotics, and Autonomous Systems*.
3. Koopman, P., & Wagner, M. (2017). Autonomous vehicle safety assurance. *SAE Technical Paper*.
4. Litrico, X., & Fromion, V. (2009). *Modeling and Control of Hydrosystems*. Springer.
5. Lei, X. (2025b). 自主智能水网架构. DOI: 10.13476/j.cnki.nsbdqk.2025.0079.

---

**下一章预告**：第7章将讨论认知增强与在线学习控制策略，重点是“可学习但不失控”的治理框架。
