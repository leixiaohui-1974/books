# 第3章 一致性协议与协商机制

## 学习目标

- 回顾第2章形式化建模框架，理解一致性协议在MAS中的作用边界。
- 掌握平均一致性、加权一致性与约束一致性的基本概念与适用场景。
- 理解通信延时、拓扑切换和异步更新对收敛性的影响。
- 能够构建“协商—校核—执行”三阶段协议流程。
- 为第4章SCADA+MAS Fusion Architecture的系统实现提供消息层规范基础。

---

## 3.1 章节衔接：从“可计算模型”到“可协同行为”

第2章已经给出水网MAS五元组模型，明确了状态、动作、观测、拓扑与约束集合。然而，模型本身并不会自动产生协同行为：若没有一致性协议，不同智能体可能在同一时刻朝相反方向调整，导致全局振荡。因而本章的核心问题是：**在ODD与Safety Envelope约束下，如何让分布式智能体对“下一步动作”达成可执行共识**。

---

## 3.2 一致性问题的工程定义

### 3.2.1 物理直觉

在水网中，“一致”不等于“完全相同”。上游库与下游闸门的控制目标天然不同，但它们必须在关键耦合变量上保持协调，例如边界流量、联调时序和风险等级。故工程一致性可定义为：

> 各智能体在共享约束与目标权重下，对关键协同变量收敛到可执行的共同区间或共同轨迹。

### 3.2.2 基本形式

记第 $i$ 个智能体的协同变量为 $\mathbf{p}_i(k)$，加权平均一致性迭代可写为：

$$
\mathbf{p}_i(k+1)=\sum_{j\in\mathcal{N}_i\cup\{i\}} w_{ij}(k)\,\mathbf{p}_j\big(k-\tau_{ij}(k)\big)
$$

其中 $w_{ij}(k)\ge0$ 且 $\sum_j w_{ij}(k)=1$，$\tau_{ij}(k)$ 为时变通信延时。

**工程解释**：该形式允许“异步+延时”并存，是实际值守网络中更稳健的协议基线。

---

## 3.3 收敛性条件与工程可验证假设

为避免“理论可行、工程失效”，本书采用以下可验证假设：

1. **联合连通性假设**：在任意长度为 $T_c$ 的时间窗口内，拓扑并集保持连通；
2. **时延有界假设**：$0\le\tau_{ij}(k)\le\bar{\tau}$；
3. **权重下界假设**：对活跃链路有 $w_{ij}(k)\ge\epsilon>0$；
4. **约束可行性假设**：局部可行域交集非空。

在上述假设下，协议可保证协同变量收敛到一致子空间；若叠加硬约束投影，可进一步保证一致结果不越过安全边界。

[图3-1: 拓扑切换下的一致性收敛示意]
{描述: 横轴为迭代步，纵轴为三个智能体协同变量偏差；展示在拓扑间歇断连条件下仍逐步收敛。}
{尺寸: 半页}
{颜色方案: 蓝色系}

---

## 3.4 约束一致性：从“平均值”到“可执行值”

### 3.4.1 仅平均一致性的局限

若只做平均一致，可能得到“数学一致但工程不可执行”的结果。例如平均后流量建议超过闸门物理上限，或动作变化率超过设备保护阈值。

### 3.4.2 投影一致性机制

定义局部可行域 $\Omega_i$，约束一致性更新为：

$$
\mathbf{p}_i(k+1)=\Pi_{\Omega_i}\left(\sum_{j}w_{ij}(k)\,\mathbf{p}_j(k-\tau_{ij}(k))\right)
$$

其中 $\Pi_{\Omega_i}(\cdot)$ 为到可行域的投影算子。

**工程意义**：该机制把“监督智能体硬校核”前移到每步迭代，可显著减少末端拒绝率，降低调度回路抖动。

[表3-1: 三类一致性机制对比]

| 机制 | 优点 | 风险 | 适用场景 |
|---|---|---|---|
| 平均一致性 | 计算简单 | 可能不可执行 | 低风险工况快速协调 |
| 加权一致性 | 可体现优先级 | 权重配置敏感 | 多目标联调 |
| 投影一致性 | 天生满足约束 | 计算量略增 | 高风险工况与生产系统 |

---

## 3.5 协商协议：三阶段流程

本书推荐“提案—校核—确认”三阶段协商流程：

1. **提案阶段（Proposal）**：优化智能体提交候选动作与预测影响；
2. **校核阶段（Validation）**：监督智能体执行Safety Envelope、ODD和动作速率校核；
3. **确认阶段（Commit）**：通过提案进入执行队列，冲突提案返回边界信息并触发二轮协商。

推荐最小消息字段：
- `msg_id`，`agent_id`，`timestamp`；
- `proposal_vector`，`constraint_margin`；
- `risk_level`，`ttl`，`signature`。

该字段集可直接映射到SCADA+MAS Fusion Architecture中的消息总线接口。

[图3-2: 协商协议时序图]
{描述: 三个智能体与一个监督智能体的时序图，展示提案、拒绝、重提、确认全过程，并标注超时重传与降级路径。}
{尺寸: 全页}
{颜色方案: 灰度}
{对应ARCH编号: ARCH-04}

---

## 3.6 例题：含延时的双库协商一致性

【例3-1】某双库联调系统中，库A与库B分别由两个优化智能体控制，监督智能体负责硬约束校核。当前周期内两者给出的下泄建议分别为 $Q_A=260$ m³/s、$Q_B=340$ m³/s。联调总量上限为 $Q_A+Q_B\le560$ m³/s，且通信存在1周期延时。

**已知**：
- 权重：$w_A=0.45,\ w_B=0.55$；
- 本周期可行域：$Q_A\in[180,300],\ Q_B\in[220,360]$；
- 动作变化率约束：$|\Delta u_A|,|\Delta u_B|\le5\%$。

**求解**：给出一次“加权+投影一致性”协商迭代结果，并说明是否可执行。

**解题过程**：
1. 先做加权聚合，得到总量建议仍接近 $600$ m³/s，超过联调上限560。
2. 监督智能体触发总量约束投影，将总量压缩至560，并按权重分配为：
   - $Q_A^*=0.45\times560=252$ m³/s；
   - $Q_B^*=0.55\times560=308$ m³/s。
3. 检查局部区间：252与308均落在各自可行域内。
4. 检查动作变化率，若任一超过5%，则进入“限速重投影”；本例假设均满足。

**结果讨论**：
该迭代表明，加入投影算子后，协商输出可直接执行，不需要末端大幅回退。对高频联调任务而言，这种“前置可行性”可显著提升调度稳定性。

---

## 3.7 本章小结

本章在第2章形式化建模基础上，给出了水网MAS的一致性协议与协商机制。首先明确了工程一致性并非“变量完全相等”，而是关键协同变量在共享约束下收敛到可执行区间；其次提出联合连通性、时延有界、权重下界和可行域非空等可验证收敛假设；再次引入投影一致性机制，将Safety Envelope约束内嵌到迭代过程中，避免“算得出但做不到”；最后通过双库例题展示了“加权—投影—校核”的完整流程。下一章将进入系统实现层，讨论SCADA+MAS Fusion Architecture中的服务划分、接口设计与部署策略。

---

## 习题

### 一、基础题

1. 解释“工程一致性”与“数学完全一致”的区别。
2. 为什么联合连通性比“每一时刻都连通”更符合实际通信网络？
3. 说明投影一致性机制如何减少末端拒绝率。

### 二、应用题

4. 设三智能体建议动作分别为 $(120,150,210)$，总量上限为420。请给出一种加权投影分配结果并验证可行性。
5. 设计一个协商协议超时重传规则（含 `ttl` 与重试次数），并说明何时进入最小风险状态。

### 三、思考题

6. 在高不确定性工况下，应优先提高一致性收敛速度，还是优先提高约束鲁棒性？请给出你的工程取舍依据。

---

## 拓展阅读

1. Olfati-Saber, R., Fax, J. A., & Murray, R. M. (2007). Consensus and cooperation in networked multi-agent systems. *Proceedings of the IEEE*, 95(1), 215–233.
2. Ren, W., Beard, R. W., & Atkins, E. M. (2005). A survey of consensus problems in multi-agent coordination. *American Control Conference*.
3. Nedić, A., & Ozdaglar, A. (2009). Distributed subgradient methods for multi-agent optimization. *IEEE TAC*, 54(1), 48–61.
4. Lei, X. (2025b). 自主智能水网架构. DOI: 10.13476/j.cnki.nsbdqk.2025.0079.
5. Lei, X. (2025c). 在环测试系统. DOI: 10.13476/j.cnki.nsbdqk.2025.0080.

---

**下一章预告**：第4章将围绕SCADA+MAS Fusion Architecture展开，给出服务拆分、接口契约、部署拓扑与灰度上线策略。
