<!-- 变更日志
v1 2026-02-19: 初稿
-->

# 第九章 工程案例：胶东调水在环验证实践

## 学习目标

1. 通过完整的工程案例，理解MIL/SIL/HIL三级在环验证在实际水利工程中的实施全过程；
2. 掌握在环验证仿真平台搭建的工程方法——从需求分析到平台架构设计、模型选择与校验；
3. 理解测试用例库的工程化建设方法——如何从项目需求出发构建结构化的用例集；
4. 掌握从缺陷发现到修复验证的闭环管理方法，理解工程实践中的决策权衡；
5. 了解验证报告编制和上线许可评审的规范化流程。

> **前章回顾**：第四至八章建立了在环验证的完整方法论体系——MIL/SIL/HIL三级测试方法、场景矩阵设计、覆盖度度量和质量门禁。这些方法论如何在实际水利工程中落地实施？理论方法与工程约束之间如何平衡？本章以胶东调水工程的在环验证实践为案例，展示从仿真平台搭建到上线许可评审的完整实施过程。

---

## 9.1 工程背景

### 9.1.1 胶东调水工程概况

胶东调水工程是山东省重要的跨区域调水工程，将黄河水和长江水调入胶东半岛，保障青岛、烟台、威海等城市的供水安全。工程包含多条输水干渠、数十座闸站和泵站、复杂的分水枢纽和调蓄水库。

工程的控制系统面临几个特殊挑战：输水距离长（数百公里级），水力学延时显著；北方冬季冰期运行，冰盖形成和消融对水力学特性影响巨大；多水源（黄河、长江）供水切换，水质变化频繁；用水区多城市、多用户，需求波动大且优先级复杂。

### 9.1.2 在环验证的需求与目标

胶东调水工程于2024年启动控制系统智能化升级（Lei, 2025c），引入HydroOS平台实现自主调度控制。智能化升级对在环验证提出了明确需求：

**安全性需求**：控制系统在任何设计工况下不得导致渠道漫溢、水位过低或设备损坏。所有安全联锁必须通过HIL验证。

**性能需求**：自动控制模式下的水位稳定精度、调节时间、扰动抑制能力满足设计指标。

**可靠性需求**：控制系统在通信中断、设备故障等异常条件下能够安全降级，不依赖持续人工干预。

**可追溯性需求**：全部验证过程可追溯、可审计，满足水利工程验收规范。

---

## 9.2 仿真平台搭建

### 9.2.1 平台需求分析

基于工程特点和验证需求，仿真平台需要满足以下功能要求：

- 覆盖主要输水干渠（约200km）和关键枢纽的水力学仿真
- 支持冰期仿真（冰盖形成、稳定冰期、融冰三个阶段）
- 支持MIL加速仿真（≥50×实时）和HIL严格实时仿真
- 提供标准I/O接口和通信协议接口（OPC-UA、Modbus）
- 支持批量自动化测试

### 9.2.2 模型选择与校验

**表9-1 胶东调水仿真平台模型配置**

| 模型对象 | MIL模型 | SIL/HIL模型 | 校验等级 |
|---------|---------|------------|---------|
| 主干渠（明渠段） | IDZ降阶模型 | Saint-Venant全模型 | B级 |
| 暗涵/隧洞段 | Muskingum模型 | MOC瞬变流模型 | B级 |
| 分水枢纽 | 静态流量分配 | 二维水力学模型 | A级（关键枢纽） |
| 闸站 | 线性闸门特性 | 含死区/滞后的非线性模型 | B级 |
| 泵站 | 特性曲线插值 | 变频器动态模型 | B级 |
| 冰期效应 | 糙率修正系数 | 冰盖-水流耦合模型 | C级（验证数据有限） |

模型校验使用了2021-2023年三个运行年度的实测SCADA数据。对每个模型组件，计算仿真输出与实测数据的Nash-Sutcliffe效率系数（NSE），要求B级校验NSE≥0.85。

主干渠IDZ模型的校验结果：以2022年非冰期数据（6月-10月）进行参数辨识，以2023年同期数据进行独立验证。验证期NSE=0.91，满足B级要求。

冰期模型的校验受限于冰期实测数据的稀缺性（仅有2个冬季的有限数据），校验等级为C级。这意味着冰期相关的MIL测试结论需要在SIL/HIL阶段用更保守的安全裕度重新验证。

### 9.2.3 平台架构

仿真平台采用分层架构：

**底层**：实时Linux操作系统（RT-Preempt内核），确保仿真任务的确定性执行。

**模型层**：全部水力学模型封装为FMI 2.0 Co-Simulation FMU，通过统一的接口与上层交互。

**仿真引擎层**：Co-Simulation Master算法管理多FMU的联合仿真时间推进和数据交换。MIL模式使用可变步长加速仿真，HIL模式使用固定步长实时仿真。

**接口层**：I/O驱动（4-20mA、数字量）、OPC-UA服务端、Modbus从站。

**测试管理层**：场景管理器、批量执行引擎、数据采集器、评估模块。

---

## 9.3 测试用例库建设

### 9.3.1 用例来源

测试用例库从四个来源构建：

**设计文档推导**：从控制系统设计说明书中提取每项功能需求，为每项需求至少设计一个验证用例。

**ODD场景矩阵**：基于第七章的四维矩阵方法，结合胶东调水工程的ODD定义（水文四季特征、设备配置、通信架构、运行组织），使用Pairwise方法生成场景集。

**历史事件**：回顾胶东调水工程历年运行中的异常事件和调度案例，将关键事件转化为测试场景。

**专家经验**：组织运行管理人员和控制系统工程师召开"场景头脑风暴"会议，识别经验中认为风险较高的工况组合。

### 9.3.2 用例库规模与结构

**表9-2 胶东调水在环验证测试用例库统计**

| 类别 | P0 | P1 | P2 | 合计 |
|------|-----|-----|------|------|
| 基本控制功能 | 12 | 45 | 120 | 177 |
| 安全联锁 | 8 | 16 | 32 | 56 |
| 接口通信 | 6 | 28 | 85 | 119 |
| 异常处理与降级 | 8 | 35 | 150 | 193 |
| 多站协调 | 4 | 22 | 95 | 121 |
| 冰期专项 | 3 | 18 | 80 | 101 |
| 极端工况 | 0 | 12 | 180 | 192 |
| 长时间运行 | 0 | 4 | 8 | 12 |
| **合计** | **41** | **180** | **750** | **971** |

---

## 9.4 MIL验证实施

### 9.4.1 MIL基准测试

MIL基准测试验证了控制算法在标称工况下的基本性能。测试使用IDZ降阶模型组作为被控对象模型，100×加速仿真。

关键结果：

- 单闸PI控制器阶跃响应：8座主要闸站全部满足超调量和调节时间要求
- 全线流量调整（协调控制）：从设计流量到最小流量的全线切换在预期时间内完成
- 扰动抑制：标称工况下各类扰动（来水波动、取水变化、旁侧入流）的抑制能力达标

### 9.4.2 参数敏感性分析

使用Morris筛选法对36个参数（8段渠道糙率、8座闸站PI参数×2、4个边界条件参数）进行全局敏感性分析。Morris分析需要$r(p+1)$=15×37=555次MIL仿真，100×加速下总计算时间约3小时。

分析结果识别出8个高敏感参数：

- 渠段3和渠段5的Manning糙率（$\mu^* > 1.2$，高影响高非线性）
- 闸站3和闸站6的PI增益$K_p$（$\mu^* > 0.9$，高影响）
- 上游来水量和主要取水口取水量（$\mu^* > 0.8$，高影响但较线性）

这8个参数在后续的蒙特卡洛扫描中被重点关注。

### 9.4.3 蒙特卡洛场景扫描

基于敏感性分析结果，使用LHS对8个高敏感参数进行2000次采样扫描。每次仿真虚拟时间72小时（3天），包含一次完整的日调度循环和两次扰动事件。100×加速下，单次仿真约43秒，2000次约24小时（使用12核并行约2小时完成）。

扫描结果：1876次通过（93.8%），124次失败。失败模式分析如下：

- 闸站3恢复超限：87次（70%），主要在$n_3 > 0.018$且$K_{p,3}$偏低时出现
- 渠段5水位超限：23次（19%），在大来水+高糙率组合时出现
- 闸门速率超限：14次（11%），在来水突变幅度>15 m³/s时出现

### 9.4.4 MIL缺陷与修复

**表9-3 MIL阶段发现的主要缺陷**

| 缺陷编号 | 等级 | 描述 | 修复方案 | 验证状态 |
|---------|------|------|---------|---------|
| MIL-D001 | S2 | 闸站3 PI参数在高糙率工况下恢复超限 | 增大$K_p$从0.5到0.65，减小$T_i$从800到550s | 回归通过 ✓ |
| MIL-D002 | S3 | 渠段5极端工况水位接近安全限值 | 增加渠段5水位预警阈值，提前触发协调控制 | 回归通过 ✓ |
| MIL-D003 | S3 | 来水突变>15 m³/s时闸门速率超限 | 增加来水变率前馈补偿环节 | 回归通过 ✓ |
| MIL-D004 | S4 | 冰期C级模型下控制性能裕度不足 | SIL/HIL阶段使用更保守的安全裕度重新验证 | 转入SIL ✓ |

参数修正后重新进行2000次蒙特卡洛扫描，通过率从93.8%提升至97.6%。剩余2.4%的失败场景均为极端工况的S3/S4问题，可带入SIL阶段。

---

## 9.5 SIL验证实施

### 9.5.1 SIL测试环境

SIL测试环境包括：HydroOS控制软件运行在工业级Linux服务器上（与现场部署环境一致）、OPC-UA协议仿真器连接控制软件与被控对象模型、时序监控插桩集成在控制软件中。

### 9.5.2 关键发现

SIL阶段的主要发现集中在接口和时序方面：

**SIL-D001（S2）**：OPC-UA数据订阅在高频率更新（10s周期）下偶发性丢失一个采样点。原因：OPC-UA客户端的发布间隔与服务端的采样间隔存在微小偏差，导致竞争条件。修复：在客户端增加数据时间戳校验和缺失数据检测。

**SIL-D002（S3）**：MPC求解器在特定约束激活组合下迭代次数超过预设上限（100次），输出上一步方案。频率约0.3%（SIL的3000次计算中出现9次）。修复：增加求解器预处理热启动，将平均迭代次数从23降至12。

**SIL-D003（S2）**：传感器数据异常检测模块的阈值在冬季低温工况下过于敏感——正常的冰期水位波动被误判为传感器故障，触发不必要的降级。修复：引入季节自适应阈值。

### 9.5.3 背靠背一致性

MIL-SIL背靠背测试使用P1的180个核心用例。一致性结果：闸门开度MAD（最大绝对偏差）的P99=0.0031m，RMSD=0.0009m。仅1个用例偏差超过0.01m阈值（MPC求解器的约束边界处理在MATLAB和C++中的实现存在微小差异），经确认不影响控制安全。

---

## 9.6 HIL验证实施

### 9.6.1 HIL平台配置

HIL测试使用了与现场一致的3台主力PLC（覆盖最关键的3座闸站）和1台工业交换机。实时仿真器通过I/O板卡（8路模拟输出+8路模拟输入+16路数字I/O）与PLC连接。SCADA上位机软件部署在与现场版本一致的工业PC上。

### 9.6.2 关键发现

**HIL-D001（S2）**：闸站2的PLC在接收到仿真器输出的4-20mA水位信号时，A/D转换值存在0.015m的系统偏差。原因：仿真器D/A输出通道的标定偏差。修复：对I/O通道进行端到端标定校准。

**HIL-D002（S3）**：工业交换机在多PLC同时发起OPC-UA会话时出现约200ms的延迟尖峰（正常约15ms）。与例6-2中发现的广播风暴类似。修复：配置交换机的QoS和VLAN隔离。

**HIL-D003（S1→降级为S3）**：安全联锁SI-01（水位超上限全开泄水闸）在初始测试中触发响应时间为12.5s，超过10s限值。原因：PLC联锁逻辑中的消抖时间设置为8s（过长），加上A/D转换和通信延时共约4.5s。修复：将消抖时间从8s减至3s。修复后响应时间降至7.2s，满足要求。

【例9-1】HIL-D003的缺陷发现与修复过程是本工程在环验证中最重要的安全发现。

[发现经过] 在HIL安全联锁测试中，仿真器以0.05 m/min速率抬升水位至安全上限3.50m。预期联锁在10s内响应，但实测响应时间12.5s。

[根因分析] 时间分解：水位达标→PLC A/D采样（0.2s）→数据传输（0.3s）→消抖判断（8s——需要连续8s超标才确认）→联锁逻辑执行（0.1s）→指令发送（0.4s）→执行器开始动作（0.5s）→合计约9.5s内部+3s裕度=12.5s。

[修复决策] 8s消抖时间是设计时为防止水位传感器波动导致的联锁误触发而设置的。减至3s需要评估误触发风险。分析SCADA历史数据（2021-2023年），水位在安全上限附近的最大瞬时波动幅度为±0.08m，持续时间＜1.5s。因此3s消抖可有效滤除正常波动，同时将响应时间控制在10s限值内。

[修复验证] 消抖改为3s后，重新执行联锁测试：响应时间7.2s ✓。额外执行水位波动干扰测试（在安全上限附近注入±0.1m、频率0.5Hz的正弦波动）：联锁未误触发 ✓。

[结果讨论] 该缺陷如果未被HIL发现而带入现场运行，在极端工况下（水位快速上升至安全上限）可能导致联锁延迟触发，延误2.5s的泄洪启动。在高水位条件下，2.5s的延迟可能对应约0.004m的额外水位上升——虽然幅度不大，但对于安全关键系统，任何延迟都是不可接受的。

---

## 9.7 验证报告与上线评审

### 9.7.1 验证报告编制

胶东调水工程的在环验证报告采用第四章定义的标准结构，总计约120页。报告的核心结论部分摘要如下：

**MIL结论**：控制算法在标称条件和97.6%的随机工况下满足性能要求。4项缺陷已修复并通过回归验证。冰期模型可信度为C级，相关结论的安全裕度已增大。

**SIL结论**：控制软件的接口、时序和异常处理功能满足设计要求。3项缺陷已修复。MIL-SIL背靠背一致性满足0.01m阈值（P99）。代码覆盖率83.5%。

**HIL结论**：控制硬件、通信链路和安全联锁在真实环境下满足设计要求。3项缺陷（含1项安全联锁延迟问题）已修复并通过验证。信号链端到端精度满足要求。

### 9.7.2 上线许可评审

上线许可评审由项目业主组织，邀请独立第三方专家参与。评审的核心议程包括：

**验证完整性评审**：检查覆盖度指标是否达标。结果：Pairwise覆盖率100%、安全联锁覆盖率100%、风险覆盖率100%、代码覆盖率83.5%（目标≥80%）——全部达标。

**缺陷关闭评审**：检查所有S1/S2缺陷是否已修复并通过回归。结果：MIL阶段1个S2已关闭、SIL阶段2个S2已关闭、HIL阶段1个S1→S3降级后关闭——全部关闭。

**遗留风险评审**：识别未完全消除的风险。主要遗留风险：冰期模型C级校验的不确定性。评审意见：首个冬季运行期采用保守参数设置，并安排持续验证监控，积累冰期数据后更新模型。

**评审结论**：通过上线许可，允许控制系统在胶东调水工程正式投入自动运行。附带条件：首个冰期运行期间实施持续验证方案。

---

## 本章小结

本章以胶东调水工程为案例，展示了MIL/SIL/HIL三级在环验证的完整实施过程。

在仿真平台方面，采用分层架构和FMI标准封装构建了覆盖200km输水干渠的仿真平台（表9-1）。模型校验使用多年实测数据，非冰期模型达到B级，冰期模型因数据限制仅达C级。

在测试用例库方面，从四个来源（设计文档、ODD矩阵、历史事件、专家经验）构建了971个测试用例（表9-2），涵盖基本功能、安全联锁、异常处理、多站协调、冰期专项等7大类。

MIL阶段通过Morris敏感性分析和2000次蒙特卡洛扫描，发现4项缺陷（表9-3），修复后通过率从93.8%提升至97.6%。SIL阶段发现3项接口和时序缺陷。HIL阶段发现3项硬件相关缺陷，其中最关键的是安全联锁响应时间超限问题（例9-1），通过调整消抖参数解决。

验证报告覆盖度指标全部达标，所有S1/S2缺陷关闭，经独立评审通过上线许可。遗留的冰期模型不确定性通过持续验证方案管理。

> 下一章（全书末章）将站在整个在环验证体系的高度进行总结与展望——回顾全书的方法论框架，展望形式化验证、数字孪生驱动的持续验证和水利V&V标准化的发展方向。

---

## 习题

### 基础题

**9-1.** 胶东调水工程的冰期模型为什么只能达到C级校验？C级校验对MIL测试结论有什么影响？工程团队采取了什么措施来缓解这一限制？

**9-2.** 在MIL蒙特卡洛扫描中，初始通过率为93.8%，修复缺陷后提升至97.6%。剩余2.4%的失败场景被允许带入SIL。这一决策的依据是什么？如果你是评审专家，你会同意这一决策吗？

**9-3.** HIL-D003（安全联锁延迟）的根因是消抖时间设置过长。解释消抖机制的目的以及消抖时间与响应速度之间的权衡关系。

### 应用题

**9-4.** 假设你负责另一个调水工程的在环验证。该工程有5座闸站、2座泵站、总输水距离80km。参考胶东调水的实践经验，请制定在环验证的总体计划，包括：（a）仿真平台的模型选择（参考表9-1的框架）；（b）测试用例库的规模估算（参考表9-2的分布比例）；（c）MIL/SIL/HIL三级测试的时间安排（估算各阶段所需工作日）；（d）团队配置（需要哪些角色、各多少人）。

**9-5.** 本章的蒙特卡洛扫描使用了2000次LHS采样。如果将采样数增加到10000次，预计会有什么收益和成本？请：（a）估算增加的计算时间；（b）分析额外样本对可靠度估计精度的改善（提示：Wilson区间宽度与样本量的关系）；（c）讨论是否值得增加样本量。

### 思考题

**9-6.** 胶东调水工程的在环验证发现了约10项缺陷（MIL 4项、SIL 3项、HIL 3项）。这个数量是"多"还是"少"？讨论：（a）缺陷发现数量与测试充分性的关系是什么？（b）如果一次在环验证零缺陷，应该高兴还是担心？（c）如何判断测试已经"足够找到大多数重要缺陷"？

**9-7.** 本案例中的上线评审采用了"附带条件通过"的方式——允许上线但要求冰期持续验证。讨论：（a）"附带条件通过"在工程实践中的适用边界是什么？什么情况下不应采用"附带条件"？（b）如果持续验证在首个冬季发现冰期控制性能确实不达标，应该如何应对？（c）这种"先上线、再完善"的策略是否适用于所有水利工程？

---

## 拓展阅读

1. **Lei, X. et al. (2025c).** "In-the-Loop Testing System for Water Network Control." *南水北调与水利科技（中英文）*, DOI: 10.13476/j.cnki.nsbdqk.2025.0080. — 胶东调水在环测试系统的技术论文，是本章工程案例的直接学术基础。

2. **Lei, X. et al. (2025a).** "Cybernetics of Hydro Systems: Theory and Framework." *南水北调与水利科技（中英文）*, DOI: 10.13476/j.cnki.nsbdqk.2025.0078. — CHS理论框架论文，为在环验证提供了控制论的理论基础。

3. **Burt, C.M., Clemmens, A.J., Strelkoff, T.S., et al. (1997).** "Irrigation performance measures: Efficiency and uniformity." *Journal of Irrigation and Drainage Engineering*, 123(6), 423-442. — 灌溉系统性能评估的经典方法，其性能指标定义对水利控制系统的验证通过准则设计有参考价值。

4. **DO-178C (2011).** *Software Considerations in Airborne Systems and Equipment Certification.* RTCA. — 航空软件认证标准。虽然面向航空领域，但其V&V流程框架、覆盖度要求和缺陷分级体系对水利控制软件的在环验证有重要借鉴意义。
