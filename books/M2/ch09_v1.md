<!-- 变更日志
v1 2026-02-16: 初稿
-->

# ch09 MPC与安全约束集成

## 9.1 学习目标

完成本章学习后，读者应能够：

1. 理解模型预测控制（Model Predictive Control, MPC）与安全约束集成的必要性；
2. 将安全包络（Safety Envelope）与运行设计域（Operational Design Domain, ODD）形式化为优化约束；
3. 设计“硬约束+软约束+安全联锁”三层安全控制机制；
4. 构建面向异常工况的最小风险状态（MRS）与降级逻辑；
5. 建立可审计的安全门禁、告警与复盘流程。

> 本章承接 ch08：在自适应与在线学习框架下，确保模型更新与控制优化始终不突破安全底线。

## 9.2 安全约束为何必须显式建模

若仅以经济性或跟踪误差作为目标，控制器可能在极端工况下逼近危险边界。将安全约束显式写入优化问题，可把“安全优先”从口号变为可计算规则。

[物理直觉] 调度员不会为了省电而让水位接近漫顶线；优化器也必须具备同样的“红线意识”。

## 9.3 安全包络形式化

定义状态安全集合：

$$
\mathcal{X}_{safe}=\{\mathbf{x}\mid h_{min}\le h\le h_{max},\;Q_{min}\le Q\le Q_{max}\}
$$

按风险等级可划分为：

- 绿色区：正常运行区；
- 黄色区：预警区，允许短时进入但需恢复；
- 红色区：禁止区，触发强制联锁或降级。

在 MPC 中可写为：

$$
\mathbf{x}_{k+i}\in\mathcal{X}_{green}\subset\mathcal{X}_{yellow}\subset\mathcal{X}_{safe}
$$

[工程解释] 绿色区用于常态优化，黄色区用于扰动缓冲，红色区用于触发保护动作。

[图9-1: 安全包络红黄绿三区间与控制动作关系]
{描述: 展示状态轨迹接近边界时的预警、收紧、联锁、降级路径。}
{尺寸: 全页}
{颜色方案: 蓝色系}
{对应ARCH编号: ARCH-07}

## 9.4 ODD约束与最小风险状态

ODD 描述控制器允许运行的工况边界（设备状态、来水范围、通信条件等）。当运行超出 ODD 时，控制器应进入最小风险状态（Minimum Risk State, MRS），例如：

- 降低调度动作幅度；
- 切换保守参数组；
- 执行固定保底出流策略。

ODD 约束可表示为逻辑门禁条件集合，作为 MPC 上层使能条件。

## 9.5 硬约束、软约束与安全联锁

推荐三层结构：

1. **硬约束层**：绝不允许突破（如防洪控制线）；
2. **软约束层**：允许有限违背并高惩罚（如经济目标相关区间）；
3. **联锁层**：异常时独立触发，绕过优化器直接保护。

[表9-1: 三层安全机制配置清单]
{描述: 列包括约束类型、典型变量、触发条件、执行动作、恢复条件。}
{尺寸: 半页}
{颜色方案: 灰度}

## 9.6 可复现实例：边界来水突增下安全控制

【例9-1】某明渠-管网耦合系统在 20 min 内发生来水突增，预测轨迹逼近黄色区上边界。

**已知**：

- 绿色区上限为 $h=3.10$ m；
- 黄色区上限为 $h=3.25$ m；
- 红色区阈值为 $h=3.30$ m；
- 当连续两步进入黄色区需触发收紧策略。

**求解**：说明如何通过“收紧约束+联锁降级”防止进入红色区。

**解题过程**：

1. 黄色区首次触发时提高水位偏差惩罚并收紧控制增量；
2. 若连续两步仍处黄色区，启动保守策略并限制高风险动作；
3. 若预测将触红，联锁层触发最小风险状态并降级控制。

**结果讨论**：
该机制可将“异常发展”提前截断，实现可解释、可追溯的安全响应链路。

## 9.7 安全门禁与审计闭环

上线前应验证：

- 安全约束覆盖度；
- 黄色区恢复时长；
- 红色区触发率；
- 联锁动作成功率；
- 降级恢复成功率。

建议输出标准化审计记录：触发时间、工况上下文、动作序列、恢复时间、责任签批。

[TODO: 需补充项目级安全审计报表模板编号与签批流程版本。]

## 9.8 本章小结

本章实现了 MPC 与安全约束的一体化集成：通过安全包络与 ODD 形式化约束，通过硬/软约束与联锁层构建分级防护，通过最小风险状态与审计闭环保障异常可控。安全不是附加模块，而是优化控制的第一约束。下一章将讨论 MPC 实时计算优化，解决“安全可行前提下的按时求解”问题。

## 习题

### 基础题

1. 为什么安全约束必须在优化器中显式表达？
2. 绿色/黄色/红色区的控制策略差异是什么？
3. ODD 与最小风险状态之间有什么关系？

### 应用题

4. 设计一个含红黄绿区间与联锁触发条件的 MPC 约束体系。  
5. 设计安全事件审计报表字段，并说明哪些字段用于责任追溯。

### 思考题

6. 若经济优化目标与安全缓冲策略冲突，你会如何设定优先级与审批流程？

### 基础题参考答案要点

1. 因否则优化可能输出物理可算但工程不安全的解。  
2. 绿色区常态优化，黄色区预警收紧，红色区联锁降级。  
3. ODD定义允许运行边界，越界时进入最小风险状态。

## 拓展阅读

1. Mayne, D.Q. et al. (2000). Constrained MPC: Stability and optimality.  
2. Rawlings, J.B., Mayne, D.Q. & Diehl, M. (2017). *Model Predictive Control: Theory, Computation, and Design*.  
3. Blanchini, F. (1999). Set invariance in control.  
4. ASCE (2014). *MOP 131: Canal Automation for Irrigation Systems*.  
5. Lei et al. (2025c). 在环测试系统。

> **术语一致性声明**：本章统一采用“模型预测控制（Model Predictive Control, MPC）”“运行设计域（Operational Design Domain, ODD）”“安全包络（Safety Envelope）”“在环测试（In-the-Loop Testing）”等规范术语；数学符号采用 $Q,h,\tau,T_p,T_c,\mathbf{x},\mathbf{u},\mathbf{y},J$。

### 质量检查清单（执行结果）

- [x] 章首学习目标、章末小结/习题/拓展阅读完整；
- [x] 基础题3 + 应用题2 + 思考题1，含基础题答案要点；
- [x] 公式前有物理直觉，公式后有工程解释；
- [x] 含可复现实例（例9-1）；
- [x] 图表不少于2项（图9-1、表9-1）；
- [x] 章首回顾ch08，章末预告ch10。
