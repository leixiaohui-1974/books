<!-- 变更日志
v1 2026-02-16: 初稿（基于“继续”命令自动续写）
-->

# ch05 MPC在线优化调度

## 5.1 学习目标

完成本章后，读者应能够：

1. 说明胶东调水场景下 Model Predictive Control (MPC) 在线优化调度的作用与边界；
2. 基于 ch03 模型与 ch04 架构构建滚动优化问题；
3. 设计约束集（ODD、安全包络、执行器限制）与目标函数权重；
4. 给出 MPC 参数整定与模式切换联动策略（补齐 ch04 跟踪项）；
5. 形成可上线的计算时序、回退策略与审计闭环方案。

> 承接 ch04：接口链路已建立，本章进入“可执行调度策略”的在线优化核心。

## 5.2 为什么胶东调水需要在线 MPC

胶东调水具有长时滞、多约束、需求时变等特征，传统静态规则难以在全局范围内兼顾供水达成、稳定性与安全性。

MPC 优势在于：

- 在预测时域内提前处理扰动；
- 显式处理多类约束；
- 支持滚动更新，适配运行状态变化。

[工程解释] 在工程上，MPC 不是替代调度员，而是把“经验调度”转化为可计算、可审计、可复盘的决策流程。

## 5.3 调度优化问题构建

可将胶东调水调度表达为：

$$
\min_{\mathbf{u}_{0:T_c-1}} J = \sum_{k=1}^{T_p}\left(\alpha\|\mathbf{y}_k-\mathbf{y}_k^{ref}\|_2^2 + \beta\|\Delta\mathbf{u}_k\|_2^2 + \gamma\,\Phi_{safety}(\mathbf{x}_k)\right)
$$

约束包括：

- 动态约束：$\mathbf{x}_{k+1}=f(\mathbf{x}_k,\mathbf{u}_k,\mathbf{d}_k)$；
- 执行器约束：$\mathbf{u}_{min}\le \mathbf{u}_k\le \mathbf{u}_{max}$；
- 变化率约束：$\Delta\mathbf{u}_{min}\le \Delta\mathbf{u}_k\le \Delta\mathbf{u}_{max}$；
- 安全约束：ODD 与 Safety Envelope 不可越界。

其中 $T_p$ 为预测时域，$T_c$ 为控制时域。

[物理直觉] 第一项保证“送到位”，第二项抑制“动作过猛”，第三项防止“越界冒险”。

## 5.4 在线求解时序与系统接口

在 SCADA+HDC 架构下，建议 MPC 在线时序如下：

1. 拉取最新状态与扰动预测；
2. 运行约束检查与数据质量评估；
3. 求解最优控制增量；
4. 仅下发首个控制动作（滚动时域）；
5. 记录策略版本、求解状态、执行反馈。

上线前应定义计算预算：

$$
\tau_{sense}+\tau_{solve}+\tau_{dispatch}+\tau_{audit} \le \tau_{cycle}
$$

若预算不满足，触发回退策略（如切换协同模式或使用上周期可行解）。

[表5-1: MPC在线调度时序与接口清单]
{描述: 列包括步骤、输入数据、输出数据、时延预算、失败回退动作、审计字段。}
{尺寸: 半页}
{颜色方案: 灰度}

[图5-1: MPC在线调度与回退流程图]
{描述: 展示状态采集、优化求解、动作下发、求解超时回退、模式切换与审计归档的闭环流程。}
{尺寸: 全页}
{颜色方案: 蓝色系}


## 5.5 参数整定与模式切换联动（补齐ch04跟踪项）

为补齐 ch04 跟踪项，本节给出最小整定流程：

- 预测时域 $T_p$：覆盖主要输水时滞；
- 控制时域 $T_c$：兼顾计算负担与控制自由度；
- 权重 $(\alpha,\beta,\gamma)$：按供水、平稳、安全目标分配。

联动规则示例：

- 自动模式：使用全量约束 MPC；
- 协同模式：提高安全权重 $\gamma$，缩短 $T_c$；
- 人工模式：MPC 转为建议输出，不直接下发。

[TODO: 需补充胶东季节工况下 $T_p,T_c$ 推荐区间与整定基线]

## 5.6 时滞补偿与回退机制（补齐ch03跟踪项）

针对长渠段时滞，可采用：

- 预测模型中显式时滞项；
- 扰动前馈补偿；
- 可行解热启动（warm start）减少求解波动。

回退机制建议分级：

1. 求解超时：使用最近一次可行解；
2. 连续不可行：切换协同模式并降级目标；
3. 关键约束冲突：进入安全联锁与最小风险状态。

[工程解释] 回退策略是上线必要条件，不是“异常附录”。

## 5.7 可复现实例：一次滚动优化与回退

【例5-1】某时段来水扰动突增，MPC 在本周期求解超时。

**已知**：
- 调度周期 $\tau_{cycle}=900$ s；
- 本周期求解耗时 $\tau_{solve}=980$ s；
- 规则：求解超时即采用上周期可行解并进入协同模式复核。

**求解**：给出处置动作链并判断是否满足安全要求。

**解题过程**：
1. 判定超时（980 > 900），触发一级回退；
2. 下发上周期首控制量，保持执行连续性；
3. 系统切换协同模式，要求人工确认下一周期动作；
4. 记录超时事件、回退动作与恢复条件。

**结果讨论**：
通过“可行解继承 + 模式切换”，系统避免了调度中断，同时保持安全约束可控。

## 5.8 本章小结

本章构建了胶东调水 MPC 在线优化调度的工程路径：从优化问题定义、时序接口、参数整定到时滞补偿与回退机制，形成可上线的闭环策略。下一章将进入在环测试与验证，检验策略在真实约束下的可用性。

## 习题

### 基础题

1. 为什么胶东调水场景特别适合采用 MPC？
2. 解释目标函数中三项权重对应的工程含义。
3. 求解超时时为何优先采用“上周期可行解”而非停控？

### 应用题

4. 针对一个长时滞渠段，给出 $T_p,T_c$ 的整定思路与验证方法。  
5. 设计一个 MPC 回退分级策略表，至少包含 3 级触发条件与动作。

### 思考题

6. 当供水目标与安全约束持续冲突时，MPC 权重应如何动态调整，谁来批准该调整？

### 基础题参考答案要点

1. 因其多约束、长时滞、扰动强且需滚动决策。  
2. 分别对应跟踪性能、动作平顺与安全惩罚。  
3. 可保持控制连续性并降低突发风险。

## 拓展阅读

1. Van Overloop, P.J. (2006). *Model Predictive Control on Open Water Systems*.  
2. Litrico, X. & Fromion, V. (2009). *Modeling and Control of Hydrosystems*.  
3. Lei et al. (2025b). 自主智能水网架构。  
4. Lei et al. (2025c). 在环测试系统。  
5. Rawlings, J.B. et al. (Model Predictive Control, latest edition).

> **术语一致性声明**：本章统一采用“模型预测控制（Model Predictive Control, MPC）”“运行设计域（Operational Design Domain, ODD）”“安全包络（Safety Envelope）”“分层分布式控制（Hierarchical Distributed Control, HDC）”“在环测试（In-the-Loop Testing）”等规范术语；数学符号采用 $Q,h,\tau,T_p,T_c,\mathbf{x},\mathbf{u},\mathbf{y},J$。

### 质量检查清单（执行结果）

- [x] 章首学习目标、章末小结/习题/拓展阅读完整；
- [x] 基础题3 + 应用题2 + 思考题1，含基础题答案要点；
- [x] 公式前有物理直觉，公式后有工程解释；
- [x] 含可复现实例（例5-1）；
- [x] 图表不少于2项（图5-1、表5-1）；
- [x] 章首回顾ch04，章末预告ch06；
- [x] 已补齐ch04对ch05的MPC参数整定与模式联动跟踪项（含TODO占位）。
