<!-- 变更日志
v1 2026-02-16: 初稿
-->

# ch10 MPC实时计算优化

## 学习目标

完成本章后，读者应能够：

1. 识别水网MPC实时部署中的计算瓶颈（模型规模、约束密度、通信时延、求解器稳定性）；
2. 设计“模型降阶—问题重构—求解器调优—超时降级”四层实时优化路径；
3. 构建可工程落地的时延预算、超时门禁与告警分级机制；
4. 给出求解失败场景下的保底控制策略与回退逻辑；
5. 建立可审计的“计算性能—控制质量—安全事件”联动看板。

> 本章承接 ch09：在“安全约束先行”的前提下，讨论如何保证MPC在每个控制周期内“算得出、算得稳、算得起”。

> **前章回顾**：上一章介绍了本领域的核心概念与方法。本章在此基础上进一步展开。


## 为什么实时性是MPC工程成败分水岭

离线仿真中可用较长计算时间追求更优解；现场运行中，若在控制时限 $T_c$ 内未输出可行控制量，系统就会从“次优”退化为“失控风险”。

[物理直觉] 闸门动作窗口只有几分钟，错过时机再优的解都失去价值。

实时控制的基本门槛可写为：

$$
\tau_{sense}+\tau_{comm}+\tau_{solve}+\tau_{act}\le T_c
$$

其中 $\tau_{sense}$ 为感知采集时延，$\tau_{comm}$ 为通信时延，$\tau_{solve}$ 为优化求解时延，$\tau_{act}$ 为执行落地时延。

[工程解释] 这不是“理论约束”，而是上线门禁。任一项超预算都应触发告警与降级。

## 计算复杂度来源与量化口径

典型QP/NLP求解复杂度随决策维度 $n_u$、预测步长 $N_p$、约束数量 $m$ 增长而上升。工程上应先建立统一度量：

- P50/P95/P99 求解时延；
- 超时率（timeout ratio）；
- 可行解率（feasible ratio）；
- 约束活跃率（active constraints ratio）。

建议把“实时性”从单点平均值改为分位统计，避免被少量快样本掩盖尾部风险。

[表10-1: 求解性能指标与门禁阈值模板]
{描述: 列包括指标名称、定义、统计窗口、建议阈值、触发动作、责任角色。}
{尺寸: 半页}
{颜色方案: 灰度}

## 四层实时优化路径

### 10.4.1 第一层：模型降阶与状态压缩

对缓变子系统可采用低阶近似，保留主导动态，减少状态维度。对耦合弱通道可采用分块解耦。

常用策略：

- 平衡截断/主成分保留；
- 慢变量抽样降频；
- 扰动预测外推替代高频在线辨识。

### 10.4.2 第二层：优化问题重构

通过结构化建模降低求解难度：

- 稀疏矩阵显式化；
- 软约束分层惩罚，避免硬冲突导致不可行；
- move blocking（控制分段常值）减少决策变量。

若控制序列按块约束，可由 $N_p$ 个决策降为 $N_b$ 个块决策（$N_b\ll N_p$）。

### 10.4.3 第三层：求解器参数调优

关键参数包括最大迭代次数、收敛容差、warm-start策略、并行线程数。建议建立“参数组A/B/C”：

- A组：高精度、常态使用；
- B组：平衡精度与速度，黄色告警时切换；
- C组：低计算负载，超时风险时保底。

### 10.4.4 第四层：超时降级与保底控制

当 $\tau_{solve}$ 超出阈值时，不应等待“完美解”，应执行可验证保底动作。推荐流程：

1. 首次超时：重用上一步可行解并收紧动作幅度；
2. 连续超时：切换C组参数并缩短预测步长；
3. 严重超时：退出优化器，执行规则库/联锁保底策略。

[图10-1: 实时求解超时分级处置流程]
{描述: 展示正常、预警、超时、严重超时四状态及对应切换路径和恢复条件。}
{尺寸: 全页}
{颜色方案: 蓝色系}

## 时延预算与网络协同

在分层分布式架构下，计算优化必须与通信设计协同。建议按链路分配预算：

$$
\tau_{solve}^{budget}=T_c-(\tau_{sense}^{budget}+\tau_{comm}^{budget}+\tau_{act}^{budget})
$$

并设置运行时裕量系数 $\gamma\in(0,1)$：

$$
\tau_{solve}^{alarm}=\gamma\cdot\tau_{solve}^{budget}
$$

通常可取 $\gamma=0.8$ 作为预警门限，P95 超过该值则触发参数降级评估。

[TODO: 需结合具体站点网络拓扑补充链路级预算基线表。]

## 可复现实例：求解超时门禁配置

【例10-1】某泵站—调蓄池系统控制周期 $T_c=120$ s，现场统计得到：

- $\tau_{sense}^{budget}=15$ s；
- $\tau_{comm}^{budget}=20$ s；
- $\tau_{act}^{budget}=15$ s；
- 设 $\gamma=0.8$。

**求解**：计算求解预算与告警阈值，并给出超时处置策略。

**解题过程**：

1. 求解预算：
$$
\tau_{solve}^{budget}=120-(15+20+15)=70\text{ s}
$$
2. 告警阈值：
$$
\tau_{solve}^{alarm}=0.8\times70=56\text{ s}
$$
3. 处置规则：
   - 单次求解时延 $>56$ s：触发黄色告警，切换B组参数；
   - 连续2次 $>70$ s：触发橙色告警，切换C组并缩短 $N_p$；
   - 连续3次超时：触发红色告警，启用保底规则并上报值守。

**结果讨论**：
通过“预算—阈值—分级动作”三元联动，可把“偶发慢解”控制为“可管理风险”，避免直接演化为安全事件。

## 运行看板与审计闭环

建议将以下指标联动展示：

- 计算侧：P95求解时延、超时率、可行解率；
- 控制侧：跟踪误差、能耗指标、动作平滑度；
- 安全侧：黄色/红色告警次数、联锁触发率、恢复时长。

看板应支持“事件回放”：从时延劣化追溯到参数切换、再追溯到控制效果与安全后果，形成可问责链路。

[表10-2: 求解超时—安全告警联动SOP模板]
{描述: 列包括事件等级、触发条件、自动动作、人工确认时限、恢复准则、归档字段。}
{尺寸: 半页}
{颜色方案: 灰度}

## 本章小结

本章围绕MPC实时计算提出了可落地框架：以时延预算为边界，以四层优化路径降低计算负担，以超时分级机制保证“先安全、后最优”，并通过联动看板完成闭环审计。下一章将进入工程部署与运维主题，讨论从试点到规模化复制的门禁体系。

## 习题

### 基础题

**10-1.** 为什么MPC实时部署必须关注P95/P99而非仅平均时延？
**10-2.** 写出控制周期内时延分解公式并解释各项含义。
**10-3.** 超时降级为什么是“控制稳定性机制”而非“性能妥协”？

### 应用题

**10-4.** 某系统 $T_c=90$ s，给定感知/通信/执行预算分别为10/15/10 s，取 $\gamma=0.75$，计算求解预算与告警阈值，并设计三级处置动作。  
**10-5.** 结合你所在工程，设计一份“求解器参数A/B/C切换表”，包含触发条件与恢复条件。

### 思考题

**10-6.** 在极端洪水场景下，若“高精度优化”与“及时可行解”冲突，应如何设定审批优先级与责任边界？

### 基础题参考答案要点

**10-7.** 尾部时延决定超时风险，直接影响安全门禁。  
**10-8.** $\tau_{sense}+\tau_{comm}+\tau_{solve}+\tau_{act}\le T_c$，分别对应采集、通信、求解、执行。  
**10-9.** 降级保障连续可行控制，避免无控制输出导致风险放大。

## 拓展阅读

1. **Rawlings, J.B., Mayne, D.Q. & Diehl, M. (2017). *Model Predictive Control: Theory, Computation, and Design*.**
2. **Wang, Y. & Boyd, S. (2010). Fast MPC using online optimization.**
3. **Kouzoupis, D. et al. (2018). Embedded optimization for MPC.**
4. **IAHR Task Committee (2024). Real-time control practice in large-scale water networks.**
5. **Lei et al. (2025b). 水网预测控制工程实践。**
