# 第4章 SCADA+MAS融合架构实现

## 学习目标

- 回顾第3章的一致性与协商机制，理解其在系统实现中的落地位置。
- 掌握SCADA+MAS Fusion Architecture的分层服务划分与职责边界。
- 能够设计消息接口契约（字段、校验、时效、签名）与异常处理分支。
- 理解灰度上线、回退策略与最小风险状态之间的联动关系。
- 为第5章“复杂约束与冲突消解”提供实现基座。

---

## 4.1 章节衔接：从协议机理到工程系统

第3章回答了“如何协商一致”，但工程现场还要回答“谁来执行、在哪执行、失败如何处置”。换言之，算法正确只是起点，架构正确才决定系统是否可持续运行。本章聚焦SCADA+MAS Fusion Architecture的实现问题：把提案、校核、确认三阶段机制映射到可部署服务与可审计接口。

---

## 4.2 融合架构的三层实现视图

### 4.2.1 接入执行层（L0）

- 对接SCADA RTU/PLC、站控系统、历史库；
- 负责数据采集、时间对齐、指令下发与回执；
- 提供“确定性执行”保障，不承载复杂协同决策。

### 4.2.2 协同决策层（L1）

- 承载优化智能体、监督智能体、诊断智能体服务；
- 实现一致性迭代、约束投影、冲突消解与候选策略排序；
- 通过消息总线实现异步通信与重试。

### 4.2.3 运营治理层（L2）

- 承载ODD判定、策略审批、审计追溯、模型版本治理；
- 管理灰度发布、A/B策略比较、回滚触发；
- 连接人机协同界面，支持人工接管。

[图4-1: SCADA+MAS Fusion Architecture部署拓扑]
{描述: 左侧为SCADA站控与边缘网关，中间为MAS微服务集群（优化/监督/诊断），右侧为治理平台与运维中心；标注数据流、控制流、审计流三条通道。}
{尺寸: 全页}
{颜色方案: 蓝色系}
{对应ARCH编号: ARCH-04}

---

## 4.3 服务拆分与职责矩阵

[表4-1: 接口字段—服务职责对照表]

| 字段 | 生产者 | 消费者 | 校验规则 | 失败处置 |
|---|---|---|---|---|
| `proposal_vector` | 优化智能体 | 监督智能体 | 维度、单位、时间戳一致 | 拒绝并返回错误码E101 |
| `constraint_margin` | 监督智能体 | 执行智能体 | 不得为负 | 触发重协商 |
| `risk_level` | 诊断智能体 | 监督智能体/L2治理 | 枚举值合法 | 降级到最小风险状态 |
| `ttl` | 消息网关 | 所有服务 | 未超时 | 超时重传，超阈值告警 |
| `signature` | 消息网关 | 执行智能体 | 签名有效 | 丢弃并记录安全事件 |

该矩阵用于将“谁负责什么”显式化，避免线上故障时跨团队互相归因。

---

## 4.4 消息接口契约与异常分支

### 4.4.1 最小接口契约

建议统一消息结构：

```json
{
  "msg_id": "uuid",
  "agent_id": "A_OPT_01",
  "timestamp": "2026-02-17T10:15:00Z",
  "proposal_vector": {"Q_A": 252, "Q_B": 308},
  "constraint_margin": {"flow_upper": 18},
  "risk_level": "YELLOW",
  "ttl": 3,
  "signature": "base64..."
}
```

### 4.4.2 关键异常分支

1. **签名校验失败**：执行智能体直接拒绝，写入安全日志，触发告警；
2. **TTL耗尽**：消息进入死信队列，由治理层决定重放或人工确认；
3. **约束裕度为负**：监督智能体触发投影重算，不允许直接执行；
4. **ODD越界**：停止新提案，切换最小风险状态。

[图4-2: 异常处理状态机]
{描述: 从消息接收、校验、协商、执行到审计的状态转移图，包含签名失败、超时、越界三类异常回路。}
{尺寸: 半页}
{颜色方案: 灰度}

---

## 4.5 灰度上线与回退机制

### 4.5.1 灰度上线四阶段

- **阶段S1（影子运行）**：MAS只读，不下发控制指令；
- **阶段S2（建议模式）**：MAS生成建议，由人工确认后执行；
- **阶段S3（半自动）**：低风险工况自动执行，高风险工况人工确认；
- **阶段S4（受控自动）**：在ODD内自动执行，异常自动回退。

### 4.5.2 回退触发条件

可定义回退函数：

$$
\rho(k)=\mathbb{I}(e_{safe}>e_{th} \lor n_{timeout}>n_{th} \lor z\notin\Omega_{ODD})
$$

若 $\rho(k)=1$，系统回退到上一稳定版本或最小风险状态。

**工程解释**：回退不是失败标志，而是安全治理能力的一部分。能安全回退的系统，才配上线。

---

## 4.6 例题：签名失败与超时并发场景处置

【例4-1】某联调周期中，优化智能体发送两条提案消息：M1在签名校验失败，M2签名通过但TTL耗尽。系统要求在30秒内输出可执行动作或进入最小风险状态。

**已知**：
- M1：`signature_invalid=true`；
- M2：`ttl=0`；
- 当前风险等级 `risk_level=YELLOW`；
- 可用上一周期稳定动作 `u_{k-1}`。

**求解**：给出处置流程并判断最终执行动作。

**解题过程**：
1. 对M1执行“拒绝+告警+审计记录”，不进入执行队列；
2. 对M2执行“死信队列登记+超时计数+请求重发”；
3. 因30秒窗口内无有效新提案，监督智能体触发回退逻辑；
4. 执行动作采用上一周期稳定动作 $u_{k-1}$，并标记“降级执行”；
5. 若超时计数持续超阈值，则升级为最小风险状态。

**结果讨论**：
该场景说明接口治理与异常分支不是附属功能，而是保障连续安全运行的主链路。尤其在通信波动场景下，“保守可执行”优先于“理论最优”。

---

## 4.7 本章小结

本章完成了SCADA+MAS Fusion Architecture从概念到实现的关键映射。首先，通过L0/L1/L2三层视图明确了执行、协同与治理职责；其次，通过接口字段—服务职责矩阵和统一消息契约，建立了可审计、可追责的协同接口；再次，构建了签名失败、TTL耗尽、约束越界、ODD越界等异常分支，保证系统在故障场景下仍有确定处置路径；最后，提出灰度上线与回退机制，强调“可安全回退”是自动化系统上线的必要条件。下一章将进一步讨论复杂约束耦合下的冲突消解与非凸可行域处理。

---

## 习题

### 一、基础题

1. 比较L0、L1、L2三层在SCADA+MAS Fusion Architecture中的核心职责。
2. 为什么`signature`与`ttl`字段必须纳入最小消息契约？
3. 说明“回退能力”为什么是上线前置条件，而不是运维补丁。

### 二、应用题

4. 给定一个泵站群协同场景，设计最小接口字段集并说明每个字段的校验规则。
5. 设计一个灰度上线指标看板（至少5个指标），并给出从S2晋级S3的准入条件。

### 三、思考题

6. 在人机共融模式下，如何界定“人工接管”触发阈值，才能既不过度保守也不过度激进？

---

## 拓展阅读

1. Buyalski, C. P. (1991). *Canal Systems Automation Manual*.
2. Litrico, X., & Fromion, V. (2009). *Modeling and Control of Hydrosystems*. Springer.
3. Leitão, P., Karnouskos, S., Ribeiro, L., et al. (2016). Smart agents in industrial cyber–physical systems. *Proceedings of the IEEE*.
4. Lei, X. (2025b). 自主智能水网架构. DOI: 10.13476/j.cnki.nsbdqk.2025.0079.
5. Lei, X. (2025c). 在环测试系统. DOI: 10.13476/j.cnki.nsbdqk.2025.0080.

---

**下一章预告**：第5章将讨论复杂约束与冲突消解，包括非凸可行域、优先级博弈与多目标权重在线调整。
