<!-- 变更日志
v1 2026-02-16: 初稿（基于“继续”命令自动续写）
-->

# ch09 HydroOS API与应用生态

## 9.1 学习目标

完成本章后，读者应能够：

1. 解释 HydroOS API 分层（设备、能力、业务）及其边界；
2. 设计面向调水与水电场景的统一接口契约与版本治理策略；
3. 构建 API 门禁策略与发布流水线联动机制（补齐 ch08 跟踪项）；
4. 评估应用生态中的扩展模式、风险隔离与兼容性要求；
5. 利用度量指标监控 API 质量并支持持续演进。

> 承接 ch08：上一章已建立“测试—发布—审计”闭环；本章进一步回答“如何把 HydroOS 的控制与认知能力稳定地对外开放”。

## 9.2 为什么 HydroOS 需要分层 API

HydroOS 的核心不是单一算法，而是跨设备、跨控制层、跨业务角色的协同系统。若 API 不分层，常见问题包括：

- 现场设备细节泄露到业务应用，导致耦合过深；
- 业务需求变化直接冲击控制内核，影响稳定运行；
- 多团队协作中接口职责不清，造成重复建设与灰度冲突。

因此建议采用三层 API 体系：

1. **设备抽象 API**：统一泵站、闸门、机组、传感器的读写语义；
2. **能力服务 API**：暴露优化、预测、告警、仿真、审计等能力；
3. **业务编排 API**：支撑调度工单、应急联动、报表与协同流程。

[图9-1: HydroOS三层API与调用关系]
{描述: 图中展示设备层、能力层、业务层及其北向/南向接口，标注同步调用与事件订阅两类链路，并给出典型调用方向。}
{尺寸: 全页}
{颜色方案: 蓝色系}
{对应ARCH编号: ARCH-03}

## 9.3 接口契约与版本治理

### 9.3.1 契约优先（Contract-First）

建议以 OpenAPI/AsyncAPI 描述契约，先定义输入输出，再实现服务。最小契约元素包括：

- 资源标识：`asset_id`、`station_id`、`basin_id`；
- 时序语义：采样周期、时区、时间戳精度；
- 约束字段：ODD 范围、安全包络阈值、门禁标签；
- 追踪字段：`trace_id`、`policy_version`、`model_version`。

[工程解释] 契约优先可将“接口争议”前移到设计阶段，减少上线后联调返工。

### 9.3.2 版本策略

推荐版本号：`API-major.minor.patch`。规则如下：

- major：破坏兼容（字段删除、语义改变）；
- minor：向后兼容新增字段或端点；
- patch：错误修复与非语义变更。

与门禁协同要求：

- `major` 发布必须通过 HIL 回归与三方会签；
- `minor` 发布必须通过 SIL 回归；
- `patch` 发布至少完成自动化契约测试。

[表9-1: API版本变更类型与测试放行矩阵]
{描述: 列包含版本变更类型、兼容性影响、最低测试层级、审批角色、可回滚窗口。}
{尺寸: 半页}
{颜色方案: 灰度}

## 9.4 API门禁与流水线联动（补齐ch08跟踪项）

为落实 ch08 的跟踪项，本节给出“契约测试—门禁判定—发布放行”联动机制。

联动核心字段：

- `api_contract_version`
- `compatibility_score`
- `gate_result`
- `pipeline_stage`
- `rollback_plan_id`

推荐放行判定：

- 当 `compatibility_score < 0.95` 时，禁止进入生产阶段；
- 当 `gate_result = conditional_pass` 时，仅允许 Canary；
- 当契约测试存在 `breaking_change` 且未完成消费方确认时，强制阻断。

[物理直觉] API 变更就像更换闸门驱动接口：即使设备能动，若命令语义变化未被下游理解，也会导致系统性误操作。

## 9.5 API质量度量与SLO

为保障生态稳定，建议定义 API SLO：

- 可用性：`Availability ≥ 99.9%`；
- 时延：关键读写接口 P95 ≤ 200 ms；
- 正确性：契约校验通过率 ≥ 99.5%；
- 变更风险：发布后 24 h 内回滚率 ≤ 5%。

可定义综合质量指标：

$$
J_{api}=w_1A+w_2(1-L_{p95}/L_{ref})+w_3C+w_4(1-R)
$$

其中：

- $A$ 为可用性；
- $L_{p95}$ 为时延 P95，$L_{ref}$ 为参考上限；
- $C$ 为契约正确性；
- $R$ 为回滚率。

[工程解释] 通过统一目标函数 $J_{api}$，可在“高性能、低风险、高兼容”之间做量化权衡。

## 9.6 生态扩展模式与隔离策略

HydroOS 应用生态可按三类扩展：

1. **原生应用（Native App）**：平台团队主导，深度集成门禁与审计；
2. **伙伴插件（Partner Plugin）**：第三方算法或报表组件，通过沙箱接入；
3. **行业集成（Enterprise Integration）**：与 SCADA、EAM、应急指挥平台双向对接。

隔离策略建议：

- 运行隔离：按租户与场景划分命名空间；
- 数据隔离：按流域/站点最小权限访问；
- 风险隔离：高风险插件仅在 staging 或 shadow 运行；
- 审计隔离：第三方操作必须独立留痕与签名。

[图9-2: HydroOS应用生态扩展与隔离边界]
{描述: 展示原生应用、伙伴插件、行业集成三类生态角色，及其访问路径、权限边界、审计边界。}
{尺寸: 半页}
{颜色方案: 蓝色系}

## 9.7 可复现实例：一次破坏性API变更的阻断流程

【例9-1】某团队拟将 `POST /dispatch/plan` 的字段 `target_level` 改为 `target_h`，并删除旧字段。该变更被标记为 `API-3.0.0`。

**已知**：

- 12 个消费方中仅 7 个完成适配；
- 契约兼容度评分 `compatibility_score = 0.82`；
- 流水线规则：`compatibility_score < 0.95` 或存在未确认 breaking change 即阻断。

**求解**：判断能否发布并给出最小处置动作。

**解题过程**：

1. 评分 0.82 低于阈值 0.95，触发阻断；
2. 存在 5 个未确认消费方，满足 breaking change 阻断条件；
3. 流水线将 `pipeline_stage` 回退至 `contract_review`；
4. 生成整改工单：要求增加过渡字段并提供兼容窗口；
5. 更新回滚预案与再测试计划后方可重新申请放行。

**结果讨论**：
在上线前阻断破坏性变更，可显著降低现场联调失败与误调度风险。

## 9.8 本章小结

本章围绕 HydroOS 对外能力开放，建立了“分层 API—契约治理—门禁联动—生态隔离—质量度量”一体化方法。其核心价值在于：让平台既可扩展、又可控制。下一章将对全书进行工程化收束，形成交付度量看板与跨章节验收清单。

## 习题

### 基础题

1. 说明 HydroOS 三层 API 的职责边界与典型调用关系。  
2. 区分 `API-major/minor/patch` 三类变更的兼容性影响。  
3. 为什么契约测试应先于服务实现？

### 应用题

4. 设计一份调水业务 API 的版本治理策略，包含变更分级、测试门槛与审批流程。  
5. 为“伙伴插件”场景制定最小隔离策略（运行、数据、审计三个维度）。

### 思考题

6. 在多单位协同的流域调度中，如何平衡“开放生态接口”与“控制系统安全闭环”？

### 基础题参考答案要点

1. 设备层管抽象控制点，能力层管算法与服务，业务层管流程协同。  
2. major 破坏兼容，minor 向后兼容扩展，patch 非语义修复。  
3. 契约优先可前置协同问题，降低集成与回归成本。

## 拓展阅读

1. Lei et al. (2025b). 自主智能水网架构。  
2. Lei et al. (2025c). 在环测试系统。  
3. OpenAPI Specification (latest).  
4. AsyncAPI Specification (latest).  
5. NIST SP 800-204A (Microservices Security).

> **术语一致性声明**：本章统一采用“水网操作系统（Water Network Operating System, HydroOS）”“运行设计域（Operational Design Domain, ODD）”“安全包络（Safety Envelope）”“在环测试（In-the-Loop Testing）”“分层分布式控制（Hierarchical Distributed Control, HDC）”等规范术语；数学符号采用 $Q,h,\tau,T_p,T_c,\mathbf{x},\mathbf{u},\mathbf{y},J$。

### 质量检查清单（执行结果）

- [x] 章首学习目标、章末小结/习题/拓展阅读完整；
- [x] 基础题3 + 应用题2 + 思考题1，含基础题答案要点；
- [x] 公式前有物理直觉，公式后有工程解释；
- [x] 含可复现实例（例9-1）；
- [x] 图表不少于2项（图9-1、图9-2、表9-1）；
- [x] 章首回顾ch08，章末预告ch10；
- [x] 已补齐ch08跟踪项（API门禁与发布流水线联动机制）。
