<!-- 变更日志
v1 2026-02-19: 初稿
-->

# 第八章 覆盖度度量与质量门禁

## 学习目标

1. 掌握在环测试覆盖度的多维度量方法——场景覆盖率、ODD子域覆盖率和风险覆盖率——理解各指标的计算方法和工程含义；
2. 理解缺陷分级体系（S1-S4）与回归测试机制的关系，能够设计闭环的"发现-修复-验证"缺陷管理流程；
3. 掌握版本发布质量门禁的设计方法，能够定义MIL/SIL/HIL各阶段的准出条件；
4. 理解运行时监控与持续验证的理念，能够将在环验证从"部署前一次性验收"扩展到"运行中持续保障"。

> **前章回顾**：第七章建立了从ODD到测试用例的系统化设计方法——四维场景矩阵提供了场景空间的系统化描述，P0/P1/P2分级确保了测试资源的合理分配，自动化测试框架保证了执行效率和可重复性。然而，"设计了多少测试用例"不等于"测试足够充分"。本章回答"测试够不够"和"系统能否发布"这两个关键的工程决策问题。

---

## 8.1 覆盖度度量体系

### 8.1.1 为什么需要覆盖度度量

覆盖度度量（Coverage Metrics）回答"测试在多大程度上覆盖了需要验证的内容"。水利控制系统的在环验证需要多维度的覆盖度度量——单一的"测试通过率"远远不够。一个100%通过率但只测试了标称工况的测试方案，其实际保障能力远低于一个95%通过率但覆盖了极端工况和故障组合的测试方案。

### 8.1.2 场景覆盖率

场景覆盖率衡量测试执行的场景在场景矩阵中的覆盖比例。

**绝对覆盖率**：$C_{abs} = N_{executed} / N_{total}$。其中$N_{total}$是场景矩阵中的全部场景数，$N_{executed}$是已执行的场景数。对于使用Pairwise缩减后的场景矩阵，绝对覆盖率应达到100%。

**Pairwise覆盖率**：$C_{pw} = N_{covered\_pairs} / N_{total\_pairs}$。衡量任意两个维度的两水平组合在多大比例上被测试覆盖。完整的Pairwise测试方案的$C_{pw}=100\%$。

**表8-1 覆盖度指标体系**

| 指标 | 定义 | 目标值 | 计算方法 |
|------|------|-------|---------|
| 场景绝对覆盖率 | 已执行场景/总场景 | 100%（Pairwise集） | 直接计数 |
| Pairwise覆盖率 | 已覆盖参数对/总参数对 | 100% | 组合分析 |
| ODD边界覆盖率 | 已测试边界/总ODD边界 | ≥90% | 边界枚举 |
| 安全联锁覆盖率 | 已验证联锁/总联锁 | 100% | 联锁清单 |
| 风险覆盖率 | 已覆盖高风险场景/总高风险场景 | 100% | 风险评估 |
| 代码覆盖率（SIL） | 已执行代码行/总代码行 | ≥80% | 覆盖工具 |

### 8.1.3 ODD子域覆盖率

ODD定义了多维连续空间，而测试只能在该空间中采样有限个点。ODD子域覆盖率将ODD空间划分为若干子域（如"枯水期+正常设备"、"冰期+设备故障"），评估每个子域是否有足够数量的测试点。

子域划分的原则：每个子域内系统行为应"相似"（等价类的概念）。子域之间的边界应对应系统行为的显著变化（如冰期/非冰期的切换点、设备故障/正常的状态变化点）。

### 8.1.4 风险覆盖率

风险覆盖率衡量高风险场景的测试覆盖程度。其计算需要先进行风险评估：

$$R_i = P_i \times I_i$$

其中$R_i$是场景$i$的风险值，$P_i$是该场景的发生概率，$I_i$是该场景下控制失效的影响严重度。风险覆盖率 = 已测试的高风险场景数 / 总高风险场景数。

【例8-1】某调水工程的在环测试覆盖度评估。

[测试执行情况] 完成40个Pairwise场景中的38个（2个因设备故障推迟），额外执行了15个专家推荐场景。P0用例45个全部通过，P1用例230个中通过225个（5个失败），P2用例1200个中通过1140个（60个失败）。

[覆盖度计算]
- 场景绝对覆盖率：38/40 = 95%（未达100%目标）
- Pairwise覆盖率：经分析，2个未执行场景导致3对参数组合未覆盖，$C_{pw}$ = 97.3%
- 安全联锁覆盖率：6个联锁全部通过HIL验证 = 100% ✓
- 风险覆盖率：12个高风险场景全部执行 = 100% ✓
- SIL代码覆盖率（语句覆盖）：83.5%

[覆盖度评判] 场景覆盖率95%和Pairwise覆盖率97.3%未达100%目标。但安全联锁和风险覆盖率均为100%，说明最关键的场景已全部覆盖。2个未执行场景涉及的是"多泵检修+通信延迟"组合——风险等级为中等，可在下一轮补充测试中完成。

---

## 8.2 缺陷分级与回归机制

### 8.2.1 缺陷分级标准

在环验证中发现的缺陷按照第四章定义的S1-S4分级标准进行分类。本节进一步细化缺陷分级的操作标准，确保分级判定的一致性。

**表8-2 缺陷分级操作标准**

| 等级 | 判定条件 | 典型示例 | 处理流程 |
|------|---------|---------|---------|
| S1-致命 | 安全联锁失效或标称工况下控制发散 | 水位超限联锁未触发 | 立即停止测试→修复→全量回归 |
| S2-严重 | 常见工况性能不达标或降级机制失效 | PI控制器在标称流量下超调超限 | 优先修复→受影响范围回归 |
| S3-一般 | 极端工况性能退化但无安全影响 | 冰期+低流量场景下调节时间超限 | 计划修复→定向回归 |
| S4-建议 | 性能可接受但有优化空间 | 闸门调节频率偏高增加磨损 | 记录→后续版本优化 |

### 8.2.2 回归测试策略

缺陷修复后的回归测试遵循"最小充分集"原则——既确保修复有效且未引入新问题，又不进行不必要的重复测试。

回归测试的选择策略：（1）必须执行：直接验证缺陷修复的测试用例；（2）强烈建议：与修改代码/配置有依赖关系的测试用例；（3）推荐：P0全量冒烟测试；（4）可选：P1中受影响功能模块的测试用例。

【例8-2】修复一个S2缺陷（闸站3的PI积分时间导致恢复超限）后的回归测试设计。

[修复内容] 将闸站3的PI积分时间$T_i$从800s减小到500s。

[回归测试方案]
- 直接验证：重新执行导致缺陷的原始测试场景（旁侧入流扰动抑制），确认恢复时间＜3600s ✓
- 依赖关系：闸站3参与的所有多站协调测试（5个用例），确认参数变更未影响协调性能
- P0冒烟：全部45个P0用例，确认基本功能无退化
- 稳定性确认：$T_i$减小可能增加闸门动作频率，需执行24小时长时间运行测试确认闸门磨损在可接受范围

[回归结果] 原始缺陷修复确认 ✓。协调测试5个用例全部通过 ✓。P0全部通过 ✓。24小时测试中闸门动作次数从日均47次增加到日均62次（增加32%），仍在设备寿命允许范围内 ✓。

---

## 8.3 版本发布质量门禁

### 8.3.1 门禁的设计原则

质量门禁（Quality Gate）是版本发布的前置条件——只有通过门禁检查的版本才允许发布或进入下一测试阶段。门禁设计遵循"必须条件+推荐条件"的分层结构。

**表8-3 MIL/SIL/HIL各阶段质量门禁**

| 门禁条件 | MIL准出 | SIL准出 | HIL准出（发布前） |
|---------|---------|---------|----------------|
| P0通过率 | 100% | 100% | 100% |
| P1通过率 | ≥95% | ≥98% | 100% |
| P2通过率 | ≥90% | ≥95% | ≥95% |
| S1缺陷 | 0个 | 0个 | 0个 |
| S2缺陷 | 0个 | 0个 | 0个 |
| S3缺陷 | 允许带入SIL | ≤3个且有规避方案 | 0个 |
| 安全联锁覆盖 | 100%通过 | 100%通过 | 100%通过 |
| 覆盖度 | $C_{pw}$≥100% | $C_{pw}$≥100% + 代码覆盖≥80% | 全部指标达标 |
| 回归测试 | 修复缺陷全部回归通过 | 同左 | 同左 |
| 报告 | MIL报告签字 | SIL报告签字 | HIL报告+发布评审签字 |

### 8.3.2 门禁审批流程

质量门禁的审批通常涉及三个角色：测试负责人（确认测试数据的完整性和准确性）、技术负责人（评审未关闭缺陷的影响和规避方案）、项目负责人（做出"通过/不通过/有条件通过"的最终决策）。

"有条件通过"适用于以下情况：少数低风险场景未覆盖但高风险场景已全部覆盖、S3/S4缺陷存在但有明确的规避方案和修复计划、覆盖度指标略低于目标但差距可解释（如设备故障导致2个场景推迟）。

---

## 8.4 运行时监控与持续验证

### 8.4.1 从一次性验收到持续验证

传统的在环验证是"部署前一次性验收"模式——通过MIL/SIL/HIL测试后投入运行，运行期间不再进行系统性验证。这种模式存在盲区：运行条件可能超出原始测试的覆盖范围，软件更新和配置变更可能引入新问题，设备老化导致特性参数偏移。

CHS提倡**持续验证**（Continuous Verification）理念——将在环验证的思想延伸到系统运行阶段。具体措施包括：

**运行时ODD监控**：实时检查系统运行状态是否在ODD边界内。当运行状态接近或超出ODD边界时发出预警。

**在线模型对比**：将实际传感器数据与在环验证中使用的被控对象模型的输出进行实时对比。当两者偏差超过阈值时，说明模型可能需要更新——要么实际工况偏离了模型假设，要么设备参数发生了偏移。

**回归测试自动化触发**：每次控制软件更新或配置变更后，自动触发P0回归测试（在MIL/SIL环境中执行，不影响实际运行）。

【例8-3】某调水工程运行一年后的持续验证发现。

[ODD监控记录] 运行第8个月起，渠段2的Manning糙率估算值从0.015逐步上升至0.019（基于水位-流量关系反推）。该值仍在ODD范围内（$n \in [0.012, 0.022]$），但已接近MIL参数敏感性分析中识别的"敏感区域"（$n > 0.017$时控制性能显著退化）。

[在线模型对比] 实际水位-流量关系与仿真模型的偏差从0.02m增加到0.08m，超过了0.05m的预警阈值。

[响应措施] (1) 更新被控对象模型的糙率参数为0.019；(2) 在MIL中以新参数重新执行P1核心测试——发现闸站3的调节时间从1500s增加到2800s，接近3600s限值；(3) 建议对闸站3的PI参数进行在线调整（增大$K_p$或减小$T_i$）；(4) 安排冬季停水期进行渠道清淤维护。

[结果讨论] 持续验证在控制系统实际发生性能退化之前预警了风险。如果没有持续验证，该问题可能在下一次极端来水工况中暴露——届时调节时间可能超限，影响调水安全。

---

## 本章小结

本章建立了在环验证的定量评价体系和工程决策机制。

首先，构建了多维覆盖度度量体系（表8-1）。场景覆盖率、Pairwise覆盖率、ODD边界覆盖率、安全联锁覆盖率和风险覆盖率从不同角度衡量测试的充分性。通过例8-1展示了覆盖度评估的完整过程和工程判断方法。

其次，细化了缺陷分级操作标准（表8-2）和回归测试策略。"最小充分集"原则确保回归测试的效率和效果。例8-2展示了S2缺陷修复后的系统性回归验证过程。

第三，建立了MIL/SIL/HIL各阶段的质量门禁体系（表8-3），定义了版本从一个验证阶段进入下一阶段或最终发布的准出条件，以及"有条件通过"的适用范围。

第四，提出了运行时监控与持续验证的理念和方法——ODD监控、在线模型对比和自动回归触发。例8-3展示了持续验证在实际工程运行中发现糙率退化风险的案例，证明了从"一次性验收"向"持续保障"演进的价值。

> 下一章将以胶东调水工程为完整案例，展示MIL/SIL/HIL全流程在环验证的实际实施过程——从仿真平台搭建到测试用例库建设，从缺陷发现与修复到验证报告编制和上线许可评审。

---

## 习题

### 基础题

**8-1.** 区分场景覆盖率和Pairwise覆盖率。为什么一个100%的场景覆盖率不一定意味着100%的Pairwise覆盖率？举例说明。

**8-2.** 解释风险覆盖率的计算方法。为什么风险覆盖率比简单的场景覆盖率更能反映测试的实际保障能力？

**8-3.** 比较S1-S4四级缺陷的处理流程差异。如果在HIL测试的最后阶段发现一个S2缺陷，但项目工期已非常紧张，应该如何处理？

**8-4.** 解释"持续验证"的含义。与传统的"一次性验收"相比，持续验证增加了哪些活动？这些活动需要什么技术基础设施的支持？

### 应用题

**8-5.** 某工程完成了MIL测试，结果如下：P0用例30个全部通过，P1用例150个中通过143个（7个失败，其中2个S2、3个S3、2个S4），P2用例800个中通过736个（64个失败，均为S3或S4）。安全联锁6个全部通过。Pairwise覆盖率100%。请：（a）根据表8-3的门禁条件，判断该版本是否可以进入SIL阶段；（b）如果不能通过，指出具体哪些条件不满足；（c）提出使其通过门禁的最小修复方案。

**8-6.** 为某调水工程设计运行时持续验证方案。工程包含3座闸站，控制采样周期60s，SCADA系统每分钟记录一次过程数据。请：（a）定义ODD监控的5个关键指标及其告警阈值；（b）设计在线模型对比的方法——使用哪个模型、对比哪些变量、偏差阈值如何确定；（c）设计自动回归触发的条件——什么情况下触发、执行哪些测试用例。

### 思考题

**8-7.** 覆盖度度量存在"指标博弈"的风险——测试团队可能为了追求覆盖度数字而增加大量低价值的测试用例，或者通过调整场景矩阵的定义来"提高"覆盖率。讨论：（a）如何设计覆盖度指标体系来减少博弈空间？（b）覆盖度数字之外，还有哪些定性指标可以辅助评判测试充分性？（c）测试评审中如何识别和应对"表面高覆盖但实质低价值"的测试方案？

**8-8.** 持续验证的理想目标是"运行中的任何时刻都能保证系统处于已验证的工况范围内"。但实际上，水利系统会遇到历史上从未出现过的新工况（如百年一遇洪水、极端冰期）。讨论：（a）对于超出历史经验的新工况，在环验证的保障能力有哪些根本局限？（b）如何通过MIL仿真探索"从未发生但可能发生"的工况？（c）当实际运行遇到超出ODD的工况时，系统应如何响应？

---

## 拓展阅读

1. **Ammann, P. & Offutt, J. (2016).** *Introduction to Software Testing.* 2nd ed., Cambridge University Press. — 软件测试理论的权威教材。第6章覆盖度准则和第8章组合测试对理解本章的覆盖度度量体系有直接参考价值。

2. **ISO 26262 (2018).** *Road vehicles — Functional safety.* International Organization for Standardization. — 汽车功能安全标准。其中Part 6关于软件测试覆盖度要求（结构覆盖度目标与ASIL等级的对应关系）对水利控制系统的覆盖度标准制定有借鉴意义。

3. **Koopman, P. & Wagner, M. (2016).** "Challenges in autonomous vehicle testing and validation." *SAE International Journal of Transportation Safety*, 4(1), 15-24. — 讨论了自动驾驶系统的测试覆盖度挑战，特别是ODD边界测试和角落场景发现方法，对水利自动控制系统的验证有启发性。

4. **Lei, X. et al. (2025c).** "In-the-Loop Testing System for Water Network Control." *南水北调与水利科技（中英文）*, DOI: 10.13476/j.cnki.nsbdqk.2025.0080. — HydroOS框架下在环测试系统的覆盖度评估方法和质量门禁设计。
