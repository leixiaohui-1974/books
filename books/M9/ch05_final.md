<!-- 变更日志
v1 2026-02-16: 初稿（基于“继续”命令自动续写）
-->

# ch05 多层级协同调度与分层执行

## 学习目标

完成本章后，读者应能够：

1. 说明水系统多层级协同调度的职责边界与信息接口；
2. 建立“日内计划—滚动校正—实时执行”分层执行流程；
3. 理解分布式协调收敛性的工程直觉与判据；
4. 使用跨班组交接的策略冻结窗口模板降低运行扰动；
5. 为 ch06 的运行评估与持续改进准备可追溯数据链。

> 承接 ch04：上一章解决“如何求解并安全发布策略”，本章解决“如何在多层级组织中稳定执行策略”。

> **前章回顾**：上一章介绍了本领域的核心概念与方法。本章在此基础上进一步展开。


## 多层级协同调度架构

运行工程通常包含三层调度：

- **L2 流域/区域层**：负责跨工程目标分配与约束下达；
- **L1 场站协调层**：负责站群协同、冲突消解与资源重分配；
- **L0 设备执行层**：负责机组、闸门、泵阀等动作落地与反馈。

可用统一接口变量描述层间通信：

- 上行：状态摘要 $\mathbf{y}^{up}$、约束占用率、异常标签；
- 下行：目标轨迹 $\mathbf{r}$、约束边界、策略版本号。

[工程解释] 分层的价值不在“多一层管理”，而在把不同时间尺度和决策粒度解耦，减少全局耦合复杂度。

[图5-1: 多层级协同调度时序图（补齐 ch04 跟踪项）]
{描述: 展示L2/L1/L0在15分钟、5分钟、秒级三个时标上的决策与反馈时序，标注计划发布、滚动重算、异常回退节点。}
{尺寸: 全页}
{颜色方案: 蓝色系}

## 分层执行流程：计划—校正—执行

建议采用“三段式执行流水线”：

1. **计划层（小时级）**：生成基准策略与资源配额；
2. **校正层（分钟级）**：根据最新状态滚动更新局部策略；
3. **执行层（秒级）**：闭环跟踪控制并上报偏差。

可定义跨层一致性误差：

$$
e_k^{align}=\left\|\mathbf{u}^{L0}_k-\mathbf{u}^{L1}_k\right\|_2
$$

当 $e_k^{align}$ 持续超阈值时，应触发“策略一致性复核”而非仅调整设备参数。

[物理直觉] 若上层策略与下层执行长期不一致，系统将表现为“局部看似稳定、全局持续偏离”。

[表5-1: 分层执行职责与输入输出模板]
{描述: 列包括层级、时标、核心任务、输入、输出、异常触发条件、责任角色。}
{尺寸: 半页}
{颜色方案: 灰度}

## 分布式协调收敛性直觉说明（补齐 ch04 跟踪项）

分布式协调常通过迭代交换局部变量与一致性约束实现。以第 $r$ 轮迭代为例，可定义一致性残差：

$$
\varepsilon^{(r)}=\sum_{i=1}^{N}\left\|\mathbf{z}_i^{(r)}-\bar{\mathbf{z}}^{(r)}\right\|_2
$$

其中 $\mathbf{z}_i$ 为第 $i$ 个子系统的协调变量，$\bar{\mathbf{z}}$ 为全局平均/协调目标。

### 工程可接受收敛判据

- **收敛阈值**：$\varepsilon^{(r)}\le \epsilon_c$；
- **单调性**：最近 $m$ 轮迭代中残差总体下降；
- **时限性**：在给定协调时间窗 $T_{coord}$ 内达到阈值。

[物理直觉] 收敛并不意味着“绝对一致”，而是“在业务时限内达到可执行一致”。

若超时未收敛，建议采用：

1. 保守共识策略（优先安全约束）；
2. 局部解封装（局部自治+全局边界保护）；
3. 人工仲裁（记录冲突原因与裁决依据）。

[图5-2: 分布式协调残差收敛示意图]
{描述: 展示正常收敛、震荡收敛与不收敛三类曲线，并标注处置分支。}
{尺寸: 半页}
{颜色方案: 灰度}

## 跨班组交接策略冻结窗口模板（补齐 ch04 跟踪项）

为避免交接班期间策略频繁变更，建议设置冻结窗口：

- 交接前 $T_f^{pre}$：禁止大幅策略改写，仅允许安全相关修正；
- 交接中 $T_f^{handover}$：锁定策略版本，执行“最小必要动作”；
- 交接后 $T_f^{post}$：逐步解冻，允许滚动校正恢复。

可定义动作变化率限制：

$$
\Delta u_k = \|\mathbf{u}_k-\mathbf{u}_{k-1}\|_2 \le \Delta u_{max}^{freeze}
$$

[工程解释] 冻结窗口的核心不是“保守”，而是“在责任交接临界时段保持策略连续性与可追责性”。

[表5-2: 跨班组交接策略冻结窗口模板]
{描述: 列包括时段、允许动作、禁止动作、审批要求、留痕字段、异常豁免条件。}
{尺寸: 全页}
{颜色方案: 灰度}

## 协同执行中的异常处置

多层级协同中常见异常包括：

- 上下游目标冲突（供水与发电目标竞争）；
- 通信延迟导致版本不同步；
- 局部设备降级导致全局策略不可行。

建议采用“三级处置闭环”：

1. **检测**：识别异常类型并打标签；
2. **缓解**：启用约束保护与局部保守策略；
3. **复盘**：更新规则库与交接模板。

## 可复现实例：交接班窗口下的站群协同

【例5-1】某区域晚班交接前 30 分钟，L2 下发新的调峰要求，但两座泵站处于设备温升敏感工况。

已知：

- 冻结窗口设置：$T_f^{pre}=15$ 分钟，$T_f^{handover}=10$ 分钟，$T_f^{post}=20$ 分钟；
- 协调残差在前 5 轮迭代内下降缓慢，尚未达到 $\epsilon_c$；
- 一座泵站通信延迟增大，版本同步滞后 2 个周期。

**任务**：给出交接窗口内的协同策略。

**解题过程**：
1. 启动冻结窗口，暂停非安全必须的策略重写；
2. 对延迟站点启用局部保守策略并设置全局约束保护；
3. 协调层采用“安全优先共识权重”继续迭代，若超时未收敛则触发人工仲裁；
4. 交接完成后按 $T_f^{post}$ 分阶段恢复滚动优化；
5. 留痕记录版本号、冻结时段、仲裁结论与恢复时间。

**结果讨论**：
该案例说明：冻结窗口 + 收敛判据 + 责任留痕可显著降低交接期间的系统性风险。

## 本章小结

本章构建了多层级协同调度与分层执行框架，补充了协同时序图、分布式协调收敛性直觉说明与跨班组交接策略冻结窗口模板，使“策略发布”进一步落地为“稳定执行”。下一章将进入运行绩效评估与持续改进闭环。

## 习题

### 基础题

**5-1.** 为什么多层级协同调度需要不同时间尺度的决策层？
**5-2.** 说明一致性残差 $\varepsilon^{(r)}$ 在工程中的作用。
**5-3.** 冻结窗口为什么要分为前、中、后三个时段？

### 应用题

**5-4.** 为一个“上游水库—中游泵站—下游闸站”系统设计 L2/L1/L0 的输入输出接口。  
**5-5.** 设计你所在单位的交接班冻结窗口参数（$T_f^{pre},T_f^{handover},T_f^{post}$）并说明依据。

### 思考题

**5-6.** 当分布式协调在时限内未收敛，但业务目标必须按时达成时，你会如何平衡安全、效率与治理三目标？

### 基础题参考答案要点

**5-7.** 因为目标分配、局部协调和设备执行的时标不同，统一时标会导致计算与执行失配。  
**5-8.** 用于衡量各子系统是否达到可执行一致，是触发降级或仲裁的重要依据。  
**5-9.** 三时段设计可覆盖“预防扰动—责任交接—平稳恢复”完整过程。

## 拓展阅读

1. **Bertsekas, D.P. (1999). *Nonlinear Programming*.**
2. **Negenborn, R.R. et al. (2009). Distributed Model Predictive Control for Networked Systems.**
3. **Rawlings, J.B. et al. (2020). *Model Predictive Control: Theory, Computation, and Design*.**
4. **Lei et al. (2025c). 在环测试与运行验证体系。**
5. **Van Overloop, P.J. (2006). *Model Predictive Control on Open Water Systems*.**
