<!-- 变更日志
v1 2026-02-17: 初稿（基于“继续”命令续写）
-->

# ch05 安全包络在线校核与在环门禁

## 5.1 学习目标

完成本章后，读者应能够：

1. 说明在线校核在安全包络闭环中的定位；
2. 设计“场景-指标-门禁”一体化在环用例矩阵；
3. 建立回归门禁模板并用于发布前放行决策；
4. 给出阈值回滚触发条件的量化判据；
5. 制定告警风暴后恢复窗口执行清单。

> 承接 ch04：上一章解决“阈值如何动态整定”，本章进一步解决“整定后如何持续校核并安全放行”。

## 5.2 在线校核总体框架

安全包络在线校核的核心是：在实时运行中持续验证“状态是否仍在可接受边界内”，并把校核结果直接连接到门禁动作。

可将校核链条抽象为：

$$
\text{State} \rightarrow \text{Envelope Check} \rightarrow \text{Risk Score} \rightarrow \text{Gate Decision}
$$

其中 Gate Decision 可取 `PASS / HOLD / ROLLBACK`。

[图5-1: 安全包络在线校核闭环图]
{描述: 展示实时状态采集、包络判定、风险评分、门禁动作、事后复盘与参数回写的闭环。}
{尺寸: 半页}
{颜色方案: 蓝色系}
{对应ARCH编号: ARCH-07}

## 5.3 在环用例矩阵（补齐 ch04 跟踪项）

在环测试（SIM-SIL-HIL）建议按“风险等级×扰动类型×控制策略版本”组织用例矩阵。

[表5-1: 在线校核在环用例矩阵（补齐 ch04 跟踪项）]
{描述: 列包括用例ID、工况类别、扰动注入方式、包络约束、预期门禁、通过标准、证据链接。}
{尺寸: 全页}
{颜色方案: 灰度}

建议最小覆盖集：

1. 常态负荷波动；
2. 上游来水突增；
3. 传感器延迟/丢包；
4. 执行器响应滞后；
5. 告警风暴并发场景。

[工程提示] 用例矩阵不是“越多越好”，而是覆盖关键风险链条并可重复执行。

## 5.4 回归门禁模板（补齐 ch04 跟踪项）

发布前回归门禁建议采用三层门禁：

- L1 数据质量门禁：输入完整性、时序一致性、缺测率；
- L2 安全包络门禁：越界率、临界区停留时长、MRS触发次数；
- L3 运行绩效门禁：调度稳定性、响应时长、能耗/供水服务指标。

[表5-2: 回归门禁模板（补齐 ch04 跟踪项）]
{描述: 列包括门禁层级、判据、阈值、责任角色、放行条件、阻断动作、复核时限。}
{尺寸: 全页}
{颜色方案: 灰度}

门禁决策可采用加权评分：

$$
G = \sum_{k=1}^{n}\lambda_k s_k,
$$

当任一强制安全项失败时，直接 `HOLD/ROLLBACK`，不受总分豁免。

## 5.5 阈值回滚触发条件量化字段（补齐 ch04 跟踪项）

为避免“凭经验回滚”，建议定义回滚触发条件：

- 连续越界次数 $N_{vio}$；
- 临界区累计驻留时长 $T_{amber}$；
- 误报率与漏报率增量 $\Delta FPR, \Delta FNR$；
- MRS触发频次 $N_{mrs}$；
- 关键服务违约事件数 $N_{sla}$。

可定义回滚判据函数：

$$
R = aN_{vio}+bT_{amber}+c\Delta FPR+d\Delta FNR+eN_{mrs}+fN_{sla}
$$

当 $R \ge R_{crit}$ 时触发回滚并进入应急值守模式。

[表5-3: 阈值回滚触发条件量化字段表（补齐 ch04 跟踪项）]
{描述: 列包括字段定义、采样窗口、报警阈值、回滚阈值、数据来源、审签链。}
{尺寸: 全页}
{颜色方案: 灰度}

## 5.6 告警风暴后恢复窗口执行清单（补齐 ch04 跟踪项）

告警风暴缓解后，不宜立即恢复常规阈值，应设置恢复窗口（如30-120分钟）执行标准清单：

1. 验证高风险链路告警是否恢复到基线频次；
2. 复核关键传感器时钟同步与质量标记；
3. 逐项恢复临时降噪策略并观察副作用；
4. 核验 MRS 触发记录与人工干预日志一致性；
5. 形成“事件-动作-结果-教训”复盘条目。

[表5-4: 告警风暴后恢复窗口执行清单（补齐 ch04 跟踪项）]
{描述: 列包括步骤、责任人、完成判据、证据附件、超时升级路径。}
{尺寸: 全页}
{颜色方案: 灰度}

## 5.7 例题：门禁失败后的放行/回滚判定

【例5-1】某次版本发布前回归中，L2门禁出现临界项失败，计算综合门禁分并给出最终决策。

[已知] 各门禁得分、强制安全项结果、回滚判据参数。

[求解] 是否可放行？若不可放行，进入 `HOLD` 还是 `ROLLBACK`？

[解题过程]
1. 计算加权门禁分 $G$；
2. 检查强制安全项是否有失败；
3. 计算回滚判据 $R$ 与阈值比较；
4. 输出门禁动作与后续任务单。

[结果讨论] 安全项“一票否决”可显著降低带病发布概率。

## 5.8 本章小结

本章建立了“在线校核—在环用例矩阵—回归门禁—回滚触发—恢复窗口清单”的完整发布安全链，补齐 ch04 跟踪项（在环用例矩阵、回归门禁模板、回滚量化字段、恢复窗口清单），使安全包络从“可分析”走向“可发布、可追溯、可审计”。下一章将进入多源不确定性下的包络鲁棒性验证。

## 5.9 习题

### 基础题

1. 在线校核与离线评估在目标与时效上有何差异？
2. 为什么回归门禁需要分层，而不是单一综合分数？
3. 说明回滚触发条件中 $N_{vio}$ 与 $T_{amber}$ 的互补意义。

### 应用题

4. 设计一个包含5类工况的在环用例矩阵，并给出通过标准。
5. 为某次告警风暴恢复窗口制定执行清单与升级路径。

### 思考题

6. 当运行绩效优异但安全门禁轻微失败时，是否允许“附条件放行”？请给出你的治理原则。

## 5.10 拓展阅读

1. Lei et al. (2025c). 在环测试与运行门禁。  
2. IEC 61508 / IEC 61511（功能安全与过程工业安全）.  
3. NIST SP 800-30（风险评估）.  
4. ISO 22320（应急管理）.  
5. ASCE/EWRI 水系统运行风险相关指南.

> **术语一致性声明**：本章采用“安全包络（Safety Envelope）”“运行设计域（ODD）”“最小风险状态（MRS）”“在环测试（SIM/SIL/HIL）”“回归门禁（Regression Gate）”等规范术语。
