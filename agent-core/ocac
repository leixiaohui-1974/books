#!/usr/bin/env python3
"""
OpenClaw Agent Core - ç»Ÿä¸€å…¥å£
æ•´åˆæ‰€æœ‰åŠŸèƒ½ï¼šä»»åŠ¡æ‰§è¡Œã€è°ƒåº¦ã€Webç›‘æ§
"""

import sys
import argparse
from typing import Optional

# æ·»åŠ è·¯å¾„
sys.path.insert(0, '/root/.openclaw/workspace/books/agent-core')

def main():
    parser = argparse.ArgumentParser(
        description='OpenClaw Agent Core (OCAC) - ç»Ÿä¸€å…¥å£',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
ç¤ºä¾‹:
  # è¿è¡Œä»»åŠ¡
  ocac run --task "ç”Ÿæˆ10ç¯‡å…¬ä¼—å·æ–‡ç« " --execute
  
  # è°ƒåº¦ä¸€æ¬¡æ€§ä»»åŠ¡
  ocac schedule --id task1 --task "ç”ŸæˆæŠ¥å‘Š" --at "2026-02-23 09:00"
  
  # è°ƒåº¦å‘¨æœŸæ€§ä»»åŠ¡
  ocac schedule --id daily --task "æ—¥æŠ¥ç”Ÿæˆ" --interval 1440
  
  # å¯åŠ¨Webç›‘æ§
  ocac web --port 8080
  
  # å¯åŠ¨è°ƒåº¦å™¨å®ˆæŠ¤è¿›ç¨‹
  ocac daemon
        """
    )
    
    subparsers = parser.add_subparsers(dest='command', help='å‘½ä»¤')
    
    # run å‘½ä»¤
    run_parser = subparsers.add_parser('run', help='è¿è¡Œä»»åŠ¡')
    run_parser.add_argument('--task', '-t', required=True, help='ä»»åŠ¡æè¿°')
    run_parser.add_argument('--id', '-i', help='ä»»åŠ¡ID')
    run_parser.add_argument('--execute', '-e', action='store_true', help='å®é™…æ‰§è¡Œ')
    run_parser.add_argument('--agent', '-a', default='kimi-coding/k2p5', help='Agentæ¨¡å‹')
    
    # schedule å‘½ä»¤
    schedule_parser = subparsers.add_parser('schedule', help='è°ƒåº¦ä»»åŠ¡')
    schedule_parser.add_argument('--id', '-i', required=True, help='ä»»åŠ¡ID')
    schedule_parser.add_argument('--task', '-t', required=True, help='ä»»åŠ¡æè¿°')
    schedule_parser.add_argument('--at', help='æ‰§è¡Œæ—¶é—´ (YYYY-MM-DD HH:MM)')
    schedule_parser.add_argument('--interval', '-n', type=int, help='é—´éš”ï¼ˆåˆ†é’Ÿï¼‰')
    
    # list å‘½ä»¤
    list_parser = subparsers.add_parser('list', help='åˆ—å‡ºä»»åŠ¡')
    list_parser.add_argument('--all', '-a', action='store_true', help='æ˜¾ç¤ºæ‰€æœ‰')
    
    # web å‘½ä»¤
    web_parser = subparsers.add_parser('web', help='å¯åŠ¨Webç›‘æ§')
    web_parser.add_argument('--port', '-p', type=int, default=8080, help='ç«¯å£å·')
    
    # daemon å‘½ä»¤
    daemon_parser = subparsers.add_parser('daemon', help='å¯åŠ¨è°ƒåº¦å™¨å®ˆæŠ¤è¿›ç¨‹')
    
    # eval å‘½ä»¤
    eval_parser = subparsers.add_parser('eval', help='è¯„ä¼°ä»»åŠ¡è¾“å‡º')
    eval_parser.add_argument('--id', '-i', required=True, help='ä»»åŠ¡ID')
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    # æ‰§è¡Œå‘½ä»¤
    if args.command == 'run':
        from ocac_v2 import OCAC
        ocac = OCAC(auto_execute=args.execute)
        result = ocac.run(args.task, args.id, args.agent, args.execute)
        print(f"\nä»»åŠ¡ç»“æœ:\n{result}")
    
    elif args.command == 'schedule':
        from task_scheduler import TaskScheduler
        scheduler = TaskScheduler()
        
        if args.at:
            from datetime import datetime
            run_at = datetime.strptime(args.at, "%Y-%m-%d %H:%M")
            scheduler.schedule_once(args.id, args.task, run_at)
        elif args.interval:
            scheduler.schedule_recurring(args.id, args.task, args.interval)
        else:
            print("é”™è¯¯: éœ€è¦ --at æˆ– --interval å‚æ•°")
            sys.exit(1)
    
    elif args.command == 'list':
        from ocac_v2 import OCAC
        ocac = OCAC()
        tasks = ocac.list_tasks()
        
        print(f"\nğŸ“‹ ä»»åŠ¡åˆ—è¡¨ ({len(tasks)}ä¸ª)\n")
        for t in tasks[:20 if not args.all else len(tasks)]:
            status_icon = {
                'completed': 'âœ…',
                'running': 'ğŸ”„',
                'prepared': 'â³',
                'failed': 'âŒ'
            }.get(t['status'], 'â“')
            
            print(f"{status_icon} {t['task_id']}")
            print(f"   æè¿°: {t['task_description'][:50]}...")
            print(f"   çŠ¶æ€: {t['status']} | å­ä»»åŠ¡: {t['subtask_count']}")
            print()
    
    elif args.command == 'web':
        from web_monitor import OCACWebServer
        server = OCACWebServer(port=args.port)
        server.start()
    
    elif args.command == 'daemon':
        from task_scheduler import TaskScheduler
        scheduler = TaskScheduler()
        scheduler.start()
        
        print("è°ƒåº¦å™¨å®ˆæŠ¤è¿›ç¨‹å·²å¯åŠ¨")
        print("æŒ‰ Ctrl+C åœæ­¢")
        
        try:
            import time
            while True:
                time.sleep(1)
        except KeyboardInterrupt:
            scheduler.stop()
    
    elif args.command == 'eval':
        from ocac_v2 import OCAC
        ocac = OCAC()
        result = ocac.evaluate_outputs(args.id)
        print(f"\nè¯„ä¼°ç»“æœ:\n{result}")


if __name__ == "__main__":
    main()
