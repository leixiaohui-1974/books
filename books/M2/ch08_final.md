<!-- 变更日志
v1 2026-02-16: 初稿
-->

# ch08 自适应MPC与在线学习

## 8.1 学习目标

完成本章学习后，读者应能够：

1. 理解自适应模型预测控制（Adaptive MPC）的基本思想与适用场景；
2. 掌握在线参数更新、模型切换与增量学习的核心流程；
3. 设计“学习—验证—发布—回退”的闭环治理机制；
4. 评估在线学习对控制性能、稳定性与安全性的影响；
5. 为后续实时计算优化与工程实践章节建立可演进控制框架。

> 本章承接 ch07：在经济型优化基础上，进一步解决模型时变与工况迁移下的持续性能保持问题。

## 8.2 为什么需要自适应MPC

水网控制对象在季节切换、设备老化、运行方式变化时会发生动力学漂移。若长期使用固定模型，控制性能会逐步退化，自适应MPC通过在线更新模型或参数保持控制器“不过时”。

[物理直觉] 控制器就像经验丰富的调度员，需要“边运行边学习”，而不是永远停留在第一次建模时的认知。

## 8.3 自适应MPC总体框架

自适应MPC包含四个核心模块：

1. **在线监测**：跟踪预测误差、约束触发率、求解成功率；
2. **参数更新**：递推最小二乘、增量辨识或贝叶斯更新；
3. **安全验证**：在影子模式验证更新模型；
4. **发布与回退**：满足门禁后发布，否则回退上一稳定版本。

[图8-1: 自适应MPC闭环演进流程]
{描述: 展示“监测→更新→影子验证→发布→在线监控→异常回退”的循环。}
{尺寸: 全页}
{颜色方案: 蓝色系}

## 8.4 在线参数更新方法

### 8.4.1 递推辨识

在每个采样时刻利用新数据更新模型参数，适合缓慢漂移场景。

### 8.4.2 多模型切换

预先建立多工况模型库，运行时根据工况识别切换模型，适合季节性变化明显场景。

### 8.4.3 残差学习增强

在机理模型基础上训练轻量残差模型修正预测误差，兼顾可解释性与精度提升。

[工程解释] 工程上通常采用“多模型切换 + 小步辨识”组合，而非单一激进在线学习。

## 8.5 学习安全与发布门禁

在线学习必须遵循“先验证、后上线”：

- 影子模式中比较新旧模型性能；
- 检查约束违约率是否下降或不劣化；
- 检查求解时长是否在门限内；
- 检查异常回退可用性。

推荐发布策略：

- 灰度发布：先在低风险子系统启用；
- 分阶段放量：逐步扩大应用范围；
- 版本审计：记录数据窗口、参数变更与评审结论。

[表8-1: 自适应MPC发布门禁清单]
{描述: 列包括门禁项、阈值建议、验证环境、失败处置与责任角色。}
{尺寸: 半页}
{颜色方案: 灰度}

## 8.6 可复现实例：季节切换下模型更新

【例8-1】某调水系统由丰水期切换至枯水期，原模型预测误差明显上升。采用“多模型切换 + 在线小步辨识”策略。

**已知**：

- 原模型7日滑动 RMSE 超出门限；
- 预置三套季节模型；
- 更新后需在影子模式验证 72 小时。

**求解**：说明为何不直接全量替换模型，而应采用灰度发布。

**解题过程**：

1. 工况识别触发候选模型切换；
2. 影子模式并行评估新旧模型；
3. 低风险渠段先灰度发布；
4. 若指标稳定，再扩大到全网。

**结果讨论**：
灰度发布可显著降低“错误更新全网扩散”风险，是在线学习工程治理的关键环节。

## 8.7 常见风险与防护策略

风险一：数据漂移导致错误学习。  
防护：加入数据质量门禁与异常样本剔除。

风险二：学习收益不稳定。  
防护：设置最小收益阈值，低于阈值不发布。

风险三：学习模型求解变慢。  
防护：限制模型复杂度并在 ch10 中做实时优化。

[TODO: 需补充在线学习版本审计模板与签批流程样表。]

## 8.8 本章小结

本章提出了自适应MPC的工程化闭环：通过在线监测识别漂移，通过参数更新或模型切换修正模型，通过影子验证和灰度发布保障安全，通过审计与回退机制控制风险。自适应的核心不是“持续改动”，而是“可控演进”。下一章将进入 MPC 与安全约束集成，系统讨论安全规则与优化控制的一体化实现。

## 习题

### 基础题

1. 自适应MPC与固定模型MPC的核心差异是什么？
2. 为什么在线学习必须经过影子模式验证？
3. 多模型切换与递推辨识分别适合哪些场景？

### 应用题

4. 设计一套“误差超阈值触发更新—影子验证—灰度发布—全量发布”的状态机。  
5. 给定一组新旧模型指标，制定发布或回退决策规则。

### 思考题

6. 若在线学习提升了精度但增加了求解时延，你会如何平衡“更准”与“更快”？

### 基础题参考答案要点

1. 自适应MPC可根据新数据调整模型/参数，固定模型MPC参数不随运行变化。  
2. 因可在不影响生产控制的前提下验证新模型安全性与收益。  
3. 切换适合分段工况，递推适合连续缓变工况。

## 拓展阅读

1. Qin, S.J. & Badgwell, T.A. (2003). A survey of industrial MPC technology.  
2. Rawlings, J.B., Mayne, D.Q. & Diehl, M. (2017). *Model Predictive Control: Theory, Computation, and Design*.  
3. Goodwin, G.C. et al. (2014). Adaptive predictive control overview.  
4. Camacho, E.F. & Bordons, C. (2007). *Model Predictive Control*.  
5. Lei et al. (2025c). 在环测试系统。

> **术语一致性声明**：本章统一采用“模型预测控制（Model Predictive Control, MPC）”“运行设计域（Operational Design Domain, ODD）”“安全包络（Safety Envelope）”“在环测试（In-the-Loop Testing）”等规范术语；数学符号采用 $Q,h,\tau,T_p,T_c,\mathbf{x},\mathbf{u},\mathbf{y},J$。

### 质量检查清单（执行结果）

- [x] 章首学习目标、章末小结/习题/拓展阅读完整；
- [x] 基础题3 + 应用题2 + 思考题1，含基础题答案要点；
- [x] 公式前有物理直觉，公式后有工程解释；
- [x] 含可复现实例（例8-1）；
- [x] 图表不少于2项（图8-1、表8-1）；
- [x] 章首回顾ch07，章末预告ch09。
