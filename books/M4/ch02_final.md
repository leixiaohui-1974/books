<!-- 变更日志
v1 2026-02-19: 初稿（完全重写）
-->

# 第二章 水网多智能体系统的形式化建模

## 学习目标

1. 掌握水网Agent的五元组形式化模型$A_i = \langle S_i, O_i, U_i, \pi_i, C_i \rangle$，理解各元素的物理含义和数学定义；
2. 理解水网物理拓扑到通信拓扑的映射方法，掌握图论工具在MAS通信设计中的应用；
3. 掌握水网MAS状态空间、动作空间和观测空间的构建方法，能够为具体工程定义完整的空间模型；
4. 理解ODD约束和安全包络的形式化表达，掌握将工程安全要求转化为数学约束的方法。

> **前章回顾**：第一章论证了大规模水网需要多智能体系统的三重理由——通信瓶颈、单点故障和组合爆炸，介绍了MAS的基本概念和SCADA+MAS融合架构。但第一章的讨论偏于定性。要设计可靠的水网MAS，需要精确的数学描述——Agent的能力边界在哪里？Agent之间如何通信？系统的安全约束如何形式化？本章建立这套形式化语言。

---

## Agent五元组模型

### 2.1.1 模型定义

水网中的每个Agent $A_i$用五元组描述：

$$A_i = \langle S_i, O_i, U_i, \pi_i, C_i \rangle$$

其中：

**状态空间$S_i$**：Agent $i$所管辖的物理量的全部可能取值。对于闸站Agent，$S_i$包含上下游水位$h_i^{up}, h_i^{dn}$、过闸流量$Q_i$、闸门开度$e_i$等。状态空间是一个有界连续集合——每个变量都有物理上下界。

**观测空间$O_i$**：Agent $i$能够实际"看到"的信息。观测空间是状态空间的一个（可能含噪声的）子集。Agent不一定能直接观测所有状态——例如，闸站Agent可以直接测量水位和闸门开度，但过闸流量通常是通过闸门方程间接估算的。

$$o_i(t) = g_i(s_i(t)) + \varepsilon_i(t)$$

其中$g_i$是观测函数（可能是非线性的），$\varepsilon_i$是传感器噪声。

**动作空间$U_i$**：Agent $i$能够执行的控制动作。对于闸站Agent，$U_i$是闸门开度的调节量$\Delta e_i$，受到物理约束：$\Delta e_i \in [-\bar{v} \cdot \Delta t, \bar{v} \cdot \Delta t]$，其中$\bar{v}$是闸门最大速率，$\Delta t$是控制周期。

**策略$\pi_i$**：从观测到动作的映射函数。$\pi_i$可以是PI控制律、MPC策略或基于规则的策略。策略是Agent的"大脑"——不同的策略产生不同的控制行为。

$$u_i(t) = \pi_i(o_i(t), m_i(t))$$

注意策略不仅依赖本地观测$o_i$，还依赖从邻居Agent接收的消息$m_i$——这是MAS与独立控制器的关键区别。

**约束集$C_i$**：Agent $i$必须满足的硬约束。安全约束（水位不超限）、物理约束（闸门行程限制）和运行约束（最小流量要求）都是约束集的成员。

### 2.1.2 闸站Agent建模实例

【例2-1】为胶东调水工程的一座典型闸站建立五元组Agent模型。

[闸站参数] 闸站位于输水明渠中段，设1孔平板闸门，宽B=6m，最大开度$e_{max}$=3.5m，闸门速率$\bar{v}$=0.001 m/s，控制周期$\Delta t$=60s。上下游各有1个水位传感器和1个流量传感器。

[五元组定义]
- $S_i = \{h^{up}, h^{dn}, Q, e\}$，其中$h^{up} \in [0, 5.0]$m，$h^{dn} \in [0, 4.5]$m，$Q \in [0, 60]$ m³/s，$e \in [0, 3.5]$m
- $O_i = \{h^{up}_{meas}, h^{dn}_{meas}, e_{meas}\}$，传感器精度$\sigma_h = \pm$0.01m，$\sigma_e = \pm$0.005m。流量$Q$通过闸门自由出流公式$Q = C_d \cdot B \cdot e \cdot \sqrt{2g \cdot (h^{up} - h^{dn})}$间接估算
- $U_i = \{\Delta e\}$，$\Delta e \in [-0.06, 0.06]$m（每控制周期最大调节量=0.001×60）
- $\pi_i$：PI控制器+安全联锁覆盖（详见第四章）
- $C_i = \{h^{dn} \leq 4.0\text{m（安全上限）}, h^{dn} \geq 1.0\text{m（最低水位）}, e \geq 0, e \leq 3.5\}$

---

## 通信拓扑

### 2.2.1 从物理拓扑到通信图

水网的物理拓扑自然定义了Agent之间的通信关系——上下游相邻的闸站Agent需要交换水位和流量信息以实现协调控制。通信拓扑用图$\mathcal{G} = (\mathcal{V}, \mathcal{E})$描述，其中$\mathcal{V}$是Agent节点集合，$\mathcal{E}$是通信边集合。

**物理邻接规则**：如果闸站$i$和闸站$j$之间由一段渠道或管道直接相连（无其他闸站/泵站），则$(i,j) \in \mathcal{E}$。

**逻辑邻接扩展**：除物理邻接外，某些非相邻Agent也需要通信。例如，分水枢纽的Agent需要同时与主干渠和支渠的Agent通信；协调Agent需要与所有管辖范围内的Agent通信。

通信拓扑的关键属性包括：

**连通性**：通信图是否连通？如果图不连通，则存在无法互相通信的Agent子群——分布式一致性协议无法在不连通图上收敛到全局一致。

**直径**：图中任意两个节点之间的最短路径长度的最大值。直径决定了信息从一端传播到另一端所需的跳数（通信轮次）。对于线性渠道，直径等于闸站数减1。

**邻接矩阵**$W = [w_{ij}]$：$w_{ij} > 0$表示Agent $i$向Agent $j$的信息赋权，$w_{ij} = 0$表示无直接通信。邻接矩阵是一致性协议分析的基本工具。

### 2.2.2 通信拓扑设计原则

**表2-1 水网MAS通信拓扑设计原则**

| 原则 | 含义 | 理由 |
|------|------|------|
| 连通性保证 | 正常工况下通信图必须连通 | 一致性收敛的必要条件 |
| 冗余路径 | 关键Agent对之间至少2条独立路径 | 容忍单链路故障 |
| 最小化直径 | 在满足前两条的前提下减小图直径 | 加快信息传播和共识收敛 |
| 通信量约束 | 每个Agent的通信邻居数$d_i \leq d_{max}$ | 限制单节点通信负担 |
| 分区容错 | 通信分区后每个分区内仍可自治 | 大范围通信中断下的安全运行 |

---

## 状态空间与动作空间

### 2.3.1 全局状态空间

水网MAS的全局状态空间是所有Agent状态空间的笛卡尔积：

$$\mathcal{S} = S_1 \times S_2 \times \cdots \times S_N$$

对于$N$座闸站（每站4个状态变量）的水网，全局状态空间的维度为$4N$。全局状态包含了水网在某一时刻的完整信息——所有水位、流量和闸门开度。

全局状态的演化由水力学方程和控制律共同决定：

$$\mathbf{s}(t + \Delta t) = f(\mathbf{s}(t), \mathbf{u}(t), \mathbf{d}(t))$$

其中$\mathbf{u}$是全部Agent的控制动作向量，$\mathbf{d}$是外部扰动（来水变化、取水变化、降雨等），$f$是由Saint-Venant方程和闸门方程定义的非线性状态转移函数。

### 2.3.2 局部可观测性

MAS的关键特征是**局部可观测性**——每个Agent只能观测全局状态的一部分。Agent $i$的观测$o_i$是全局状态$\mathbf{s}$的函数，但通常只依赖于Agent $i$及其物理邻居的状态：

$$o_i(t) = g_i(s_i(t), s_{N(i)}(t)) + \varepsilon_i(t)$$

其中$N(i)$是Agent $i$的物理邻居集合。这意味着Agent不需要知道整个水网的状态就能做出合理的控制决策——它只需要知道"附近发生了什么"。

但局部可观测性也带来风险——远端的大扰动可能在到达本地之前Agent无法感知。这就是为什么Agent之间的消息传递（$m_i$）如此重要——通过邻居传递的消息，Agent可以获得超出其直接观测范围的信息。

【例2-2】局部可观测性对控制性能的影响。

[场景] 5座串联闸站（A1-A5），A1上游突然来水增加10 m³/s。A5（最下游）的Agent能否及时获知这一变化？

[分析] 
- 仅依赖物理观测：水力波从A1传播到A5需要经过4段渠道。若每段渠道长10km、水波速2 m/s，传播时间约5000s×4=20000s≈5.6小时。A5要等5.6小时后才能通过水位变化感知上游的来水增加。
- 通过消息传递：A1检测到来水增加后立即发送消息给A2，A2转发给A3，依次传递。消息延迟约4×(通信延迟+处理时间)≈4×2s=8s。A5在8秒内获知上游变化。
- 结论：消息传递将信息获取时间从5.6小时缩短到8秒——这是MAS分布式协调的核心价值所在。

---

## ODD约束形式化

### 2.4.1 运行设计域的数学描述

运行设计域（ODD）定义了MAS设计为在其中安全运行的全部条件范围。ODD用约束集合形式化：

$$\mathcal{ODD} = \{(\mathbf{s}, \mathbf{d}) : \underline{s}_j \leq s_j \leq \overline{s}_j, \; \underline{d}_k \leq d_k \leq \overline{d}_k, \; \forall j, k\}$$

其中$\underline{s}_j, \overline{s}_j$是状态变量$s_j$的ODD边界，$\underline{d}_k, \overline{d}_k$是外部扰动$d_k$的ODD边界。

ODD的核心思想是承认MAS不能在所有可能的条件下都安全运行——它划定了一个"设计范围"，在范围内MAS保证性能和安全，在范围外MAS应安全降级。

### 2.4.2 安全包络

安全包络（Safety Envelope）是ODD约束中的安全子集——系统状态在任何时刻都不得超出安全包络。安全包络用不变集（Invariant Set）形式化：

$$\mathcal{SE} = \{\mathbf{s} : h_j(\mathbf{s}) \leq 0, \; j = 1, \ldots, n_c\}$$

其中$h_j$是安全约束函数。典型的水网安全包络约束包括：

- 水位安全约束：$h^{dn}_i \leq h^{dn}_{i,max}$（防漫溢）和$h^{dn}_i \geq h^{dn}_{i,min}$（防干渠）
- 流量安全约束：$Q_i \leq Q_{i,max}$（防冲刷）
- 闸门安全约束：$e_i \geq 0$且$e_i \leq e_{i,max}$

**表2-2 安全包络与ODD的关系**

| 状态 | 含义 | MAS行为 |
|------|------|--------|
| $\mathbf{s} \in \mathcal{SE} \cap \mathcal{ODD}$ | 安全且在设计范围内 | 正常控制——追求性能最优 |
| $\mathbf{s} \in \mathcal{SE} \setminus \mathcal{ODD}$ | 安全但超出设计范围 | 保守控制——维持安全，放弃性能优化 |
| $\mathbf{s} \notin \mathcal{SE}$ | 不安全 | 紧急处置——立即触发安全联锁 |

### 2.4.3 Agent层面的约束分解

全局安全包络需要分解到各Agent的局部约束。理想情况下，如果每个Agent独立满足其局部约束，则全局安全包络也得到满足。但在耦合系统中，局部约束的独立满足不一定保证全局约束——例如，相邻两座闸站同时最大开度排水可能导致中间渠段水位骤降。

约束分解的保守方法是为每个Agent施加比全局约束更严格的局部约束（留裕度），确保即使在最不利的邻居行为下局部约束仍然保证全局安全。

【例2-3】安全包络的约束分解。

[全局约束] 渠段AB的水位$h_{AB}$不得低于1.0m。渠段AB受上游闸站A的出流和下游闸站B的入流控制。

[简化分析] 渠段水位变化率$\dot{h}_{AB} \approx (Q_A - Q_B) / (B \cdot L)$，其中$B$是渠宽，$L$是渠长。最危险情况是$Q_A$最小（闸站A全关）且$Q_B$最大（闸站B全开）。

[约束分解] 为保证$h_{AB} \geq 1.0$m，可以对闸站A和B分别施加约束：当$h_{AB} < 1.5$m时（预警阈值），A不得减小开度，B不得增大开度。0.5m的裕度为Agent的响应延迟和协调时间提供了缓冲。

---

## 消息空间与交互协议

### 2.5.1 消息类型

Agent之间交换的消息分为三类：

**状态共享消息**：Agent向邻居广播自身的观测和状态估计。格式为$m^{state}_{i \to j} = \langle t, id_i, o_i(t), \hat{s}_i(t) \rangle$。状态共享是最基础的消息类型，支持邻居Agent的态势感知。

**协商消息**：在需要多Agent协调的场景中，Agent之间交换协商请求和协商响应。格式为$m^{nego}_{i \to j} = \langle t, id_i, type, payload \rangle$，其中$type$包括REQUEST（协商请求）、PROPOSE（方案提议）、ACCEPT（接受）、REJECT（拒绝）。

**协调指令消息**：协调Agent或上级系统下达的全局协调指令。格式为$m^{coord}_{c \to i} = \langle t, id_c, priority, directive \rangle$。协调指令具有更高优先级，本地Agent收到后应优先执行。

### 2.5.2 消息传递的约束

水网MAS的消息传递受到通信网络的物理约束：

**延迟约束**：消息从Agent $i$到Agent $j$的传递延迟$\tau_{ij}$不为零，且可能随网络负载波动。一致性协议的设计必须考虑延迟的影响。

**丢包约束**：通信链路可能丢失消息。丢包率$p_{loss}$在正常条件下通常低于0.1%，但在极端天气或设备故障时可能显著升高。协议必须对消息丢失具有鲁棒性。

**带宽约束**：每条通信链路的带宽有限。当大量Agent同时发送状态共享消息时，可能产生拥塞。消息压缩和自适应发送频率是应对措施。

---

## 本章小结

本章建立了水网MAS的形式化建模框架。

首先，定义了Agent五元组模型$A_i = \langle S_i, O_i, U_i, \pi_i, C_i \rangle$——状态空间描述Agent管辖的物理量，观测空间描述可感知的信息（含噪声），动作空间描述可执行的控制，策略定义从观测到动作的映射，约束集定义硬约束边界。例2-1展示了闸站Agent五元组建模的完整过程。

其次，建立了通信拓扑的图模型——从物理拓扑到通信图的映射、连通性和直径等关键属性、通信拓扑设计原则（表2-1）。

第三，讨论了全局状态空间和局部可观测性。例2-2通过5站串联场景定量说明了消息传递的价值——将信息传播时间从5.6小时缩短到8秒。

第四，形式化了ODD约束和安全包络——ODD定义设计范围，安全包络定义不可违反的安全边界（表2-2）。例2-3展示了全局约束到Agent局部约束的分解方法。

第五，定义了消息空间——状态共享、协商和协调指令三类消息格式，以及通信的延迟、丢包和带宽约束。

> 下一章将在本章形式化框架的基础上，深入一致性协议和协商机制——如何让分布式的Agent在有限通信条件下达成可执行的一致决策。

---

## 习题

### 基础题

**2-1.** 写出Agent五元组模型的定义，并解释每个元素的物理含义。五元组模型与传统PID控制器模型（输入-输出描述）的根本区别是什么？

**2-2.** 解释通信图的连通性和直径对MAS性能的影响。对于一条有10座闸站的线性渠道，通信图的直径是多少？如果增加一条从首站到末站的直接通信链路，直径变为多少？

**2-3.** 区分ODD和安全包络。系统状态可以位于ODD之外但安全包络之内吗？如果可以，此时MAS应该如何行为？

**2-4.** 解释局部可观测性对MAS控制的影响。如果一个Agent完全不与邻居通信（$m_i = \emptyset$），它的控制策略与传统的本地PID控制器有什么区别？

### 应用题

**2-5.** 为一个包含1座泵站和3座闸站的供水系统（泵站→闸站1→闸站2→闸站3）建立完整的MAS形式化模型：（a）为每个Agent定义五元组；（b）画出通信拓扑图并写出邻接矩阵；（c）定义全局安全包络（至少5个约束）；（d）将全局约束分解为各Agent的局部约束。

**2-6.** 在例2-2的5站串联场景中，如果通信拓扑不是线性链（每站只与相邻站通信），而是增加了"隔站通信"（A1↔A3, A2↔A4, A3↔A5），消息从A1到A5的最短传播时间是多少？比较两种拓扑在信息传播速度、通信负担和容错性方面的差异。

### 思考题

**2-7.** 五元组模型假设Agent的策略$\pi_i$是确定性的——给定相同的观测和消息，总是产生相同的动作。但某些场景下随机策略可能更优（例如在博弈论框架下）。讨论：（a）水网MAS中是否存在需要随机策略的场景？（b）随机策略对安全包络保证有什么影响？（c）如何在安全约束下引入有限的随机性？

**2-8.** 本章的安全包络形式化假设约束函数$h_j(\mathbf{s})$是确定性的。但实际中，传感器噪声导致Agent对状态的估计存在不确定性——Agent可能"以为"系统在安全包络内，实际上已经超出。讨论如何将测量不确定性纳入安全包络的形式化框架。

---

## 拓展阅读

1. **Shoham, Y. & Leyton-Brown, K. (2008).** *Multiagent Systems: Algorithmic, Game-Theoretic, and Logical Foundations.* Cambridge University Press. — MAS理论的权威教材，第1-3章对Agent模型、环境和交互的形式化定义是本章五元组模型的理论基础。

2. **Mesbahi, M. & Egerstedt, M. (2010).** *Graph Theoretic Methods in Multiagent Networks.* Princeton University Press. — 图论方法在多智能体网络中的系统应用，对理解通信拓扑设计和一致性分析有重要参考价值。

3. **Ames, A.D., Xu, X., Grizzle, J.W., & Tabuada, P. (2017).** "Control barrier functions: Theory and applications." *2017 IEEE 55th Conference on Decision and Control (CDC)*. — 控制屏障函数理论，为安全包络的形式化验证提供了数学工具。

4. **Lei, X. et al. (2025b).** "Autonomous Water Networks: Architecture and Key Technologies." *南水北调与水利科技（中英文）*. — SCADA+MAS融合架构的设计理念，本章Agent模型和通信拓扑设计的直接工程基础。

5. **Olfati-Saber, R. & Murray, R.M. (2004).** "Consensus problems in networks of agents with switching topology and time-delays." *IEEE Transactions on Automatic Control*, 49(9), 1520-1533. — 通信拓扑切换和时延条件下的一致性问题经典论文，为本章通信拓扑设计原则提供理论支撑。
