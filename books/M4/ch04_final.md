<!-- 变更日志
v1 2026-02-19: 初稿（完全重写）
-->

# 第四章 SCADA+MAS融合架构实现

## 学习目标

1. 掌握SCADA+MAS融合架构的系统设计——双栈消息总线、Agent运行容器和服务注册发现机制；
2. 理解Agent生命周期管理的工程方法——从部署、启动、运行、暂停到销毁的完整流程；
3. 掌握MAS服务在HydroOS平台中的集成方式——服务接口定义、状态同步和配置管理；
4. 理解融合架构中SCADA层与MAS层的数据流交互和权限边界。

> **前章回顾**：第三章建立了Agent之间协调的核心机制——一致性协议和三阶段协商。这些协议在数学上是优美的，但工程实现面临大量实际问题：消息如何可靠传递？Agent如何在工业级环境中稳定运行？与已有的SCADA系统如何共存？本章将理论机制落地为可部署的软件系统。

---

## 4.1 融合架构总体设计

### 4.1.1 设计原则

SCADA+MAS融合架构遵循四条设计原则：

**渐进增强**：MAS层是SCADA系统的"增强层"而非"替代层"。关闭MAS后，SCADA系统仍能独立运行——回退到传统集中式模式。

**安全优先**：任何MAS层的故障不得影响SCADA层的安全联锁功能。安全联锁在PLC层硬编码，不受MAS层控制。

**标准接口**：MAS层通过标准工业协议（OPC-UA、MQTT）与SCADA层交互，不依赖私有协议。

**可观测性**：MAS层的所有Agent状态、消息流和决策过程对SCADA操作员完全透明——操作员可以在HMI上看到每个Agent的当前状态、正在执行的协议和决策依据。

### 4.1.2 架构分层

**表4-1 SCADA+MAS融合架构层次详述**

| 层次 | 组件 | 接口 | 职责边界 |
|------|------|------|---------|
| SCADA监控层 | HMI+历史数据库+报警管理 | OPC-UA客户端 | 显示、记录、告警、人工干预 |
| MAS协调层 | Agent运行容器+消息总线+协议引擎 | OPC-UA服务端+MQTT | 分布式协商、一致性协调、方案优化 |
| 控制执行层 | PLC/RTU+本地控制器 | Modbus/4-20mA | PI/PID执行、安全联锁 |
| 物理层 | 传感器+执行器 | 电气信号 | 数据采集、动作执行 |

MAS协调层位于SCADA监控层和控制执行层之间，这一位置使其可以接收SCADA层的全局调度指令和控制执行层的实时状态反馈，同时向两个方向输出——向上报告Agent状态供操作员监控，向下提供优化后的控制参考值。

---

## 4.2 消息总线设计

### 4.2.1 双栈消息总线

MAS协调层使用双栈消息总线——实时消息栈和可靠消息栈。

**实时消息栈（MQTT-based）**：用于Agent之间的状态共享和快速协商。MQTT的发布/订阅模式天然适合多Agent广播。每个Agent订阅其通信邻居的状态主题，发布自身状态到对应主题。

主题命名规范：`mas/{site_id}/state` 用于状态共享，`mas/{site_id}/negotiate` 用于协商消息，`mas/coordinator/directive` 用于协调指令。

**可靠消息栈（OPC-UA-based）**：用于关键控制指令的可靠传递。OPC-UA提供确认机制和数据质量标记，适合控制参考值的下发。每个闸站Agent通过OPC-UA将优化后的控制参考值写入PLC的寄存器。

### 4.2.2 消息序列化与压缩

Agent间的状态共享消息需要高频传输（每控制周期一次），消息大小直接影响通信负担。

【例4-1】闸站Agent状态消息的序列化设计。

[消息内容] 时间戳(8B) + Agent ID(2B) + 上游水位(4B float) + 下游水位(4B float) + 流量(4B float) + 开度(4B float) + 状态标志(2B) + 校验和(2B) = 30字节。

[传输频率] 每60s一次，5座闸站互相广播，每站每周期收到4条消息 = 120字节/周期。

[带宽评估] 120字节/60s = 2字节/s。远低于工业以太网（100Mbps）和蜂窝网络（1Mbps）的容量。即使100座闸站的大型水网，带宽需求也仅为约200字节/s——消息带宽不是水网MAS的瓶颈，消息延迟才是。

---

## 4.3 Agent运行容器

### 4.3.1 容器架构

Agent运行容器是MAS层的核心运行环境——它为每个Agent提供隔离的执行空间、标准化的接口和统一的生命周期管理。容器架构包含三个子系统：

**执行引擎**：加载Agent的策略代码（$\pi_i$），按控制周期调度执行。支持Python和C两种语言的Agent策略实现——Python用于快速原型开发，C用于生产部署。

**通信适配器**：连接双栈消息总线，为Agent策略代码提供简洁的消息收发API：`send(topic, message)` 和 `receive(topic, timeout)`。通信适配器负责消息序列化、超时处理和重传。

**状态管理器**：维护Agent的持久化状态——配置参数、运行日志、协商历史和诊断信息。状态管理器提供原子化的状态读写操作，防止并发冲突。

### 4.3.2 Agent生命周期

**表4-2 Agent生命周期状态与转换**

| 状态 | 含义 | 可执行操作 | 转出状态 |
|------|------|----------|---------|
| Created | 已加载配置，未启动 | 启动 | Running |
| Running | 正常运行中 | 暂停/停止 | Paused/Stopped |
| Paused | 暂停协调（仍接收消息但不发送） | 恢复/停止 | Running/Stopped |
| Degraded | 通信异常，进入降级模式 | 恢复/停止 | Running/Stopped |
| Stopped | 已停止，不再参与MAS协调 | 重启/销毁 | Created/Destroyed |
| Destroyed | 已销毁 | — | — |

Agent从Created到Running的启动过程包括：加载策略代码→连接消息总线→订阅邻居主题→发送上线通知→开始周期性执行。

**Degraded**状态是水网MAS的关键设计——当Agent检测到通信异常（连续3个周期未收到任何邻居消息）时，自动进入降级模式。降级模式下Agent停止参与一致性协商，回退到纯本地PI控制，确保安全运行。

---

## 4.4 HydroOS集成

### 4.4.1 MAS作为HydroOS服务

在HydroOS三层架构（设备抽象层/调度引擎层/应用服务层）中，MAS作为调度引擎层的核心服务之一。MAS服务通过HydroOS的服务注册中心注册，提供标准化的REST API供上层应用调用。

核心API包括：
- `GET /mas/agents` — 获取所有Agent状态列表
- `POST /mas/agents/{id}/command` — 向特定Agent发送命令
- `GET /mas/protocols/status` — 获取当前协议执行状态
- `POST /mas/coordinate` — 发起全局协调请求

### 4.4.2 与SCADA的数据流

**表4-3 SCADA↔MAS数据流定义**

| 数据流方向 | 数据内容 | 协议 | 频率 |
|-----------|---------|------|------|
| SCADA→MAS | 全局调度指令（目标流量/水位） | OPC-UA Write | 事件触发 |
| SCADA→MAS | 操作员手动覆盖指令 | OPC-UA Write | 事件触发 |
| MAS→SCADA | Agent状态和决策日志 | OPC-UA Read | 每控制周期 |
| MAS→PLC | 优化后的控制参考值 | OPC-UA Write | 每控制周期 |
| PLC→MAS | 实时测量值和设备状态 | OPC-UA Read | 每控制周期 |

【例4-2】操作员手动覆盖MAS决策的完整流程。

[场景] MAS协调层建议将闸站3的设定水位从3.0m提高到3.2m（基于上游来水预测）。操作员基于经验判断来水预测可能偏高，决定维持3.0m。

[流程]
1. 操作员在HMI上查看MAS的决策依据（来水预测曲线、一致性协商结果、校核仿真结果）
2. 操作员点击"手动覆盖"按钮，输入3.0m作为覆盖值
3. SCADA通过OPC-UA向闸站3的Agent发送覆盖指令：`{type: "OVERRIDE", target: "setpoint", value: 3.0, operator: "OP001", timestamp: ...}`
4. Agent接收覆盖指令，将本地设定值锁定为3.0m，通知邻居Agent"闸站3设定值已由操作员锁定"
5. 邻居Agent将闸站3的设定值视为外部约束，在后续协商中不再尝试修改
6. SCADA记录覆盖事件到历史数据库（审计追溯）
7. 操作员可随时取消覆盖，Agent恢复参与MAS协商

---

## 本章小结

本章将SCADA+MAS融合架构从设计理念落实为可部署的系统实现。

架构遵循渐进增强、安全优先、标准接口和可观测性四条原则（表4-1）。MAS协调层位于SCADA监控层和控制执行层之间，通过标准工业协议（OPC-UA/MQTT）双向交互。

消息总线采用双栈设计——实时栈（MQTT）用于状态共享和快速协商，可靠栈（OPC-UA）用于控制指令传递。例4-1展示了消息带宽分析——即使大型水网的通信带宽需求也远低于工业网络容量。

Agent运行容器提供执行引擎、通信适配器和状态管理器三个子系统。Agent生命周期包含6个状态（表4-2），其中Degraded状态确保通信异常时的安全回退。

MAS作为HydroOS调度引擎层的服务集成，提供标准REST API。SCADA↔MAS的数据流通过OPC-UA实现（表4-3），操作员手动覆盖机制确保人工干预能力始终可用（例4-2）。

> 下一章将深入MAS面临的最复杂工程问题之一——当多个Agent的局部决策相互冲突时如何消解？当复杂约束使得协商无法收敛时如何仲裁？

---

## 习题

### 基础题

**4-1.** 解释SCADA+MAS融合架构中"渐进增强"原则的含义。如果MAS层完全失效，系统应如何运行？

**4-2.** 比较MQTT和OPC-UA在MAS通信中的角色差异。为什么状态共享用MQTT而控制指令用OPC-UA？

**4-3.** 解释Agent的Degraded状态及其触发条件。为什么Degraded状态下Agent回退到本地PI控制而非完全停止？

### 应用题

**4-4.** 为一个10座闸站的调水工程设计MQTT主题命名方案和订阅关系。要求：（a）列出全部主题名称；（b）画出每个Agent的订阅关系图（假设线性链拓扑+一个协调Agent）；（c）估算每分钟的总消息数量和总数据量。

**4-5.** 设计Agent运行容器的健康监控方案。要求：（a）定义至少5个健康指标（如CPU使用率、消息延迟等）；（b）为每个指标定义正常/告警/异常三级阈值；（c）设计从告警到Degraded状态转换的决策逻辑。

### 思考题

**4-6.** 操作员手动覆盖MAS决策（例4-2）在工程实践中可能被滥用——如果操作员频繁覆盖MAS建议，MAS的协调能力将被架空。讨论：（a）如何设计覆盖权限管理（谁可以覆盖、覆盖需要审批吗）？（b）如何记录和分析覆盖事件以评估MAS决策质量？（c）如何建立操作员对MAS的信任？

**4-7.** 本章的Agent运行容器采用单进程模型——每个Agent运行在独立进程中。讨论：（a）单进程模型的优缺点；（b）是否可以将多个Agent部署在同一进程的不同线程中？风险是什么？（c）容器化部署（Docker/Kubernetes）对水网MAS的适用性如何？

---

## 拓展阅读

1. **Bellifemine, F., Caire, G., & Greenwood, D. (2007).** *Developing Multi-Agent Systems with JADE.* Wiley. — JADE多智能体平台的实践指南，其Agent生命周期管理和消息传递机制对本章的容器设计有参考价值。

2. **Mahnke, W., Leitner, S.H., & Damm, M. (2009).** *OPC Unified Architecture.* Springer. — OPC-UA协议的权威技术参考，对理解MAS与SCADA之间的数据交互有直接帮助。

3. **Lei, X. et al. (2025b).** "Autonomous Water Networks: Architecture and Key Technologies." *南水北调与水利科技（中英文）*. — HydroOS架构论文，SCADA+MAS融合架构的设计蓝图。

4. **Leitão, P. & Karnouskos, S. (Eds.) (2015).** *Industrial Agents: Emerging Applications of Software Agents in Industry.* Morgan Kaufmann. — 工业Agent的综合著作，工业环境中Agent部署的实践经验对水网MAS有重要借鉴。
