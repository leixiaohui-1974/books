<!-- 变更日志
v1 2026-02-16: 初稿
-->

# ch04 非线性MPC与管网控制

## 学习目标

完成本章学习后，读者应能够：

1. 说明为何管网控制常需采用非线性模型预测控制（Nonlinear MPC, NMPC）；
2. 构建含非线性水力关系与约束的 NMPC 优化问题；
3. 理解序列二次规划（SQP）与实时迭代（RTI）在在线求解中的作用；
4. 设计管网场景下的状态估计、约束收紧与回退机制；
5. 评估 NMPC 在复杂管网中的适用边界、计算负担与工程收益。

> 本章承接 ch03：ch03解决线性MPC在明渠的高效部署；本章扩展到非线性显著、耦合更强的管网控制问题。

> **前章回顾**：上一章介绍了本领域的核心概念与方法。本章在此基础上进一步展开。


## 管网非线性动力学与控制需求

在输配水管网中，流量—压头关系、阀门特性、泵站工况曲线都具有非线性。若使用线性近似过于粗糙，容易在工况偏移时产生系统性误差，因此需采用 NMPC 直接处理非线性模型。

典型离散模型写为：

$$
\mathbf{x}_{k+1}=f(\mathbf{x}_k,\mathbf{u}_k,\mathbf{d}_k),\quad
\mathbf{y}_k=g(\mathbf{x}_k,\mathbf{u}_k)
$$

其中 $f,g$ 可由机理模型、降阶模型（Reduced-Order Model, ROM）或混合模型构成。

[物理直觉] 当泵站效率、管阻与阀门开度共同变化时，“线性叠加”不再成立，控制器必须直接面对非线性耦合。

## NMPC标准问题与约束构造

NMPC 在时刻 $k$ 求解：

$$
\min_{\mathbf{u}_{k:k+N_c-1}} J=\sum_{i=1}^{N_p}\ell(\mathbf{x}_{k+i},\mathbf{u}_{k+i-1})+V_f(\mathbf{x}_{k+N_p})
$$

满足：

- 动力学约束：$\mathbf{x}_{k+i+1}=f(\mathbf{x}_{k+i},\mathbf{u}_{k+i},\mathbf{d}_{k+i})$；
- 物理约束：压力、流量、库容、泵站功率边界；
- 安全约束：安全包络（Safety Envelope）与运行设计域（Operational Design Domain, ODD）；
- 运维约束：阀门动作率、启停次数、通信与计算时限。

[工程解释] 与线性MPC相比，NMPC优势在“模型更真实”，挑战在“求解更重”。

[图4-1: 管网NMPC闭环与求解链路]
{描述: 展示状态估计、非线性预测、求解器迭代、执行反馈、异常回退与在环验证链路。}
{尺寸: 全页}
{颜色方案: 蓝色系}

## 在线求解策略：SQP与RTI

### 4.4.1 SQP基本流程

SQP（Sequential Quadratic Programming）通过在每次迭代中线性化约束、二次近似目标，求解一系列 QP 子问题逐步逼近最优解。其优点是理论成熟、可处理复杂约束；缺点是计算量可能较大。

### 4.4.2 RTI工程化策略

RTI（Real-Time Iteration）强调“每采样周期仅做少量迭代”，利用上一时刻解作热启动，在实时性与最优性之间折中。

[物理直觉] 工程控制不是离线论文竞赛；“准最优但按时给出”通常优于“更优但超时无用”。

## 状态估计与模型失配处理

管网传感器可能存在噪声、漂移与缺测。NMPC 实施前通常需要状态估计器（如扩展 Kalman 滤波）提供一致状态输入。为应对模型失配，可采用：

- 偏置在线估计与补偿；
- 约束收紧（constraint tightening）；
- 管理型回退策略（如降级到线性MPC或规则控制）。

[表4-1: 管网NMPC失配场景与处置策略]
{描述: 列为“失配来源、典型表现、诊断指标、处置动作、恢复条件”。}
{尺寸: 半页}
{颜色方案: 灰度}

## 可复现实例：泵阀协同非线性控制

【例4-1】某管网含 2 座泵站与 3 个调节阀，采样周期 2 min。目标是在满足末端压力约束下最小化能耗与动作冲击。

**已知**：

- 压力约束：$p\in[0.24,0.42]$ MPa；
- 泵站功率上限：$P_{pump}\le 1.8$ MW；
- 阀门动作率：$\Delta u\in[-2\%,2\%]$；
- 求解时限：每周期 1.2 s。

**求解**：说明为何采用“RTI + 热启动 + 超时降级”架构。

**解题过程**：

1. 非线性耦合显著，需 NMPC 才能保持模型一致性；
2. RTI 与热启动可降低单周期计算负担；
3. 若超时，立即降级到保守控制策略，保障连续运行。

**结果讨论**：
该架构体现了 NMPC 的工程化原则：优先保证“准时可用 + 约束安全”，在此基础上再优化性能。

## 在环验证与上线门禁

NMPC 上线前应按 MIL→SIL→HIL 逐级验证：

- **MIL**：验证模型与求解器配置正确性；
- **SIL**：验证软件集成、接口时序与异常处理；
- **HIL**：验证控制器在真实通信时延与抖动下的稳定性。

建议门禁指标示例：

- 求解成功率 > 99%；
- 求解超时率 < 1%；
- 约束违背率 < 0.5%；
- 超时降级恢复成功率 > 99%。

[TODO: 需补充具体工程平台上的求解器版本与硬件配置清单。]

## 本章小结

本章构建了非线性MPC在管网控制中的完整路径：以非线性模型提升描述精度，以 SQP/RTI 保障在线求解，以状态估计与约束收紧对冲失配风险，以在环门禁确保可部署性。与线性MPC相比，NMPC更强调“模型真实度与计算可行性”的工程平衡。下一章将进入分布式MPC架构，解决大规模水网的协同优化问题。

## 习题

### 基础题

**4-1.** 为什么管网场景中 NMPC 往往比线性MPC更必要？
**4-2.** 比较 SQP 与 RTI 的优势与局限。
**4-3.** 约束收紧在工程上线中解决了什么问题？

### 应用题

**4-4.** 设计一个含泵阀协同的 NMPC 目标函数，至少包含压力跟踪、能耗与动作平滑三项。  
**4-5.** 给定求解时限与约束违背阈值，设计“正常—预警—降级—恢复”四态门禁逻辑。

### 思考题

**4-6.** 若团队希望提高模型复杂度以追求更高精度，但计算资源有限，你会如何制定分阶段实施路线？

### 基础题参考答案要点

**4-7.** 因管网水力关系与设备特性非线性显著，线性模型在跨工况时误差可能不可接受。  
**4-8.** SQP收敛质量高但计算偏重，RTI实时性更好但最优性依赖热启动与参数设置。  
**4-9.** 通过预留安全裕度对冲模型失配与扰动，降低约束违背风险。

## 拓展阅读

1. **Diehl, M. et al. (2005). Real-time optimization and nonlinear MPC.**
2. **Rawlings, J.B., Mayne, D.Q. & Diehl, M. (2017). *Model Predictive Control: Theory, Computation, and Design*.**
3. **Allgöwer, F. & Zheng, A. (2000). *Nonlinear Model Predictive Control*.**
4. **Camacho, E.F. & Bordons, C. (2007). *Model Predictive Control*.**
5. **Lei et al. (2025c). 在环测试系统。**
