<!-- 变更日志
v1 2026-02-19: 初稿（完全重写）
-->

# 第三章 一致性协议与协商机制

## 学习目标

1. 掌握平均一致性协议的基本原理和收敛条件，理解Laplacian矩阵在一致性分析中的核心作用；
2. 理解加权一致性和约束一致性在水网MAS中的应用，掌握将水力学耦合关系纳入一致性权重的方法；
3. 掌握通信延时和拓扑切换对一致性收敛的影响，以及相应的鲁棒一致性协议设计；
4. 理解"协商-校核-执行"三阶段协议的流程，能够为具体水网场景设计完整的协商机制。

> **前章回顾**：第二章建立了水网MAS的形式化框架——五元组Agent模型、通信拓扑图和安全包络。在这一框架下，每个Agent拥有局部观测和局部动作能力，通过消息传递与邻居交互。本章回答核心问题：分布式的Agent如何通过局部交互达成全局一致的决策？

---

## 平均一致性协议

### 3.1.1 问题定义

一致性问题的标准形式：$N$个Agent各自持有一个初始值$x_i(0)$（例如水位设定值或流量分配方案），目标是通过邻居间的信息交换使所有Agent的值收敛到某个公共值。

**平均一致性**要求收敛值等于所有初始值的平均：

$$\lim_{t \to \infty} x_i(t) = \frac{1}{N} \sum_{j=1}^{N} x_j(0), \quad \forall i$$

平均一致性协议的标准更新规则为：

$$x_i(t+1) = x_i(t) + \epsilon \sum_{j \in N(i)} w_{ij} (x_j(t) - x_i(t))$$

其中$\epsilon > 0$是步长参数，$w_{ij}$是邻接权重，$N(i)$是Agent $i$的通信邻居集合。

### 3.1.2 Laplacian矩阵与收敛分析

将上述更新规则用矩阵形式表达：

$$\mathbf{x}(t+1) = (I - \epsilon L) \mathbf{x}(t)$$

其中$L$是通信图的Laplacian矩阵，$L_{ij} = -w_{ij}$（$i \neq j$），$L_{ii} = \sum_{j \neq i} w_{ij}$。

收敛条件：当且仅当通信图连通且步长$\epsilon$满足$0 < \epsilon < 2/\lambda_N$时，一致性协议收敛。$\lambda_N$是Laplacian矩阵的最大特征值。收敛速度由第二小特征值$\lambda_2$（代数连通度）决定——$\lambda_2$越大，收敛越快。

**表3-1 通信拓扑对一致性收敛的影响**

| 拓扑类型 | 节点数 | $\lambda_2$ | 收敛速度 | 适用场景 |
|---------|-------|------------|---------|---------|
| 线性链 | $N$ | $O(1/N^2)$ | 慢（随$N$急剧降低） | 线性渠道 |
| 环形 | $N$ | $O(1/N^2)$ | 慢 | 环状管网 |
| 星形 | $N$ | 1 | 快（不随$N$变化） | 有协调Agent |
| 小世界 | $N$ | $O(1)$ | 快 | 加少量长距离链路 |

### 3.1.3 水网一致性的物理解释

【例3-1】用平均一致性协议实现3站调水渠道的水位协调。

[场景] 3座闸站（A1, A2, A3）的目标水位设定值需要协调调整。当前各站设定值为$x_1=3.2$m, $x_2=3.0$m, $x_3=2.8$m。因上游来水增加，需要统一提高设定值。

[一致性协议执行] 通信拓扑为线性链（A1↔A2↔A3）。权重$w_{12}=w_{23}=1$，步长$\epsilon=0.3$。

迭代过程：
- $t=0$: $x = [3.2, 3.0, 2.8]$
- $t=1$: $x_1 = 3.2+0.3(3.0-3.2) = 3.14$, $x_2 = 3.0+0.3(3.2-3.0)+0.3(2.8-3.0) = 3.0$, $x_3 = 2.8+0.3(3.0-2.8) = 2.86$
- $t=2$: $x = [3.098, 3.024, 2.918]$
- ... 约10次迭代后收敛到$x_1 \approx x_2 \approx x_3 \approx 3.0$m

[物理意义] 平均一致性使三站的设定值收敛到初始值的平均3.0m。在实际工程中，可能不希望简单取平均——上游站应该维持更高水位以保证输水能力。这正是加权一致性的应用场景。

---

## 加权一致性

### 3.2.1 水力学权重

在水网中，Agent之间的耦合强度不是均匀的——上下游的耦合比平行管道的耦合更强，短渠段的耦合比长渠段的耦合更快。加权一致性通过调整邻接权重$w_{ij}$来反映这种非均匀耦合。

水力学权重的设计原则：

**距离反比权重**：$w_{ij} = 1/L_{ij}$，其中$L_{ij}$是渠段长度。短渠段的Agent之间权重更大，反映更强的水力学耦合。

**延时反比权重**：$w_{ij} = 1/\tau_{ij}$，其中$\tau_{ij}$是水力学延时。延时短的Agent对之间权重更大，反映更快的相互影响。

**流量比例权重**：$w_{ij} = Q_{ij}/Q_{max}$，按流量大小分配权重。主干渠的Agent之间权重大于支渠。

### 3.2.2 约束一致性

标准一致性协议不考虑约束——收敛值可能违反安全约束。约束一致性在每次更新后投影到可行域：

$$x_i(t+1) = \text{Proj}_{C_i}\left[x_i(t) + \epsilon \sum_{j \in N(i)} w_{ij} (x_j(t) - x_i(t))\right]$$

其中$\text{Proj}_{C_i}[\cdot]$是到Agent $i$约束集$C_i$的投影运算。

【例3-2】约束一致性在水位设定值协调中的应用。

[场景] 同例3-1的3站渠道，但增加约束：$x_1 \geq 3.0$m（上游必须维持足够水头），$x_3 \leq 2.9$m（下游水位受限）。

[约束一致性执行] 平均一致性的收敛值3.0m满足$x_1$约束但违反$x_3$约束。约束投影后，$x_3$被截断为2.9m。由于$x_3$的约束激活改变了全局一致性平衡，协议需要更多迭代才能收敛，最终收敛到$x_1 \approx 3.05$, $x_2 \approx 2.975$, $x_3 = 2.9$——不再是精确平均，而是满足约束条件下的最优折衷。

---

## 通信延时与拓扑切换

### 3.3.1 延时一致性

实际通信中，消息从Agent $i$到Agent $j$存在延迟$\tau_{ij}$。延时一致性协议使用延迟的消息：

$$x_i(t+1) = x_i(t) + \epsilon \sum_{j \in N(i)} w_{ij} (x_j(t - \tau_{ij}) - x_i(t))$$

延时对收敛性的影响：当延时$\tau_{ij}$足够小时（相对于系统动态），一致性仍能收敛但速度降低。当延时超过临界值时，协议可能发散或振荡。

**表3-2 通信延时对一致性性能的影响**

| 延时水平 | 收敛性 | 收敛速度 | 水网典型场景 |
|---------|--------|---------|------------|
| $\tau < 0.1/\lambda_2$ | 收敛 | 接近无延时 | 站内或短距离通信 |
| $0.1/\lambda_2 < \tau < 1/\lambda_2$ | 收敛 | 显著降低 | 长距离光纤通信 |
| $\tau > 1/\lambda_2$ | 可能发散 | — | 卫星通信或严重网络拥塞 |

### 3.3.2 拓扑切换

水网MAS的通信拓扑不是固定的——通信链路可能因设备故障而断开，也可能因维护而恢复。拓扑切换条件下的一致性需要更强的条件：**联合连通性**——在任意有限时间窗口$[t, t+T]$内，切换拓扑的并集图是连通的。

联合连通性保证了即使每个时刻的拓扑可能不连通，但只要"在一段时间内信息能到达所有Agent"，一致性仍能实现。

---

## "协商-校核-执行"三阶段协议

### 3.4.1 协议设计

水网MAS的决策协调不能仅依赖一致性协议——一致性只解决"达成相同的值"，但不解决"这个值是否安全可行"。CHS提出三阶段协议来解决这一问题：

**阶段一：协商（Negotiate）**。Agent之间通过一致性协议或协商消息交换方案提议，寻求共识。此阶段的输出是一个候选控制方案$\mathbf{u}^*$。

**阶段二：校核（Verify）**。候选方案在本地被控对象模型上进行快速仿真预演——Agent预测如果执行$\mathbf{u}^*$，未来$T$个时间步的状态轨迹是否满足安全包络约束。如果任何Agent的校核发现安全违规，方案被否决并返回阶段一重新协商。

**阶段三：执行（Execute）**。通过校核的方案被所有Agent同步执行。执行过程中，Agent持续监控实际状态与预测状态的偏差——如果偏差超过阈值，触发重新协商。

### 3.4.2 三阶段协议的时序

**表3-3 三阶段协议的典型时序参数**

| 阶段 | 时间预算 | 关键约束 |
|------|---------|---------|
| 协商 | 5-30个控制周期 | 一致性收敛时间、通信延迟 |
| 校核 | 1-2个控制周期 | 本地仿真计算时间 |
| 执行 | 直到下次触发 | 状态偏差监控阈值 |

协商阶段的时间预算取决于通信拓扑和一致性收敛速度。对于线性渠道（$\lambda_2$小），可能需要更多迭代轮次。

【例3-3】三阶段协议处理全线流量调整。

[场景] 调度中心要求将全线设计流量从40 m³/s调整到30 m³/s。涉及5座闸站协调。

[阶段一-协商] 协调Agent发起流量调整请求。各闸站Agent根据本地条件提出调节方案——A1提议先减小本站开度，等下游水位稳定后再逐站减小。A3提议同步减小以缩短过渡时间。经过8轮一致性迭代，达成折衷方案：按从上游到下游的顺序依次减小开度，每站间隔2个控制周期。

[阶段二-校核] 每个闸站Agent用本地IDZ模型仿真预演：以当前水位为初始条件，输入协商确定的开度调节序列，预测未来60个控制周期（60分钟）的水位轨迹。结果：A3的预测显示在第35个周期水位可能低于1.2m（安全下限1.0m，预警阈值1.2m）。A3发送REJECT消息。

[重新协商] 修正方案：A3的开度减小速率放缓，延迟4个周期（而非2个）。重新校核通过。

[阶段三-执行] 方案下发执行。实际执行过程中，A3在第28个周期监测到水位比预测偏低0.05m（偏差阈值0.1m），在阈值内，继续执行。流量调整在45分钟内完成，全线水位保持在安全范围内。

---

## 本章小结

本章建立了水网MAS的一致性协议和协商机制。

平均一致性协议通过局部信息交换使Agent收敛到公共值，收敛条件为通信图连通且步长适当。Laplacian矩阵的代数连通度$\lambda_2$决定收敛速度——线性链拓扑的$\lambda_2$随节点数急剧降低，是水网MAS的瓶颈（表3-1）。

加权一致性通过水力学权重（距离反比、延时反比、流量比例）反映Agent之间的非均匀耦合。约束一致性通过投影运算保证收敛值满足安全约束（例3-2）。

通信延时降低收敛速度并可能导致发散（表3-2），拓扑切换要求联合连通性条件。

"协商-校核-执行"三阶段协议（表3-3）将一致性协商与安全校核相结合——协商阶段寻求共识，校核阶段用本地模型验证安全性，执行阶段同步实施并持续监控（例3-3）。

> 下一章将把一致性协议和协商机制嵌入SCADA+MAS融合架构的系统实现中——消息总线如何承载协议消息？Agent生命周期如何管理？HydroOS平台如何集成MAS服务？

---

## 习题

### 基础题

**3-1.** 写出平均一致性协议的更新规则和矩阵形式。解释Laplacian矩阵第二小特征值$\lambda_2$对收敛速度的影响。

**3-2.** 对于一个4节点线性链拓扑（A1↔A2↔A3↔A4），写出Laplacian矩阵$L$（假设所有权重为1），并计算其特征值。$\lambda_2$是多少？

**3-3.** 解释约束一致性与普通一致性的区别。约束投影操作为什么可能导致收敛值不是初始值的精确平均？

**3-4.** "协商-校核-执行"三阶段协议中，校核阶段的作用是什么？如果省略校核阶段直接执行协商方案，可能产生什么后果？

### 应用题

**3-5.** 某调水渠道有6座闸站（线性链拓扑），需要从当前流量50 m³/s降至35 m³/s。使用加权一致性协议协调各站的开度调整量。请：（a）设计权重方案（假设渠段长度分别为8, 12, 10, 15, 10 km）；（b）计算3次迭代后各站的开度调整值；（c）分析如果A3到A4的通信链路中断，协议能否仍然收敛？

**3-6.** 为例3-3中的5站场景设计完整的三阶段协议实现方案：（a）定义消息格式（协商请求/响应的具体字段）；（b）设计校核阶段的仿真参数（预测步长、预测时域、安全裕度）；（c）设计执行阶段的偏差监控策略（监控哪些变量、阈值如何确定、超阈后的处理流程）。

### 思考题

**3-7.** 平均一致性假设所有Agent的"投票权"相等。但在水网中，上游大型闸站的影响力应该大于下游小型闸站。讨论如何设计非对称的一致性协议，使收敛值偏向"重要"Agent的初始值。这种非对称设计对收敛性有什么影响？

**3-8.** 三阶段协议中的校核阶段依赖本地模型的预测能力。但本地模型只是真实系统的近似——如果模型不准确，校核可能通过了不安全的方案或否决了安全的方案。讨论如何设计对模型误差鲁棒的校核机制。

---

## 拓展阅读

1. **Ren, W. & Beard, R.W. (2008).** *Distributed Consensus in Multi-vehicle Cooperative Control.* Springer. — 分布式一致性的权威著作，系统推导了各类拓扑和约束条件下的一致性协议收敛条件。

2. **Olfati-Saber, R., Fax, J.A., & Murray, R.M. (2007).** "Consensus and cooperation in networked multi-agent systems." *Proceedings of the IEEE*, 95(1), 215-233. — 多智能体一致性问题的综合综述，覆盖了延时、切换拓扑和非线性系统的一致性理论。

3. **Nedic, A. & Ozdaglar, A. (2009).** "Distributed subgradient methods for multi-agent optimization." *IEEE Transactions on Automatic Control*, 54(1), 48-61. — 分布式约束优化的理论基础，约束一致性的数学分析工具。

4. **van Overloop, P.J., Negenborn, R.R., De Schutter, B., & van de Giesen, N.C. (2010).** "Predictive control for national water flow optimization in the Netherlands." *Intelligent Infrastructures*, Springer, 439-461. — 荷兰国家水流优化中的预测控制，展示了分布式协调在实际水网中的应用。
