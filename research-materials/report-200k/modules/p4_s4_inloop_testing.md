## 4.5 在回路测试：从离线仿真到工程级验证

水网控制系统从算法设计走向工程部署，中间横亘着一道难以逾越的鸿沟——验证鸿沟。一个在离线仿真中表现优异的控制算法，在真实工程上线后可能因传感器噪声、执行器延迟、通信中断等因素而表现迥异。航空航天和汽车工业早已建立了成熟的在回路测试（X-in-the-Loop Testing）体系来弥合这一鸿沟，但水利行业长期缺乏系统化的控制验证流程。随着水网自主等级（WNAL）的不断提升，建立覆盖"模型在环—软件在环—硬件在环"（MIL-SIL-HIL）的分层测试体系，已成为水系统控制论（CHS）工程化落地的关键支撑。

### 4.5.1 验证鸿沟：为什么需要在回路测试

#### （1）传统验证模式的局限

传统水利工程控制系统的验证通常采用"离线仿真+现场调试"的两步模式。离线仿真阶段，工程师利用水动力学模型对控制算法进行测试，验证其在理想条件下的性能。现场调试阶段，将算法直接部署到实际工程中，通过反复调整参数来适应真实工况。

这种模式存在三个根本性缺陷。第一，离线仿真与真实工况之间存在显著的"仿真-现实鸿沟"（Sim-to-Real Gap）。离线仿真通常假设传感器数据精确、执行器响应理想、通信链路可靠，但这些假设在真实工程中几乎从不完全成立。第二，现场调试的风险高、成本大、窗口期短。大型水利工程如南水北调、胶东调水等，其运行调度关系到数千万人的供水安全，不允许在真实系统上进行大范围的"试错"。第三，现场调试的可重复性差。水利系统的运行工况受来水、需水、气象等自然因素影响，几乎不可能精确复现某一特定工况，这使得调试结论难以系统化积累。

#### （2）航空航天和汽车工业的经验借鉴

航空航天和汽车工业在控制系统验证方面积累了丰富的经验。美国航空航天局（NASA）早在阿波罗计划时期就建立了分层测试体系，从数学仿真到半实物仿真，再到全系统集成测试，形成了严格的"V字型"开发验证流程。汽车行业的自动驾驶技术验证更是将在回路测试推向了新的高度：Waymo等自动驾驶公司在虚拟环境中累计行驶数十亿英里，远超实际道路测试的里程数，正是通过MIL-SIL-HIL的分层验证来确保系统安全。

水网控制系统与自动驾驶系统存在深刻的相似性：两者都需要在复杂、动态、不确定的环境中做出实时控制决策；两者都涉及安全关键（Safety-Critical）系统，一旦失误可能造成严重后果；两者都需要处理传感器融合、多目标优化、异常工况应对等共性技术挑战。因此，借鉴这些成熟行业的验证方法论，构建水网控制系统自己的在回路测试体系，既是必要的也是可行的。

#### （3）WNAL提升对验证能力的刚性需求

随着水网自主等级从L1（辅助运行）向L3（有条件自主运行）乃至更高等级演进，控制系统的复杂度和自主决策范围急剧增加。在L1阶段，控制系统仅执行简单的设定值跟踪，验证需求相对有限。但在L3及以上阶段，系统需要自主应对工况切换、故障诊断、策略在线调整等复杂场景，验证的覆盖范围和深度要求呈指数级增长。

更为关键的是，高等级自主运行要求控制系统具备明确的运行设计域（ODD）边界和安全包络（Safety Envelope）约束。这些边界和约束不能仅仅停留在设计文档上，而必须通过系统化的测试来验证其有效性。在回路测试体系正是实现这一验证需求的核心手段。

### 4.5.2 MIL-SIL-HIL三层测试架构

#### （1）模型在环测试（MIL）

模型在环测试（Model-in-the-Loop, MIL）是在回路测试的第一层，也是成本最低、效率最高的验证手段。MIL的核心思想是：在纯软件环境中，将被测控制算法与高精度水动力学仿真模型进行闭环耦合，验证控制逻辑的正确性和基本性能。

MIL平台的基本架构包括四个核心组件。第一是被测控制器模块 $C$，即待验证的控制算法，可以是PID控制器、MPC控制器，或更复杂的分层分布式控制策略。第二是高精度水动力仿真器模块 $P$，基于完整的圣维南方程或其简化形式（如IDZ模型），模拟水力系统的动态响应。第三是场景管理与故障注入模块 $S$，负责生成测试场景、注入各类扰动和故障。第四是指标评估与报告模块 $E$，自动采集测试数据并生成结构化的评估报告。

四个组件的闭环关系可以形式化表达为：

$$u_k = C(x_k, r_k), \quad x_{k+1} = P(x_k, u_k, d_k)$$

其中 $x_k$ 为系统状态向量（包括各节点水位、流量等），$u_k$ 为控制指令向量（闸门开度、泵站转速等），$r_k$ 为参考轨线（目标水位、目标流量等），$d_k$ 为场景模块注入的外部扰动。

MIL测试的标准场景库通常包括三大类：正常工况场景（稳态跟踪、计划变流、日常调度），极端工况场景（突增突降来流、需求阶跃变化、多点同时扰动），以及故障注入场景（传感器漂移与失效、执行器饱和与卡阻、通信时延与丢包）。每个场景都需要明确定义输入边界条件、测试持续时间、通过判定阈值和安全约束条件。

MIL测试的核心性能评价指标体系包括：跟踪性能指标（如水位偏差的均方根误差RMSE、最大绝对偏差MAE、调节时间等），安全性指标（如安全包络越界次数、越界持续时间、最小安全裕度等），鲁棒性指标（如参数摄动下的性能退化率、扰动拒绝比等），以及实时性指标（如单步求解时间、最大求解时间、超时率等）。

#### （2）软件在环测试（SIL）

软件在环测试（Software-in-the-Loop, SIL）是MIL的升级版，其核心区别在于：被测控制算法不再是理想化的数学模型，而是编译后的实际软件代码，运行在近真实的软件栈环境中。SIL关注的重点从"算法逻辑正确性"扩展到"软件工程质量"，包括接口兼容性、时序一致性、内存管理、异常处理等。

SIL测试平台在MIL平台基础上增加了三个关键组件：软件容器化运行环境（模拟实际部署的操作系统和中间件环境），通信仿真层（模拟实际的OPC-UA、Modbus等工业通信协议），以及时钟同步机制（确保仿真时钟与控制器时钟的严格同步）。

SIL阶段重点验证的问题包括：接口超时率（控制器与仿真器之间的通信是否在规定时间内完成），消息重放正确率（系统重启或恢复后是否能正确重放历史指令），容器重启恢复时间（软件崩溃后是否能在容许时间内恢复运行），以及多控制器协同一致性（分布式部署的多个控制器是否能保持决策一致）。

SIL测试的一个重要价值在于发现MIL阶段无法暴露的软件缺陷。例如，某MPC控制器在MIL中表现完美，但在SIL中发现其求解器在特定工况下会出现数值溢出，导致输出异常值。这类问题如果在HIL甚至现场才发现，其修复成本和安全风险将大幅增加。

#### （3）硬件在环测试（HIL）

硬件在环测试（Hardware-in-the-Loop, HIL）是在回路测试的最高层级，其核心特征是：被测控制器运行在真实的硬件平台（PLC、RTU或工控机）上，通过真实的工业通信接口与仿真系统进行闭环交互。HIL测试的目的是验证控制算法在真实硬件和通信条件下的完整表现，是工程上线前的最后一道技术关卡。

HIL平台的物理构成包括：真实的控制器硬件（与现场部署相同型号的PLC或工控机），实时仿真器（运行水动力学模型的高性能计算设备，通常需要满足硬实时要求），I/O接口板卡（模拟传感器信号和执行器反馈），以及工业通信网络（与现场相同的SCADA通信架构）。

HIL测试相比SIL增加的验证维度包括：硬件I/O响应时延及其抖动特性，真实通信协议下的数据传输可靠性，控制器在满负荷计算下的实时性表现，联锁保护与安全动作的硬件触发一致性，以及长时间连续运行的稳定性（如72小时或更长的耐久测试）。

在胶东调水工程的实践中，HIL测试发现了多个MIL和SIL阶段未能暴露的问题。例如，某控制器的PLC在高频数据采集模式下出现扫描周期超限，导致控制指令输出延迟；又如，某闸门执行器的反馈信号在特定工况下出现毛刺，触发了控制器的虚假联锁保护。这些问题只有在真实硬件环境中才能被发现和解决。

### 4.5.3 测试场景自动生成与覆盖度量

#### （1）场景库的系统化构建

测试场景是在回路测试的核心驱动力。一个高质量的测试场景库需要满足两个基本要求：覆盖性（尽可能涵盖所有可能的运行工况）和可追溯性（每个场景都有明确的来源和生成依据）。

水网控制系统的测试场景可以从三个维度进行系统化构建。第一个维度是基于ODD的工况枚举：根据已定义的运行设计域，枚举所有可能的工况组合，包括不同的来水条件、需水模式、季节特征、设备状态等。第二个维度是基于历史事件的场景提取：从真实运行记录中提取典型的异常事件和极端工况，将其参数化后纳入场景库。第三个维度是基于风险分析的边界场景生成：利用故障树分析（FTA）或失效模式与影响分析（FMEA）方法，识别可能导致系统失效的关键边界条件，生成对应的测试场景。

#### （2）场景自动生成技术

随着控制系统复杂度的增加，人工设计测试场景越来越难以满足覆盖要求。自动场景生成技术正在成为一个重要的研究方向。其核心思想是利用算法自动搜索那些最可能导致控制系统失效的"对抗性场景"（Adversarial Scenarios）。

一种典型的方法是基于参数化场景模板的蒙特卡洛采样。将场景参数化为向量 $\boldsymbol{\xi} = [\xi_1, \xi_2, \ldots, \xi_m]^T$（其中 $\xi_i$ 可以是来流量级、扰动时刻、故障类型等），定义参数的概率分布 $p(\boldsymbol{\xi})$，然后通过大量采样生成测试场景集合 $\Xi = \{\boldsymbol{\xi}_1, \boldsymbol{\xi}_2, \ldots, \boldsymbol{\xi}_N\}$。为了提高测试效率，可以采用重要性采样（Importance Sampling）或自适应采样方法，优先生成那些位于控制系统性能边界附近的场景。

另一种更为先进的方法是基于强化学习的对抗性场景搜索。将场景生成建模为一个博弈问题：场景生成器（对手）试图找到让控制系统性能最差的场景，而控制系统（玩家）试图在所有场景下保持最佳性能。通过对抗训练，可以高效地发现控制系统的薄弱环节。

#### （3）覆盖度量与充分性判定

如何判断测试是否"足够充分"？这是在回路测试面临的一个核心挑战。借鉴软件工程中的代码覆盖率概念，可以定义水网控制系统的测试覆盖度量。

ODD工况覆盖率定义为已测试工况数与ODD中定义的全部工况数之比。边界条件覆盖率衡量测试场景对安全包络边界的逼近程度。故障模式覆盖率统计已测试的故障模式与FMEA中识别的全部故障模式之比。多维度的综合覆盖指标可以表达为：

$$C_{total} = \prod_{i=1}^{n} C_i^{w_i}, \quad \sum_{i=1}^{n} w_i = 1$$

其中 $C_i$ 为第 $i$ 个维度的覆盖率，$w_i$ 为对应的权重。当 $C_{total}$ 达到预设阈值时，测试被判定为充分。

### 4.5.4 灰度发布与持续验证

在回路测试体系不仅覆盖工程上线前的验证环节，还延伸到工程上线后的持续验证。灰度发布（Canary Release）策略是连接"测试环境"与"生产环境"的桥梁，其核心思想是将新的控制策略先在小范围内试运行，验证稳定后再逐步扩大到全系统。

灰度发布推荐采用三阶段渐进策略。第一阶段是影子运行（Shadow Mode）：新控制策略在后台并行运行，仅计算控制指令但不实际执行，将其建议动作与当前运行策略进行对比分析。第二阶段是小流量执行（Canary Mode）：选取低风险的渠段或站点执行新策略，设置严格的性能门槛和自动回滚触发条件。第三阶段是全量发布（Full Rollout）：在小流量执行稳定达标后，逐步扩大新策略的覆盖范围直至全系统。

每个阶段都需要定义明确的进入条件、退出条件和回滚触发条件。典型的回滚触发条件包括：连续两个观测窗口内约束违例次数超过基线的1.5倍，联锁触发频率异常升高且无法用外部工况变化解释，关键性能指标（如流量偏差、调度时延）超过预设红线阈值。

灰度发布的全过程需要与审计系统紧密集成，确保每一次策略变更都有完整的测试证据、审批记录和运行效果评估。这种"可验证上线"的机制，将传统的"经验性调试"转变为工程级的"闭环交付"，是水网控制系统迈向高WNAL等级的必备基础设施。

### 4.5.5 基于模型的设计验证一体化（MBD）

在回路测试体系的更高层次是基于模型的设计验证一体化（Model-Based Design, MBD）方法论。MBD的核心理念是：控制系统的设计、仿真、验证和代码生成共享同一套模型，从而消除设计文档与实际代码之间的不一致性，实现"设计即验证、模型即代码"。

在水网控制领域，MBD方法论的具体实现路径包括：首先，在统一的建模环境中完成控制算法的设计与MIL验证；其次，通过自动代码生成工具将验证过的控制模型转化为可部署的PLC或工控机代码；再次，生成的代码自动进入SIL和HIL测试流水线进行验证；最后，通过测试的代码经灰度发布流程部署到生产环境。

MBD方法论的关键优势在于大幅缩短了从设计到部署的周期，同时提高了部署代码与设计意图的一致性。在传统模式下，从算法设计到现场部署可能需要数月甚至更长时间，而采用MBD方法后，这一周期可以缩短到数周。更重要的是，MBD方法为控制策略的持续迭代提供了高效的基础设施——当运行数据反馈需要调整控制参数或策略时，工程师可以在模型层面进行修改，然后通过自动化的MIL-SIL-HIL流水线快速验证和部署。

### 4.5.6 工程实践：胶东调水在回路测试平台

胶东调水工程是国内首个系统化实施MIL-SIL-HIL在回路测试的大型调水工程。该工程输水线路全长约479公里，涉及多座泵站和控制闸门，控制系统的可靠性直接关系到沿线城市的供水安全。

在MIL阶段，基于完整的圣维南方程建立了全线水动力学仿真模型，与分层分布式MPC控制器进行闭环耦合。测试场景库包含正常工况场景42个、极端工况场景28个、故障注入场景35个，累计执行自动化测试超过10,000轮次。MIL测试发现了3个控制逻辑缺陷和7个参数配置不当问题，全部在仿真环境中修复。

在SIL阶段，将控制软件部署到容器化环境中，模拟真实的OPC-UA通信协议。SIL测试发现了2个接口时序问题和1个内存泄漏缺陷——这些问题在MIL的理想化环境中完全不可见。

在HIL阶段，使用与现场相同型号的PLC硬件，通过I/O板卡与实时仿真器进行闭环联调。HIL测试持续运行72小时，验证了控制系统在长时间连续运行条件下的稳定性，并发现了1个PLC扫描周期在高频采集模式下的超限问题。

通过MIL-SIL-HIL三层测试，胶东调水工程的控制系统在正式上线前共发现并修复了14个各类问题，其中有5个问题如果在现场运行中才暴露，可能导致供水中断或安全事故。在回路测试体系的建立，使得该工程的控制系统上线后运行稳定，首年运行期间未发生因控制软件缺陷导致的供水中断事件。

### 4.5.7 展望：数字孪生驱动的持续在环验证

展望未来，在回路测试将从"工程上线前的一次性验证"演进为"贯穿全生命周期的持续验证"。数字孪生技术的成熟为这一演进提供了技术基础：基于高保真的数字孪生模型，控制系统可以在虚拟环境中持续接受各类工况的考验，新的控制策略可以先在数字孪生中"试运行"，确认安全后再部署到真实系统。

这种"持续在环验证"的范式与DevOps理念高度契合。正如软件工程领域的"持续集成/持续部署"（CI/CD），水网控制系统也正在走向"持续建模/持续验证/持续部署"（CM/CV/CD）的新范式。在这一范式下，测试不再是开发流程末尾的一个独立阶段，而是融入控制策略全生命周期的每一个环节，成为保障水网自主运行安全性的常态化基础设施。

