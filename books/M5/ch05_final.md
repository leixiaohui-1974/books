<!-- 变更日志
v1 2026-02-19: 初稿
-->

# 第五章 检索增强生成（RAG）技术与水利应用

---

## 学习目标

完成本章后，读者应能够：

1. 阐述检索增强生成（RAG）的核心原理，理解"检索—增强—生成"三阶段流程以及RAG相对于纯LLM的优势与局限；
2. 设计面向水利领域的文档处理与分块（Chunking）方案，针对调度规程、技术标准和工程报告的不同文档特征选择合适的策略；
3. 选择和配置向量嵌入模型与向量数据库，建立高效的语义检索索引；
4. 综合运用稠密检索、稀疏检索和知识图谱检索构建混合检索管线，并根据水利领域的查询特征调优检索策略；
5. 设计完整的水利领域RAG系统架构，集成第三章的知识图谱和第四章的领域LLM，形成闭环的认知AI引擎。

---

> **前章回顾**：上一章介绍了本领域的核心概念与方法。本章在此基础上进一步展开。


## 为什么需要RAG：LLM的知识困境

第四章讨论了如何通过继续预训练和指令微调将通用LLM适配为水利领域模型。经过训练的模型确实掌握了大量水利知识，但它仍然面临三个根本性困境。

### 5.1.1 知识时效困境

LLM的知识来自训练数据，其截止日期是固定的。然而水利工程的运行条件持续变化：调度规程每年修订，设备参数因检修而更新，气象预报逐小时刷新。即使采用第四章建议的"季度微调"机制，模型的知识仍然滞后于现实。

[场景] 调度员问："目前3号闸门的最大允许开度是多少？"如果3号闸门上月刚完成改造，最大开度从1.5m调整为1.8m，而模型的训练数据截止于改造之前，它将给出过时的错误答案。这类错误在调度决策中可能导致严重后果。

### 5.1.2 知识精确困境

LLM将知识存储在数十亿参数的连续空间中，这种"隐式记忆"擅长模式匹配和泛化推理，但不擅长精确回忆具体事实。模型可能记住"冰期需要降低流速"这一规律，但无法准确回忆具体的限速值是0.6m/s还是0.8m/s。更危险的是，模型可能"自信地"给出一个看似合理但实际错误的数值——这就是所谓的"幻觉（Hallucination）"问题。

### 5.1.3 知识可追溯困境

当模型给出一个调度建议时，调度员需要知道这个建议的依据是什么——来自哪份规程的哪一条？基于哪次历史事件的经验？纯LLM的回答缺乏明确的来源指向，这使得调度员无法验证回答的可靠性，也无法在出现分歧时追溯到权威文档。

### 5.1.4 RAG的解决思路

检索增强生成（Retrieval-Augmented Generation, RAG）的核心思想是：**让LLM在回答问题时先从外部知识库中检索相关文档，然后基于检索到的文档生成回答**。

这个思路用一个形象的类比来说明：

- **纯LLM** = 闭卷考试。学生只能依靠考前记忆作答，容易遗忘细节、张冠李戴。
- **RAG** = 开卷考试。学生可以翻阅教材和笔记，关键信息有据可查。

RAG同时解决了上述三个困境：

**表5-1 大语言模型困境与RAG解决方式**

| 困境 | RAG的解决方式 |
|------|-------------|
| 知识时效 | 外部知识库可以实时更新，不需要重新训练模型 |
| 知识精确 | 精确信息直接从文档中检索，而非从模型参数中"回忆" |
| 知识可追溯 | 回答附带来源文档引用，可追溯、可验证 |

RAG最初由Lewis et al. (2020)提出，此后迅速成为LLM应用的标配架构。在水利领域，RAG不仅是一种技术选择，更是安全合规的要求——调度决策必须有据可查，这与RAG的知识可追溯特性天然契合。

---

## RAG系统架构

一个完整的RAG系统包含离线索引构建和在线查询服务两条流水线。

### 5.2.1 离线索引构建流水线

```
原始文档 → 文档解析 → 文本分块 → 向量嵌入 → 存入向量数据库
                                        ↓
                              元数据提取 → 存入元数据索引
                                        ↓
                              关键词索引 → 存入倒排索引（BM25）
```

**文档解析**：将多种格式的文档（PDF、Word、HTML、扫描图片）转换为结构化文本。

**文本分块**：将长文档切分为适合检索的短文本片段（chunk）。

**向量嵌入**：使用嵌入模型将每个文本片段转换为高维向量，表征其语义信息。

**索引存储**：将向量、元数据和关键词索引分别存储，支持多路检索。

### 5.2.2 在线查询服务流水线

```
用户查询 → 查询理解/改写 → 多路检索 → 结果融合与重排 → 上下文构建 → LLM生成 → 回答+引用
               ↓                ↓

**图5-1 水利RAG系统多路检索架构**

          意图分类        向量检索(语义)
          查询扩展        关键词检索(BM25)
          实体识别        知识图谱检索(结构化)
```

**查询理解**：分析用户意图，提取关键实体，必要时改写查询以提升检索效果。

**多路检索**：同时使用语义检索、关键词检索和知识图谱检索，从不同维度获取相关信息。

**结果融合与重排**：将多路检索结果合并，使用重排模型按相关性排序。

**上下文构建**：将排序后的文档片段组织为结构化的上下文，连同用户查询一起输入LLM。

**LLM生成**：基于检索到的上下文生成回答，并标注信息来源。

### 5.2.3 水利领域RAG架构的特殊考量

水利领域的RAG系统与通用RAG相比，有以下特殊设计需求：

**多源异构知识融合**：水利领域的知识分布在调度规程（结构化文本）、知识图谱（图结构数据）、SCADA实时数据（时序数据）和历史案例库（半结构化数据）中。RAG系统需要能够同时检索和融合这些异构数据源。

**安全分级检索**：不同密级的文档需要不同的访问控制。例如，水利工程的安全防护方案可能是保密文档，不应出现在普通查询的检索结果中。RAG系统需要支持基于用户权限的检索过滤。

**数值精确性保障**：水利领域的许多查询涉及精确数值（闸门参数、水位限值、流量定额等），检索系统必须确保返回的数值信息与源文档完全一致，不能有任何改动或近似。

**实时数据集成**：部分查询需要结合SCADA系统的实时数据（如"当前3号闸门的水位是多少？"）。RAG系统需要有专门的实时数据查询通道，而不仅仅依赖离线索引。

---

## 文档处理与分块策略

分块（Chunking）是RAG系统中最关键也最容易被低估的环节。分块质量直接决定了检索精度，进而决定了最终回答的质量。

### 5.3.1 分块的基本原则

分块策略需要在两个目标之间取得平衡：

- **粒度足够细**：每个chunk应聚焦于一个主题或一条信息，使得检索能够精准命中
- **上下文足够完整**：每个chunk应包含足够的上下文，使得LLM能理解其含义

过粗的分块导致检索召回大量无关信息（噪声高），过细的分块导致关键信息被截断（语义不完整）。

**通用参数建议**：

| 参数 | 推荐范围 | 说明 |
|------|---------|------|
| chunk大小 | 256-1024 tokens | 视文档类型而定 |
| 重叠长度 | 50-200 tokens | chunk间的重叠，防止信息截断 |
| 最小chunk | 50 tokens | 过短的chunk信息密度太低 |

### 5.3.2 水利领域文档的分块策略

不同类型的水利文档需要不同的分块策略：

**策略一：调度规程分块——以条款为单位**

调度规程具有天然的层级结构（篇→章→节→条→款→项），每个条款是一个独立的操作指令或规定。推荐以条款为基本分块单位，同时保留其层级路径作为元数据。

示例：

```
原文结构：
第四章 应急调度
  第一节 暴雨应急
    第4.1.1条 当上游来水超过设计流量120%时，应启动一级应急响应...
    第4.1.2条 一级应急响应期间，所有分水闸应关闭至零开度...
    第4.1.3条 应急泄洪操作流程：(1)确认上游来水...(2)通知下游...(3)开启退水闸...

分块结果：
Chunk 1: {
  text: "第4.1.1条 当上游来水超过设计流量120%时，应启动一级应急响应...",
  metadata: {
    doc: "胶东调水调度规程",
    chapter: "第四章 应急调度",
    section: "第一节 暴雨应急",
    clause: "4.1.1",
    type: "regulation",
    keywords: ["暴雨", "应急响应", "设计流量", "120%"]
  }
}
```

这种分块方式的优势在于：（1）每个chunk是一个完整的操作规定，语义自足；（2）层级路径元数据支持精确的结构化检索；（3）调度员可以直接追溯到具体条款编号。

**策略二：学术文献分块——以段落/节为单位**

学术论文和教材以段落为基本单位，同一节内的段落通常讨论相关主题。推荐以段落为基础分块，但在段落过短时合并相邻段落，过长时按语义断句切分。

```
分块规则：
- 单段落 < 100 tokens → 与下一段合并
- 单段落 > 800 tokens → 在句号处切分，保留200 tokens重叠
- 含公式的段落 → 公式与其前后解释文字保持在同一chunk中
- 图表引用 → 图表标题和说明文字作为独立chunk
```

**策略三：工程报告分块——混合策略**

工程报告结构松散，包含文字描述、数据表格、计算过程和结论。推荐采用混合策略：

- 文字段落：按段落+重叠方式分块
- 数据表格：每张表格（含表头和标题）作为独立chunk
- 计算过程：从"已知条件"到"计算结果"保持在同一chunk中
- 结论/建议：每条结论作为独立chunk

**策略四：SCADA运行日志分块——以时段/事件为单位**

运行日志通常是时序记录。推荐以"事件"为分块单位——将一个完整的操作事件（从触发条件到操作完成到效果确认）作为一个chunk。

```
事件chunk示例：
{
  text: "2024-06-15 08:15 上游WL-003报警：水位42.85m超过警戒值42.50m。
         08:18 HDC系统建议增开3号退水闸至0.8m。
         08:20 调度员确认执行。
         08:35 水位降至42.48m，低于警戒值。报警解除。",
  metadata: {
    event_type: "水位越限处置",
    start_time: "2024-06-15T08:15:00",
    end_time: "2024-06-15T08:35:00",
    equipment: ["WL-003", "退水闸-3号"],
    resolution: "成功"
  }
}
```

### 5.3.3 分块质量评估

分块完成后，需要评估分块质量。推荐以下评估方法：

**语义完整性抽检**：随机抽取100个chunk，人工判断每个chunk是否是一个语义完整的信息单元。完整率应≥85%。

**信息截断检测**：检查是否存在以下模式——关键信息被截断在两个chunk之间，使得任何单个chunk都不包含完整信息。截断率应≤5%。

**检索命中测试**：构建50个典型查询，检查正确答案所在的chunk是否出现在检索结果的Top-5中。命中率应≥80%。

---

## 向量嵌入与语义检索

向量嵌入（Embedding）是RAG系统的语义理解核心。它将文本转换为高维向量空间中的点，使得语义相近的文本在向量空间中距离较近。

### 5.4.1 嵌入模型选型

嵌入模型的选择直接影响检索质量。水利领域的嵌入模型选型需要考虑以下维度：

**中文语义理解能力**：模型是否能准确理解中文水利文本的语义？这是最基本的要求。

**领域适配性**：通用嵌入模型可能无法捕捉水利领域的语义细微差别。例如，"节制闸"和"退水闸"在通用语义空间中可能非常接近（都含"闸"字），但在水利语境中它们的功能完全不同。

**向量维度与检索效率**：高维向量（如1024维或1536维）通常语义区分度更好，但检索和存储成本更高。

**长文本支持**：部分水利文档的chunk可能较长（如包含完整条款+解释的chunk），嵌入模型需要支持足够的输入长度。

截至2025年，适合水利领域的主流嵌入模型：

| 模型 | 发布方 | 维度 | 最大输入 | 中文能力 | MTEB-中文排名 |
|------|--------|------|---------|---------|-------------|
| bge-large-zh-v1.5 | BAAI | 1024 | 512 tokens | ★★★★★ | Top-5 |
| bge-m3 | BAAI | 1024 | 8192 tokens | ★★★★★ | Top-3 |
| text-embedding-3-large | OpenAI | 3072 | 8191 tokens | ★★★★☆ | Top-5 |
| gte-Qwen2-7B-instruct | 阿里 | 3584 | 32K tokens | ★★★★★ | Top-1 |
| e5-mistral-7b-instruct | Microsoft | 4096 | 32K tokens | ★★★☆☆ | Top-10 |

**推荐方案**：

- **首选**：bge-m3（BAAI），理由是中文能力优秀、支持8192 tokens长文本、且支持稠密+稀疏+多粒度三种检索模式，非常适合混合检索架构
- **高性能选择**：gte-Qwen2-7B-instruct，语义理解能力最强，但推理成本较高（7B参数），适合对检索质量要求极高的场景
- **轻量选择**：bge-large-zh-v1.5，模型小（326M参数）、推理快，适合资源受限的边缘部署

### 5.4.2 领域适配嵌入

通用嵌入模型可能无法充分捕捉水利领域的语义关系。可以通过以下方法进行领域适配：

**方法一：对比学习微调**

构建水利领域的正负样本对，使用对比学习损失微调嵌入模型：

$$\mathcal{L}_{CL} = -\log \frac{\exp(\text{sim}(\mathbf{q}, \mathbf{d}^+)/\tau)}{\exp(\text{sim}(\mathbf{q}, \mathbf{d}^+)/\tau) + \sum_{j}\exp(\text{sim}(\mathbf{q}, \mathbf{d}_j^-)/\tau)}$$

其中 $\mathbf{q}$ 是查询向量，$\mathbf{d}^+$ 是正例文档向量，$\mathbf{d}_j^-$ 是负例文档向量，$\tau$ 是温度参数。

**正样本构造**：从水利问答数据中提取——查询与其正确答案所在的文档段落构成正对。

**困难负样本构造**：选择与查询"表面相似但语义不同"的文档作为困难负样本。例如：

| 查询 | 正样本 | 困难负样本 |
|------|--------|-----------|
| "冰期闸门操作要求" | 冰期调度规程条款 | 非冰期闸门操作条款 |
| "3号闸门最大开度" | 3号闸门技术参数 | 4号闸门技术参数 |
| "MPC预测时域设置" | MPC参数配置文档 | MPC理论推导文档 |

困难负样本的质量是对比学习成败的关键。在水利领域，"表面相似但语义不同"的文本非常普遍（同一工程的不同闸门、同一规程的不同工况条款），这既是挑战也是机会——大量的天然困难负样本使得对比学习特别有效。

**方法二：指令化嵌入**

为查询添加任务指令前缀，引导嵌入模型关注特定方面：

```
# 原始查询
"冰期闸门操作"

# 指令化查询
"检索关于冰期工况下闸门操作规程条款的文档：冰期闸门操作"
```

bge-m3和gte-Qwen2等指令化嵌入模型支持这种用法，实验表明在领域检索场景中可以提升3-8%的检索准确率。

### 5.4.3 向量数据库选型

向量数据库负责存储嵌入向量并提供高效的相似度检索。主流选择：

| 数据库 | 类型 | 最大向量数 | 检索延迟 | 特殊能力 | 推荐场景 |
|--------|------|-----------|---------|---------|---------|
| Milvus | 开源分布式 | 百亿级 | <10ms | 混合检索、分布式 | 大规模生产环境 |
| Qdrant | 开源单机/集群 | 亿级 | <5ms | Payload过滤、高精度 | 中等规模 |
| ChromaDB | 开源轻量 | 百万级 | <10ms | 极简API | 原型验证 |
| FAISS | 库（非数据库） | 十亿级 | <1ms | 极致性能 | 嵌入式场景 |
| Elasticsearch(kNN) | 开源 | 十亿级 | <20ms | 全文+向量混合 | 已有ES基础设施 |

**水利领域推荐**：

对于典型的调水工程RAG系统（文档量级约10万-100万chunk），推荐 **Qdrant** 或 **Milvus Lite**：

- 文档规模在百万chunk以内，单机即可满足
- 支持元数据过滤（如按文档类型、工况类型、时间范围过滤）
- 支持混合检索（向量+标量条件联合查询）

**索引配置建议**：

| 参数 | 推荐值 | 说明 |
|------|--------|------|
| 索引类型 | HNSW | 精度高、查询快，适合中等规模 |
| 距离度量 | 余弦相似度 | 对文本嵌入最常用 |
| ef_construction | 200 | HNSW构建参数，影响索引质量 |
| ef_search | 128 | HNSW搜索参数，影响检索精度 |
| M | 16 | HNSW图连接数，影响内存和精度 |

---

## 混合检索策略

单一检索方式难以覆盖水利领域的全部查询类型。语义检索擅长理解意图但可能遗漏精确关键词，关键词检索擅长精确匹配但无法理解同义表达，知识图谱检索擅长结构化查询但无法处理自由文本。混合检索将三者结合，取长补短。

### 5.5.1 稠密检索（语义检索）

稠密检索使用嵌入向量的相似度作为相关性度量：

$$\text{score}_{dense}(q, d) = \cos(\mathbf{e}_q, \mathbf{e}_d) = \frac{\mathbf{e}_q \cdot \mathbf{e}_d}{\|\mathbf{e}_q\| \|\mathbf{e}_d\|}$$

**优势**：理解查询意图，匹配语义而非字面。例如，查询"如何防止渠道结冰"可以匹配到包含"冰期输水防护措施"的文档，即使两者没有共同关键词。

**局限**：对精确术语和数值的匹配不敏感。查询"第4.1.3条"可能无法精确检索到该条款。

### 5.5.2 稀疏检索（关键词检索）

BM25是最经典的稀疏检索算法，基于词频和逆文档频率计算相关性：

$$\text{BM25}(q, d) = \sum_{t \in q} \text{IDF}(t) \cdot \frac{f(t, d) \cdot (k_1 + 1)}{f(t, d) + k_1 \cdot (1 - b + b \cdot |d|/\text{avgdl})}$$

其中 $f(t,d)$ 是词 $t$ 在文档 $d$ 中的频率，$|d|$ 是文档长度，$\text{avgdl}$ 是平均文档长度，$k_1$ 和 $b$ 是调节参数。

**优势**：对精确关键词匹配效果极佳，不需要GPU推理，检索速度极快。

**局限**：无法理解语义，对同义词和近义词不敏感。

**水利领域BM25优化**：

1. **自定义分词词典**：将水利领域专业术语（如"模型预测控制""分层分布式控制""安全包络"等）添加到分词词典中，避免被错误切分
2. **停用词扩展**：添加水利领域的高频低信息词（如"水利""工程""系统"等常见但区分度低的词）
3. **同义词扩展**：建立水利术语的同义词表（如"闸门"↔"水闸"、"泵站"↔"抽水站"），查询时自动扩展

### 5.5.3 知识图谱检索

第三章构建的水利知识图谱为RAG提供了第三条检索通道。知识图谱检索特别适合以下查询类型：

**实体属性查询**："3号节制闸的设计流量是多少？"

```cypher
MATCH (g:Gate {name: "3号节制闸"})
RETURN g.design_flow
```

**关系链查询**："3号闸门下游有哪些受影响的设施？"

```cypher
MATCH (g:Gate {name: "3号节制闸"})-[:DOWNSTREAM*1..3]->(facility)
RETURN facility.name, facility.type
```

**条件规则查询**："冰期工况下适用的调度规程条款有哪些？"

```cypher
MATCH (r:Regulation)-[:APPLIES_TO]->(c:Condition {type: "冰期"})
RETURN r.clause_number, r.content
```

知识图谱检索的优势在于结果的精确性和结构化——它返回的是确切的事实，而非"可能相关"的文档片段。但它的覆盖面受限于知识图谱的构建范围，对于超出图谱覆盖的查询无法提供帮助。

### 5.5.4 三路融合检索架构

将三种检索方式融合的推荐架构：

```
用户查询
  ├─→ 实体识别 ──→ 知识图谱检索 ──→ 精确结果（权重α）
  ├─→ 查询嵌入 ──→ 向量检索 ──────→ 语义结果（权重β）
  └─→ 关键词提取 → BM25检索 ──────→ 关键词结果（权重γ）
                                        ↓
                              倒数排名融合（RRF）
                                        ↓
                              重排模型（Cross-Encoder）
                                        ↓
                              Top-K检索结果
```

**倒数排名融合（Reciprocal Rank Fusion, RRF）**是最简单有效的结果融合方法：

$$\text{RRF}(d) = \sum_{r \in R} \frac{1}{k + r(d)}$$

其中 $R$ 是各路检索结果，$r(d)$ 是文档 $d$ 在该路结果中的排名，$k$ 是平滑常数（通常取60）。

RRF的优雅之处在于它不需要对不同检索方式的分数进行归一化——无论语义检索的分数范围是[0,1]还是BM25的分数范围是[0,50]，RRF只关注排名，天然适合异构检索结果的融合。

**重排模型（Cross-Encoder Reranker）**：RRF融合后的结果通常还需要进一步精排。推荐使用Cross-Encoder重排模型（如bge-reranker-v2-m3），它将查询和文档拼接后输入Transformer模型，输出精确的相关性分数。Cross-Encoder的精度远高于Bi-Encoder（即嵌入模型的双塔架构），但计算成本也更高，因此只用于对候选集（通常50-100个文档）进行重排。

### 5.5.5 水利领域的检索策略调优

不同类型的查询应采用不同的检索权重配比：

| 查询类型 | 示例 | 推荐权重(α:β:γ) | 理由 |
|---------|------|-----------------|------|
| 条款查询 | "第4.1.3条的内容" | 2:1:5 | 精确关键词匹配为主 |
| 概念理解 | "什么是安全包络" | 0:5:2 | 语义理解为主 |
| 设备参数 | "3号闸门最大开度" | 5:1:2 | 知识图谱精确查询为主 |
| 工况查询 | "暴雨应急如何处置" | 1:4:3 | 语义+关键词混合 |
| 历史案例 | "去年冬天类似事件" | 0:4:3 | 语义检索为主 |
| 计算咨询 | "Manning公式怎么用" | 0:3:4 | 术语关键词+语义混合 |

**自动策略选择**：可以训练一个轻量级的查询分类器（如基于规则+小型分类模型），根据查询内容自动选择最佳权重配比。查询分类器的输入特征包括：是否包含条款编号、是否包含设备名称、是否包含疑问词、查询长度等。

---

## 查询理解与改写

用户的原始查询往往不是最佳的检索输入。查询理解与改写模块的作用是将用户的自然语言问题转化为更适合检索的形式。

### 5.6.1 查询分析

对用户查询进行以下分析：

**意图分类**：判断查询属于哪种类型（事实查询、操作指导、故障诊断、计算咨询、概念解释等）。不同的意图类型对应不同的检索策略和回答格式。

**实体提取**：识别查询中的关键实体，如设备名称（"3号节制闸"）、地点（"K120处"）、工况类型（"冰期"）、时间引用（"去年冬天"）等。提取的实体可用于知识图谱检索和元数据过滤。

**约束条件识别**：识别查询中的隐含约束，如"目前"（需要最新数据）、"安全"（需要考虑安全约束）、"应急"（需要紧急处置流程）等。

### 5.6.2 查询改写策略

**策略一：同义词扩展**

```
原始查询："水闸怎么操作"
扩展后："水闸 OR 闸门 怎么操作 OR 操作方法 OR 操作规程"
```

**策略二：HyDE（Hypothetical Document Embeddings）**

HyDE（Gao et al., 2023）的思想是：让LLM先生成一个"假设性回答"，然后用这个假设性回答的嵌入来检索。这样做的好处是假设性回答的语言风格更接近文档（而非问题），嵌入向量与文档库的匹配度更高。

```
用户查询："冰期如何防止渠道结冰"

HyDE生成的假设性回答：
"冰期输水防护措施包括：降低输水流速至0.6m/s以下，监测沿线气温和水温变化，
在易结冰渠段设置冰情观测点，当水温降至0.5℃以下时启动防冰预警..."

→ 用假设性回答的嵌入进行检索
```

[工程注意] HyDE的优势在于显著提升语义检索的召回率，但它引入了额外的LLM推理延迟（生成假设性回答需要1-3秒）。在实时性要求高的场景中，建议仅对复杂查询启用HyDE。

**策略三：多步查询分解**

对于复合性问题，将其分解为多个子查询分别检索：

```
原始查询："对比胶东调水和南水北调中线的冰期调度策略差异"

分解为：
子查询1："胶东调水工程冰期调度策略"
子查询2："南水北调中线冰期调度策略"
子查询3："调水工程冰期调度对比"
```

每个子查询独立检索，结果合并后由LLM综合对比分析。

### 5.6.3 对话上下文管理

在多轮对话中，用户的查询往往依赖于前几轮的上下文：

```
轮次1：用户："胶东调水工程有多少座闸门？"
轮次2：用户："其中哪些在冰期需要特别关注？"
轮次3：用户："3号闸门的冰期操作有什么特殊要求？"
```

轮次2和轮次3的查询是不完整的——脱离上下文无法理解。需要将对话历史融入当前查询：

```
轮次2改写后："胶东调水工程中哪些闸门在冰期需要特别关注？"
轮次3改写后："胶东调水工程3号闸门的冰期操作有什么特殊要求？"
```

对话上下文的改写可以使用LLM完成，通过简单的提示即可实现：

```
给定对话历史和最新问题，请将最新问题改写为一个独立的、自包含的查询。
对话历史: [...]
最新问题: "其中哪些在冰期需要特别关注？"
改写结果:
```

---

## 上下文构建与提示工程

检索完成后，需要将检索结果组织为结构化的上下文，与用户查询一起输入LLM。上下文构建的质量直接影响LLM生成回答的准确性和可用性。

### 5.7.1 上下文窗口预算分配

LLM的上下文窗口是有限的资源，需要合理分配：

| 组成部分 | 建议Token预算 | 说明 |
|---------|-------------|------|
| 系统提示 | 500-1000 | 角色定义、行为规范 |
| 检索结果 | 3000-6000 | 核心知识来源 |
| 对话历史 | 1000-3000 | 最近3-5轮对话 |
| 用户查询 | 100-500 | 当前问题 |
| 生成预留 | 1000-2000 | 给模型回答留出空间 |
| **合计** | **6000-12000** | **典型总预算** |

在32K窗口的模型上，这个预算还有较大余量，可以根据需要增加检索结果的数量。

### 5.7.2 检索结果的组织

检索到的文档片段需要按以下原则组织：

**原则一：相关性排序**——最相关的文档放在最前面。研究表明，LLM对上下文开头和结尾的内容关注度最高（"Lost in the Middle"现象，Liu et al., 2024），因此最关键的信息应放在上下文的开头。

**原则二：来源标注**——每个文档片段标注其来源信息，便于LLM在回答中引用。

```
[文档1] 来源：胶东调水调度规程 第4.1.3条
应急泄洪操作流程：(1)确认上游来水量超过设计流量120%...

[文档2] 来源：2024年冰期调度总结报告 第3节
2024年冬季冰期共计68天，期间3号闸门累计调节127次...

[文档3] 来源：知识图谱查询结果
3号节制闸参数：设计流量50m³/s，最大开度1.5m，当前状态：正常运行
```

**原则三：去冗余**——如果多个检索结果包含高度重复的内容，只保留最完整/最权威的那个，避免浪费上下文窗口。

**原则四：矛盾标注**——如果检索结果之间存在矛盾信息（如不同年份的规程对同一参数的规定不同），应明确标注，让LLM在回答中处理这种矛盾。

### 5.7.3 RAG提示模板设计

水利领域RAG系统的提示模板：

```
<|system|>
你是水利工程智能助手，基于提供的参考资料回答问题。
规则：
1. 仅基于参考资料回答，不使用未提供的信息
2. 如果参考资料不足以回答问题，明确告知并说明需要哪些补充信息
3. 在回答中标注信息来源（如"根据调度规程第X.X.X条"）
4. 对涉及安全的问题，优先引用安全相关的规程条款
5. 如果参考资料中存在矛盾，指出矛盾并建议以最新/最权威的为准
6. 数值信息必须与参考资料完全一致，不可近似或推算
<|/system|>

<|context|>
{按相关性排序的检索结果，含来源标注}
<|/context|>

<|user|>
{用户查询（经过改写后的完整查询）}
<|/user|>
```

### 5.7.4 忠实性保障

RAG系统中一个关键挑战是**忠实性（Faithfulness）**——LLM是否忠实地基于检索结果回答，而不是"自行发挥"。研究表明，即使提供了明确的参考资料，LLM仍然可能忽略参考资料而使用自身的参数化知识，尤其是当参考资料中的信息与模型内部知识矛盾时。

**忠实性保障策略**：

1. **系统提示强化**：在系统提示中反复强调"仅基于参考资料回答"的要求
2. **引用强制**：要求模型在回答的每个关键声明后标注来源编号
3. **忠实性检测**：使用NLI（自然语言推理）模型检测生成回答与参考资料之间的蕴含关系
4. **自我检验**：让模型在生成回答后自问："我的回答中每个事实性声明是否都有参考资料支持？"

对于水利领域，忠实性尤为重要。如果模型声称"根据调度规程第4.1.3条"但实际引用了错误的条款内容，后果可能比不引用更严重（因为它制造了虚假的权威感）。

---

## 高级RAG技术

基础RAG架构在许多场景下已经够用，但对于复杂的水利领域查询，可以引入以下高级技术进一步提升性能。

### 5.8.1 自适应检索（Adaptive Retrieval）

并非所有查询都需要检索。对于通用知识问题（如"什么是Manning公式？"），模型的内部知识可能已经足够准确。不必要的检索不仅增加延迟，还可能引入噪声。

自适应检索的思路是：让模型先判断是否需要检索，只在需要时才触发检索流程。

```
判断规则：
- 涉及具体工程参数/设备状态 → 必须检索
- 涉及规程条款引用 → 必须检索
- 涉及实时数据 → 必须检索（且需查询SCADA接口）
- 通用概念解释 → 可选检索（模型自信度高时跳过）
- 计算方法说明 → 可选检索
```

### 5.8.2 迭代检索（Iterative Retrieval）

对于复杂问题，单轮检索可能无法获取所有必要信息。迭代检索允许模型在生成过程中发现知识缺口时，主动触发额外的检索。

```
轮次1检索：用户问"对比两种冰期防护方案的成本效益"
→ 检索到方案A的技术描述和方案B的技术描述
→ 模型发现缺少成本数据
轮次2检索：模型自动生成"冰期防护方案成本数据"的检索查询
→ 检索到成本对比报告
→ 模型综合两轮检索结果生成完整的对比分析
```

迭代检索的实现需要模型具备"自我反思"能力——能够判断当前信息是否充分，并在不充分时主动请求更多信息。这可以通过在指令微调阶段加入"信息不足时请求补充"的训练数据来实现。

### 5.8.3 知识图谱增强RAG（GraphRAG）

第三章构建的知识图谱可以从两个层面增强RAG系统：

**层面一：检索增强**

知识图谱作为第三条检索通道（如5.5.3节所述），提供精确的结构化查询结果。这些结果可以与向量检索和BM25检索的结果融合。

**层面二：上下文增强**

利用知识图谱的图结构提供额外的上下文信息。例如，当用户查询涉及某个闸门时，知识图谱可以自动补充该闸门的上下游关系、所属渠段、历史故障记录等关联信息，丰富LLM的决策上下文。

```
用户查询："3号节制闸水位异常升高，怎么处理？"

知识图谱增强的上下文：
- 3号节制闸上游直接连接渠段：渠段A-7（长度2.3km）
- 3号节制闸下游直接连接：4号节制闸（距离3.1km）
- 3号节制闸关联退水闸：退水闸-3（可用于紧急泄水）
- 3号节制闸历史故障：2023年6月曾发生水位传感器漂移
- 当前工况标签：非冰期、正常输水
```

这些结构化的关联信息可以帮助LLM给出更全面、更有针对性的回答。

**层面三：推理增强**

利用知识图谱的推理能力进行多跳推理。例如，查询"如果3号闸门关闭，哪些下游用户会受到影响？"可以通过知识图谱的路径遍历得到精确答案，而纯文本检索可能无法可靠地回答这类结构化关系查询。

### 5.8.4 多模态RAG

水利领域的知识不仅存在于文本中，还存在于工程图纸、系统架构图、SCADA界面截图和监控照片中。多模态RAG将视觉信息纳入检索和理解范围。

当前多模态RAG的典型做法是：

1. 使用视觉语言模型（如GPT-4V、Qwen-VL）为图片生成文本描述
2. 将文本描述作为普通文档索引
3. 检索时通过文本描述间接匹配图片

[TODO: 多模态RAG在水利领域的成熟度仍有限，本节仅做前瞻性介绍，成熟方案待后续版本补充]

---

## 工程案例：胶东调水智能问答系统

本节以胶东调水工程为例，展示完整的RAG系统设计与实施过程。

### 5.9.1 需求分析

胶东调水工程调度中心希望建设一个智能问答系统，满足以下需求：

1. **规程查询**：调度员可以用自然语言查询调度规程的具体条款
2. **设备状态查询**：查询闸门、泵站等设备的当前参数和历史记录
3. **工况分析**：根据当前运行数据分析工况状态并给出建议
4. **历史案例检索**：查找与当前情况相似的历史处置案例
5. **知识问答**：回答水利专业知识问题

### 5.9.2 知识库构建

| 知识源 | 文档数量 | 分块策略 | Chunk数量 | 更新频率 |
|--------|---------|---------|----------|---------|
| 调度规程（现行版） | 3份 | 条款分块 | ~2,000 | 年度修订 |
| 技术标准 | 12份 | 节+条款分块 | ~5,000 | 不定期 |
| 设备台账 | 1份 | 设备为单位 | ~500 | 季度更新 |
| 历史调度总结 | 10份 | 段落+事件分块 | ~3,000 | 年度新增 |
| 运行日志（近3年） | ~1000天 | 事件分块 | ~15,000 | 每日新增 |
| 知识图谱 | 1个 | — | ~30,000三元组 | 持续维护 |
| **合计** | | | **~25,500 chunks** | |

### 5.9.3 系统架构

```
调度员查询
    ↓
[查询理解模块]
├─ 意图分类（规程/设备/工况/案例/知识）
├─ 实体提取（闸门名称、工况类型等）
├─ 对话上下文融合
└─ 查询改写
    ↓
[混合检索模块]
├─ 语义检索 → Qdrant (bge-m3嵌入)
├─ 关键词检索 → Elasticsearch (BM25+自定义分词)
├─ 知识图谱检索 → Neo4j (Cypher查询)
└─ 实时数据查询 → SCADA API（当涉及当前状态时）
    ↓
[结果融合与重排]
├─ RRF融合
├─ Cross-Encoder重排 (bge-reranker-v2-m3)
└─ Top-5结果输出
    ↓
[上下文构建]
├─ 检索结果组织（含来源标注）
├─ 关联信息补充（知识图谱上下文）
└─ 系统提示拼接
    ↓
[LLM生成] → 瀚铎水网大模型（ch04训练的领域LLM）
    ↓
[后处理]
├─ 忠实性检查
├─ 安全合规检查
├─ 来源引用格式化
└─ 回答输出（含引用链接）
```

### 5.9.4 典型交互示例

**示例一：规程查询**

```
调度员：上游来水超过设计流量120%时应该怎么办？

[系统处理]
意图：规程查询
实体：设计流量、120%
检索：BM25命中"第4.1.1条"(score=18.5)，向量检索命中"应急泄洪预案"(score=0.89)
重排后Top-1：第4.1.1条

回答：根据调度规程第4.1.1条，当上游来水超过设计流量120%时，应启动一级应急响应。
具体操作流程如下：
1. 立即关闭所有分水闸至零开度（规程第4.1.2条）
2. 按从下游到上游的顺序逐步开启退水闸（规程第4.1.3条）
3. 通知下游河道管理单位做好防洪准备
4. 全过程应在安全包络约束范围内执行

[来源] 胶东调水调度规程 第四章第一节 第4.1.1-4.1.3条
```

**示例二：设备状态+工况综合查询**

```
调度员：现在是冰期，3号闸门能不能开大一些？

[系统处理]
意图：工况分析+设备参数
实体：冰期、3号闸门
知识图谱查询：3号闸门当前最大允许开度=1.0m（冰期限制）
SCADA查询：3号闸门当前开度=0.7m
规程检索：冰期操作条款
重排后融合结果

回答：当前处于冰期工况，3号节制闸受冰期限制，最大允许开度为1.0m
（非冰期为1.5m）。当前实际开度为0.7m，理论上还有0.3m的调节裕度。

但请注意以下冰期安全约束（规程第6.2.3条）：
- 调节速率不超过0.05m/min，避免冰盖扰动
- 调节后需观察上下游冰情变化至少30分钟
- 如发现冰塞迹象，应立即停止调节并报告

建议：可以适度增开，但建议每次调节不超过0.1m，并密切关注冰情。

[来源] 设备台账-3号节制闸、调度规程第6.2.3条、SCADA实时数据
```

### 5.9.5 性能评估

[TODO: 需补充胶东调水智能问答系统的实际测试数据]

初步设计的评估方案：

| 指标 | 目标值 | 评估方法 |
|------|--------|---------|
| 检索命中率（Top-5） | ≥90% | 100条标注查询 |
| 回答准确率 | ≥85% | 专家盲审 |
| 忠实性（无幻觉率） | ≥95% | NLI检测+人工抽检 |
| 平均响应时间 | ≤5秒 | 端到端计时 |
| 调度员满意度 | ≥4.0/5.0 | 问卷调查 |

---

## RAG系统的常见问题与优化

### 5.10.1 典型故障模式

**故障模式一：检索失败——正确文档未被检索到**

原因分析：
- 查询与文档的表述差异大（同义异形）→ 优化嵌入模型或添加同义词
- 分块不当导致关键信息与查询匹配部分被切分到不同chunk → 调整分块策略
- 向量数据库索引配置不当 → 检查ef_search等参数

**故障模式二：检索污染——检索到大量不相关文档**

原因分析：
- 查询过于宽泛 → 引入查询细化机制
- 嵌入模型对领域术语区分度不足 → 领域适配微调
- BM25对高频词权重过高 → 调整停用词表和IDF平滑

**故障模式三：生成幻觉——LLM忽略检索结果自行编造**

原因分析：
- 检索结果与查询不够相关，LLM"放弃"使用 → 提升检索质量
- 系统提示中忠实性约束不够强 → 强化忠实性提示
- 模型本身的幻觉倾向 → 补充对齐训练数据

**故障模式四：过度依赖——LLM拒绝回答检索结果未覆盖的简单问题**

原因分析：
- 系统提示过于严格（"仅基于参考资料回答"） → 分级处理策略
- 检索结果为空时模型不知如何处理 → 训练空检索场景

### 5.10.2 持续优化方法

**方法一：检索失败案例库**

建立检索失败案例库，记录每一次用户报告"回答不准确"的案例。定期分析失败原因分布，针对性优化。

**方法二：A/B测试框架**

在调整检索策略（如更换嵌入模型、调整分块大小、修改融合权重）时，使用A/B测试评估变更效果。框架应支持将同一查询同时路由到两个版本的系统，对比结果质量。

**方法三：自动化评估流水线**

建立每日运行的自动化评估流水线：在固定的评估集上运行RAG系统，统计检索命中率、回答准确率和忠实性指标。当指标出现显著下降时自动告警。

---

## 本章小结

本章系统论述了检索增强生成（RAG）技术在水利领域的应用，主要内容包括：

1. **RAG的必要性**：分析了纯LLM面临的知识时效、知识精确和知识可追溯三重困境，阐述了RAG如何通过"外部知识+实时检索"的方式同时解决这三个问题。

2. **RAG系统架构**：设计了包含离线索引构建和在线查询服务两条流水线的完整架构，并分析了水利领域的四个特殊设计需求：多源异构知识融合、安全分级检索、数值精确性保障和实时数据集成。

3. **文档分块策略**：针对水利领域四类文档（调度规程、学术文献、工程报告、运行日志）设计了差异化的分块方案，其中以条款为单位的规程分块和以事件为单位的日志分块是水利领域的特色方案。

4. **向量嵌入与语义检索**：推荐了bge-m3作为首选嵌入模型，讨论了对比学习微调和指令化嵌入两种领域适配方法，并给出了向量数据库选型和配置建议。

5. **混合检索策略**：提出了语义检索+BM25+知识图谱检索的三路融合架构，使用RRF进行结果融合和Cross-Encoder进行重排，并给出了按查询类型自适应调整权重的策略。

6. **查询理解与改写**：设计了意图分类、实体提取、同义词扩展、HyDE和多步查询分解等查询优化方法，以及多轮对话上下文管理方案。

7. **上下文构建与忠实性保障**：提出了上下文窗口预算分配方案、检索结果组织原则和RAG提示模板，特别讨论了忠实性保障的四种策略。

8. **高级RAG技术**：介绍了自适应检索、迭代检索、GraphRAG和多模态RAG四种进阶方法，其中GraphRAG作为第三章知识图谱与RAG的深度集成方案具有特别重要的应用价值。

9. **工程案例**：以胶东调水工程为例，展示了从需求分析、知识库构建到系统架构设计的完整实施过程，并给出了两个典型交互示例。

---

## 习题

### 基础题

**5-1.** 解释RAG解决LLM"知识三困境"（时效、精确、可追溯）的原理。如果不使用RAG，还有什么替代方案？各方案的优缺点是什么？

**5-2.** 对于以下三种查询，分别说明最适合的检索方式（语义检索/BM25/知识图谱检索）及理由：
  - "调度规程第3.2.1条的内容"
  - "遇到类似暴雨情况应如何调度"
  - "3号闸门的上游是哪个设施"

**5-3.** 解释倒数排名融合（RRF）的计算方法。给定以下三路检索结果（显示文档排名），计算每个文档的RRF分数（$k=60$），确定最终排序：
  - 语义检索：D3(1), D1(2), D5(3)
  - BM25检索：D1(1), D3(2), D2(3)
  - 知识图谱检索：D2(1), D3(2)

### 应用题

**5-4.** 给定以下调度规程片段，设计分块方案（包括chunk边界、元数据提取和重叠处理）：

> "第六章 冰期调度
>   第一节 一般规定
>     第6.1.1条 冰期定义为每年11月15日至次年3月15日。当连续3天日最低气温低于-5℃时，可提前进入冰期调度模式。
>     第6.1.2条 冰期输水流速不得超过0.8m/s。当实测流速超过0.7m/s时应发出预警。
>   第二节 冰情监测
>     第6.2.1条 冰期期间应在以下位置设置冰情观测点：（1）所有节制闸上下游各100m处；（2）弯道段外侧...
>     第6.2.2条 冰情观测频率：正常情况每4小时一次，气温骤降时每2小时一次，发现冰塞迹象时每30分钟一次。"

**5-5.** 设计一个水利领域的HyDE实验方案：选择5个不同类型的水利查询，人工编写每个查询的"假设性回答"，然后分别使用原始查询和假设性回答进行向量检索，对比Top-5的检索命中率。

### 思考题

**5-6.** RAG系统的一个根本假设是"正确信息存在于知识库中"。但在水利工程实践中，可能出现以下情况：（a）规程条款之间存在矛盾；（b）最新的操作经验尚未写入正式文档；（c）某些关键知识仅存在于老师傅的头脑中。针对这三种情况，RAG系统分别应如何应对？这是否暴露了RAG的根本局限性？

---

## 拓展阅读

1. **Lewis, P. et al. (2020).** "Retrieval-Augmented Generation for Knowledge-Intensive NLP Tasks." *NeurIPS 2020*. — RAG的奠基论文，首次将检索与生成统一为端到端的框架。

2. **Gao, L. et al. (2023).** "Precise Zero-Shot Dense Retrieval without Relevance Labels." *ACL 2023*. — 提出HyDE方法，通过假设性文档嵌入显著提升零样本检索效果。

3. **Liu, N.F. et al. (2024).** "Lost in the Middle: How Language Models Use Long Contexts." *TACL*. — 揭示LLM在使用长上下文时的注意力分布偏差，对RAG的上下文组织有重要指导意义。

4. **Gao, Y. et al. (2024).** "Retrieval-Augmented Generation for Large Language Models: A Survey." *arXiv:2312.10997*. — RAG技术的系统综述，覆盖检索、增强、生成三个环节的最新进展。

5. **Edge, D. et al. (2024).** "From Local to Global: A Graph RAG Approach to Query-Focused Summarization." *arXiv:2404.16130*. — 提出GraphRAG方法，将知识图谱深度集成到RAG架构中。

6. **Lei, X. et al. (2025b).** "Architecture of Autonomous Intelligent Water Networks." *南水北调与水利科技*, DOI: 10.13476/j.cnki.nsbdqk.2025.0079. — 描述了认知AI引擎的整体架构，RAG是其核心组件之一。

---

> **下一章预告**：第六章将讨论认知AI引擎的整体设计与实现——如何将第三章的知识图谱、第四章的领域LLM和本章的RAG系统集成为一个统一的认知AI引擎，使其成为CHS框架中"认知增强"原理的技术载体。我们将讨论引擎的模块化架构、API设计、与物理AI引擎的接口以及与HydroOS的集成方案。
