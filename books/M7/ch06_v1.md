<!-- 变更日志
v1 2026-02-16: 初稿
-->

# ch06 控制与优化服务托管

## 6.1 学习目标

完成本章后，读者应能够：

1. 理解 HydroOS 中控制与优化服务托管（Control & Optimization Service Hosting）的目标与边界；
2. 设计 MPC、规则控制、估计器与辅助优化器的统一服务封装规范；
3. 建立算法服务资源隔离策略（CPU/内存/优先级/故障域）；
4. 构建服务版本管理、灰度发布与回滚门禁流程；
5. 给出算法服务超时、异常和漂移场景下的降级策略。

> 本章承接 ch05：任务编排解决了“谁先执行”，本章解决“算法服务如何稳定执行并可演进”。

## 6.2 为什么算法服务必须托管化

若控制算法以“脚本散落”方式运行，常见问题包括：

- 环境依赖不可复现；
- 不同版本并行导致结果不可比；
- 故障影响范围不可控；
- 无法形成统一审计链路。

[物理直觉] 同一水电站不可能把关键机组放在无防护的临时支架上运行；关键算法也必须运行在受管环境中。

[工程解释] 托管化并不限制算法创新，而是给创新提供可验证、安全可控的运行底座。

## 6.3 服务封装标准

建议每个算法服务统一暴露以下接口：

- `init(config, model_ref)`：初始化；
- `infer(state, constraints, horizon)`：执行一次决策；
- `health()`：输出服务健康指标；
- `explain(trace_id)`：输出关键决策解释；
- `shutdown()`：优雅下线。

统一输入输出字段建议：

- 输入：`trace_id`、`oddscope`、`state_vector`、`constraint_set`、`deadline_ms`；
- 输出：`control_action`、`confidence`、`risk_level`、`fallback_hint`、`latency_ms`。

[表6-1: 算法服务封装与I/O契约模板]
{描述: 列包括接口名、输入、输出、超时阈值、失败动作、审计字段。}
{尺寸: 半页}
{颜色方案: 灰度}

## 6.4 资源隔离策略（补齐ch05遗留项）

为补齐 ch05 跟踪项，本章给出算法托管资源隔离策略：

1. **计算隔离**：关键控制服务独占保留核，非关键服务共享核；
2. **内存隔离**：按服务配额限制，防止单服务内存泄漏拖垮全局；
3. **故障隔离**：按服务域划分故障边界，失败不跨域传播；
4. **优先级隔离**：SLA-A 服务优先级高于 SLA-B/C。

建议资源配额策略：

- 控制服务（SLA-A）保留 CPU ≥ 40%；
- 优化服务（SLA-B）弹性 CPU 20–40%；
- 分析服务（SLA-C）余量调度。

[工程解释] 配额不是静态常数，应按 ODD 场景动态调整（如汛期提高控制服务保留配额）。

## 6.5 服务发布与回滚门禁

发布流程建议：

1. 离线回放验证（功能/时延/约束）；
2. 沙箱在环测试（In-the-Loop Testing）；
3. 小流量灰度发布；
4. 观察期门禁判定；
5. 全量发布或自动回滚。

关键门禁条件：

- P95 推理时延不劣于基线 10% 以上；
- 约束违背率不高于基线；
- 红色告警触发率不升高。

[图6-1: 算法服务灰度发布与回滚流程]
{描述: 展示发布前验证、灰度观测、门禁判定、回滚与审计归档路径。}
{尺寸: 全页}
{颜色方案: 蓝色系}

## 6.6 托管时序门禁

算法服务在控制周期内需满足：

$$
\tau_{load}+\tau_{infer}+\tau_{verify}+\tau_{commit}\le T_c
$$

其中：

- $\tau_{load}$：模型与参数装载时延；
- $\tau_{infer}$：推理/求解时延；
- $\tau_{verify}$：约束与风险校验时延；
- $\tau_{commit}$：动作提交时延。

[物理直觉] 决策再优，若提交晚于动作窗口，就等于无效决策。

## 6.7 可复现实例：MPC服务超时降级

【例6-1】某站点 MPC 服务在晚高峰期间负载上升，`infer` P95 从 420 ms 升至 760 ms，控制周期 $T_c=1$ s。

**已知**：

- `\tau_{load}=80` ms，`\tau_{verify}=90` ms，`\tau_{commit}=70` ms；
- 超时阈值：总时延 > 950 ms 触发橙色告警；
- 连续3次橙色告警触发回退到规则控制服务。

**求解**：判断是否触发降级并给出处置流程。

**解题过程**：

1. 当前总时延：$80+760+90+70=1000$ ms，超过阈值；
2. 立即触发橙色告警并切换轻量参数组；
3. 若连续3周期仍超阈值，回退到规则控制并保留 MPC 建议输出供人工参考；
4. 记录 `trace_id`、版本号、回退原因并进入复盘队列。

**结果讨论**：
该机制保证“先连续可控，再恢复最优”，避免因单服务性能退化引发控制链路失效。

## 6.8 本章小结

本章建立了 HydroOS 中算法服务的工程化托管框架：通过统一封装契约、资源隔离、发布回滚门禁与时序预算，实现控制与优化算法的稳定运行与可演进。下一章将进入安全门禁与审计系统，讨论如何把策略执行全过程转化为可问责、可复盘的治理链路。

## 习题

### 基础题

1. 为什么算法服务托管化是 HydroOS 的必要条件？
2. 资源隔离策略中“故障隔离”解决了什么问题？
3. 解释托管时序门禁公式各项时延的意义。

### 应用题

4. 为一个双机房部署场景设计算法服务资源配额方案，包含SLA-A/B/C三类服务。  
5. 设计一份算法灰度发布门禁表，至少包含时延、约束违背率、告警触发率三项指标。

### 思考题

6. 当新模型精度更高但时延略高时，你会如何设置发布准入与审批策略？

### 基础题参考答案要点

1. 托管化可保证环境一致、版本可控、故障可隔离与审计可追溯。  
2. 防止单个服务崩溃扩散到全局控制链路。  
3. 分别对应装载、推理、校验、提交时延，总和必须受控制周期约束。

## 拓展阅读

1. Burns, B. et al. (2022). *Kubernetes: Up and Running*.  
2. Rawlings, J.B., Mayne, D.Q. & Diehl, M. (2017). *Model Predictive Control: Theory, Computation, and Design*.  
3. Kleppmann, M. (2017). *Designing Data-Intensive Applications*.  
4. Lei et al. (2025b). 自主智能水网架构。  
5. Lei et al. (2025c). 在环测试系统。

> **术语一致性声明**：本章统一采用“水网操作系统（Water Network Operating System, HydroOS）”“运行设计域（Operational Design Domain, ODD）”“安全包络（Safety Envelope）”“模型预测控制（Model Predictive Control, MPC）”“在环测试（In-the-Loop Testing）”等规范术语；数学符号采用 $Q,h,\tau,T_p,T_c,\mathbf{x},\mathbf{u},\mathbf{y},J$。

### 质量检查清单（执行结果）

- [x] 章首学习目标、章末小结/习题/拓展阅读完整；
- [x] 基础题3 + 应用题2 + 思考题1，含基础题答案要点；
- [x] 公式前有物理直觉，公式后有工程解释；
- [x] 含可复现实例（例6-1）；
- [x] 图表不少于2项（图6-1、表6-1）；
- [x] 章首回顾ch05，章末预告ch07。
