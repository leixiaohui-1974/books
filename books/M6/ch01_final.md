<!-- 变更日志
v1 2026-02-19: 初稿
-->

# 第一章 绪论：为什么需要在环验证

---

## 学习目标

完成本章后，读者应能够：

1. 阐述验证与确认（V&V）的基本概念体系，区分验证（Verification）与确认（Validation）的定义差异及其在水利控制系统中的具体含义；
2. 分析水利控制系统在安全性、实时性和环境不确定性方面的特殊性，理解这些特殊性为何使得在环验证成为不可替代的质量保障手段；
3. 概述MIL（模型在环）、SIL（软件在环）、HIL（硬件在环）三级在环测试框架的基本概念和递进逻辑；
4. 理解在环验证在水系统控制论（CHS）体系中的定位，以及它与安全包络、HydroOS、水网自主等级（WNAL）等核心概念的关系；
5. 描述本书的结构安排和各章之间的逻辑关系，为后续深入学习建立全局认知。

---

## 1.1 一个真实的教训：从"仿真通过"到"现场失控"

2019年秋季，中国北方某调水工程启用了一套新的自动化闸门控制策略。该策略在开发团队的仿真环境中表现优异——在所有预设场景下，水位跟踪误差均小于设计指标的50%，闸门响应时间满足规范要求，节水效率提升了12%。开发团队满怀信心地将策略部署到现场SCADA系统。

然而，上线运行的第三周，一个未曾预料的工况出现了。上游来水在6小时内骤增了40%——这一幅度虽未达到设计洪水标准，但远超仿真测试中使用的"来水变化"场景范围（仿真中的最大变化幅度为25%）。控制策略在应对这一超出预期的扰动时出现了振荡：闸门在开启和关闭之间反复摆动，导致下游水位在30分钟内波动了1.2米——远超安全允许范围的0.3米。

值班调度员迅速发现异常并切换到手动模式，避免了更严重的后果。事后分析揭示了问题的根源：控制策略中的积分环节在大偏差条件下发生了积分饱和（integral windup），而仿真环境中使用的执行器模型过于理想化——真实闸门的响应存在0.8秒的纯延迟和3%的位置死区，仿真模型中只建模了0.3秒延迟且忽略了死区。在正常工况下，这些差异可以忽略；但在大偏差快速调节场景下，模型与实际的偏差被控制回路放大，最终导致了振荡。

这个事件不是孤例。它揭示了水利控制系统开发中一个普遍而深刻的问题：**仿真验证的通过并不等于现场运行的安全**。从算法设计到现场部署，存在一条漫长的"信任链"——每一个环节都可能引入与现实世界的偏差，而这些偏差在特定工况下可能被激发和放大。在环验证（In-the-Loop Verification）正是为了系统性地检测和弥合这些偏差而诞生的方法论。

### 1.1.1 "仿真通过"的三个隐含假设

上述事件的技术分析指出了"仿真通过"这一结论背后的三个隐含假设，而这三个假设在实际工程中往往不成立。

**假设一：仿真模型是真实系统的精确映射**。任何仿真模型都是对真实系统的简化。水力学模型忽略了局部湍流、泥沙运移、温度分层等因素；执行器模型忽略了机械磨损、液压油温变化、电气干扰等因素；传感器模型忽略了漂移、噪声非平稳性和故障模式等因素。这些简化在"正常"工况下影响不大，但在极端或边界工况下可能成为系统失稳的触发因素。

**假设二：测试场景覆盖了所有可能的运行工况**。测试人员不可能穷举所有可能的输入组合。水利系统的工况空间是连续的、高维的——来水量、水位、流速、温度、设备状态、通信状态、人员操作等变量的组合构成了一个庞大的工况空间。有限的测试场景只能覆盖这个空间的极小一部分。更危险的是，最容易导致系统失败的往往是那些"出乎意料"的工况组合——正是因为出乎意料，它们才没有被纳入测试。

**假设三：软件实现忠实地翻译了算法设计**。从MATLAB中的控制算法到C语言的嵌入式代码，再到SCADA系统中的执行逻辑，每一次"翻译"都可能引入错误。数值精度的差异（浮点数vs定点数）、实时操作系统的任务调度、通信协议的时延抖动、数据格式的转换——这些看似细微的差异，在闭环控制系统中可能被逐级放大。

在环验证的本质，就是通过分层递进的测试手段，系统性地检验这三个假设是否成立，并在假设不成立时尽早发现问题。

### 1.1.2 水利行业的特殊风险

水利控制系统的在环验证需求比一般工业控制系统更为迫切，这源于水利系统的几项特殊属性。

**不可逆性**。许多水利操作的后果是不可逆的。一旦闸门误开导致过量泄水，已经流出的水无法收回；一旦渠道水位超过堤防安全高度导致溃堤，后果不可挽回。与制造业的质量问题（可以返工或召回）不同，水利运行错误的代价往往是即时的、不可逆的和严重的。

**传播性**。水利系统是一个互联的网络——上游的操作会影响下游数十乃至数百公里范围内的所有节点。一个闸站的控制错误不仅影响本地，还会以水力波的形式向下游传播，可能导致连锁反应。这种传播特性意味着局部的控制错误可能演变为全局性的系统事故。

**时变性**。水利系统的物理特性随时间持续变化——渠道糙率因泥沙淤积和藻类生长而变化，闸门密封因老化而性能退化，传感器因环境腐蚀而精度降低。这意味着即使初始验证通过，系统也可能在运行一段时间后因为参数漂移而偏离设计工作点。

**季节性与极端性**。水利系统需要在极其多样的工况下运行——从枯水期的低流量精细调节到汛期的大流量安全泄洪，从正常运行到冰期特殊工况，跨度巨大。极端工况（如百年一遇洪水、极端低温冰凌、多设备同时故障）发生频率低但后果严重，而这些极端工况恰恰是最难在现场测试中复现的。

这些特殊性共同指向一个结论：水利控制系统的质量保障不能仅依赖离线仿真和有限的现场试验，必须借助系统化的在环验证方法，在受控环境中尽可能逼真地模拟各种工况，包括那些在现场不安全或不可能复现的极端场景。

---

## 1.2 验证与确认（V&V）概念体系

### 1.2.1 V&V的定义与区分

验证与确认（Verification and Validation, V&V）是系统工程中确保系统质量的两个核心活动，它们回答的问题不同。

**验证（Verification）**回答的问题是："我们是否正确地构建了系统？"（Are we building the system right?）。验证关注的是开发过程的正确性——设计是否忠实地实现了需求规格，代码是否忠实地实现了设计，每一步转换是否引入了错误。验证是一个内向（inward-looking）的过程，它以系统的规格说明为基准，检查每个开发产物是否符合其对应的规格。

**确认（Validation）**回答的问题是："我们是否构建了正确的系统？"（Are we building the right system?）。确认关注的是系统目的的达成——系统是否满足了用户的真实需求，是否能在实际运行环境中完成预期功能。确认是一个外向（outward-looking）的过程，它以用户需求和运行环境为基准，评估系统整体是否适合其预定用途。

在水利控制系统的语境下，验证包括：控制算法的数学正确性验证、软件代码与设计文档的一致性验证、硬件接口与协议规范的一致性验证等。确认包括：控制系统在各种运行工况下的性能确认、调度员操作界面的可用性确认、系统在极端条件下的安全性确认等。

### 1.2.2 V&V在水利控制开发中的V模型

系统工程中广泛使用V模型（V-Model）描述开发与验证的对应关系。在V模型中，左侧是自顶向下的开发过程（需求→系统设计→详细设计→编码），右侧是自底向上的验证过程（单元测试→集成测试→系统测试→验收测试），两侧在同一抽象层次上对应。

在水利控制系统中，V模型可以具体化为以下对应关系：

**表1-1 水利控制系统V模型的开发-验证对应**

| 开发阶段 | 对应产物 | 验证阶段 | 验证手段 |
|---------|---------|---------|---------|
| 运行需求分析 | 调度规程、性能指标 | 验收测试 | 现场运行评估、调度员评价 |
| 系统设计 | 控制架构、接口规范 | 系统测试 | HIL硬件在环测试 |
| 详细设计 | 控制算法、通信协议 | 集成测试 | SIL软件在环测试 |
| 编码实现 | 嵌入式代码、配置文件 | 单元测试 | MIL模型在环测试 |

V模型的核心理念是：验证活动的规划应该在对应的开发活动开始时就同步进行，而不是等开发完成后才考虑如何测试。在水利控制系统中，这意味着在编写调度规程时就应该考虑如何验收；在设计控制架构时就应该规划HIL测试方案；在设计控制算法时就应该准备SIL测试环境。

### 1.2.3 从功能安全标准中借鉴

水利控制系统的V&V可以从其他安全攸关行业的成熟标准中获得借鉴。

**IEC 61508《电气/电子/可编程电子安全相关系统的功能安全》**是功能安全领域的基础标准。它定义了安全完整性等级（Safety Integrity Level, SIL 1-4），并为每个等级规定了从需求分析到运行维护的全生命周期V&V要求。水利控制系统中的安全功能（如水位超限时的自动泄洪、设备故障时的安全停机）可以参照IEC 61508的方法进行安全完整性分析和验证。

**ISO 26262《道路车辆功能安全》**是汽车行业的功能安全标准，其中关于在环测试的方法论尤其值得水利行业借鉴。ISO 26262详细规定了MIL、SIL、HIL三级测试的适用条件、测试方法和覆盖度要求。自动驾驶系统的安全验证与水网自主运行的安全验证有诸多相似之处——两者都需要在复杂、动态、不确定的环境中保证控制系统的安全行为。

**DO-178C《机载系统和设备认证中的软件考虑》**是航空软件的认证标准。它对软件开发过程的严格性要求代表了安全攸关软件验证的最高标准。虽然水利控制软件的认证等级可能不需要达到DO-178C的最高等级（DAL A），但其中关于结构覆盖分析、最坏情况执行时间分析和形式化验证的方法，对水利控制软件的质量保障具有重要参考价值。

需要指出的是，水利行业目前尚未建立专门的功能安全标准体系。现有的水利行业标准（如《水利工程自动化系统设计规范》SL 517-2013）对控制系统的功能和性能提出了要求，但在V&V方法、在环测试和安全完整性方面的规定相对薄弱。建立适合水利行业特点的在环验证标准，是本书希望推动的目标之一。

---

## 1.3 在环验证的核心理念

### 1.3.1 什么是"在环"

"在环"（In-the-Loop）一词源于控制工程中的"闭环"（closed-loop）概念。在闭环控制系统中，被控对象的输出通过反馈回路返回控制器，形成一个封闭的信号环路。"在环测试"的核心思想是：将被测试的组件置于这个闭环之中，让它像在真实运行中一样接收反馈、处理信息、发出控制指令，从而在受控环境中观察和验证其行为。

与"开环测试"相比，在环测试的关键区别在于**动态交互性**。开环测试向被测组件提供预先录制或生成的输入序列，观察其输出是否正确。但在闭环控制系统中，被测组件的输出会影响系统的状态，而系统状态的变化又会改变下一时刻的输入。这种动态交互意味着某些问题（如振荡、不稳定、死锁）只有在闭环条件下才能暴露。

以上文的闸门控制事件为例：积分饱和问题在开环测试中可能不会显现——如果输入序列是预先设定的，控制器的输出不会影响输入，积分项的异常累积不会被反馈回路放大。只有在闭环条件下，控制器输出→闸门动作→水位变化→传感器反馈→控制器输入的完整环路才能暴露积分饱和导致的振荡行为。

### 1.3.2 MIL/SIL/HIL三级递进

在环验证采用三级递进的测试策略，从最抽象（模型级）到最具体（硬件级），逐步增加测试的真实度（fidelity），同时逐步缩小仿真世界与物理世界之间的差距。

**MIL（Model-in-the-Loop，模型在环测试）**是第一级。在MIL中，控制算法以其原始形式（如MATLAB/Simulink模型或Python脚本）与系统仿真模型（水力学模型、设备模型等）在同一仿真环境中闭环运行。MIL的主要目标是验证控制算法本身的正确性——在理想化条件下，算法是否能实现设计意图。MIL的优势是成本低、速度快、修改方便，适合算法开发的快速迭代阶段。MIL的局限是不涉及软件实现和硬件执行的真实性。

**SIL（Software-in-the-Loop，软件在环测试）**是第二级。在SIL中，控制算法被编译为目标平台的可执行代码（如C语言的嵌入式软件），在PC或目标处理器的模拟环境中运行，与仿真模型通过标准通信接口（如OPC-UA、Modbus/TCP）交互。SIL的主要目标是验证软件实现的正确性——代码是否忠实地实现了算法逻辑，通信接口是否按照协议规范工作，实时调度是否满足时序要求。SIL揭示了从算法到软件"翻译"过程中引入的问题，如数值精度差异、字节序错误、缓冲区溢出、时序违规等。

**HIL（Hardware-in-the-Loop，硬件在环测试）**是第三级。在HIL中，控制软件运行在真实的控制器硬件上，通过真实的物理接口（如RS-485、以太网、4-20mA模拟信号）与实时仿真器连接。实时仿真器以硬实时方式模拟水利系统的物理行为，向控制器提供仿真的传感器信号，并接收控制器的输出指令驱动仿真模型。HIL的主要目标是验证硬件集成的正确性——控制器硬件的实时性能、物理接口的信号完整性、电磁兼容性、以及在真实硬件约束下的控制行为。HIL是上线前的最后一道防线，也是最接近真实运行条件的测试环节。

三级测试的递进逻辑可以类比为"先在纸上画好路线（MIL），再在驾驶模拟器上练习（SIL），最后在封闭试车场实际驾驶（HIL）"。每一级都在前一级的基础上增加真实度，也增加测试的成本和复杂度。

**表1-2 MIL/SIL/HIL三级测试对比**

| 维度 | MIL | SIL | HIL |
|------|-----|-----|-----|
| 被测对象 | 算法模型 | 目标代码 | 硬件+软件 |
| 运行环境 | 仿真平台（如MATLAB） | PC/模拟器 | 真实控制器+实时仿真器 |
| 系统模型 | 可简化，非实时 | 较完整，软实时 | 高保真，硬实时 |
| 通信接口 | 内部函数调用 | 标准协议（OPC-UA等） | 物理信号（模拟/数字） |
| 执行速度 | 可加速（100x-1000x） | 接近实时或加速 | 严格实时（1x） |
| 主要发现 | 算法逻辑错误、参数不当 | 软件缺陷、接口错误 | 硬件兼容性、时序问题 |
| 测试成本 | 低 | 中 | 高 |
| 迭代速度 | 快（分钟级） | 中（小时级） | 慢（天级） |
| 典型缺陷发现率 | 60-70%的设计缺陷 | 20-25%的实现缺陷 | 10-15%的集成缺陷 |

### 1.3.3 在环验证的经济学

在环验证需要投入仿真平台建设、测试用例开发、测试执行和结果分析等方面的资源。这些投入是否值得？我们可以从两个角度分析。

**缺陷发现的成本曲线**。系统工程领域的一个经典结论是：缺陷发现和修复的成本随开发阶段呈指数增长。在算法设计阶段发现一个控制逻辑错误，修复成本可能只需要工程师几小时的工作；在软件集成阶段发现同一个错误，可能需要修改代码、重新编译、重新测试，成本增加一个数量级；在现场部署后发现这个错误，可能需要远程调试、现场出差、系统停运，成本再增加一个数量级。更糟糕的是，如果这个错误在运行中导致了事故（如上文的振荡事件），其直接和间接成本（工程损失、应急处置、事故调查、声誉损害）可能比开发阶段的修复成本高出3-4个数量级。

MIL/SIL/HIL三级验证的分层递进策略，正是为了在成本最低的阶段发现最多的缺陷。统计数据表明，一个设计良好的在环验证体系可以在上线前发现90%以上的控制逻辑缺陷和95%以上的软件实现缺陷，将现场事故率降低到可接受的水平。

**安全保障的投资回报**。水利系统事故的经济损失往往是巨大的。一次严重的调度失误可能导致下游农田被淹、城市供水中断或水利设施损坏，直接经济损失可达数百万甚至数千万元。相比之下，一套完整的在环验证体系的建设成本通常在系统总投资的5-10%范围内。从投资回报的角度看，在环验证是一项高回报的"保险投资"。

---

## 1.4 在环验证在CHS体系中的定位

### 1.4.1 CHS八原理中的"在环验证原理"

水系统控制论（Cybernetics of Hydro Systems, CHS）提出了指导水网自主运行的八项基本原理，其中第五条原理——**在环验证原理**——直接奠定了本书的理论基础。

在环验证原理的表述为：水网控制系统的每一项控制策略，在部署到实际工程之前，必须经过MIL→SIL→HIL递进式的在环验证，以可复现、可量化、可审计的方式证明其在运行设计域（ODD）内的安全性和有效性。

这一原理包含三个关键要素：

**递进式验证**。控制策略的质量保障不是一次性的活动，而是一个分阶段、逐级深入的过程。MIL验证算法的正确性，SIL验证软件的一致性，HIL验证硬件集成的可靠性。每一级验证都建立在前一级通过的基础上，形成逐级收窄风险的"漏斗"。

**ODD约束**。验证的范围以运行设计域（Operational Design Domain, ODD）为界。ODD定义了控制策略预期工作的工况范围——包括水文条件、设备状态、通信条件和环境条件的允许范围。验证的目标是证明控制策略在ODD内的行为满足安全和性能要求，同时识别并记录ODD的边界条件。ODD的概念借鉴自M3《水网运行安全包络》中的安全包络理论——安全包络定义了运行参数的合法范围，ODD则更广泛地定义了控制策略的适用条件。

**可审计性**。验证的过程和结果必须留有完整的记录，使得第三方（如安全审查委员会、运行管理部门）可以独立审查验证的充分性。这要求测试用例的设计有据可依、测试过程可复现、测试结果有明确的通过/不通过判据。

### 1.4.2 在环验证与水网自主等级

水网自主等级（Water Network Autonomy Level, WNAL）定义了水网系统从L0（完全人工）到L5（完全自主）的六个等级。不同自主等级对在环验证的要求有显著差异。

在L1-L2级（辅助自动化和部分自主），控制策略相对简单（如定水位PID控制、预设方案的自动执行），在环验证的重点是MIL级别的算法验证和SIL级别的软件正确性验证。HIL验证虽然推荐但不是强制要求，因为人类调度员持续在环，可以作为最终的安全保障。

在L3级（有条件的高度自主），系统在定义的ODD内自主运行，调度员退出实时控制回路。此时，在环验证变得不可或缺——系统必须在所有ODD内工况下证明其安全性，因为调度员不再作为实时的安全兜底。MIL/SIL/HIL三级验证全部成为强制要求，且需要覆盖ODD边界条件和退化模式。

在L4-L5级（高度自主和全自主），在环验证的要求进一步提升。系统需要应对部分超出预定义ODD的场景，这要求验证不仅覆盖已知工况，还需要通过随机化测试和对抗性测试探索未知工况空间。此外，认知AI引擎、多智能体系统等智能组件的引入，使得验证的难度显著增加——这些组件的行为不完全由确定性逻辑决定，传统的覆盖度指标可能不再充分。

**表1-3 不同自主等级的在环验证要求**

| WNAL等级 | MIL要求 | SIL要求 | HIL要求 | 特殊要求 |
|---------|---------|---------|---------|---------|
| L1 辅助自动化 | 推荐 | 推荐 | 可选 | — |
| L2 部分自主 | 必需 | 必需 | 推荐 | 安全联锁验证 |
| L3 有条件高度自主 | 必需 | 必需 | 必需 | ODD全覆盖、退化模式验证 |
| L4 高度自主 | 必需 | 必需 | 必需 | ODD边界探索、对抗性测试 |
| L5 全自主 | 必需 | 必需 | 必需 | 形式化验证、持续监控 |

### 1.4.3 在环验证与HydroOS

HydroOS水网操作系统是CHS体系中所有控制策略的运行载体。从在环验证的角度看，HydroOS提供了三个层面的支持。

**仿真集成接口**。HydroOS的设备抽象层（Hardware Abstraction Layer, HAL）为在环测试提供了天然的"接缝"——在MIL和SIL阶段，HAL之下的物理设备可以被仿真模型替代，而HAL之上的控制逻辑无需修改。这种抽象层的设计使得从仿真到实物的切换变得简洁，降低了在环测试的工程复杂度。

**测试数据管理**。HydroOS的数据管理模块可以记录在环测试过程中的所有输入输出数据，包括传感器读数、控制指令、系统状态和事件日志。这些数据为测试结果的分析和审计提供了完整的信息基础。

**版本管理与回滚**。HydroOS的版本管理机制确保每一个经过在环验证的控制策略版本都有明确的标识，可以在必要时回滚到上一个已验证版本。这在控制策略的迭代升级中尤为重要——新版本在完成全部在环验证之前不会被部署到生产环境。

### 1.4.4 在环验证与安全包络

M3《水网运行安全包络》定义了水网运行参数的安全边界——红区（禁止进入）、黄区（需要警惕）和绿区（正常运行）。安全包络为在环验证提供了两方面的支持。

第一，安全包络为测试用例的设计提供了明确的边界。测试用例不仅需要覆盖绿区（正常工况），还需要系统地探测黄区（临界工况）和红区边界（极端工况）。一个合格的在环验证方案必须证明：在绿区内，控制策略的性能满足指标要求；在黄区内，控制策略能够正确识别风险并采取预防措施；在接近红区时，控制策略能够触发安全联锁并将系统导向最小风险状态（Minimum Risk State, MRS）。

第二，安全包络为测试结果的判定提供了定量准则。在环测试中的每一条轨迹都可以在安全包络的坐标系中标注——如果轨迹始终停留在绿区和黄区内，且在预期条件下不进入红区，则视为通过；如果轨迹意外进入红区，则标记为严重缺陷，必须在修复后重新测试。

---

## 1.5 水利在环验证的发展历程与现状

### 1.5.1 国际发展脉络

水利控制系统在环验证的发展可以追溯到20世纪90年代，但其系统化和标准化进程远落后于航空、汽车和核电等行业。

**萌芽阶段（1990年代）**。早期的水利自动化控制主要依赖PID和简单的规则逻辑，验证方法以人工审查和现场调试为主。Buyalski等人在1991年发表的美国垦务局水渠自动化手册中，首次提出了控制策略在部署前应进行"离线仿真验证"的建议，但尚未形成系统化的在环测试方法。

**探索阶段（2000-2010年）**。随着模型预测控制（MPC）等先进控制算法在水利领域的应用，算法复杂度的增加使得简单的离线仿真不再充分。荷兰代尔夫特理工大学的van Overloop在其2006年的博士论文中，首次将MIL概念引入水渠控制领域——他使用MATLAB/Simulink构建了水渠的水力学模型，并将MPC控制器与之闭环连接进行验证。这可以被视为水利领域MIL测试的开端。

法国INRAE（原IRSTEA）的Malaterre等人在同一时期开展了SIC（Simulation of Irrigation Canals）仿真平台的开发，为水渠控制的仿真验证提供了重要的工具支持。SIC平台允许用户将自定义的控制算法与水力学模型闭环运行，虽然当时尚未使用"SIL"术语，但其功能本质上已经实现了软件在环测试的核心理念。

**发展阶段（2010-2020年）**。这一时期的标志性进展包括：澳大利亚墨尔本大学的Weyer等人将工业控制系统的HIL测试方法引入灌溉渠道控制，利用实时仿真器验证可编程逻辑控制器（PLC）的控制行为；美国Caltrans的运河自动化项目中，采用了完整的MIL→SIL→HIL验证流程，成为水利领域在环验证的早期标杆案例。

**深化阶段（2020年至今）**。随着水网自主运行概念的提出和AI技术在水利控制中的应用，在环验证面临新的挑战。传统的MIL/SIL/HIL框架主要面向确定性控制算法，而AI驱动的控制策略（如基于强化学习的调度优化、基于LLM的认知辅助）的行为具有统计性和上下文依赖性，传统的覆盖度指标和通过准则需要扩展。这也是本书将要深入探讨的前沿问题。

### 1.5.2 中国水利行业的现状

中国水利行业的在环验证实践总体处于起步阶段，但在近年来取得了显著进展。

在政策层面，《水利部关于加快推进水利工程自动化建设的指导意见》明确提出了"先仿真验证、后现场部署"的原则，为在环验证的推广提供了政策依据。但相关的技术标准和规范仍在制定过程中。

在技术层面，南水北调工程、胶东调水工程、引江济淮工程等重大水利项目已经开始实施不同程度的在环验证。其中，Lei等人（2025c）提出的水网控制在环测试系统框架，首次将MIL/SIL/HIL三级验证体系系统化应用于中国的大型调水工程，为本书的工程案例（第九章）提供了实践基础。

在平台层面，HydroOS水网操作系统集成了仿真验证功能模块，使得MIL和SIL测试可以在统一的软件环境中完成。基于dSPACE和NI PXI平台的HIL测试系统已在实验室中搭建完成，并在胶东调水工程中完成了首次工程级验证。

然而，与航空和汽车行业相比，中国水利行业在以下方面仍有明显差距：在环测试的标准化程度不足，不同项目之间缺乏统一的测试规范和判定标准；测试用例的系统性和完整性有待提升，目前的测试主要集中在正常工况，对极端工况和退化模式的覆盖不足；HIL测试的工程化水平较低，实时仿真器和物理接口的成本仍然较高；以及AI组件的验证方法尚处于探索阶段。

### 1.5.3 与国际同行的对比

**表1-4 水利在环验证的国际对比（2026年）**

| 维度 | 中国 | 荷兰/法国 | 澳大利亚 | 美国 |
|------|------|----------|---------|------|
| MIL应用程度 | 中（大型项目） | 高（学术+工业） | 高（灌溉系统） | 高（运河系统） |
| SIL应用程度 | 低-中 | 中 | 中 | 中 |
| HIL应用程度 | 低（起步） | 低-中 | 中 | 中 |
| 标准化程度 | 制定中 | 部分标准化 | 行业指南 | 项目级规范 |
| AI组件验证 | 探索中 | 探索中 | 有限 | 有限 |
| 仿真平台 | HydroOS/自研 | SIC/Sobek | OASIS | HEC系列/定制 |
| 代表性项目 | 南水北调/胶东调水 | 马士基渠运河 | MIL渠道自动化 | Caltrans运河 |

从表中可以看出，中国在MIL层面已经达到国际先进水平，在SIL和HIL层面正在快速追赶，在AI组件验证方面则与国际同行处于同一起跑线上。本书的目标之一是为中国水利行业的在环验证实践提供系统化的理论指导和方法论参考。

---

## 1.6 本书的范围与结构

### 1.6.1 本书的定位与读者

本书是CHS教材体系16本书中的专著之一，编号M6，聚焦于水网控制系统的在环验证理论与实践。

本书的定位是一部**面向实践的系统性专著**。"系统性"意味着它不是零散的经验总结，而是从理论框架到工程方法到实践案例的完整知识体系；"面向实践"意味着它不停留在理论层面，而是为读者提供可操作的方法、工具和案例参考。

本书的预期读者包括三类人群：从事水利自动化控制系统开发的工程师和研究人员——他们需要理解在环验证的方法论以提升开发质量；水利工程运行管理人员——他们需要理解在环验证的意义以制定合理的验收标准；以及水利工程和控制工程方向的研究生——他们需要掌握在环验证的理论和技术以开展相关研究。

### 1.6.2 各章内容概览

全书共十章，按照"基础→方法→实践→展望"的逻辑组织。

**基础篇（第一至三章）**建立在环验证的理论基础和仿真环境。第一章（本章）阐明在环验证的动机、概念体系和CHS定位。第二章深入数字孪生与仿真环境的构建，包括数字孪生的概念架构、离线/实时/超实时仿真的区分、FMI/FMU封装标准和联合仿真框架。第三章聚焦水力学模型的封装与接口标准，包括Saint-Venant方程的仿真封装、降阶模型的集成、多模型耦合与切换策略、以及模型参数同化方法。

**方法篇（第四至八章）**系统阐述MIL/SIL/HIL三级测试方法和支撑技术。第四章详述MIL模型在环测试，包括MIL架构、场景设计、参数敏感性分析和蒙特卡洛测试方法。第五章详述SIL软件在环测试，包括嵌入式软件栈验证、接口契约测试、时序一致性验证和异常注入技术。第六章详述HIL硬件在环测试，包括实时仿真器架构、SCADA闭环测试、执行器响应验证和安全联锁验证。第七章讨论测试用例的系统化设计方法，包括ODD驱动的场景矩阵、用例分级体系和自动化测试框架。第八章建立覆盖度度量和质量门禁体系，包括场景覆盖率指标、风险覆盖率指标、缺陷分级与回归机制、以及版本发布的门禁流程。

**实践篇（第九章）**以胶东调水工程为完整案例，展示MIL→SIL→HIL全流程在实际工程中的应用。从仿真平台搭建到测试用例库建设，从缺陷发现与修复到验证报告编制，从上线许可评审到运行时持续监控，提供一个端到端的工程参考。

**展望篇（第十章）**总结全书核心内容，讨论形式化验证、数字孪生驱动的持续验证、AI组件验证等前沿方向，展望水利V&V标准化的发展路径。

### 1.6.3 与CHS体系其他著作的关系

本书与CHS教材体系中的其他著作存在密切的交叉引用关系。

M1《明渠水动力降阶建模》为本书第三章（水力学模型封装）提供了降阶模型的理论基础。在环测试中使用的仿真模型通常需要在精度和速度之间权衡——全维Saint-Venant模型精度高但计算慢，降阶模型速度快但精度受限。M1讨论了多种降阶方法的适用条件和精度特性，是选择仿真模型时的重要参考。

M2《水网预测控制》为本书第四章（MIL测试）提供了典型的被测算法。MPC控制器是当前水网控制中最常用的先进控制算法之一，其在环验证需要考虑预测模型精度、优化求解时间和滚动时域长度等特殊因素。

M3《水网运行安全包络》为本书第七章（测试用例设计）和第八章（覆盖度度量）提供了安全边界的定义。安全包络的红/黄/绿三区间直接用于测试用例的场景分类和测试结果的通过判定。

M4《水网多智能体系统》为本书第五、六章（SIL/HIL测试）提供了分布式系统测试的参考。多智能体系统的在环验证涉及智能体间的通信协议、协调机制和一致性问题，比单体控制系统的验证更为复杂。

M5《水利认知智能》为本书的前沿展望（第十章）提供了AI组件验证的背景。认知AI引擎的在环验证是一个全新的挑战——如何验证一个基于大语言模型的系统的行为正确性和安全性，是当前学术界和工业界都在探索的前沿问题。

M7《HydroOS设计与实现》为本书的仿真环境（第二章）和测试框架（第七章）提供了平台支撑。HydroOS的设备抽象层、数据管理和版本控制功能是在环测试体系运行的基础设施。

M8《水利工程自主运行实践》为本书第九章（工程案例）提供了工程背景。胶东调水和沙坪水电站的自主运行实践是在环验证的直接应用场景。

### 1.6.4 如何阅读本书

对于不同背景的读者，本书建议以下阅读路径：

**水利自动化工程师**：建议按顺序通读全书，重点关注第四至六章的MIL/SIL/HIL方法细节和第九章的工程案例。如果时间有限，可以优先阅读第一章（建立全局认知）、与自身工作最相关的测试级别章节（MIL/SIL/HIL之一）、以及第九章（工程参考）。

**运行管理人员**：建议阅读第一章（理解在环验证的价值和必要性）、第七章（了解测试用例的设计逻辑以制定合理的验收标准）、第八章（理解覆盖度度量和质量门禁以把控上线标准）、以及第九章（参考工程实践）。

**研究生**：建议按顺序通读全书，特别注意每章的数学推导和例题。建议在阅读本书之前或同时阅读M1（降阶建模）和M3（安全包络），以获得必要的前置知识。建议在完成本书后阅读M7（HydroOS），以理解在环验证的工程实现环境。

---

## 1.7 例题

【例1-1】某水渠控制系统采用PI控制器调节闸门开度以跟踪目标水位。在MIL测试中，使用理想化的闸门模型（无延迟、无死区、线性响应），控制器在所有测试场景下均表现良好。但在SIL测试中，引入了真实闸门的特性参数（纯延迟τ=0.8s、死区δ=3%、非线性响应曲线），发现在上游来水突增30%的场景下，系统出现持续振荡。

[已知]
- PI控制器参数：Kp=2.0, Ki=0.05
- 理想闸门模型：开度指令到实际开度的传递函数为G_ideal(s) = 1
- 真实闸门模型：G_real(s) = e^{-0.8s} / (1 + 0.5s)，叠加3%死区
- 来水扰动：阶跃增加30%

[问题] (1) 分析MIL测试未能发现振荡问题的原因；(2) 估算真实闸门模型引入的相位裕度损失；(3) 提出修复方案。

[解题过程]

(1) MIL中使用的理想闸门模型G_ideal(s)=1意味着闸门瞬时完美响应控制指令，不引入任何相位延迟。在这种条件下，PI控制器的开环传递函数为：

L_ideal(s) = (Kp + Ki/s) · G_plant(s) · G_ideal(s) = (Kp + Ki/s) · G_plant(s)

系统的稳定性完全取决于被控对象G_plant(s)的特性和PI参数的匹配。如果这个匹配是良好的，系统在MIL中自然表现稳定。

但在SIL中引入真实闸门模型后，开环传递函数变为：

L_real(s) = (Kp + Ki/s) · G_plant(s) · e^{-0.8s} / (1 + 0.5s)

纯延迟项e^{-0.8s}在穿越频率ωc处引入的相位延迟为-0.8ωc（弧度），一阶惯性项1/(1+0.5s)在ωc处引入额外的相位延迟-arctan(0.5ωc)。死区则引入等效的增益非线性。这些因素共同导致相位裕度的显著降低。

(2) 假设MIL中的穿越频率ωc≈0.5 rad/s，则真实闸门模型引入的额外相位延迟为：

Δφ = -0.8 × 0.5 × (180/π) - arctan(0.5 × 0.5) × (180/π)
    = -22.9° - 14.0°
    = -36.9°

如果MIL中的相位裕度为45°（一个合理的设计值），SIL中的相位裕度降至约45° - 36.9° = 8.1°，远低于通常建议的30°最小值，系统处于临界稳定状态。叠加3%的死区引起的极限环振荡，系统出现持续振荡完全符合预期。

(3) 修复方案有多种选择：

方案A——降低控制器增益：将Kp从2.0降至1.0左右，以降低穿越频率ωc，从而减小延迟项的相位影响。代价是响应速度变慢。

方案B——引入Smith预估器：在控制器中引入延迟补偿环节，使用闸门延迟的估计值进行补偿。要求延迟估计的精度在±20%以内。

方案C——增加抗积分饱和（anti-windup）机制：限制积分项的累积范围，防止在大偏差条件下积分项过度累积导致的振荡。

[结果讨论] 本例说明了在环验证中"逐级增加真实度"的重要性。MIL使用理想化模型是合理的——它的目的是快速验证控制算法的基本逻辑。但MIL通过不能作为现场部署的充分条件。SIL引入更真实的执行器模型后暴露了稳定性问题，这正是SIL测试的价值所在。如果没有SIL这一环节，问题将在现场部署后才暴露——代价要大得多。

---

## 本章小结

本章作为全书的绪论，建立了水利控制系统在环验证的全局认知框架。

首先，通过一个真实工程事件（控制策略仿真通过但现场振荡）引出了在环验证的核心动机：仿真验证的通过不等于现场运行的安全。分析了"仿真通过"背后的三个隐含假设（模型精确性、场景完备性、实现忠实性），以及水利系统的四项特殊性（不可逆性、传播性、时变性、季节性与极端性）对在环验证的特殊需求。

其次，建立了V&V概念体系——区分了验证（Are we building the system right?）与确认（Are we building the right system?），介绍了V模型在水利控制开发中的应用，以及IEC 61508、ISO 26262和DO-178C等功能安全标准对水利在环验证的借鉴意义。

第三，阐述了在环验证的核心理念——"在环"的含义是闭环动态交互，MIL/SIL/HIL三级递进策略逐步增加测试真实度。表1-2系统对比了三级测试的特点。

第四，明确了在环验证在CHS体系中的定位——它是CHS八原理之一，与水网自主等级（WNAL）、安全包络、HydroOS等核心概念深度关联。表1-3给出了不同自主等级对在环验证的要求。

第五，回顾了水利在环验证的国际发展历程和中国现状，指出中国在MIL层面已达国际先进水平，在SIL/HIL层面正在追赶，在AI组件验证方面与国际同行处于同一起点。

> 下一章将深入数字孪生与仿真环境的构建——这是在环验证的基础设施。一个高质量的在环测试体系，首先需要一个高质量的仿真环境来提供"虚拟的被控对象"。

---

## 习题

### 基础题

**1-1.** 请用自己的话区分"验证"（Verification）和"确认"（Validation）的含义，并各举一个水利控制系统中的具体例子。

**1-2.** 请解释为什么在环测试（闭环测试）能够发现开环测试无法发现的问题。以闸门控制为例，说明一种只能在闭环条件下暴露的典型缺陷类型。

**1-3.** 请列出MIL、SIL、HIL三级测试分别侧重发现的缺陷类型，并说明为什么三级测试不能相互替代。

### 应用题

**1-4.** 某调水工程计划将控制策略从L1（辅助自动化）升级到L2（部分自主）。参考表1-3，请设计该升级项目的在环验证计划框架：需要新增哪些测试环节？需要覆盖哪些新的测试场景？验收标准应如何制定？

**1-5.** 参考例1-1的分析方法，如果一个水泵变频控制系统在MIL中表现良好，但在SIL中发现泵出口压力出现低频振荡，请分析可能的原因（至少列出三种可能），并为每种可能设计一个验证实验来确认或排除。

### 思考题

**1-6.** 本章将水利在环验证与航空（DO-178C）和汽车（ISO 26262）行业进行了类比。请讨论：水利控制系统的在环验证是否可以直接采用这些行业的标准和方法？有哪些水利行业的特殊性需要在标准移植过程中特别考虑？

**1-7.** 1.1节的工程事件中，问题最终由值班调度员手动干预解决。如果该系统已升级到L3自主等级（调度员不再实时在环），同样的问题可能导致什么后果？这对L3及以上系统的在环验证提出了什么特殊要求？

---

## 拓展阅读

1. **Buyalski, C. P., Ehler, D. G., Falvey, H. T., Rogers, D. C., & Serfozo, E. A. (1991).** *Canal Systems Automation Manual, Volume 2.* U.S. Bureau of Reclamation. — 美国垦务局的水渠自动化经典手册，首次系统讨论了水渠控制策略的仿真验证方法，是水利在环验证思想的重要先驱。

2. **van Overloop, P. J. (2006).** *Model Predictive Control on Open Water Systems.* Ph.D. Thesis, Delft University of Technology. — 首次将模型预测控制与闭环仿真验证系统性应用于明渠控制，其中的MIL方法论对后续水利在环验证实践产生了深远影响。

3. **IEC 61508:2010.** *Functional Safety of Electrical/Electronic/Programmable Electronic Safety-Related Systems.* International Electrotechnical Commission. — 功能安全领域的基础标准，定义了安全完整性等级和全生命周期V&V框架，为水利控制系统的安全验证提供了方法论借鉴。

4. **ISO 26262:2018.** *Road Vehicles — Functional Safety.* International Organization for Standardization. — 汽车功能安全标准，其中Part 6（软件层面产品开发）对MIL/SIL/HIL测试方法有详细规定，是水利在环验证标准化的重要参考。

5. **Lei, X. et al. (2025c).** "In-the-Loop Testing System for Water Network Control." *南水北调与水利科技（中英文）*, DOI: 10.13476/j.cnki.nsbdqk.2025.0080. — 提出了水网控制在环测试系统的总体框架，首次将MIL/SIL/HIL三级验证体系化应用于中国大型调水工程，是本书工程案例的直接理论基础。

6. **Malaterre, P. O. & Baume, J. P. (1998).** "Modeling and Regulation of Irrigation Canals: Existing Applications and Ongoing Researches." *IEEE International Conference on Systems, Man, and Cybernetics*. — SIC仿真平台的早期文献，展示了水渠控制仿真验证的技术路线，对理解水利在环验证的历史演进有参考价值。
