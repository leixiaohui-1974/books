<!-- 变更日志
v1 2026-02-19: 初稿
-->

# 第三章 水力学模型封装与接口标准

## 学习目标

1. 掌握Saint-Venant方程数值模型的标准化封装方法，理解从"科研代码"到"在环测试组件"的工程化转变；
2. 理解降阶模型（ROM）在在环测试中的角色定位，掌握IDZ模型、Muskingum模型等典型降阶模型的封装规范；
3. 掌握多模型耦合与动态切换机制，能够设计适应不同测试需求的模型编排策略；
4. 理解SCADA数据接口标准与实时数据驱动仿真的实现方法；
5. 掌握模型参数同化与在线校正的基本原理，能够设计仿真模型的持续校准机制。

> **前章回顾**：第二章建立了数字孪生与仿真环境的整体框架，介绍了FMI/FMU封装标准、联合仿真架构和仿真校验方法。本章将聚焦仿真环境中最核心的技术组件——水力学模型，系统阐述如何将复杂的水力学模型从"能跑的科研代码"转化为"可信赖的在环测试组件"。这一转化过程涉及模型封装、接口标准化、多模型耦合、数据接口对接和参数持续校正五个关键环节。

---

## 从科研模型到测试组件：工程化挑战

### 3.1.1 一个典型的困境

一个常见的场景是：团队花了两年时间开发了精度很高的明渠水力学模型，在学术论文中用RMSE和NSE证明了其精度，但当要将这个模型集成到在环测试平台时，却发现困难重重。模型依赖特定版本的Fortran编译器和特定的操作系统；输入输出格式是自定义的文本文件；计算步长固定为30秒，无法适配HIL平台的10ms实时约束；模型内部没有错误处理，输入数据异常时直接崩溃而不是给出降级结果。

这个困境揭示了科研模型与工程组件之间的根本差异。科研模型的目标是"证明方法有效"，工程组件的目标是"在各种条件下可靠运行"。两者的质量标准完全不同。

### 3.1.2 工程化的五个维度

将科研模型转化为在环测试组件，需要在五个维度上进行工程化改造：

**表3-1 科研模型与在环测试组件的差异对比**

| 维度 | 科研模型 | 在环测试组件 |
|------|---------|------------|
| 接口 | 自定义文件I/O | 标准化API（FMI/OPC-UA） |
| 时间管理 | 固定步长、自主推进 | 可变步长、外部驱动 |
| 异常处理 | 崩溃或忽略 | 降级运行、错误码返回 |
| 性能约束 | 无实时要求 | MIL加速、SIL/HIL实时 |
| 可配置性 | 源码修改 | 参数文件/API配置 |
| 可观测性 | printf调试 | 结构化日志、状态监控 |
| 版本管理 | 个人文件系统 | 模型仓库、语义版本号 |

### 3.1.3 本章的技术路线

本章将沿着"从内到外"的路线展开：首先讨论全水力学模型（Saint-Venant方程）的封装方法（3.2节），然后讨论降阶模型的集成策略（3.3节），接着讨论多模型耦合与切换机制（3.4节），再讨论与SCADA系统的数据接口标准（3.5节），最后讨论模型参数的在线同化与校正（3.6节）。

---

## Saint-Venant方程模型封装

### 3.2.1 封装的前提：模型结构标准化

在封装之前，首先需要将Saint-Venant方程数值模型的内部结构标准化。无论采用何种数值格式（特征线法、Preissmann隐格式、有限体积法等），模型都应被组织为以下标准结构：

**初始化接口（Init）**：接收模型参数（渠道几何、糙率、初始条件等），完成内存分配、矩阵预构建等准备工作。初始化应支持两种模式——冷启动（从给定初始条件开始）和热启动（从保存的状态快照恢复）。

**单步推进接口（Step）**：接收当前时间步的边界条件（上游入流、下游水位、旁侧入流/取水、闸门开度等），推进一个时间步长，返回状态量（各断面水位和流量）。单步推进是封装的核心接口，其设计直接影响联合仿真的效率和灵活性。

**查询接口（Query）**：在不推进时间的情况下查询模型的内部状态——包括任意断面的水位、流量、流速、水面宽度、过水面积等。查询接口支持联合仿真中其他子系统获取水力学状态。

**状态快照接口（Snapshot/Restore）**：保存和恢复模型的完整内部状态。状态快照用于实现仿真的"存档/读档"功能，在MIL的参数扫描和蒙特卡罗测试中至关重要——可以从同一初始状态出发、改变不同参数进行批量测试。

**终止接口（Terminate）**：释放资源，输出运行摘要。

这五个接口构成了水力学模型封装的最小接口集。用伪代码表示：

```
class HydraulicModel:
    def init(config: ModelConfig, mode: 'cold'|'warm') -> Status
    def step(dt: float, bc: BoundaryConditions) -> StepResult
    def query(location: float, variable: str) -> float
    def snapshot() -> StateVector
    def restore(state: StateVector) -> Status
    def terminate() -> Summary
```

### 3.2.2 Preissmann隐格式的封装实践

Preissmann四点隐格式是明渠水力学仿真中最常用的数值方法，其核心是将Saint-Venant方程在$(x, t)$平面的四个网格点上加权离散。

对于连续性方程和动量方程：

$$\frac{\partial A}{\partial t} + \frac{\partial Q}{\partial x} = q_l$$

$$\frac{\partial Q}{\partial t} + \frac{\partial}{\partial x}\left(\frac{Q^2}{A}\right) + gA\frac{\partial h}{\partial x} + gAS_f = 0$$

Preissmann格式将空间导数和时间导数分别用权重因子$\theta$和$\psi$加权，得到关于相邻两个时间层、相邻两个空间节点的代数方程组。对于$N$个计算断面的渠段，离散后形成一个$2(N-1)$维的非线性方程组，通常用追赶法（Thomas算法的推广）求解。

封装Preissmann格式模型时需要特别注意以下技术要点：

**权重因子$\theta$的暴露**：权重因子$\theta$（通常取0.5-1.0）直接影响数值稳定性和精度。$\theta = 0.5$对应Crank-Nicolson格式，精度最高但可能振荡；$\theta = 1.0$对应全隐格式，无条件稳定但数值耗散较大。在环测试中，不同场景可能需要不同的$\theta$值——常规工况取0.6，快速变化工况取0.7-0.8，极端稳定性要求取1.0。因此$\theta$应作为可配置参数暴露在接口中。

**边界条件类型的灵活性**：在环测试中，上游边界可能是流量过程线（Q(t)），也可能是水位过程线（h(t)），甚至是闸门开度（控制器输出）；下游边界可能是水位、流量或水位-流量关系。封装时应支持多种边界条件类型的运行时切换。

**时间步长的适配**：科研模型通常使用固定时间步长（如Δt = 30s或60s），但联合仿真中的通信步长可能与模型计算步长不同。封装时需要实现"外部步长-内部步长"的解耦——外部Step接口接受联合仿真的通信步长，内部可能执行多个小步长的计算。

【例3-1】某明渠渠段长$L = 50$ km，梯形断面底宽$B = 12$ m，边坡系数$m = 2$，底坡$S_0 = 0.00015$，Manning糙率系数$n = 0.016$。设计流量$Q_0 = 80$ m³/s。现需将其Preissmann格式模型封装为FMU，联合仿真通信步长为$\Delta T_{comm} = 120$ s。

[已知] 为保证Preissmann格式的数值精度，空间步长$\Delta x$不宜大于渠段长度的1/50（$\Delta x \leq 1000$ m），时间步长$\Delta t$需满足Courant条件的参考值。

[求解] 确定空间离散方案、计算步长与通信步长的适配方案、以及FMU的接口参数。

[解题过程]

（1）空间离散：取$\Delta x = 1000$ m，共$N = 50$个计算断面（加上两个边界断面，共52个节点）。每个断面有2个未知数（$Q$和$h$），故方程组规模为$2 \times 50 = 100$维。

（2）时间步长确定：设计工况下均匀流水深约$y_0 \approx 2.8$ m（通过Manning公式迭代求解），水面宽$B_s = B + 2my_0 = 12 + 2 \times 2 \times 2.8 = 23.2$ m，过水断面面积$A_0 = (B + my_0)y_0 = (12 + 2 \times 2.8) \times 2.8 = 49.3$ m²，流速$V_0 = Q_0/A_0 = 80/49.3 = 1.62$ m/s，波速$c = \sqrt{gA_0/B_s} = \sqrt{9.81 \times 49.3/23.2} = 4.57$ m/s。Courant数参考值$Cr = (V_0 + c)\Delta t / \Delta x$，取$Cr \leq 10$（隐格式允许较大Courant数），则$\Delta t \leq 10 \times 1000/(1.62 + 4.57) = 1615$ s。取$\Delta t = 60$ s作为计算步长，安全裕度充分。

（3）通信-计算步长适配：联合仿真通信步长$\Delta T_{comm} = 120$ s，模型计算步长$\Delta t = 60$ s，每个通信步内执行$120/60 = 2$个计算步。FMU的Step接口每次被调用时，内部执行2步Preissmann推进。

（4）FMU接口参数设计：

```
输入变量（causality = input）:
  - Q_upstream: 上游入流量 [m³/s]
  - h_downstream: 下游水位 [m]
  - gate_openings[5]: 5座中间闸门开度 [m]
  
输出变量（causality = output）:
  - h[52]: 各断面水位 [m]
  - Q[52]: 各断面流量 [m³/s]
  - V_max: 最大流速 [m/s]
  
参数（causality = parameter）:
  - theta: Preissmann权重因子 [-]，默认0.6
  - n_manning: Manning糙率系数 [s/m^{1/3}]
  - dx: 空间步长 [m]
  - dt_internal: 内部计算步长 [s]
```

[结果讨论] 本例展示了Preissmann格式模型封装的典型流程。关键设计决策包括：（a）计算步长（60s）与通信步长（120s）的解耦，使模型可以在不同联合仿真配置中复用；（b）权重因子$\theta$暴露为参数，支持不同测试场景的数值配置；（c）输出变量包含全断面水位/流量和导出量（最大流速），满足在环测试中安全约束检查的需求。

### 3.2.3 特征线法（MOC）的封装特殊性

特征线法（Method of Characteristics）常用于管道瞬变流（水锤）仿真。与Preissmann格式的隐式求解不同，MOC是显式方法，其时间步长受CFL条件严格约束：

$$\Delta t \leq \frac{\Delta x}{a}$$

其中$a$为管道中的波速（水锤波速），通常在800-1400 m/s之间。对于空间步长$\Delta x = 100$ m的管道，计算步长$\Delta t$不超过0.07-0.12 s。

这给封装带来了两个特殊挑战：

**高频计算与低频通信的步长比**：如果联合仿真的通信步长为1秒，而MOC的计算步长为0.1秒，则每个通信步内需执行10个计算步。当通信步长更大（如10秒）时，步长比达到100:1，计算开销和数据管理都需要仔细设计。

**波速与步长的耦合**：MOC的一个独特约束是$a \cdot \Delta t = \Delta x$（Courant数严格等于1时精度最高）。如果管道的波速$a$在运行过程中变化（如含气量变化、管壁弹性变化），步长也需要相应调整。封装时需要在接口中提供步长自适应机制或允许外部控制器查询推荐步长。

### 3.2.4 有限体积法的封装

有限体积法（Finite Volume Method, FVM）近年来在明渠仿真中日益流行，特别是处理包含跨临界流（如水跃、闸下急流）的复杂工况。Godunov型格式（如HLL、Roe格式）可以自然处理间断，无需人工识别和追踪水跃位置。

封装有限体积法模型时的关键注意事项：

**通量限制器的暴露**：高分辨率格式通常使用通量限制器（如minmod、van Leer、superbee）在精度和稳定性之间取得平衡。不同限制器的特性差异显著——minmod最耗散但最稳定，superbee最少耗散但可能产生伪振荡。在环测试中应将限制器选择暴露为配置参数。

**干湿边界处理**：有限体积法经常需要处理"干河床"（水深为零或极小值）的情况。干湿边界的处理方法影响数值稳定性和质量守恒。封装时需要确保干湿处理方法的行为在接口文档中有清晰说明，并在单元测试中覆盖。

---

## 降阶模型（ROM）集成

### 3.3.1 降阶模型在在环测试中的角色

降阶模型（Reduced-Order Model, ROM）不是全水力学模型的"简化替代品"，而是在环测试体系中承担着独特角色的关键组件。在MIL测试中，ROM使大规模参数扫描和蒙特卡罗仿真成为可能——一个需要10分钟的全模型仿真，用ROM可能只需0.1秒。在SIL测试中，ROM作为"快速代理"提供实时或超实时的物理约束检查。在HIL测试中，ROM是唯一能满足毫秒级实时约束的模型形态。

**表3-2 不同模型类型在三级在环测试中的角色**

| 测试级别 | 全水力学模型 | 降阶模型（ROM） | 角色分工 |
|---------|------------|---------------|---------|
| MIL | 基准仿真（精确但慢） | 批量扫描（快速代理） | ROM扫描→全模型验证关键点 |
| SIL | 离线对比验证 | 实时物理约束检查 | 全模型确认、ROM在线守护 |
| HIL | 仅用于离线标定 | 实时闭环仿真（主角） | ROM承担实时计算、全模型事后审计 |

### 3.3.2 IDZ模型的封装

IDZ（Integrator Delay Zero）模型是明渠降阶模型中最经典的形式之一，由Litrico和Fromion在系统辨识框架下发展。其核心思想是将一个渠池（两闸之间的渠段）的传递函数用以下形式近似：

$$G(s) = \frac{Q_{down}(s)}{Q_{up}(s)} \approx \frac{1}{A_d s} \cdot e^{-\tau_d s} \cdot \frac{1 + T_z s}{1 + T_p s}$$

其中$A_d$为回水面积（积分器增益的倒数）、$\tau_d$为传输延时、$T_z$和$T_p$分别为零点和极点的时间常数。

物理意义的直觉解释：入流扰动首先以波速传播到下游（延时$\tau_d$），然后在渠池中逐渐蓄积（积分器$1/A_d s$），伴随着高频扰动的衰减（一阶滞后$T_p$）和中间过程的超调（零点$T_z$）。

封装IDZ模型时需注意以下要点：

**延时的离散实现**：纯延时$e^{-\tau_d s}$在离散时间域的实现有多种方法——最简单的是固定延迟缓冲区（延时取计算步长的整数倍），更精确的是Padé近似或Thiran全通滤波器。选择哪种方法取决于$\tau_d / \Delta t$的比值和精度要求。

**参数在线更新**：IDZ模型的四个参数（$A_d, \tau_d, T_z, T_p$）依赖于工况（流量水平、水位高度）。在非线性较强的工况范围内，同一个渠池可能需要多组参数。封装时应支持参数的在线切换或插值。

**多渠池级联**：实际输水线路通常由多个渠池级联组成。每个渠池一个IDZ模型，级联连接时上游渠池的输出是下游渠池的输入。封装时应支持灵活的级联配置。

【例3-2】胶东调水工程某段干渠包含3个渠池（K0-K15、K15-K32、K32-K50），各渠池在设计流量$Q_0 = 50$ m³/s下的IDZ参数如下：

| 渠池 | $A_d$ (m²) | $\tau_d$ (s) | $T_z$ (s) | $T_p$ (s) |
|------|-----------|-------------|-----------|-----------|
| Pool 1 (K0-K15) | 180,000 | 5,400 | 3,200 | 4,800 |
| Pool 2 (K15-K32) | 204,000 | 6,120 | 3,600 | 5,400 |
| Pool 3 (K32-K50) | 216,000 | 6,480 | 3,800 | 5,700 |

现需将三级联IDZ模型封装为单个FMU，用于MIL批量测试。通信步长为60秒，采用一阶保持（FOH）离散化。

[已知] 延时$\tau_d$最大为6,480 s（108分钟），计算步长为60 s。

[求解] 设计FMU的内部结构和接口。

[解题过程]

（1）延时缓冲区设计：最大延时6,480 s，步长60 s，需要缓冲区长度$6480/60 = 108$个采样点。采用循环缓冲区实现，内存开销约$3 \times 108 \times 8 = 2.6$ KB（3个渠池，每个采样点8字节双精度浮点数），可以忽略不计。对于非整数延时（$\tau_d$不是$\Delta t$的整数倍），采用线性插值在两个相邻采样点之间获取延时输出。

（2）传递函数离散化：对每个渠池的传递函数（不含延时部分），采用零阶保持（ZOH）或一阶保持（FOH）离散化。以Pool 1为例，连续域传递函数为：

$$G_1(s) = \frac{1}{180000 s} \cdot \frac{1 + 3200s}{1 + 4800s}$$

采用FOH离散化（$\Delta t = 60$ s），首先将积分器和一阶环节分别离散。积分器$1/(A_d s)$离散为$\Delta t/(A_d(1-z^{-1}))$，一阶环节$(1+T_z s)/(1+T_p s)$离散为双线性变换（Tustin方法）。

（3）FMU接口设计：

```
输入变量:
  - Q_in: Pool 1上游入流量 [m³/s]
  - Q_lateral[3]: 各渠池旁侧入流 [m³/s]

输出变量:
  - h_pool[3]: 各渠池下游端水位偏差 [m]
  - Q_out: Pool 3下游出流量 [m³/s]
  - Q_pool[3]: 各渠池出流量 [m³/s]

参数:
  - Ad[3], tau_d[3], Tz[3], Tp[3]: IDZ参数
  - Q0: 线性化工作点流量 [m³/s]
  - h0[3]: 线性化工作点水位 [m]
```

（4）状态向量设计：每个渠池的状态包括延时缓冲区（最大108点）和离散传递函数的内部状态（2-3个变量）。三个渠池的总状态向量维度约$3 \times (108 + 3) = 333$。Snapshot/Restore接口保存和恢复这333个状态量。

[结果讨论] 本例展示了IDZ级联模型封装的典型设计。与全水力学模型封装（例3-1）相比，IDZ模型的FMU具有两个显著优势：（a）计算量极小——每步仅需矩阵向量运算和缓冲区移位，单步计算时间在微秒量级；（b）状态向量紧凑——333维远小于全模型的数千维，使大规模蒙特卡罗仿真的状态管理更高效。代价是精度受限于线性化假设——当实际工况偏离线性化工作点较远时，IDZ模型的精度下降。

### 3.3.3 Muskingum类模型的封装

Muskingum模型及其改进形式（Muskingum-Cunge）是另一类广泛使用的降阶模型，特别适用于河道洪水演进和长距离调水的流量传播计算。

经典Muskingum模型的储量方程为：

$$S = K[xQ_{in} + (1-x)Q_{out}]$$

其中$K$为演进时间常数（约等于波传播时间），$x$为权重因子（0-0.5之间）。结合连续性方程$dS/dt = Q_{in} - Q_{out}$，可得到显式递推公式：

$$Q_{out}^{n+1} = C_1 Q_{in}^{n+1} + C_2 Q_{in}^n + C_3 Q_{out}^n$$

其中系数$C_1, C_2, C_3$由$K$、$x$和$\Delta t$确定。

Muskingum模型的封装相对简单（仅需存储前一步的$Q_{in}$和$Q_{out}$），但有两个工程化要点：

**多河段级联**：长距离渠道需要分为多个子河段级联。子河段数的选择需要平衡精度和计算效率——子河段越多精度越高（接近分布式参数系统），但计算量和参数量也增加。封装时应支持可配置的子河段数。

**参数的物理约束**：$C_1 + C_2 + C_3 = 1$是质量守恒的必要条件，且三个系数都应非负以保证物理合理性（$C_1 \geq 0, C_2 \geq 0, C_3 \geq 0$）。封装时应在参数设置接口中内置这些约束的检查。

### 3.3.4 数据驱动降阶模型的封装

近年来，基于深度学习的数据驱动降阶模型（如LSTM、Transformer、Neural ODE）在水力学预测中取得了显著进展。这类模型的封装面临一些独特挑战：

**推理引擎的集成**：深度学习模型的推理通常依赖Python和TensorFlow/PyTorch等框架，而在环测试平台可能基于C/C++。封装时需要考虑推理引擎的嵌入方式——可以通过ONNX Runtime等跨平台推理框架，将模型转换为与Python解耦的标准格式。

**隐状态的管理**：LSTM等循环网络的内部维护隐状态（hidden state），这些隐状态需要在Snapshot/Restore接口中完整保存。Transformer模型虽然没有传统意义上的隐状态，但其注意力窗口内的历史输入序列也需要作为状态的一部分管理。

**不确定性量化**：数据驱动模型的一个优势是可以通过集成方法（如MC Dropout、Deep Ensemble）提供预测不确定性的估计。封装时应考虑是否暴露不确定性输出——在在环测试中，不确定性信息可以用于触发全模型的验证计算。

**表3-3 三类降阶模型封装特性对比**

| 特性 | IDZ模型 | Muskingum模型 | 数据驱动模型 |
|------|--------|-------------|------------|
| 理论基础 | 传递函数/频域辨识 | 水量平衡/运动波近似 | 统计学习/神经网络 |
| 参数量 | 4个/渠池 | 2-3个/子河段 | 数万-数百万 |
| 计算速度 | 微秒级 | 微秒级 | 毫秒级（GPU）/数十毫秒（CPU） |
| 适用工况 | 小扰动线性范围 | 中等扰动洪水演进 | 训练数据覆盖范围 |
| 物理一致性 | 质量守恒保证 | 质量守恒保证 | 不保证 |
| 外推能力 | 有限（线性假设） | 中等 | 差（超出训练分布时不可靠） |
| HIL适用性 | 优秀 | 优秀 | 需要优化（模型压缩） |

---

## 多模型耦合与动态切换

### 3.4.1 为什么需要多模型

实际的在环测试往往不能仅依赖单一模型。原因有三：

**精度-速度权衡**：MIL测试的批量扫描阶段需要ROM的速度，但关键场景的精确验证需要全模型的精度。同一个测试流程中可能需要在两种模型之间切换。

**工况适用性**：IDZ模型在小扰动范围内精度很高，但大幅度调控（如紧急泄洪）超出了线性化假设。Muskingum模型擅长洪水演进但不擅长回水计算。有限体积法在跨临界流中表现优异但计算量大。不同工况需要不同模型。

**冗余安全**：在安全关键场景的测试中，多个独立模型的交叉验证可以提高测试结论的可信度。如果两个不同原理的模型对同一场景给出一致的结果，置信度显著提升。

### 3.4.2 多模型编排架构

CHS框架下的多模型编排采用"模型注册中心+编排引擎"的架构：

**模型注册中心（Model Registry）**：所有可用模型以标准FMU格式注册，每个模型附带元数据——包括模型类型、适用工况范围、精度指标（NSE、RMSE等在不同工况下的标定值）、计算性能指标（单步耗时、实时比）和资源需求（内存、是否需要GPU）。

**编排引擎（Orchestration Engine）**：根据当前测试需求和工况状态，选择最合适的模型或模型组合。编排策略可以是静态的（在测试配置中预先指定）或动态的（运行时根据工况自动切换）。

### 3.4.3 模型切换的技术挑战

模型切换（Model Switching）是多模型编排的核心技术难点。从模型A切换到模型B时，需要解决状态迁移问题——两个模型的内部状态表示通常不同（如全模型有数千维状态、IDZ模型只有数百维），直接将一个模型的状态"拷贝"到另一个模型是不可能的。

**切换方法一：重新初始化法**

将模型A在切换时刻的输出（各断面水位和流量）作为模型B的初始条件，重新初始化模型B。这是最简单的方法，但存在初始化瞬态——模型B需要一段"热身"时间才能从给定初始条件收敛到自洽的内部状态。

**切换方法二：并行运行法**

在切换前的一段时间窗口内，两个模型并行运行、接收相同的输入。切换时刻，模型B已经有了自洽的内部状态，可以无缝接管。代价是并行运行期间的计算资源翻倍。

**切换方法三：状态映射法**

建立模型A和模型B的状态空间之间的映射关系。对于全模型→ROM的切换，可以通过在全模型的状态空间上进行投影（如POD/PCA降维）获得ROM的初始状态。反向切换（ROM→全模型）则需要状态重构——从ROM的低维状态恢复全模型的高维状态，通常需要辅助数据（如历史工况的状态数据库）。

【例3-3】在某MIL测试中，需要对1000个随机场景进行批量扫描，然后对其中安全裕度最小的50个场景用全模型精确验证。请设计多模型编排方案。

[已知] IDZ模型单步耗时0.01ms，全水力学模型（Preissmann格式）单步耗时50ms。每个场景仿真时长为12小时（虚拟时间），步长60s，共$12 \times 3600/60 = 720$步。

[求解] 总计算时间和模型切换策略。

[解题过程]

（1）ROM批量扫描阶段：1000个场景 × 720步 × 0.01ms/步 = 7.2 s。使用IDZ模型对全部1000个场景完成扫描，每个场景记录最小安全裕度（水位距安全包络上限的最小距离）。

（2）场景筛选：对1000个场景按安全裕度排序，选取最小的50个场景进入精确验证。

（3）全模型验证阶段：50个场景 × 720步 × 50ms/步 = 1800 s = 30 min。对50个关键场景使用Preissmann格式全模型验证。

（4）模型切换策略：本例不需要运行时切换——ROM阶段和全模型阶段是串行的两个独立批次。每个全模型场景从ROM筛选出的初始条件冷启动。这是最简单的编排模式。

（5）结果对比：ROM扫描用时7.2秒 + 全模型验证用时30分钟 ≈ 30分钟。如果全部1000个场景都用全模型，需要$1000 \times 720 \times 50ms = 36000 s = 10$小时。多模型编排将计算时间从10小时压缩到30分钟（加速比20倍），同时对关键场景保持了全模型精度。

[结果讨论] 本例展示了最基本的"ROM筛选+全模型验证"两阶段编排策略。该策略的核心假设是ROM的排序与全模型的排序一致——即ROM判断为"最危险"的场景，全模型也会认为是最危险的。这个假设需要通过ROM与全模型的校准来保证（参见3.6节模型参数同化）。

---

## SCADA数据接口标准

### 3.5.1 在环测试中的SCADA数据需求

在环测试需要与SCADA系统进行数据交互的场景包括：

**MIL阶段**：使用历史SCADA数据作为仿真的边界条件和初始条件。例如，从SCADA历史数据库中提取某次真实调度过程的边界条件时间序列（来水量、闸门操作记录、泵站运行记录），用于驱动仿真模型进行"重放"（replay）。

**SIL阶段**：控制软件通过标准协议（如OPC-UA）读写SCADA模拟信号。仿真模型模拟水力学过程并将状态数据通过SCADA接口反馈给控制软件，形成闭环。

**HIL阶段**：实时仿真器通过硬件I/O接口与SCADA远程终端单元（RTU）通信，模拟现场传感器信号（水位、流量、闸位反馈等）和执行器响应（闸门动作确认、泵站启停反馈等）。

### 3.5.2 OPC-UA作为统一数据接口

OPC-UA（Open Platform Communications Unified Architecture）是工业自动化领域的国际标准通信协议，近年来在水利SCADA系统中的采用率显著增长。相比传统的OPC-DA（基于Windows COM/DCOM），OPC-UA具有平台无关性（跨操作系统）、内建安全机制（加密和认证）和信息模型标准化等优势。

在在环测试中采用OPC-UA作为统一数据接口的关键设计包括：

**地址空间设计**：OPC-UA的信息模型将所有数据组织为节点树。对于水利在环测试，建议按照"工程-渠段-设施-变量"的四层结构组织地址空间：

```
Root
└── JiaodongWaterTransfer
    ├── Section_K0_K15
    │   ├── Gate_01
    │   │   ├── Opening (Float, RW)
    │   │   ├── Opening_Feedback (Float, RO)
    │   │   ├── Status (Enum, RO)
    │   │   └── Alarm (Bool, RO)
    │   ├── WaterLevel_K5 (Float, RO)
    │   ├── FlowRate_K5 (Float, RO)
    │   └── ...
    ├── Section_K15_K32
    │   └── ...
    └── Section_K32_K50
        └── ...
```

其中RW（Read-Write）表示控制软件可以写入的量（如闸门目标开度），RO（Read-Only）表示仿真模型输出的量（如水位、流量反馈）。

**时间戳与数据质量**：OPC-UA的每个数据值都附带时间戳和质量码（Good/Uncertain/Bad）。在在环测试中，仿真模型输出的数据应使用仿真时钟的时间戳（而非系统时钟），并且在模型出现数值异常时将质量码设为Uncertain或Bad，而不是输出错误值。这一点对SIL和HIL测试中的控制软件行为验证至关重要——控制软件需要能够正确处理数据质量不良的情况。

### 3.5.3 MQTT作为轻量替代

对于不需要OPC-UA完整功能的场景（如MIL阶段的数据重放），MQTT（Message Queuing Telemetry Transport）是更轻量的替代选择。MQTT的发布/订阅模型适合一对多的数据分发，延迟低、带宽开销小。

在在环测试中使用MQTT的典型模式：

**数据重放服务**：一个MQTT发布者按照时间戳顺序发布历史SCADA数据，多个订阅者（仿真模型、控制算法、监控界面）同时接收。时间可以按照加速比播放（如10倍速重放）。

**状态广播**：仿真模型将计算结果发布到MQTT主题（topic），监控仪表盘和日志记录器订阅并实时展示。主题命名应与OPC-UA地址空间保持一致，便于在不同测试级别之间切换时无需修改订阅配置。

### 3.5.4 数据接口的时间同步

在SIL和HIL测试中，SCADA数据接口的时间同步是一个关键技术问题。仿真时钟和控制系统时钟必须同步，否则闭环控制的时序将出错。

**硬同步方案**：仿真器和SCADA系统共享同一个硬件时钟源（如PTP/IEEE 1588精密时间协议）。这是HIL测试的推荐方案，时间同步精度可达微秒级。

**软同步方案**：仿真器通过软件定时器驱动，每隔固定时间间隔发送一帧数据。SCADA系统在接收端进行时间戳对齐。这种方案实现简单但同步精度受操作系统调度抖动影响，一般在毫秒级。适用于SIL测试。

**虚拟时钟方案**：在MIL测试中，仿真可以以任意倍速运行。仿真器维护一个虚拟时钟，所有数据的时间戳使用虚拟时钟而非系统时钟。SCADA数据接口在MIL模式下忽略实际时间约束。

---

## 模型参数同化与在线校正

### 3.6.1 为什么需要在线校正

水力学模型的参数（如Manning糙率系数$n$、闸门流量系数$C_d$、泵站特性曲线等）并非固定不变。糙率随着渠道生物附着、泥沙淤积和季节变化而改变；闸门流量系数随着闸板磨损和密封老化而变化；泵站特性曲线随着叶轮磨蚀而偏移。

如果在环测试使用的模型参数与实际工况不一致，测试结论的可信度将大打折扣。因此，模型参数同化（Data Assimilation）和在线校正（Online Calibration）是保证仿真模型持续有效的关键技术。

### 3.6.2 参数同化的基本框架

参数同化的核心思想是利用观测数据（SCADA测量值）来修正模型参数，使模型预测与观测之间的偏差最小。

设模型的状态方程为：

$$\mathbf{x}_{k+1} = f(\mathbf{x}_k, \mathbf{u}_k, \boldsymbol{\theta}) + \mathbf{w}_k$$

其中$\mathbf{x}$为状态向量（水位、流量等）、$\mathbf{u}$为输入向量（边界条件）、$\boldsymbol{\theta}$为待同化的参数向量（糙率、流量系数等）、$\mathbf{w}_k$为过程噪声。观测方程为：

$$\mathbf{z}_k = H(\mathbf{x}_k) + \mathbf{v}_k$$

其中$\mathbf{z}_k$为SCADA观测值、$H$为观测算子（从状态空间映射到观测空间）、$\mathbf{v}_k$为观测噪声。

参数同化的目标是找到$\boldsymbol{\theta}$的最优估计，使得模型预测与观测的偏差在统计意义上最小。

### 3.6.3 常用参数同化方法

**扩展Kalman滤波（EKF）参数估计**

将参数向量$\boldsymbol{\theta}$增广到状态向量中，得到增广状态$\tilde{\mathbf{x}} = [\mathbf{x}^T, \boldsymbol{\theta}^T]^T$，然后对增广系统应用EKF。参数的"状态方程"通常假设为随机游走模型：

$$\boldsymbol{\theta}_{k+1} = \boldsymbol{\theta}_k + \boldsymbol{\eta}_k$$

其中$\boldsymbol{\eta}_k$为参数漂移噪声。通过调节$\boldsymbol{\eta}_k$的方差来控制参数的更新速度——方差大则参数跟踪快但估计噪声大，方差小则参数稳定但跟踪慢。

**集合Kalman滤波（EnKF）参数估计**

EnKF通过一组集合成员（ensemble members）来近似状态的概率分布。每个集合成员使用不同的参数值运行模型，然后根据观测数据对集合进行更新。EnKF的优势是不需要计算Jacobian矩阵，且能够处理非线性程度较高的模型。

在水力学模型参数同化中，典型的集合规模为50-200个成员。参数的初始集合通过在先验估计值周围添加随机扰动生成。

**变分方法（4D-Var）**

4D-Var通过最小化一个时间窗口内模型预测与观测偏差的代价函数来估计参数：

$$J(\boldsymbol{\theta}) = \frac{1}{2}\sum_{k=0}^{K}[\mathbf{z}_k - H(f^k(\mathbf{x}_0, \boldsymbol{\theta}))]^T \mathbf{R}^{-1} [\mathbf{z}_k - H(f^k(\mathbf{x}_0, \boldsymbol{\theta}))] + \frac{1}{2}(\boldsymbol{\theta} - \boldsymbol{\theta}_b)^T \mathbf{B}^{-1} (\boldsymbol{\theta} - \boldsymbol{\theta}_b)$$

其中$\mathbf{R}$为观测误差协方差矩阵、$\boldsymbol{\theta}_b$为参数的先验估计、$\mathbf{B}$为先验误差协方差矩阵。4D-Var需要模型的伴随（adjoint），实现复杂度较高，但在参数较多且观测稀疏的场景中通常比EnKF更高效。

### 3.6.4 在线校正的工程实现

在在环测试平台中，模型参数在线校正的实现架构包括以下组件：

**观测数据缓冲区**：接收SCADA实时数据，进行质量过滤（剔除异常值、插补缺失值）后存入滑动时间窗口缓冲区。时间窗口长度的选择需要权衡——窗口太短则参数估计不稳定，窗口太长则无法及时跟踪参数变化。典型的窗口长度为数小时至一天。

**同化计算模块**：按照设定的同化频率（如每小时一次），从缓冲区中提取观测数据，运行EKF/EnKF/4D-Var算法，输出参数的更新值和不确定性估计。

**参数更新验证**：更新后的参数在正式应用到在环测试模型之前，需要通过一组验证检查——参数值是否在物理合理范围内（如糙率$n \in [0.008, 0.040]$）、参数变化是否过大（防止单次观测异常导致参数跳变）、更新后的模型预测是否改善。

**参数版本管理**：每次参数更新都记录在参数历史日志中，包括更新时间、旧值、新值、更新依据（哪些观测数据触发了更新）和验证结果。这为在环测试结果的可追溯性提供支撑。

【例3-4】某渠段在冬季运行中，观测到仿真模型预测水位持续偏低（模型偏差约-0.08 m）。怀疑是渠壁附着物（冰期藻类残留）增大了糙率。现使用EKF方法进行糙率在线同化。

[已知] 当前模型糙率$n_0 = 0.016$（标定值），渠段设有3个水位监测断面（K5、K10、K15），观测频率15分钟一次，观测精度$\sigma_z = 0.02$ m。同化时间窗口为6小时（24个观测值/站 × 3站 = 72个观测值）。

[求解] 设计EKF参数同化方案并估计校正后的糙率值。

[解题过程]

（1）增广状态向量：将糙率$n$作为第51个状态量（原50个断面各有$Q$和$h$共100个状态量，但此处简化为50个水位状态 + 1个参数），增广状态向量$\tilde{\mathbf{x}} = [h_1, h_2, ..., h_{50}, n]^T$。

（2）参数漂移模型：$n_{k+1} = n_k + \eta_k$，其中$\eta_k \sim N(0, \sigma_\eta^2)$，取$\sigma_\eta = 0.0001$（表示糙率在15分钟内的变化不超过0.0003 s/m^{1/3}，3$\sigma$原则）。

（3）观测方程：$\mathbf{z}_k = [h_{K5}, h_{K10}, h_{K15}]_k^T + \mathbf{v}_k$，$\mathbf{v}_k \sim N(\mathbf{0}, 0.02^2 \mathbf{I}_3)$。

（4）EKF更新：经过72个观测数据的顺序同化，糙率估计收敛到$\hat{n} = 0.0172 \pm 0.0004$。模型偏差从-0.08 m降低到-0.01 m以内。

（5）验证检查：校正后糙率0.0172在物理合理范围$[0.008, 0.040]$内，变化量$\Delta n = 0.0012$为原值的7.5%，处于合理范围。用校正后参数进行6小时外推预测，预测偏差-0.015 m，优于原参数的-0.08 m。验证通过。

[结果讨论] 本例展示了EKF参数同化在实际中的应用。糙率从0.016增大到0.0172（增加7.5%），与冬季渠壁附着物增大糙率的物理预期一致。需要注意的是，EKF方法假设系统近似线性，当糙率变化导致水流状态发生较大变化时（如从缓流变为急流），需要改用EnKF等非线性方法。

### 3.6.5 在线校正与在环测试的交互

模型在线校正与在环测试的关系需要仔细设计。核心原则是：**在环测试使用的模型参数应该有明确的版本记录，测试结论应能追溯到具体的参数版本**。

具体实践中有两种模式：

**冻结模式**：在一次完整的在环测试会话中，模型参数保持固定（使用测试开始时的最新校准值）。在线校正在后台运行但不实时更新测试模型的参数。测试结束后，如果在线校正产生了显著的参数更新，需要使用新参数重新运行关键测试用例。

**跟踪模式**：模型参数在测试过程中随在线校正实时更新。这种模式更接近实际运行状态，但带来可重复性问题——如果重新运行同一测试用例，结果可能因为参数不同而不一致。因此跟踪模式通常仅用于SIL和HIL的长期耐久性测试，不用于需要严格可重复性的验收测试。

---

## 本章小结

本章系统阐述了水力学模型从"科研代码"到"在环测试组件"的工程化转变过程，涵盖五个核心技术环节。

第一，Saint-Venant方程全模型封装。通过Init/Step/Query/Snapshot/Terminate五接口标准化，实现了Preissmann隐格式、特征线法（MOC）和有限体积法三类数值方法的FMU封装。关键技术是计算步长与通信步长的解耦和边界条件类型的运行时切换（例3-1）。

第二，降阶模型（ROM）集成。IDZ模型（例3-2）、Muskingum模型和数据驱动模型各有其适用场景，在MIL/SIL/HIL三级测试中承担不同角色（表3-2）。ROM的核心价值是使大规模批量测试成为可能。

第三，多模型耦合与切换。"ROM筛选+全模型验证"的两阶段编排策略（例3-3）可实现20倍以上加速比，同时保持关键场景的全模型精度。模型切换的三种方法（重新初始化、并行运行、状态映射）适用于不同场景。

第四，SCADA数据接口。OPC-UA作为SIL/HIL测试的统一通信协议，MQTT作为MIL阶段的轻量替代，时间同步通过硬/软/虚拟时钟三种方案适配不同测试级别。

第五，模型参数同化与在线校正。EKF/EnKF/4D-Var三种同化方法（例3-4）配合冻结/跟踪两种测试交互模式，确保仿真模型的持续有效性和测试结论的可追溯性。

> 下一章（第四章）将基于本章建立的模型封装和仿真环境，系统介绍MIL（模型在环）测试的完整流程——从测试架构搭建、控制算法验证、参数敏感性分析到蒙特卡洛场景扫描和MIL报告规范。

---

## 习题

### 基础题

**3-1.** 请列出将科研水力学模型转化为在环测试组件的五个工程化维度（表3-1），并解释为什么"异常处理"维度在在环测试中特别重要。一个"崩溃"的仿真模型在MIL、SIL和HIL测试中分别会导致什么后果？

**3-2.** 解释IDZ模型四个参数（$A_d, \tau_d, T_z, T_p$）的物理含义。如果一个渠池的长度增加一倍（其他条件不变），这四个参数分别会如何变化？请给出定性的变化方向和简要的物理解释。

**3-3.** 比较OPC-UA和MQTT作为在环测试数据接口的优缺点。在MIL、SIL和HIL三个测试级别中，分别推荐使用哪种协议？为什么？

**3-4.** 模型参数在线校正的"冻结模式"和"跟踪模式"各适用于什么场景？如果在验收测试中使用了"跟踪模式"，可能带来什么问题？

### 应用题

**3-5.** 某管道输水工程采用钢管（波速$a = 1200$ m/s），管道长度$L = 5$ km，需要封装MOC模型用于SIL测试。联合仿真通信步长要求为1秒。请计算：（a）满足CFL条件的最大空间步长$\Delta x$和对应的计算步长$\Delta t$；（b）每个通信步内需要执行的MOC计算步数；（c）如果要求空间步长不超过100m，计算节点数和每步的计算量级（方程数）。

**3-6.** 参考例3-3的多模型编排方案，假设某工程需要进行5000个场景的MIL批量测试。ROM（IDZ）模型单步耗时0.02ms，全模型单步耗时100ms，每个场景1440步（虚拟时间24小时，步长60s）。如果先用ROM扫描全部场景、再对最危险的100个场景用全模型验证，请计算：（a）两阶段各自的计算时间；（b）与全部使用全模型相比的加速比；（c）如果要在8小时工作日内完成全部测试，ROM筛选的阈值应如何设定（最多允许多少个场景进入全模型验证）？

### 思考题

**3-7.** 数据驱动降阶模型（如LSTM）在在环测试中有一个根本性的局限：它不保证物理守恒（如质量守恒）。讨论：（a）物理不守恒在在环测试中可能导致什么具体问题？（b）有哪些方法可以在训练或推理阶段强制施加物理约束？（c）如果不能完全保证物理守恒，数据驱动模型是否仍有在在环测试中的应用空间？在什么条件下可以接受其使用？

**3-8.** 本章讨论的模型参数同化方法（EKF/EnKF/4D-Var）假设观测数据是可靠的。但在实际SCADA系统中，传感器故障、通信中断和数据篡改都可能导致观测数据不可靠。讨论：（a）不可靠的观测数据会对参数同化产生什么影响？（b）如何在同化算法中检测和处理异常观测？（c）如果SCADA系统遭受网络攻击（注入虚假数据），对模型参数同化和在环测试的安全性有何影响？

---

## 拓展阅读

1. **Litrico, X. & Fromion, V. (2009).** *Modeling and Control of Hydrosystems.* Springer. — IDZ模型和明渠传递函数建模的经典著作，详细推导了各类降阶模型的理论基础和辨识方法。第3-5章是本章IDZ模型封装（3.3.2节）的直接理论来源。

2. **Blochwitz, T., Otter, M., Åkesson, J., et al. (2012).** "Functional Mockup Interface 2.0: The Standard for Tool Independent Exchange of Simulation Models." *Proceedings of the 9th International Modelica Conference*. — FMI 2.0标准的技术论文，是本章模型封装接口设计的规范依据。

3. **Evensen, G. (2009).** *Data Assimilation: The Ensemble Kalman Filter.* 2nd ed., Springer. — 集合Kalman滤波的权威著作，系统阐述了EnKF的理论基础和实际应用。第6-8章对理解本章3.6节的参数同化方法特别有价值。

4. **Lei, X. et al. (2025c).** "In-the-Loop Testing System for Water Network Control." *南水北调与水利科技（中英文）*, DOI: 10.13476/j.cnki.nsbdqk.2025.0080. — 提出了HydroOS框架下的在环测试系统架构，其中的模型封装标准和SCADA接口设计是本章工程实践的直接基础。

5. **Malaterre, P.O., Rogers, D.C., & Schuurmans, J. (1998).** "Classification of Canal Control Algorithms." *Journal of Irrigation and Drainage Engineering*, 124(1), 3-10. — 明渠控制算法分类的经典论文，虽然不直接讨论在环测试，但其对控制算法特性的分类框架对理解模型封装的需求分析有重要参考价值。

6. **Willard, J., Jia, X., Xu, S., Steinbach, M., & Kumar, V. (2022).** "Integrating Scientific Knowledge with Machine Learning for Engineering and Environmental Systems." *ACM Computing Surveys*, 55(4), 1-37. — 物理约束与机器学习融合的综合综述，对理解3.3.4节数据驱动降阶模型的物理一致性问题有直接参考价值。
